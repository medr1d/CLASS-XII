{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PYTHON ASSEMBLY</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'auth_app/favicon.ico' %}" onerror="this.onerror=null; this.href='data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'auth_app/favicon.ico' %}" onerror="this.onerror=null; this.href='data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';"
    
    <!-- Google Analytics - Deferred loading for better performance -->
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4GQ8NQ38P5');
      
      // Load GA script after page load
      window.addEventListener('load', function() {
        var script = document.createElement('script');
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-4GQ8NQ38P5';
        document.head.appendChild(script);
      });
    </script>
    
    
    <!-- Ace Editor - Load synchronously to avoid conflicts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ext-language_tools.min.js"></script>
    
    <!-- Pyodide - Load asynchronously -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js" defer></script>
    
    <style>
        :root {
            --primary-color: #00aa00;
            --secondary-color: #008800;
            --tertiary-color: #006600;
            --bg-primary: #000000;
            --bg-secondary: #020202;
            --bg-tertiary: #050505;
            --border-color: #008800;
            --text-color: #00cc00;
            --text-bright: #00ff00;
            --shadow-color: rgba(0, 136, 0, 0.4);
            --glow-color: rgba(0, 136, 0, 0.15);
            --grid-color: rgba(0, 136, 0, 0.03);
        }

        body.theme-greydom {
            --primary-color: #ff4444;
            --secondary-color: #cc3333;
            --tertiary-color: #aa2222;
            --bg-primary: #1a1d2e;
            --bg-secondary: #16192a;
            --bg-tertiary: #212435;
            --border-color: #ff4444;
            --text-color: #ff6666;
            --text-bright: #ff4444;
            --shadow-color: rgba(255, 68, 68, 0.4);
            --glow-color: rgba(255, 68, 68, 0.15);
            --grid-color: rgba(100, 120, 150, 0.05);
        }

        body.theme-cloud {
            --primary-color: #000000;
            --secondary-color: #1a1a1a;
            --tertiary-color: #2d2d2d;
            --bg-primary: #ffffff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5f5f5;
            --border-color: #cccccc;
            --text-color: #000000;
            --text-bright: #000000;
            --shadow-color: rgba(0, 0, 0, 0.15);
            --glow-color: rgba(0, 0, 0, 0.05);
            --grid-color: rgba(0, 0, 0, 0.03);
        }

        body.theme-chaos {
            --primary-color: #808080;
            --secondary-color: #666666;
            --tertiary-color: #4d4d4d;
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #141414;
            --border-color: #808080;
            --text-color: #b0b0b0;
            --text-bright: #d0d0d0;
            --shadow-color: rgba(128, 128, 128, 0.3);
            --glow-color: rgba(128, 128, 128, 0.1);
            --grid-color: rgba(128, 128, 128, 0.05);
        }

        body.theme-lebron {
            --primary-color: #000000;
            --secondary-color: #000000;
            --tertiary-color: #000000;
            --bg-primary: transparent;
            --bg-secondary: transparent;
            --bg-tertiary: transparent;
            --border-color: #000000;
            --text-color: #000000;
            --text-bright: #000000;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --glow-color: rgba(0, 0, 0, 0.1);
            --grid-color: rgba(0, 0, 0, 0.05);
            background: transparent !important;
        }

        body.theme-lebron::before {
            background-image: url("{% static 'auth_app/images/lebron.jpg' %}") !important;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            opacity: 1;
            z-index: -1;
            /* Remove the grid overlay */
            background-blend-mode: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 15%, var(--bg-primary) 30%, var(--bg-tertiary) 45%, var(--bg-primary) 60%, var(--bg-secondary) 75%, var(--bg-primary) 90%, var(--bg-tertiary) 100%);
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    var(--grid-color) 2px,
                    var(--grid-color) 4px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    var(--grid-color) 2px,
                    var(--grid-color) 4px
                );
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            height: 100vh;
            gap: 0;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.8s ease-in-out, visibility 0.8s;
        }

        .container.ready {
            opacity: 1;
            visibility: visible;
        }

        .container.ready .file-manager {
            animation: slideInLeft 0.8s ease-out 0.2s both;
        }

        .container.ready .main-area {
            animation: slideInUp 0.8s ease-out 0.4s both;
        }

        .container.ready .file-viewers {
            animation: slideInRight 0.8s ease-out 0.6s both;
        }


        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: var(--text-color);
            overflow: hidden;
        }

        .loading-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                var(--grid-color) 2px,
                var(--grid-color) 4px
            );
            animation: scanlines 2s linear infinite;
            pointer-events: none;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 1s ease-out, visibility 1s;
        }

        .loading-title {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 
                0 0 10px var(--secondary-color),
                0 0 20px var(--secondary-color),
                0 0 40px var(--secondary-color);
            animation: bootSequence 3s ease-in-out infinite;
            letter-spacing: 3px;
            text-transform: uppercase;
        }



        @keyframes pixelGlow {
            0% { 
                text-shadow: 
                    2px 2px 0px var(--tertiary-color),
                    4px 4px 0px var(--bg-tertiary),
                    0 0 20px var(--secondary-color),
                    0 0 40px var(--secondary-color);
                transform: scale(1);
            }
            100% { 
                text-shadow: 
                    2px 2px 0px var(--tertiary-color),
                    4px 4px 0px var(--tertiary-color),
                    0 0 30px var(--primary-color),
                    0 0 60px var(--primary-color);
                transform: scale(1.02);
            }
        }

        .retro-computer {
            width: 80px;
            height: 60px;
            border: 3px solid var(--secondary-color);
            border-radius: 4px;
            position: relative;
            margin-bottom: 20px;
            background: var(--bg-primary);
            animation: computerBoot 2s ease-in-out infinite;
        }

        .retro-computer::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 15px;
            background: var(--secondary-color);
            opacity: 0.1;
            animation: screenFlicker 1.5s ease-in-out infinite;
        }

        .retro-computer::after {
            content: '█';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--secondary-color);
            font-size: 16px;
            animation: pixelBlink 1s infinite;
        }

        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: var(--secondary-color);
            margin: 0 3px;
            animation: dotPulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 10px var(--secondary-color);
        }

        .loading-dot:nth-child(1) { animation-delay: 0s; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        .loading-dot:nth-child(4) { animation-delay: 0.6s; }
        .loading-dot:nth-child(5) { animation-delay: 0.8s; }

        .loading-text {
            font-size: 1.2em;
            opacity: 0.8;
            animation: typeWriter 2s steps(20) infinite;
            border-right: 2px solid var(--secondary-color);
            white-space: nowrap;
            overflow: hidden;
            max-width: fit-content;
        }

        .loading-progress {
            margin-top: 20px;
            font-size: 0.9em;
            opacity: 0.6;
            animation: progressFade 1.5s ease-in-out infinite alternate;
        }

        .boot-sequence {
            position: absolute;
            top: 10%;
            left: 10%;
            right: 10%;
            color: var(--secondary-color);
            font-size: 12px;
            animation: bootText 3s ease-in-out;
            opacity: 0.7;
        }

        .progress-bar {
            width: 300px;
            height: 4px;
            background: var(--glow-color);
            border: 1px solid var(--border-color);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--secondary-color) 50%, 
                transparent 100%);
            width: 0%;
            animation: progressLoad 3s ease-in-out infinite;
            box-shadow: 0 0 10px var(--secondary-color);
        }

        @keyframes scanlines {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }

        @keyframes bootSequence {
            0%, 100% { 
                opacity: 1; 
                text-shadow: 
                    0 0 10px var(--secondary-color),
                    0 0 20px var(--secondary-color),
                    0 0 40px var(--secondary-color);
            }
            50% { 
                opacity: 0.7; 
                text-shadow: 
                    0 0 5px var(--secondary-color),
                    0 0 10px var(--secondary-color),
                    0 0 20px var(--secondary-color);
            }
        }

        @keyframes computerBoot {
            0%, 100% { 
                border-color: var(--secondary-color); 
                box-shadow: 0 0 20px var(--glow-color);
            }
            50% { 
                border-color: var(--tertiary-color); 
                box-shadow: 0 0 40px var(--shadow-color);
            }
        }

        @keyframes screenFlicker {
            0%, 100% { opacity: 0.1; }
            50% { opacity: 0.3; }
        }

        @keyframes pixelBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes dotPulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 0.5;
                box-shadow: 0 0 10px var(--secondary-color);
            }
            50% { 
                transform: scale(1.5); 
                opacity: 1;
                box-shadow: 0 0 20px var(--secondary-color);
            }
        }

        @keyframes typeWriter {
            0% { width: 0; }
            50% { width: 100%; }
            100% { width: 0; }
        }

        @keyframes progressFade {
            0% { opacity: 0.4; }
            100% { opacity: 0.8; }
        }

        @keyframes basketballSpin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .loading-screen.theme-lebron {
            background: #ffb3d9 !important;
        }

        .loading-screen.theme-lebron::before {
            display: none;
        }

        .loading-screen.theme-lebron .loading-title {
            color: #000000 !important;
            text-shadow: none !important;
        }

        .loading-screen.theme-lebron .retro-computer {
            width: 180px; /* enlarged for prominence */
            height: 180px;
            border: none;
            background: transparent url("{% static 'auth_app/images/basketball.png' %}") center/70% no-repeat;
            animation: basketballSpin 3s linear infinite;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
        }

        .loading-screen.theme-lebron .retro-computer::before,
        .loading-screen.theme-lebron .retro-computer::after {
            display: none;
        }

        .loading-screen.theme-lebron .loading-dot {
            background: #000000;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .loading-screen.theme-lebron .loading-progress {
            color: #000000 !important;
        }

        @keyframes bootText {
            0% { opacity: 0; transform: translateY(20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        @keyframes progressLoad {
            0% { width: 0%; transform: translateX(-100%); }
            50% { width: 100%; transform: translateX(0%); }
            100% { width: 0%; transform: translateX(100%); }
        }


        @keyframes slideInLeft {
            0% { 
                opacity: 0; 
                transform: translateX(-100px);
            }
            100% { 
                opacity: 1; 
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            0% { 
                opacity: 0; 
                transform: translateX(100px);
            }
            100% { 
                opacity: 1; 
                transform: translateX(0);
            }
        }

        @keyframes slideInUp {
            0% { 
                opacity: 0; 
                transform: translateY(50px);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0);
            }
        }


        @keyframes crtScanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(100%); }
        }

        @keyframes crtGlow {
            0% { 
                opacity: 0.8;
                filter: blur(0.5px);
            }
            100% { 
                opacity: 1;
                filter: blur(0.3px);
            }
        }

        @keyframes terminalBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--secondary-color); }
        }


        @keyframes selectedPulse {
            0%, 100% { 
                box-shadow: 0 0 15px var(--glow-color);
                border-color: var(--secondary-color);
            }
            50% { 
                box-shadow: 0 0 25px var(--shadow-color);
                border-color: var(--tertiary-color);
            }
        }

        .file-manager {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 20%, var(--bg-primary) 40%, var(--bg-tertiary) 60%, var(--bg-primary) 80%, var(--bg-secondary) 100%);
            border-right: 1px solid var(--border-color);
            padding: 10px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) var(--bg-primary);
            position: relative;
            z-index: 2;
            box-shadow: inset 0 0 20px var(--glow-color);
        }

        .file-manager::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 20px,
                var(--grid-color) 20px,
                var(--grid-color) 21px
            );
            pointer-events: none;
            z-index: -1;
        }

        .file-manager h3 {
            color: var(--text-bright);
            margin-bottom: 15px;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            text-shadow: 0 0 10px var(--text-bright);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-manager::-webkit-scrollbar {
            width: 8px;
        }

        .file-manager::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .file-manager::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--secondary-color), var(--tertiary-color));
            border-radius: 4px;
            box-shadow: 0 0 5px var(--glow-color);
        }

        .file-manager::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--tertiary-color), var(--secondary-color));
        }

        .file-list {
            list-style: none;
        }

        .file-item {
            padding: 8px 10px;
            margin: 2px 0;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            color: var(--text-color);
            transition: all 0.3s ease;
            word-break: break-all;
            position: relative;
            border: 1px solid transparent;
        }

        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, 
                var(--glow-color) 0%, 
                var(--shadow-color) 50%, 
                var(--glow-color) 100%);
            transition: width 0.3s ease;
            z-index: -1;
        }

        .file-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
            color: var(--text-bright);
            text-shadow: 0 0 5px var(--text-bright);
            transform: translateX(5px);
        }

        .file-item:hover::before {
            width: 100%;
        }

        .file-item.selected {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
            color: var(--text-bright);
            text-shadow: 0 0 10px var(--text-bright);
            box-shadow: 0 0 15px var(--shadow-color);
            animation: selectedPulse 2s ease-in-out infinite;
        }

        body.theme-lebron .file-item::after {
            /* Remove small per-file icon for cleaner premium aesthetic */
            content: none;
        }

        /* LeBron Theme - Make ALL backgrounds transparent */
        body.theme-lebron .file-manager,
        body.theme-lebron .editor-section,
        body.theme-lebron .terminal-section,
        body.theme-lebron .file-manager::before,
        body.theme-lebron .editor-section::before,
        body.theme-lebron .terminal-section::before,
        body.theme-lebron .container,
        body.theme-lebron section,
        body.theme-lebron .editor-container,
        body.theme-lebron .editor-container::before,
        body.theme-lebron .terminal-container,
        body.theme-lebron .output-container,
        body.theme-lebron .terminal-output,
        body.theme-lebron .file-controls,
        body.theme-lebron .header,
        body.theme-lebron .header-title,
        body.theme-lebron .toolbar {
            background: transparent !important;
            box-shadow: none !important;
        }

        body.theme-lebron .file-manager,
        body.theme-lebron .editor-section,
        body.theme-lebron .terminal-section {
            border-color: rgba(0, 0, 0, 0.3) !important;
        }

        body.theme-lebron .file-button,
        body.theme-lebron .btn,
        body.theme-lebron button {
            background: rgba(255, 255, 255, 0.2) !important;
            color: #000000 !important;
            border-color: #000000 !important;
        }

        body.theme-lebron .file-button:hover,
        body.theme-lebron .btn:hover,
        body.theme-lebron button:hover {
            background: rgba(255, 255, 255, 0.4) !important;
        }

        body.theme-lebron .settings-dropdown {
            background: rgba(255, 255, 255, 0.95) !important;
            border-color: #000000 !important;
        }

        body.theme-lebron .theme-option {
            background: rgba(255, 255, 255, 0.5) !important;
        }

        body.theme-lebron .theme-option:hover,
        body.theme-lebron .theme-option.active {
            background: rgba(255, 255, 255, 0.8) !important;
        }

        .file-controls {
            margin-bottom: 15px;
        }

        .file-input {
            width: 100%;
            padding: 8px;
            background: #222;
            border: 1px solid #333;
            color: #fff;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .file-button {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .file-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--glow-color) 50%,
                transparent 100%);
            transition: left 0.5s ease;
        }

        .file-button:hover {
            background: var(--bg-secondary);
            border-color: var(--text-bright);
            color: var(--text-bright);
            text-shadow: 0 0 10px var(--text-bright);
            box-shadow: 0 0 15px var(--shadow-color);
            transform: translateY(-2px);
        }

        .file-button:hover::before {
            left: 100%;
        }

        .file-button:active {
            transform: translateY(0);
            box-shadow: 0 0 5px var(--shadow-color);
        }

        .main-area {
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 30%, var(--bg-primary) 70%, var(--bg-tertiary) 100%);
        }

        .editor-section {
            flex: 1;
            padding: 0;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .editor-container {
            position: relative;
            height: calc(100% - 50px);
            overflow: hidden;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            box-shadow: inset 0 0 20px var(--glow-color);
        }

        .editor-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 100px,
                rgba(0, 136, 0, 0.02) 100px,
                rgba(0, 136, 0, 0.02) 101px
            );
            pointer-events: none;
            z-index: 1;
        }

        .syntax-highlight-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            padding: 15px;
            margin: 0;
            border: 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: normal;
            font-style: normal;
            line-height: 1.5;
            letter-spacing: 0;
            word-spacing: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: normal;
            overflow-wrap: break-word;
            text-rendering: auto;
            -webkit-font-smoothing: auto;
            -moz-osx-font-smoothing: auto;
            font-variant: normal;
            font-stretch: normal;

            pointer-events: none;
            z-index: 2;
            overflow: auto;
            background: #000;
            color: #fff;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            scrollbar-width: none;
            -ms-overflow-style: none;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
        }

        .syntax-highlight-overlay::-webkit-scrollbar {
            display: none;
        }

        .editor-textarea {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            color: transparent;
            caret-color: var(--secondary-color);
            border: 0;
            margin: 0;
            padding: 15px;

            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: normal;
            font-style: normal;
            line-height: 1.5;
            letter-spacing: 0;
            word-spacing: 0;

            resize: none;
            outline: none;
            tab-size: 4;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: normal;
            overflow-wrap: break-word;
            text-rendering: auto;
            -webkit-font-smoothing: auto;
            -moz-osx-font-smoothing: auto;
            font-variant: normal;
            font-stretch: normal;

            z-index: 3;
            box-sizing: border-box;
            overflow: auto;

            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) #111;
            transition: all 0.3s ease;
        }

        .editor-textarea:focus {
            caret-color: var(--secondary-color);
            filter: drop-shadow(0 0 5px rgba(0, 136, 0, 0.5));
        }

        .editor-textarea::selection {
            background: rgba(0, 136, 0, 0.3);
        }

        .editor-textarea::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .editor-textarea::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
            border: 1px solid #333;
        }

        .editor-textarea::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--secondary-color), var(--tertiary-color));
            border-radius: 6px;
            border: 2px solid #111;
            box-shadow: 0 0 10px var(--shadow-color);
        }

        .editor-textarea::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--tertiary-color), var(--secondary-color));
            box-shadow: 0 0 15px var(--shadow-color);
        }

        .editor-textarea::-webkit-scrollbar-corner {
            background: #111;
        }


        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9998;
            display: none;
            flex-direction: column;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 20px;
            border: 1px solid #333;
            border-radius: 5px;
            overflow: hidden;
        }

        .fullscreen-editor .editor-header {
            background: #111;
            border-bottom: 1px solid #333;
        }

        .fullscreen-editor .editor-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        .fullscreen-editor .editor-textarea,
        .fullscreen-editor .syntax-highlight-overlay {
            height: 100%;
        }

        .editor-header {
            background: #111;
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .editor-header h2 {
            font-size: 14px;
            margin: 0;
        }

        .editor-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Enhanced Focus and Notebook Mode Buttons */
        .focus-button {
            background: linear-gradient(45deg, var(--bg-primary) 0%, var(--secondary-color) 50%, var(--bg-primary) 100%);
            border: 2px solid var(--border-color);
            color: #ffffff;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 10px var(--glow-color);
        }

        .focus-button:hover {
            background: linear-gradient(45deg, var(--secondary-color) 0%, var(--primary-color) 50%, var(--secondary-color) 100%);
            box-shadow: 0 0 15px var(--glow-color);
            transform: translateY(-2px);
        }

        .focus-button:active {
            transform: translateY(0);
            box-shadow: 0 0 10px var(--shadow-color);
        }

        .focus-button.active {
            background: linear-gradient(45deg, var(--primary-color) 0%, var(--text-bright) 50%, var(--primary-color) 100%);
            border-color: var(--primary-color);
            box-shadow: 0 0 15px var(--shadow-color);
        }

        .expand-button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 5px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .expand-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--glow-color) 50%,
                transparent 100%);
            transition: left 0.3s ease;
        }

        .expand-button:hover {
            background: #555;
            border-color: var(--text-bright);
            color: var(--text-bright);
            text-shadow: 0 0 5px var(--text-bright);
            transform: scale(1.1);
        }

        .expand-button:hover::before {
            left: 100%;
        }

        .expand-button:active {
            background: #222;
            transform: scale(0.95);
        }


        .python-keyword { 
            color: #ff6b6b; 
            font-weight: bold; 
            text-shadow: 0 0 5px #ff6b6b;
            transition: all 0.3s ease;
        }
        .python-string { 
            color: #4ecdc4; 
            text-shadow: 0 0 3px #4ecdc4;
        }
        .python-comment { 
            color: #95e1d3; 
            font-style: italic; 
            opacity: 0.8;
            text-shadow: 0 0 2px #95e1d3;
        }
        .python-number { 
            color: #fce38a; 
            text-shadow: 0 0 3px #fce38a;
        }
        .python-function { 
            color: #c7ceea; 
            text-shadow: 0 0 3px #c7ceea;
            transition: all 0.3s ease;
        }
        .python-operator { 
            color: #ff8a80; 
            font-weight: bold;
            text-shadow: 0 0 2px #ff8a80;
        }
        .python-builtin { 
            color: #81c784; 
            cursor: help; 
            pointer-events: auto;
            text-shadow: 0 0 5px #81c784;
            transition: all 0.3s ease;
        }
        .python-builtin:hover {
            color: var(--text-bright);
            text-shadow: 0 0 10px var(--text-bright);
            transform: scale(1.05);
        }
        .python-default { 
            color: #fff; 
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
        }


        .python-tooltip {
            position: absolute;
            background: #2a2a2a;
            border: 1px solid var(--border-color);
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 2px 8px var(--shadow-color);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .python-tooltip.show {
            opacity: 1;
        }

        .python-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 10px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid var(--border-color);
        }

        .terminal-section {
            height: 300px;
            background: #000;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .terminal-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                var(--grid-color) 2px,
                var(--grid-color) 4px
            );
            pointer-events: none;
            z-index: 1;
            animation: crtScanlines 2s linear infinite;
        }

        .terminal-section::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, 
                var(--glow-color) 0%, 
                var(--glow-color) 50%, 
                rgba(0, 0, 0, 0.3) 100%);
            pointer-events: none;
            z-index: 1;
            animation: crtGlow 3s ease-in-out infinite alternate;
        }

        .terminal-header {
            background: #111;
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .terminal-header h2 {
            font-size: 14px;
            margin: 0;
        }

        .execute-button {
            background: linear-gradient(45deg, var(--tertiary-color) 0%, var(--secondary-color) 50%, var(--tertiary-color) 100%);
            border: 1px solid var(--border-color);
            color: #ffffff;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 8px var(--glow-color);
        }

        .execute-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--shadow-color) 50%,
                transparent 100%);
            transition: left 0.4s ease;
        }

        .execute-button:hover {
            background: var(--text-bright);
            color: var(--bg-primary);
            border-color: var(--text-bright);
            text-shadow: none;
            box-shadow: 0 0 20px var(--shadow-color);
            transform: translateY(-2px) scale(1.02);
        }

        .execute-button:hover::before {
            left: 100%;
        }

        .execute-button:active {
            transform: translateY(0) scale(0.98);
        }

        .execute-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .terminal-output {
            flex: 1;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 30%, var(--bg-primary) 70%, var(--bg-tertiary) 100%);
            color: var(--text-color);
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            overflow-y: auto;
            white-space: pre-wrap;
            border: none;
            resize: none;
            outline: none;
            position: relative;
            z-index: 2;
            text-shadow: 0 0 1px var(--text-color);
            scrollbar-width: thin;
            scrollbar-color: var(--text-bright) var(--bg-secondary);
        }


        .terminal-output img {
            display: block;
            margin: 10px 0;
            max-width: 100%;
            height: auto;
            border: 2px solid var(--text-bright);
            border-radius: 8px;
            box-shadow: 0 0 15px var(--shadow-color);
            background: #fff;
            padding: 5px;
        }

        /* Custom scrollbars for all elements */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--secondary-color) 0%, var(--tertiary-color) 50%, var(--secondary-color) 100%);
            border-radius: 5px;
            box-shadow: 0 0 3px var(--secondary-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 50%, var(--primary-color) 100%);
            box-shadow: 0 0 5px var(--secondary-color);
        }

        .terminal-output::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-output::-webkit-scrollbar-track {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
        }

        .terminal-output::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--secondary-color) 0%, var(--tertiary-color) 50%, var(--secondary-color) 100%);
            border-radius: 4px;
            box-shadow: 0 0 3px var(--secondary-color);
        }

        .terminal-output.error {
            color: #ff4444;
            text-shadow: 0 0 5px #ff4444;
        }

        .terminal-cursor::after {
            content: '█';
            animation: terminalBlink 1s infinite;
            color: var(--text-bright);
            text-shadow: 0 0 10px var(--text-bright);
        }

        .terminal-typing {
            overflow: hidden;
            border-right: 2px solid var(--text-bright);
            white-space: nowrap;
            margin: 0 auto;
            animation: 
                typing 2s steps(40, end),
                blink-caret 0.75s step-end infinite;
        }

        .terminal-input-line {
            display: none;
            color: #0f0;
            background: transparent;
            border: none;
            outline: none;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .terminal-prompt {
            color: #0f0;
        }

        .file-viewers {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 20%, var(--bg-primary) 40%, var(--bg-tertiary) 60%, var(--bg-primary) 80%, var(--bg-secondary) 100%);
            border-left: 1px solid var(--border-color);
            padding: 10px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) var(--bg-primary);
            position: relative;
            z-index: 2;
            box-shadow: inset 0 0 20px var(--glow-color);
        }

        .file-viewers::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                -45deg,
                transparent,
                transparent 20px,
                var(--grid-color) 20px,
                var(--grid-color) 21px
            );
            pointer-events: none;
            z-index: -1;
        }

        .file-viewers::-webkit-scrollbar {
            width: 8px;
        }

        .file-viewers::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .file-viewers::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--text-bright), var(--text-color));
            border-radius: 4px;
            box-shadow: 0 0 5px var(--glow-color);
        }

        .file-viewers::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--text-color), var(--text-bright));
        }

        .file-viewer {
            margin-bottom: 20px;
        }

        .file-viewer h3 {
            color: var(--text-bright);
            margin-bottom: 10px;
            font-size: 12px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            text-shadow: 0 0 5px var(--text-bright);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-content {
            background: 
                linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-color);
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.3;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            scrollbar-width: thin;
            scrollbar-color: var(--text-bright) #0a0a0a;
            border-radius: 3px;
            box-shadow: inset 0 0 10px var(--glow-color);
            transition: all 0.3s ease;
        }

        .file-content:hover {
            border-color: var(--text-bright);
            box-shadow: 
                inset 0 0 10px var(--glow-color),
                0 0 15px var(--shadow-color);
        }

        .file-content::-webkit-scrollbar {
            width: 6px;
        }

        .file-content::-webkit-scrollbar-track {
            background: #000000;
            border-radius: 3px;
        }

        .file-content::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--text-bright), var(--primary-color));
            border-radius: 3px;
            box-shadow: 0 0 3px var(--shadow-color);
        }

        .binary-hex {
            color: #888;
            font-size: 10px;
        }

        .status-bar {
            background: 
                linear-gradient(90deg, #111 0%, #0a0a0a 50%, #111 100%);
            padding: 5px 15px;
            border-top: 1px solid #333;
            font-size: 11px;
            color: var(--text-bright);
            text-shadow: 0 0 5px #00ff00;
            position: relative;
            z-index: 2;
        }

        .status-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                #00ff00 50%, 
                transparent 100%);
            animation: statusGlow 3s ease-in-out infinite;
        }

        @keyframes statusGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animated {
            animation: fadeIn 0.3s ease-out;
        }

        .success {
            color: #0f0;
        }

        .error {
            color: #f44;
        }

        .focus-mode .background-blur {
            filter: blur(5px);
            transition: all 0.3s ease;
        }

        .focus-mode .editor-section {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 95%;
            height: 85%;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
        }

        .focus-mode .editor-section textarea {
            height: calc(100% - 100px);
        }

        .focus-mode::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }


        .notebook-mode .main-area {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .notebook-container {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background: #000000;
        }

        .notebook-mode .notebook-container {
            display: flex;
        }

        .notebook-mode .editor-section {
            display: none;
        }

        .notebook-mode .terminal-section {
            display: none;
        }

        .notebook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 136, 0, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        .notebook-title {
            color: var(--text-bright);
            font-size: 1.4em;
            font-weight: bold;
        }

        .notebook-controls {
            display: flex;
            gap: 10px;
        }

        .nb-btn {
            background: var(--glow-color);
            border: 1px solid var(--border-color);
            color: var(--text-bright);
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            transition: all 0.2s;
        }

        .nb-btn:hover {
            background: var(--shadow-color);
            box-shadow: 0 0 10px var(--shadow-color);
        }

        .notebook-cell {
            margin-bottom: 15px;
            border: 1px solid #333;
            border-radius: 5px;
            background: var(--bg-secondary);
            overflow: hidden;
            transition: all 0.3s;
        }

        .notebook-cell.selected {
            border-color: var(--secondary-color);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
        }

        /* Custom Ace Editor Green-on-Black Theme Override */
        .ace_editor {
            background-color: #000000 !important;
            color: var(--text-color) !important;
        }

        body.theme-cloud .ace_editor {
            background-color: #ffffff !important;
            color: #000000 !important;
        }

        .ace_gutter {
            background-color: #050505 !important;
            color: var(--secondary-color) !important;
            border-right: 1px solid var(--tertiary-color) !important;
        }

        body.theme-cloud .ace_gutter {
            background-color: #f5f5f5 !important;
            color: #2c3e50 !important;
            border-right: 1px solid #cccccc !important;
        }

        .ace_gutter-active-line {
            background-color: #0a0a0a !important;
        }

        body.theme-cloud .ace_gutter-active-line {
            background-color: #e8e8e8 !important;
        }

        .ace_marker-layer .ace_active-line {
            background-color: #080808 !important;
        }

        body.theme-cloud .ace_marker-layer .ace_active-line {
            background-color: #f0f0f0 !important;
        }

        body.theme-lebron .ace_editor {
            background-color: transparent !important;
            color: #000000 !important;
        }

        body.theme-lebron .ace_gutter {
            background-color: rgba(255, 255, 255, 0.3) !important;
            color: #000000 !important;
            border-right: 1px solid #000000 !important;
        }

        body.theme-lebron .ace_gutter-active-line {
            background-color: rgba(255, 255, 255, 0.5) !important;
        }

        body.theme-lebron .ace_marker-layer .ace_active-line {
            background-color: rgba(255, 255, 255, 0.2) !important;
        }

        body.theme-lebron .ace_cursor {
            color: #000000 !important;
            border-left: 2px solid #000000 !important;
        }

        body.theme-lebron .ace_selection {
            background-color: rgba(0, 0, 0, 0.2) !important;
        }

        body.theme-lebron .ace_keyword,
        body.theme-lebron .ace_string,
        body.theme-lebron .ace_comment,
        body.theme-lebron .ace_function,
        body.theme-lebron .ace_variable,
        body.theme-lebron .ace_constant,
        body.theme-lebron .ace_support {
            color: #000000 !important;
        }

        .ace_cursor {
            color: var(--text-bright) !important;
            border-left: 2px solid var(--text-bright) !important;
        }

        .ace_selection {
            background-color: var(--glow-color) !important;
        }

        .ace_keyword {
            color: var(--text-bright) !important;
            font-weight: bold !important;
        }

        .ace_string {
            color: var(--text-color) !important;
        }

        .ace_comment {
            color: var(--tertiary-color) !important;
            font-style: italic !important;
        }

        .ace_function {
            color: var(--text-bright) !important;
        }

        .ace_variable {
            color: var(--secondary-color) !important;
        }

        .ace_constant.ace_numeric {
            color: var(--primary-color) !important;
        }

        .ace_scrollbar {
            background-color: #000000 !important;
        }

        .ace_scrollbar-h {
            background-color: #000000 !important;
        }

        .ace_scrollbar-v {
            background-color: #000000 !important;
        }

        .cell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .cell-type {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
        }

        .cell-controls {
            display: flex;
            gap: 5px;
        }

        .cell-btn {
            background: linear-gradient(45deg, #000000 0%, #0a0a0a 50%, #000000 100%);
            border: 1px solid #006600;
            color: var(--text-color);
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 136, 0, 0.1);
            min-width: 30px;
            text-align: center;
        }

        .cell-btn:hover {
            background: linear-gradient(45deg, #0a0a0a 0%, #008800 50%, #0a0a0a 100%);
            color: #ffffff;
            box-shadow: 0 0 10px rgba(0, 136, 0, 0.2);
            transform: translateY(-1px);
        }

        .cell-btn:active {
            transform: translateY(0);
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.2);
        }

        .cell-input {
            position: relative;
        }

        .cell-textarea {
            width: 100%;
            min-height: 80px;
            background: var(--bg-primary);
            border: none;
            color: var(--text-bright);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 12px;
            resize: vertical;
            outline: none;
            line-height: 1.4;
        }

        .cell-textarea::placeholder {
            color: #444;
        }

        .markdown-cell .cell-textarea {
            color: #ccc;
        }

        .cell-output {
            border-top: 1px solid #333;
            background: var(--bg-secondary);
            padding: 12px;
            color: var(--text-color);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            min-height: 30px;
            white-space: pre-wrap;
            display: none;
        }

        .cell-output.has-output {
            display: block;
        }

        .cell-execution-count {
            color: #666;
            font-size: 11px;
            margin-right: 8px;
        }

        .add-cell-btn {
            width: 100%;
            padding: 15px;
            background: rgba(0, 136, 0, 0.1);
            border: 2px dashed #333;
            color: #666;
            cursor: pointer;
            border-radius: 5px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .add-cell-btn:hover {
            border-color: var(--secondary-color);
            color: var(--text-bright);
            background: rgba(0, 136, 0, 0.2);
        }

        .notebook-stats {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            color: #888;
            font-size: 11px;
        }

        /* Package Installer Widget */
        .package-installer {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 280px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            z-index: 1000;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            backdrop-filter: blur(10px);
        }

        .package-installer.collapsed {
            height: 45px;
            overflow: hidden;
        }

        .package-installer.expanded {
            height: auto;
            max-height: 300px;
        }

        .package-installer-header {
            padding: 12px 15px;
            background: linear-gradient(135deg, var(--secondary-color), var(--tertiary-color));
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px 6px 0 0;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .package-installer-toggle {
            color: var(--text-bright);
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        .package-installer.expanded .package-installer-toggle {
            transform: rotate(180deg);
        }

        .package-installer-body {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 0 0 6px 6px;
        }

        .package-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .package-input {
            flex: 1;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 11px;
            font-family: 'Courier New', monospace;
            transition: all 0.2s ease;
        }

        .package-input:focus {
            outline: none;
            border-color: var(--text-bright);
            box-shadow: 0 0 8px var(--glow-color);
        }

        .package-install-btn {
            padding: 8px 12px;
            background: linear-gradient(135deg, var(--secondary-color), var(--tertiary-color));
            border: none;
            border-radius: 4px;
            color: var(--text-bright);
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }

        .package-install-btn:hover {
            background: linear-gradient(135deg, var(--tertiary-color), var(--secondary-color));
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .package-install-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .package-status {
            min-height: 60px;
            max-height: 120px;
            overflow-y: auto;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            font-size: 10px;
            line-height: 1.4;
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }

        .package-status::-webkit-scrollbar {
            width: 4px;
        }

        .package-status::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        .package-status::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .status-success {
            color: var(--text-bright);
        }

        .status-error {
            color: #ff6b6b;
        }

        .status-info {
            color: var(--text-secondary);
        }

        .quick-packages {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .quick-package-btn {
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 9px;
            transition: all 0.2s ease;
        }

        .quick-package-btn:hover {
            background: var(--secondary-color);
            color: var(--text-bright);
        }

        /* Theme-specific adjustments */
        body.theme-cloud .package-installer {
            background: #ffffff;
            color: #000000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        body.theme-cloud .package-installer-body {
            background: #f5f5f5;
        }

        body.theme-cloud .package-status {
            background: #ffffff;
        }

        body.theme-lebron .package-installer {
            background: url('{% static "auth_app/images/lebron.jpg" %}') center/cover;
            background-blend-mode: overlay;
            background-color: rgba(139, 38, 53, 0.9);
        }
    </style>
</head>
<body class="{% if user_theme == 'greydom' %}theme-greydom{% elif user_theme == 'cloud' %}theme-cloud{% elif user_theme == 'chaos' %}theme-chaos{% elif user_theme == 'lebron' %}theme-lebron{% endif %}">
    
    <div class="loading-screen {% if user_theme == 'lebron' %}theme-lebron{% endif %}" id="loading-screen">
        <div class="boot-sequence">
            > INITIALIZING PYTHON TERMINAL v3.11.4<br>
            > Loading Python Environment...<br>
            > SETTING UP VIRTUAL FILE SYSTEM...<br>
            > CONFIGURING SECURITY RESTRICTIONS...<br>
        </div>
        
        <div class="loading-title">PYTHON TERMINAL</div>
        
        <div class="retro-computer"></div>
        
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
        
        <div class="loading-text" id="loading-text">INITIALIZING ENVIRONMENT</div>
        
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
        
        <div class="loading-progress" id="loading-progress">Loading Pyodide WebAssembly</div>
    </div>

    <div class="container" id="main-container">
        
        <div class="file-manager">
            <h3>Client-Side Script Manager</h3>
            
            <div class="file-controls">
                <input type="text" id="filename-input" class="file-input" placeholder="script_name" maxlength="50">
                <button onclick="saveScript()" class="file-button">Save Script to Browser</button>
                <button onclick="deleteScript()" class="file-button">Delete Script</button>
                <button onclick="newScript()" class="file-button">New Script</button>
            </div>

            <ul class="file-list" id="file-list">
                
            </ul>
            
            <div style="margin-top: 20px; padding: 10px; background: #222; border-radius: 3px; font-size: 11px;">
                <strong>File Access Rules:</strong><br>
                • Only text.txt, tester.csv, binary.dat can be accessed<br>
                • All scripts run in browser (client-side)<br>
                • Scripts saved to browser storage only
            </div>
        </div>

        
        <div class="main-area">
            
            <div class="editor-section">
                <div class="editor-header">
                    <h2>Python Code Editor (Client-Side)</h2>
                    <div class="editor-controls">
                        <span id="current-file">untitled_script</span>
                        <button id="notebook-btn" class="focus-button" onclick="toggleNotebookMode()" title="Jupyter-style Notebook Mode">NOTEBOOK</button>
                        <button id="focus-btn" class="focus-button" onclick="toggleFocusMode()" title="Focus Mode">FOCUS</button>
                    </div>
                </div>
                <div class="editor-container">
                    <div id="ace-editor" style="width: 100%; height: 100%; font-size: 14px;"></div>
                    <textarea id="code_content" style="display: none;">{{ code_content }}</textarea>
                </div>
            </div>

            
            <div class="terminal-section">
                <div class="terminal-header">
                    <h2>Python Terminal (Client-Side)</h2>
                    <button onclick="executeCode()" class="execute-button" id="run-btn">Run Code (Ctrl+Enter)</button>
                    <button onclick="clearTerminal()" class="execute-button">Clear Terminal</button>
                </div>
                <div class="terminal-output" id="terminal-output">
                    Initializing Python environment...<br>
                    Python terminal ready! Your code will run in the browser.
                    <div id="input-container" style="display: none;">
                        <span class="terminal-prompt" id="input-prompt"></span>
                        <input type="text" id="terminal-input" class="terminal-input-line">
                    </div>
                </div>
            </div>

            
            <div class="notebook-container" id="notebook-container">
                <div class="notebook-header">
                    <div class="notebook-title">Python Notebook (Jupyter-style)</div>
                    <div class="notebook-controls">
                        <button class="nb-btn" onclick="toggleNotebookMode()">← Back to Editor</button>
                        <button class="nb-btn" onclick="addNotebookCell('code')">+ Code</button>
                        <button class="nb-btn" onclick="addNotebookCell('markdown')">+ Markdown</button>
                        <button class="nb-btn" onclick="runAllCells()">Run All</button>
                        <button class="nb-btn" onclick="clearAllOutputs()">Clear Outputs</button>
                        <button class="nb-btn" onclick="showKeyboardShortcuts()">Shortcuts</button>
                        <button class="nb-btn" onclick="exportNotebook()">Export</button>
                    </div>
                </div>
                
                <div class="notebook-toolbar" style="padding: 10px; background: rgba(0, 136, 0, 0.05); border-radius: 5px; margin-bottom: 15px; font-size: 12px; color: #888;">
                    <strong>Quick Tips:</strong> 
                    <code>Shift+Enter</code> = Run & Next | 
                    <code>Ctrl+Enter</code> = Run | 
                    <code>Alt+Enter</code> = Run & Add Cell | 
                    <code>Tab</code> = Auto-complete | 
                    Auto-save enabled
                </div>
                
                <div id="notebook-cells">
                    
                    <div class="notebook-cell code-cell" data-cell-id="1" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [1]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea" placeholder="# Welcome to Notebook Mode!
# This is a Jupyter-style notebook interface
# Press Shift+Enter to run a cell

import matplotlib.pyplot as plt
import numpy as np

# Create a simple plot
x = np.linspace(0, 10, 100)
y = np.sin(x)

plt.figure(figsize=(8, 4))
plt.plot(x, y, 'b-', linewidth=2)
plt.title('Sine Wave')
plt.xlabel('x')
plt.ylabel('sin(x)')
plt.grid(True, alpha=0.3)
plt.show()">import matplotlib.pyplot as plt
import numpy as np
import sys

print("Python Notebook Mode Active")
print(f"Available: NumPy, Matplotlib, Pandas, SciPy, Scikit-learn, SymPy, NetworkX, Seaborn")
print(f"Python {'.'.join(map(str, sys.version_info[:3]))} running in WebAssembly")

x = np.linspace(0, 4*np.pi, 200)
y1 = np.sin(x) 
y2 = np.cos(x)

plt.figure(figsize=(10, 6))
plt.plot(x, y1, 'b-', linewidth=2, label='sin(x)', alpha=0.8)
plt.plot(x, y2, 'r--', linewidth=2, label='cos(x)', alpha=0.8)
plt.fill_between(x, y1, alpha=0.2, color='blue')
plt.title('Trigonometric Functions Visualization', fontsize=14, fontweight='bold')
plt.xlabel('x (radians)')
plt.ylabel('f(x)')
plt.legend()
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()</textarea>
                        </div>
                        <div class="cell-output" id="output-1"></div>
                    </div>

                    
                    <div class="notebook-cell code-cell" data-cell-id="2" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [2]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

np.random.seed(42)
dates = pd.date_range('2024-01-01', periods=100)
data = {
    'date': dates,
    'temperature': 20 + 10 * np.sin(np.arange(100) * 2 * np.pi / 365) + np.random.normal(0, 2, 100),
    'humidity': 50 + 20 * np.cos(np.arange(100) * 2 * np.pi / 365) + np.random.normal(0, 5, 100),
    'sales': np.random.poisson(50, 100) + np.arange(100) * 0.5
}

df = pd.DataFrame(data)
print("Sample Dataset:")
print(df.head())
print(f"\nDataset info: {len(df)} rows, {len(df.columns)} columns")
print(f"Statistics:\n{df.describe().round(2)}")

fig, axes = plt.subplots(2, 2, figsize=(12, 8))
fig.suptitle('Multi-Variable Analysis Dashboard', fontsize=16)

axes[0,0].plot(df.index, df['temperature'], 'tab:orange', alpha=0.7)
axes[0,0].set_title('Temperature Trend')
axes[0,0].set_ylabel('°C')
axes[0,0].grid(True, alpha=0.3)

scatter = axes[0,1].scatter(df['temperature'], df['humidity'], 
                           c=df['sales'], cmap='viridis', alpha=0.6)
axes[0,1].set_title('Humidity vs Temperature')
axes[0,1].set_xlabel('Temperature (°C)')
axes[0,1].set_ylabel('Humidity (%)')
plt.colorbar(scatter, ax=axes[0,1], label='Sales')

axes[1,0].hist(df['sales'], bins=20, color='skyblue', alpha=0.7, edgecolor='black')
axes[1,0].set_title('Sales Distribution')
axes[1,0].set_xlabel('Sales Count')
axes[1,0].set_ylabel('Frequency')

corr_data = df[['temperature', 'humidity', 'sales']].corr()
im = axes[1,1].imshow(corr_data, cmap='coolwarm', aspect='auto')
axes[1,1].set_title('Correlation Matrix')
axes[1,1].set_xticks(range(len(corr_data.columns)))
axes[1,1].set_yticks(range(len(corr_data.columns)))
axes[1,1].set_xticklabels(corr_data.columns, rotation=45)
axes[1,1].set_yticklabels(corr_data.columns)

plt.tight_layout()
plt.show()</textarea>
                        </div>
                        <div class="cell-output" id="output-2"></div>
                    </div>

                    
                    <div class="notebook-cell code-cell" data-cell-id="3" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [3]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">from sklearn.datasets import make_classification
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report, confusion_matrix
import numpy as np
import matplotlib.pyplot as plt

print("Creating ML Classification Example...")

X, y = make_classification(n_samples=1000, n_features=4, n_informative=3, 
                          n_redundant=1, n_clusters_per_class=1, random_state=42)

feature_names = ['Feature_A', 'Feature_B', 'Feature_C', 'Feature_D']

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42)

print(f"Dataset: {X.shape[0]} samples, {X.shape[1]} features")
print(f"Training set: {X_train.shape[0]} samples")
print(f"Test set: {X_test.shape[0]} samples")

rf_model = RandomForestClassifier(n_estimators=100, random_state=42)
rf_model.fit(X_train, y_train)

y_pred = rf_model.predict(X_test)

accuracy = (y_pred == y_test).mean()
print(f"\nModel Accuracy: {accuracy:.3f}")

plt.figure(figsize=(10, 6))

plt.subplot(1, 2, 1)
importance = rf_model.feature_importances_
indices = np.argsort(importance)[::-1]
plt.title('Feature Importance')
plt.bar(range(len(importance)), importance[indices], color='lightcoral', alpha=0.8)
plt.xticks(range(len(importance)), [feature_names[i] for i in indices], rotation=45)
plt.ylabel('Importance Score')

plt.subplot(1, 2, 2)
cm = confusion_matrix(y_test, y_pred)
plt.imshow(cm, interpolation='nearest', cmap='Blues')
plt.title('Confusion Matrix')
plt.colorbar()
plt.xlabel('Predicted Label')
plt.ylabel('True Label')

thresh = cm.max() / 2.
for i, j in np.ndindex(cm.shape):
    plt.text(j, i, format(cm[i, j], 'd'),
             ha="center", va="center",
             color="white" if cm[i, j] > thresh else "black")

plt.tight_layout()
plt.show()

print(f"\nClassification Report:")
print(classification_report(y_test, y_pred))</textarea>
                        </div>
                        <div class="cell-output" id="output-3"></div>
                    </div>

                    
                    <div class="notebook-cell markdown-cell" data-cell-id="4" data-cell-type="markdown">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count"></span>
                                Markdown Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">C</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea"># 📚 Python Notebook Features

This notebook demonstrates the **full power** of Python in the browser using Pyodide! 

##Key Features

- **Jupyter-style Interface**: Familiar cell-based editing
- **Full Python 3.11**: Complete Python environment in your browser
- **Rich Libraries**: NumPy, Pandas, Matplotlib, SciPy, Scikit-learn
- **Interactive Plotting**: Visualizations with Matplotlib
- **Data Science Ready**: Perfect for analysis and machine learning
- **No Installation**: Everything runs client-side in WebAssembly

##Getting Started

1. **Code Cells**: Write and execute Python code
2. **Markdown Cells**: Add formatted documentation (like this!)
3. **Keyboard Shortcuts**: `Shift+Enter` to run cells
4. **Cell Management**: Add, delete, move, and convert cells
5. **Export**: Save your work as a `.ipynb` file

##Tips

- Use `plt.show()` to display plots
- All computations happen in your browser
- Your work is automatically saved in browser storage

```python
# Quick example - try this in a code cell:
import this  # The Zen of Python
```

Happy coding! 🐍✨</textarea>
                        </div>
                        <div class="cell-output" id="output-4"></div>
                    </div>

                    <div class="notebook-cell code-cell" data-cell-id="5" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [5]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">import sympy as sp
import numpy as np
import matplotlib.pyplot as plt

print("Symbolic Mathematics with SymPy")

x, y, z = sp.symbols('x y z')
t = sp.Symbol('t', real=True)

f1 = x**3 - 3*x**2 + 2*x - 1
f2 = sp.sin(x) * sp.exp(-x/2)
f3 = sp.sqrt(x**2 + y**2)

print(f"Function 1: {f1}")
print(f"Derivative: {sp.diff(f1, x)}")
print(f"Integral: {sp.integrate(f1, x)}")

print(f"\nFunction 2: {f2}")
print(f"Derivative: {sp.diff(f2, x)}")
print(f"Limit as x->0: {sp.limit(f2, x, 0)}")

eq1 = sp.Eq(x**2 + y**2, 25)
eq2 = sp.Eq(x - y, 1)
solutions = sp.solve([eq1, eq2], [x, y])
print(f"\nSolving system: {eq1}, {eq2}")
print(f"Solutions: {solutions}")

expr = sp.expand((x + y)**4)
print(f"\nExpanded (x+y)^4: {expr}")

factored = sp.factor(x**4 - 1)
print(f"Factored x^4-1: {factored}")

x_vals = np.linspace(-2, 4, 1000)
f1_func = sp.lambdify(x, f1, 'numpy')
f1_derivative = sp.lambdify(x, sp.diff(f1, x), 'numpy')

plt.figure(figsize=(12, 4))

plt.subplot(1, 3, 1)
plt.plot(x_vals, f1_func(x_vals), 'b-', linewidth=2, label=f'f(x) = {f1}')
plt.plot(x_vals, f1_derivative(x_vals), 'r--', linewidth=2, label="f'(x)")
plt.axhline(y=0, color='k', linestyle='-', alpha=0.3)
plt.axvline(x=0, color='k', linestyle='-', alpha=0.3)
plt.grid(True, alpha=0.3)
plt.legend()
plt.title('Function and Derivative')

plt.subplot(1, 3, 2)
x_vals2 = np.linspace(0, 10, 1000)
f2_func = sp.lambdify(x, f2, 'numpy')
plt.plot(x_vals2, f2_func(x_vals2), 'g-', linewidth=2)
plt.title('sin(x) * exp(-x/2)')
plt.grid(True, alpha=0.3)

plt.subplot(1, 3, 3)
x_mesh = np.linspace(-5, 5, 50)
y_mesh = np.linspace(-5, 5, 50)
X, Y = np.meshgrid(x_mesh, y_mesh)
Z = np.sqrt(X**2 + Y**2)
contour = plt.contour(X, Y, Z, levels=20)
plt.colorbar(contour)
plt.title('sqrt(x² + y²)')

plt.tight_layout()
plt.show()</textarea>
                        </div>
                        <div class="cell-output" id="output-5"></div>
                    </div>

                    <div class="notebook-cell code-cell" data-cell-id="6" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [6]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">import networkx as nx
import matplotlib.pyplot as plt
import numpy as np
from faker import Faker

print("Network Analysis with NetworkX")

fake = Faker()
Faker.seed(42)

G = nx.Graph()

nodes = [fake.name() for _ in range(15)]
G.add_nodes_from(nodes)

edges = []
for i in range(len(nodes)):
    for j in range(i+1, len(nodes)):
        if np.random.random() < 0.3:
            weight = np.random.randint(1, 10)
            edges.append((nodes[i], nodes[j], {'weight': weight}))

G.add_edges_from(edges)

print(f"Network created with {G.number_of_nodes()} nodes and {G.number_of_edges()} edges")

centrality_measures = {
    'degree': nx.degree_centrality(G),
    'betweenness': nx.betweenness_centrality(G),
    'closeness': nx.closeness_centrality(G),
    'eigenvector': nx.eigenvector_centrality(G)
}

top_nodes = {}
for measure, values in centrality_measures.items():
    top_node = max(values, key=values.get)
    top_nodes[measure] = (top_node, values[top_node])
    print(f"Highest {measure} centrality: {top_node[:15]}... ({values[top_node]:.3f})")

plt.figure(figsize=(15, 10))

layouts = {
    'spring': nx.spring_layout(G, seed=42),
    'circular': nx.circular_layout(G),
    'kamada_kawai': nx.kamada_kawai_layout(G),
    'random': nx.random_layout(G, seed=42)
}

for i, (layout_name, pos) in enumerate(layouts.items(), 1):
    plt.subplot(2, 2, i)
    
    if layout_name == 'spring':
        node_colors = [centrality_measures['betweenness'][node] for node in G.nodes()]
        nodes = nx.draw_networkx_nodes(G, pos, node_color=node_colors, 
                                     cmap=plt.cm.viridis, node_size=300, alpha=0.8)
        plt.colorbar(nodes, shrink=0.8, label='Betweenness Centrality')
    else:
        nx.draw_networkx_nodes(G, pos, node_color='lightblue', 
                             node_size=300, alpha=0.8)
    
    nx.draw_networkx_edges(G, pos, alpha=0.5, edge_color='gray')
    
    if layout_name in ['spring', 'kamada_kawai']:
        labels = {node: node.split()[0] for node in G.nodes()}
        nx.draw_networkx_labels(G, pos, labels, font_size=8)
    
    plt.title(f'{layout_name.replace("_", " ").title()} Layout')
    plt.axis('off')

plt.tight_layout()
plt.show()

if nx.is_connected(G):
    diameter = nx.diameter(G)
    avg_path_length = nx.average_shortest_path_length(G)
    print(f"\nNetwork diameter: {diameter}")
    print(f"Average path length: {avg_path_length:.3f}")
else:
    components = list(nx.connected_components(G))
    print(f"\nNetwork has {len(components)} connected components")

clustering_coeff = nx.average_clustering(G)
print(f"Average clustering coefficient: {clustering_coeff:.3f}")

print(f"Network density: {nx.density(G):.3f}")</textarea>
                        </div>
                        <div class="cell-output" id="output-6"></div>
                    </div>

                    <div class="notebook-cell code-cell" data-cell-id="7" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [7]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">import seaborn as sns
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats

print("Advanced Statistical Analysis with Seaborn")

np.random.seed(42)

data = {
    'category': np.random.choice(['A', 'B', 'C', 'D'], 500),
    'value1': np.random.normal(100, 15, 500),
    'value2': np.random.exponential(2, 500),
    'group': np.random.choice(['Group1', 'Group2', 'Group3'], 500),
    'binary': np.random.choice([0, 1], 500)
}

for i, cat in enumerate(['A', 'B', 'C', 'D']):
    mask = np.array(data['category']) == cat
    data['value1'] = np.where(mask, data['value1'] + i*10, data['value1'])

df = pd.DataFrame(data)

print("Dataset Overview:")
print(df.describe())
print(f"\nData shape: {df.shape}")
print(f"Categories: {df['category'].value_counts().to_dict()}")

plt.figure(figsize=(16, 12))

plt.subplot(2, 3, 1)
sns.histplot(data=df, x='value1', hue='category', alpha=0.7, bins=30)
plt.title('Distribution by Category')

plt.subplot(2, 3, 2)
sns.boxplot(data=df, x='category', y='value1')
plt.title('Value1 by Category')

plt.subplot(2, 3, 3)
sns.violinplot(data=df, x='group', y='value2', inner='box')
plt.title('Value2 Distribution by Group')

plt.subplot(2, 3, 4)
correlation_matrix = df.select_dtypes(include=[np.number]).corr()
sns.heatmap(correlation_matrix, annot=True, cmap='coolwarm', center=0)
plt.title('Correlation Matrix')

plt.subplot(2, 3, 5)
sns.scatterplot(data=df, x='value1', y='value2', hue='category', size='binary', alpha=0.7)
plt.title('Value1 vs Value2')

plt.subplot(2, 3, 6)
pivot_table = df.pivot_table(values='value1', index='category', columns='group', aggfunc='mean')
sns.heatmap(pivot_table, annot=True, fmt='.1f', cmap='viridis')
plt.title('Mean Value1 by Category & Group')

plt.tight_layout()
plt.show()

print("\nStatistical Tests:")

for cat in df['category'].unique():
    cat_data = df[df['category'] == cat]['value1']
    stat, p_value = stats.normaltest(cat_data)
    print(f"Category {cat} normality test: p-value = {p_value:.4f}")

f_stat, p_value = stats.f_oneway(*[df[df['category'] == cat]['value1'] for cat in df['category'].unique()])
print(f"\nANOVA test (value1 by category): F = {f_stat:.3f}, p = {p_value:.4f}")

correlation, p_value = stats.pearsonr(df['value1'], df['value2'])
print(f"Correlation (value1 vs value2): r = {correlation:.3f}, p = {p_value:.4f}")

from scipy.stats import chi2_contingency
contingency = pd.crosstab(df['category'], df['group'])
chi2, p_value, dof, expected = chi2_contingency(contingency)
print(f"Chi-square test (category vs group): χ² = {chi2:.3f}, p = {p_value:.4f}")

print(f"\nContingency Table:")
print(contingency)</textarea>
                        </div>
                        <div class="cell-output" id="output-7"></div>
                    </div>

                    <div class="notebook-cell code-cell" data-cell-id="8" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [8]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">from wordcloud import WordCloud
import matplotlib.pyplot as plt
import numpy as np
from PIL import Image
import re

print("Text Analysis and Word Cloud Generation")

sample_text = """
Python is a high-level, general-purpose programming language. Its design philosophy emphasizes 
code readability with the use of significant indentation. Python is dynamically-typed and 
garbage-collected. It supports multiple programming paradigms, including structured, 
object-oriented and functional programming. Python is often described as a batteries included 
language due to its comprehensive standard library. Data science machine learning artificial 
intelligence web development automation scripting scientific computing numpy pandas matplotlib 
sklearn tensorflow pytorch django flask jupyter notebook anaconda scipy seaborn plotly 
algorithms data structures statistics mathematics linear algebra calculus probability 
computer science software engineering programming python developer coding development 
analysis visualization dashboard interactive plotting scientific research academic industry 
business analytics big data processing visualization dashboard creation reporting tools 
automated testing continuous integration deployment cloud computing databases SQL NoSQL 
web scraping API development REST microservices containerization docker kubernetes 
version control git github gitlab collaboration open source community documentation 
debugging optimization performance profiling memory management concurrency parallel processing 
"""

print("Processing text...")
text = re.sub(r'[^a-zA-Z\s]', '', sample_text.lower())
words = text.split()
word_freq = {}
for word in words:
    if len(word) > 3:
        word_freq[word] = word_freq.get(word, 0) + 1

top_words = dict(sorted(word_freq.items(), key=lambda x: x[1], reverse=True)[:20])
print("Top 20 words by frequency:")
for word, freq in top_words.items():
    print(f"{word}: {freq}")

plt.figure(figsize=(15, 10))

plt.subplot(2, 2, 1)
wordcloud_basic = WordCloud(width=400, height=300, background_color='white', 
                           colormap='viridis', max_words=100).generate(sample_text)
plt.imshow(wordcloud_basic, interpolation='bilinear')
plt.title('Basic Word Cloud')
plt.axis('off')

plt.subplot(2, 2, 2)
wordcloud_freq = WordCloud(width=400, height=300, background_color='black', 
                          colormap='plasma', max_words=80, 
                          relative_scaling=0.5, min_font_size=8).generate_from_frequencies(word_freq)
plt.imshow(wordcloud_freq, interpolation='bilinear')
plt.title('Frequency-based Word Cloud')
plt.axis('off')

plt.subplot(2, 2, 3)
words_list = list(top_words.keys())
freqs_list = list(top_words.values())
colors = plt.cm.Set3(np.linspace(0, 1, len(words_list)))
bars = plt.bar(range(len(words_list)), freqs_list, color=colors)
plt.xticks(range(len(words_list)), words_list, rotation=45, ha='right')
plt.title('Word Frequency Distribution')
plt.ylabel('Frequency')

for i, (bar, freq) in enumerate(zip(bars, freqs_list)):
    plt.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.1, 
             str(freq), ha='center', va='bottom', fontsize=8)

plt.subplot(2, 2, 4)
wordcloud_custom = WordCloud(width=400, height=300, background_color='navy', 
                            colormap='cool', max_words=60, 
                            prefer_horizontal=0.9, max_font_size=40).generate(sample_text)
plt.imshow(wordcloud_custom, interpolation='bilinear')
plt.title('Custom Styled Word Cloud')
plt.axis('off')

plt.tight_layout()
plt.show()

print(f"\nText Statistics:")
print(f"Total characters: {len(sample_text)}")
print(f"Total words: {len(words)}")
print(f"Unique words: {len(word_freq)}")
print(f"Average word length: {np.mean([len(w) for w in words]):.2f}")
print(f"Most frequent word: '{max(word_freq, key=word_freq.get)}' ({max(word_freq.values())} times)")

word_lengths = [len(w) for w in words if len(w) > 0]
print(f"Word length distribution:")
print(f"  Min: {min(word_lengths)}")
print(f"  Max: {max(word_lengths)}")  
print(f"  Median: {np.median(word_lengths)}")
print(f"  Standard deviation: {np.std(word_lengths):.2f}")</textarea>
                        </div>
                        <div class="cell-output" id="output-8"></div>
                    </div>

                    
                    <div class="notebook-cell code-cell" data-cell-id="9" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [9]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea"># 🎮 Interactive Input Demo
# This demonstrates the new input() pausing functionality!

print("🚀 Interactive Input Demo")
print("=" * 40)

# Basic input example
name = input("What's your name? ")
print(f"Hello, {name}! Nice to meet you! 👋")

# Numeric input with validation
while True:
    try:
        age_input = input("How old are you? ")
        age = int(age_input)
        if age > 0:
            break
        else:
            print("Please enter a positive number!")
    except ValueError:
        print("Please enter a valid number!")

print(f"Wow, you're {age} years old!")

# Interactive calculation
print("\n🧮 Let's do some math!")
try:
    num1 = float(input("Enter first number: "))
    operator = input("Enter operator (+, -, *, /): ").strip()
    num2 = float(input("Enter second number: "))
    
    if operator == '+':
        result = num1 + num2
    elif operator == '-':
        result = num1 - num2
    elif operator == '*':
        result = num1 * num2
    elif operator == '/':
        if num2 != 0:
            result = num1 / num2
        else:
            result = "Error: Division by zero!"
    else:
        result = "Error: Invalid operator!"
    
    print(f"\n📊 Result: {num1} {operator} {num2} = {result}")
    
except ValueError:
    print("Error: Invalid number input!")

# Fun personality test
print(f"\n🎯 Quick personality test, {name}!")
color = input("What's your favorite color? ").lower().strip()

color_meanings = {
    'blue': 'calm and trustworthy',
    'red': 'passionate and energetic', 
    'green': 'natural and harmonious',
    'yellow': 'optimistic and creative',
    'purple': 'mysterious and imaginative',
    'orange': 'enthusiastic and friendly',
    'black': 'sophisticated and strong',
    'white': 'pure and peaceful'
}

meaning = color_meanings.get(color, 'unique and special')
print(f"🎨 {color.title()} lovers are typically {meaning}!")

print(f"\n✨ Thanks for trying the interactive demo, {name}!")
print("🔄 The input() function now properly pauses execution!")
print("⏰ Timeout: 20 seconds (returns empty string if no input)")</textarea>
                        </div>
                        <div class="cell-output" id="output-9"></div>
                    </div>
                </div>
                
                <button class="add-cell-btn" onclick="addNotebookCell('code')">
                    + Add Cell
                </button>
                
                <div class="notebook-stats">
                    <div>Cells: <span id="cell-count">8</span></div>
                    <div>Mode: Notebook</div>
                </div>
            </div>
        </div>

        
        <div class="file-viewers">
            <div class="file-viewer">
                <h3>text.txt</h3>
                <div class="file-content" id="text-content">Loading from Pyodide...</div>
            </div>

            <div class="file-viewer">
                <h3>tester.csv</h3>
                <div class="file-content" id="csv-content">Loading from Pyodide...</div>
            </div>

            <div class="file-viewer">
                <h3>binary.dat</h3>
                <div class="file-content" id="binary-content">Loading from Pyodide...</div>
                <div class="file-content binary-hex" id="binary-hex" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <span id="status">Python Terminal Environment Ready</span>
    </div>

    <script>
        // ==============================================
        // UTILITY FUNCTIONS (Must be defined first!)
        // ==============================================
        
        function updateTerminal(message, isError = false) {
            const terminal = document.getElementById('terminal-output');
            if (!terminal) return;
            
            const span = document.createElement('span');
            
            if (message.includes('<img')) {
                span.innerHTML = message; 
            } else {
                span.textContent = message; 
            }
            
            if (isError) {
                span.style.color = '#f44';
            }
            terminal.appendChild(span);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            if (!status) return;
            
            status.textContent = message;
            status.className = type;
            
            if (type !== 'info') {
                setTimeout(() => {
                    status.textContent = 'Python Terminal Environment Ready';
                    status.className = '';
                }, 3000);
            }
        }

        // ==============================================
        // GLOBAL VARIABLES
        // ==============================================
        
        let selectedScript = '';
        let currentScript = 'untitled_script';
        let pyodide = null;
        let isInitialized = false;
        let isWaitingForInput = false;
        let inputResolver = null;

        // ==============================================
        // PYODIDE INITIALIZATION
        // ==============================================

        function updateLoadingProgress(message) {
            const progressElement = document.getElementById('loading-progress');
            if (progressElement) {
                progressElement.textContent = message;
            }
        }


        function showMainInterface() {
            const loadingScreen = document.getElementById('loading-screen');
            const mainContainer = document.getElementById('main-container');
            
            if (loadingScreen && mainContainer) {
                loadingScreen.classList.add('hidden');
                mainContainer.classList.add('ready');
            }
            

            initializeAceEditor();
            

            loadUserData();
        }

        let aceEditor = null;

        function initializeAceEditor() {
            // Check if Ace is loaded
            if (typeof ace === 'undefined') {
                console.error('Ace editor not loaded yet');
                setTimeout(initializeAceEditor, 100);
                return;
            }
            
            try {
                aceEditor = ace.edit("ace-editor");
                
                // Set theme based on user preference
                {% if user_theme == 'greydom' %}
                    aceEditor.setTheme("ace/theme/monokai");
                {% elif user_theme == 'cloud' %}
                    aceEditor.setTheme("ace/theme/katzenmilch");
                {% elif user_theme == 'chaos' %}
                    aceEditor.setTheme("ace/theme/chaos");
                {% else %}
                    aceEditor.setTheme("ace/theme/terminal");
                {% endif %}
                
                aceEditor.session.setMode("ace/mode/python");
                

                aceEditor.setOptions({
                    fontSize: "14px",
                    showPrintMargin: false,
                    wrap: true
                });

                
                if (typeof ace.require === 'function') {
                    ace.require("ace/ext/language_tools");
                    aceEditor.setOptions({
                        enableBasicAutocompletion: true,
                        enableLiveAutocompletion: true,
                        enableSnippets: true
                    });
                }
            } catch (error) {
                console.error('Failed to initialize Ace editor:', error);
                return;
            }
            const defaultContent = `# 🐍 Python Assembly - Scientific Computing in Browser!
print("Welcome to your Python environment!")
print("✅ Environment loaded successfully!")
print("📁 Available files: text.txt, tester.csv, binary.dat")
print()

# Test basic functionality
import numpy as np
print(f"NumPy version: {np.__version__}")

# Create simple array
x = np.array([1, 2, 3, 4, 5])
print(f"Array: {x}")
print(f"Array sum: {np.sum(x)}")
print(f"Array mean: {np.mean(x)}")

# Test file reading
print("\\nTesting file access:")
try:
    with open('text.txt', 'r') as f:
        content = f.read()
        print("📄 text.txt content:")
        print(content[:100] + "..." if len(content) > 100 else content)
except Exception as e:
    print(f"File read error: {e}")

# Test pandas if available
try:
    import pandas as pd
    df = pd.read_csv('tester.csv')
    print("\\n📊 CSV Data Preview:")
    print(df.head(3))
    print(f"Dataset shape: {df.shape}")
except Exception as e:
    print(f"\\n📊 Pandas/CSV: {e}")

print("\\n💡 Tips:")
print("• Install more packages: await install_package('requests')")
print("• Try notebook mode for Jupyter-like experience")
print("✨ Environment ready - happy coding!")`;

            // Try to load user code from textarea, fallback to default if problematic
            let userCode = document.getElementById('code_content').value.trim();
            let codeToUse = defaultContent;
            
            // Basic validation - check if user code exists and doesn't have obvious template issues
            if (userCode && userCode.length > 0 && !userCode.includes('{{') && !userCode.includes('}}')) {
                // Additional check - make sure it doesn't have obvious syntax issues
                try {
                    // Simple heuristic check for function definitions followed by try blocks
                    if (!userCode.match(/def\s+\w+\s*\([^)]*\):\s*\n\s*try:/)) {
                        codeToUse = userCode;
                    }
                } catch (e) {
                    console.warn('User code validation failed, using default:', e);
                }
            }
            
            aceEditor.setValue(codeToUse, -1);
            

            aceEditor.session.on('change', function() {
                document.getElementById('code_content').value = aceEditor.getValue();
            });
        }


        function getEditorValue() {
            return aceEditor ? aceEditor.getValue() : document.getElementById('code_content').value;
        }

        function setEditorValue(value) {
            if (aceEditor) {
                aceEditor.setValue(value, -1);
            }
            document.getElementById('code_content').value = value;
        }


        async function saveUserData() {
            const userData = {
                currentCode: getEditorValue(),
                scripts: {},
                notebooks: {},
                settings: {
                    theme: 'monokai',
                    fontSize: 14,
                    lastSaved: new Date().toISOString()
                }
            };


            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('python_script_') || key.startsWith('data_file_')) {
                    userData.scripts[key] = localStorage.getItem(key);
                }
            }

            
            const notebookData = localStorage.getItem('notebook_data');
            if (notebookData) {
                userData.notebooks = JSON.parse(notebookData);
            }

            try {
                const response = await fetch('/save_user_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    console.log('User data saved to account');
                    updateStatus('Data saved to account', 'success');
                } else {
                    console.log('Failed to save to account, using local storage');
                    localStorage.setItem('user_data_backup', JSON.stringify(userData));
                }
            } catch (error) {
                console.log('Network error, using local storage backup');
                localStorage.setItem('user_data_backup', JSON.stringify(userData));
            }
        }

        async function loadUserData() {
            try {
                const response = await fetch('/load_user_data');
                if (response.ok) {
                    const userData = await response.json();
                    restoreUserData(userData);
                    console.log('User data loaded from account');
                    return;
                }
            } catch (error) {
                console.log('Failed to load from account, checking local backup');
            }

            
            const backupData = localStorage.getItem('user_data_backup');
            if (backupData) {
                try {
                    const userData = JSON.parse(backupData);
                    restoreUserData(userData);
                    console.log('User data loaded from local backup');
                } catch (error) {
                    console.log('Failed to parse backup data');
                }
            }
        }

        function restoreUserData(userData) {
            
            if (userData.currentCode) {
                setEditorValue(userData.currentCode);
            }

            
            if (userData.scripts) {
                for (const [key, value] of Object.entries(userData.scripts)) {
                    localStorage.setItem(key, value);
                }
            }

            
            if (userData.notebooks) {
                localStorage.setItem('notebook_data', JSON.stringify(userData.notebooks));
            }

            
            if (userData.settings) {
                if (aceEditor && userData.settings.fontSize) {
                    aceEditor.setFontSize(userData.settings.fontSize + 'px');
                }
            }

            
            loadScriptList();
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        
        let autoSaveTimer = null;
        function scheduleAutoSave() {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(saveUserData, 5000); 
        }

        
        window.addEventListener('beforeunload', function(event) {
            saveUserData();
        });

        
        document.addEventListener('DOMContentLoaded', function() {
            if (aceEditor) {
                aceEditor.session.on('change', scheduleAutoSave);
            }
        });


        // ==============================================
        // PYODIDE INITIALIZATION (INLINE)
        // ==============================================
        
        async function initPyodide() {
            if (isInitialized) return;
            
            try {
                // Step 1: Load Pyodide
                updateLoadingProgress("Loading Pyodide...");
                updateTerminal("Loading Python environment...\n");
                
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                
                // Step 2: Load core packages
                updateLoadingProgress("Loading packages...");
                updateTerminal("Loading NumPy, Pandas, Matplotlib...\n");
                await pyodide.loadPackage(["numpy", "matplotlib", "pandas", "micropip"]);
                
                // Step 3: Setup matplotlib
                updateLoadingProgress("Configuring matplotlib...");
                try {
                    await pyodide.runPythonAsync(`
import matplotlib
import matplotlib.pyplot as plt
import io
import base64
import warnings

warnings.filterwarnings('ignore', category=UserWarning, module='matplotlib')
matplotlib.use('Agg')

def show_plot():
    """Custom show function that outputs plots as base64 images"""
    try:
        buf = io.BytesIO()
        plt.savefig(buf, format='png', bbox_inches='tight', dpi=96)
        buf.seek(0)
        img_str = base64.b64encode(buf.read()).decode()
        buf.close()
        print(f'<img src="data:image/png;base64,{img_str}" style="max-width:100%;height:auto;"/>')
        plt.close()
    except Exception as err:
        print(f'Plot error: {err}')
        plt.close()

plt.show = show_plot
`);
                    updateTerminal("Matplotlib configured\n");
                } catch (matplotError) {
                    console.warn("Matplotlib configuration failed:", matplotError);
                    updateTerminal("Matplotlib: using basic mode\n");
                }
                
                // Step 4: Setup I/O
                updateLoadingProgress("Configuring input/output...");
                await pyodide.runPythonAsync(`
import builtins
import os

original_open = builtins.open

def sync_web_input(prompt=""):
    import js
    try:
        result = js.showInputDialog(prompt)
        return result if result else ""
    except:
        return ""

def safe_open(filename, mode='r', *args, **kwargs):
    allowed_files = ['text.txt', 'tester.csv', 'binary.dat']
    allowed_paths = ['/lib/python3.11/', '/lib/python311.zip/', '/usr/', '<']
    basename = os.path.basename(filename)
    if basename in allowed_files:
        return original_open(filename, mode, *args, **kwargs)
    for path in allowed_paths:
        if filename.startswith(path) or path in filename:
            return original_open(filename, mode, *args, **kwargs)
    raise PermissionError(f'Cannot open: {filename}')

builtins.input = sync_web_input
builtins.open = safe_open
`);
                updateTerminal("I/O configured\n");
                
                // Step 5: Setup package installer
                updateLoadingProgress("Setting up package installer...");
                try {
                    await pyodide.runPythonAsync(`
import micropip

async def install_package(package_name):
    try:
        print(f'Installing {package_name}...')
        await micropip.install(package_name)
        print(f'✓ {package_name} installed')
        return True
    except Exception as err:
        print(f'✗ {package_name} failed: {err}')
        return False
`);
                    updateTerminal("Package installer ready\n");
                } catch (installerError) {
                    console.warn("Package installer failed:", installerError);
                }
                
                // Step 6: Setup virtual filesystem
                updateLoadingProgress("Setting up virtual filesystem...");
                const defaultFiles = {
                    'text.txt': `Hello from Python Environment!
This is your personal text file.
You can read and modify this file in your Python code.
Example: open('text.txt', 'r').read()`,
                    
                    'tester.csv': `name,age,city,score
Alice,25,NYC,85
Bob,30,LA,92
Carol,28,Chicago,78
David,35,Houston,95`,
                    
                    'binary.dat': 'Sample binary data for Python processing'
                };
                
                // Try to fetch user files from server
                try {
                    const response = await fetch('/python/get-files/');
                    if (response.ok) {
                        const filesData = await response.json();
                        defaultFiles['text.txt'] = filesData.text_content || defaultFiles['text.txt'];
                        defaultFiles['tester.csv'] = filesData.csv_content || defaultFiles['tester.csv'];
                        defaultFiles['binary.dat'] = filesData.binary_content || defaultFiles['binary.dat'];
                    }
                } catch (fetchError) {
                    console.log('Using default files');
                }
                
                // Write files to Pyodide filesystem
                for (const [filename, content] of Object.entries(defaultFiles)) {
                    try {
                        pyodide.FS.writeFile(filename, content);
                    } catch (fsError) {
                        console.warn(`Failed to write ${filename}:`, fsError);
                    }
                }
                
                updateTerminal("Files loaded\n");
                
                // Setup input/output handlers
                await setupInputOutputHandlers();
                
                isInitialized = true;
                updateTerminal("\n=== Python Environment Ready ===\n");
                updateTerminal("Packages: numpy, pandas, matplotlib\n");
                updateTerminal("Use plt.show() to display plots\n");
                updateTerminal("Use await install_package('name') for more\n\n");
                
                setTimeout(() => showMainInterface(), 500);
                
            } catch (error) {
                console.error("Init failed:", error);
                updateTerminal("Failed to initialize: " + error.message + "\n");
                setTimeout(() => showMainInterface(), 2000);
            }
        }

        
        // Helper function to setup input/output handlers
        async function setupInputOutputHandlers() {
            if (!pyodide || !isInitialized) return;
            
            // Setup input state
            globalThis.inputState = {
                waiting: false,
                result: null,
                ready: false
            };
            
            globalThis.startInput = function(prompt) {
                globalThis.inputState.waiting = true;
                globalThis.inputState.result = null;
                globalThis.inputState.ready = false;
                
                showTerminalInput(prompt, function(result) {
                    globalThis.inputState.result = result;
                    globalThis.inputState.ready = true;
                    globalThis.inputState.waiting = false;
                });
            };
            
            globalThis.checkInput = function() {
                return globalThis.inputState.ready;
            };
            
            globalThis.getInputResult = function() {
                const result = globalThis.inputState.result;
                globalThis.inputState.waiting = false;
                globalThis.inputState.result = null;
                globalThis.inputState.ready = false;
                return result || "";
            };
            
            globalThis.refreshFileList = function() {
                if (typeof loadScriptList === 'function') {
                    loadScriptList();
                }
            };
            
            // Expose to Python
            try {
                pyodide.globals.set("startInput", globalThis.startInput);
                pyodide.globals.set("checkInput", globalThis.checkInput);
                pyodide.globals.set("getInputResult", globalThis.getInputResult);
                pyodide.globals.set("refreshFileList", globalThis.refreshFileList);
            } catch (error) {
                console.warn("Failed to expose functions to Python:", error);
            }
        }

        
        function showTerminalInput(prompt, resolver) {
            console.log('showTerminalInput called with prompt:', prompt);
            
            const terminal = document.getElementById('terminal-output');
            const inputContainer = document.getElementById('input-container');
            const inputPrompt = document.getElementById('input-prompt');
            const terminalInput = document.getElementById('terminal-input');
            
            console.log('Elements found:', {
                terminal: !!terminal,
                inputContainer: !!inputContainer,
                inputPrompt: !!inputPrompt,
                terminalInput: !!terminalInput
            });
            
            if (!terminal || !inputContainer || !inputPrompt || !terminalInput) {
                console.error('Missing required elements!');
                resolver(''); 
                return;
            }
            
            
            updateTerminal(prompt);
            
            
            terminal.scrollTop = terminal.scrollHeight;
            
            
            inputPrompt.textContent = '';
            terminalInput.value = '';
            inputContainer.style.display = 'block';
            terminalInput.style.display = 'inline';
            
            
            setTimeout(() => {
                terminalInput.focus();
                terminal.scrollTop = terminal.scrollHeight;
            }, 50);
            
            isWaitingForInput = true;
            inputResolver = resolver;
            
            console.log('Input setup complete, waiting for user input');
            
            
            terminalInput.onkeydown = function(e) {
                if (e.key === 'Enter') {
                    console.log('Enter pressed, value:', terminalInput.value);
                    const value = terminalInput.value;
                    
                    
                    updateTerminal(value + '\n');
                    
                    
                    inputContainer.style.display = 'none';
                    isWaitingForInput = false;
                    
                    
                    if (inputResolver) {
                        console.log('Resolving with value:', value);
                        inputResolver(value);
                        inputResolver = null;
                    }
                }
            };
        }

        
        function saveScript() {
            const scriptName = document.getElementById('filename-input').value.trim();
            if (!scriptName) {
                updateStatus('Please enter a script name', 'error');
                return;
            }

            
            const allowedExtensions = ['.py', '.txt', '.csv', '.dat'];
            const hasValidExtension = allowedExtensions.some(ext => scriptName.toLowerCase().endsWith(ext));
            
            if (!hasValidExtension) {
                updateStatus('File name must end with .py, .txt, .csv, or .dat', 'error');
                return;
            }

            const code = getEditorValue();
            
            
            const isPythonScript = scriptName.toLowerCase().endsWith('.py');
            const storageKey = isPythonScript ? 'python_script_' + scriptName : 'data_file_' + scriptName;
            
            localStorage.setItem(storageKey, code);
            updateStatus(`${isPythonScript ? 'Script' : 'Data file'} '${scriptName}' saved to browser storage`, 'success');
            scheduleAutoSave(); 
            loadScriptList();
            currentScript = scriptName;
            document.getElementById('current-file').textContent = currentScript;
        }

        function loadScript() {
            if (!selectedScript) {
                updateStatus('Please select a file first', 'error');
                return;
            }

            
            let code = localStorage.getItem('python_script_' + selectedScript);
            if (code === null) {
                code = localStorage.getItem('data_file_' + selectedScript);
            }
            
            if (code !== null) {
                setEditorValue(code);
                currentScript = selectedScript;
                document.getElementById('current-file').textContent = currentScript;
                updateStatus(`File '${selectedScript}' loaded`, 'success');
            } else {
                updateStatus('File not found', 'error');
            }
        }

        function deleteScript() {
            if (!selectedScript) {
                updateStatus('Please select a file first', 'error');
                return;
            }

            if (confirm(`Delete file '${selectedScript}'?`)) {
                
                let deleted = false;
                if (localStorage.getItem('python_script_' + selectedScript)) {
                    localStorage.removeItem('python_script_' + selectedScript);
                    deleted = true;
                } else if (localStorage.getItem('data_file_' + selectedScript)) {
                    localStorage.removeItem('data_file_' + selectedScript);
                    deleted = true;
                }
                
                if (deleted) {
                    updateStatus(`File '${selectedScript}' deleted`, 'success');
                    loadScriptList();
                    selectedScript = '';
                    
                    
                    if (currentScript === selectedScript) {
                        setEditorValue('');
                        currentScript = '';
                        document.getElementById('current-file').textContent = 'No file selected';
                    }
                } else {
                    updateStatus('File not found', 'error');
                }
            }
        }

        function newScript() {
            setEditorValue(`# New Python Script
# Available files: text.txt, tester.csv, binary.dat

print("Hello from new script!")

# Example: Read allowed file
try:
    with open('text.txt', 'r') as f:
        content = f.read()
        print("File content:", content[:100] + "..." if len(content) > 100 else content)
except Exception as e:
    print("Error:", e)

# Example: Interactive input
try:
    user_input = input("Enter something: ")
    print(f"You entered: {user_input}")
except Exception as e:
    print("Input error:", e)
`);
            document.getElementById('filename-input').value = '';
            currentScript = 'untitled_script';
            document.getElementById('current-file').textContent = currentScript;
            
            updateStatus('New script created');
        }

        function selectScript(scriptName) {
            
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            
            event.target.classList.add('selected');
            selectedScript = scriptName;
            
            
            document.getElementById('filename-input').value = scriptName;
            
            
            const code = localStorage.getItem('python_script_' + scriptName);
            if (code !== null) {
                setEditorValue(code);
                currentScript = scriptName;
                document.getElementById('current-file').textContent = currentScript;
                updateStatus(`Loaded: ${scriptName} (${code.length} characters)`);
            } else {
                updateStatus(`Error: Script '${scriptName}' not found in browser storage`);
            }
        }

        function selectDataFile(filename) {
            
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            
            event.target.classList.add('selected');
            selectedScript = filename; 
            
            
            document.getElementById('filename-input').value = filename;
            
            
            const content = localStorage.getItem('data_file_' + filename);
            if (content !== null) {
                setEditorValue(content);
                currentScript = filename;
                document.getElementById('current-file').textContent = currentScript;
                updateStatus(`Loaded: ${filename} (${content.length} characters)`);
            } else {
                updateStatus(`Error: Data file '${filename}' not found in browser storage`);
            }
        }

        function loadScriptList() {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            const computedStyle = getComputedStyle(document.body);
            const textColor = computedStyle.getPropertyValue('--text-bright').trim() || '#0f0';
            
            
            const dataSection = document.createElement('li');
            dataSection.innerHTML = '<strong>Data Files:</strong>';
            dataSection.style.color = textColor;
            dataSection.style.marginBottom = '10px';
            fileList.appendChild(dataSection);
            
            
            const allowedFiles = ['text.txt', 'tester.csv', 'binary.dat'];
            allowedFiles.forEach(filename => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.style.cursor = 'pointer';
                li.style.padding = '5px';
                li.style.marginLeft = '15px';
                
                
                let icon = '';
                if (filename.endsWith('.txt')) icon = '';
                else if (filename.endsWith('.csv')) icon = 'CSV';
                else if (filename.endsWith('.dat')) icon = 'DAT';
                
                
                try {
                    if (pyodide && pyodide.FS) {
                        try {
                            const content = pyodide.FS.readFile(filename, { encoding: 'utf8' });
                            li.innerHTML = `${icon} ${filename} <span style="color: #888">(${content.length} chars)</span>`;
                        } catch (e) {
                            li.innerHTML = `${icon} ${filename} <span style="color: #666">(empty)</span>`;
                        }
                    } else {
                        li.innerHTML = `${icon} ${filename} <span style="color: #666">(loading...)</span>`;
                    }
                } catch (e) {
                    li.innerHTML = `${icon} ${filename} <span style="color: #666">(error)</span>`;
                }
                
                li.onclick = () => selectFile(filename);
                fileList.appendChild(li);
            });
            
            
            let hasDataFiles = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('data_file_')) {
                    hasDataFiles = true;
                    const filename = key.replace('data_file_', '');
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.style.cursor = 'pointer';
                    li.style.padding = '5px';
                    li.style.marginLeft = '15px';
                    
                    
                    let icon = '';
                    if (filename.endsWith('.txt')) icon = '';
                    else if (filename.endsWith('.csv')) icon = 'CSV';
                    else if (filename.endsWith('.dat')) icon = 'DAT';
                    
                    const content = localStorage.getItem(key);
                    li.innerHTML = `${icon} ${filename} <span style="color: #888">(${content.length} chars)</span>`;
                    li.onclick = () => selectDataFile(filename);
                    fileList.appendChild(li);
                }
            }
            
            
            const separator = document.createElement('li');
            separator.innerHTML = '<hr style="border-color: #333; margin: 10px 0;">';
            fileList.appendChild(separator);
            
            
            const scriptSection = document.createElement('li');
            scriptSection.innerHTML = '<strong>Saved Scripts:</strong>';
            scriptSection.style.color = textColor;
            scriptSection.style.marginBottom = '10px';
            fileList.appendChild(scriptSection);
            
            
            let hasScripts = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('python_script_')) {
                    hasScripts = true;
                    const scriptName = key.replace('python_script_', '');
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.style.cursor = 'pointer';
                    li.style.padding = '5px';
                    li.style.marginLeft = '15px';
                    
                    const content = localStorage.getItem(key);
                    li.innerHTML = `� ${scriptName} <span style="color: #888">(${content.split('\n').length} lines)</span>`;
                    li.onclick = () => selectScript(scriptName);
                    fileList.appendChild(li);
                }
            }
            
            if (!hasScripts) {
                const noScripts = document.createElement('li');
                noScripts.style.color = '#666';
                noScripts.style.marginLeft = '15px';
                noScripts.textContent = 'No saved scripts';
                fileList.appendChild(noScripts);
            }
        }

        
        function updateFileViewers() {
            if (!pyodide || !pyodide.FS) return;
            
            try {
                
                const textContent = pyodide.FS.readFile('text.txt', { encoding: 'utf8' });
                document.getElementById('text-content').textContent = textContent;
                
                
                const csvContent = pyodide.FS.readFile('tester.csv', { encoding: 'utf8' });
                document.getElementById('csv-content').textContent = csvContent;
                
                
                try {
                    
                    if (globalThis.binaryContent && globalThis.binaryContent !== 'Binary data example') {
                        document.getElementById('binary-content').textContent = globalThis.binaryContent;
                    } else {
                        
                        const binaryData = pyodide.FS.readFile('binary.dat');
                        let binaryDisplay = '';
                        
                        
                        try {
                            const pickleResult = pyodide.runPython(`
import pickle
import io
try:
    data = open('binary.dat', 'rb').read()
    items = []
    bio = io.BytesIO(data)
    try:
        while True:
            item = pickle.load(bio)
            items.append(str(item))
    except EOFError:
        pass
    if items:
        result = f"Pickle data ({len(items)} items):\\n" + "\\n".join(f"{i}: {item}" for i, item in enumerate(items))
    else:
        result = f"Binary file ({len(data)} bytes) - not pickle data"
    result
except Exception as e:
    f"Error parsing binary data: {str(e)}"
                            `);
                            binaryDisplay = pickleResult;
                            
                            globalThis.binaryContent = binaryDisplay;
                        } catch (e) {
                            binaryDisplay = `Binary file (${binaryData.length} bytes) - parsing error: ${e.message}`;
                        }
                        
                        document.getElementById('binary-content').textContent = binaryDisplay;
                    }
                    
                    
                    if (globalThis.binaryHexData && globalThis.binaryHexData !== 'No hex data available') {
                        document.getElementById('binary-hex').textContent = globalThis.binaryHexData;
                        document.getElementById('binary-hex').style.display = 'block';
                    }
                    
                } catch (e) {
                    document.getElementById('binary-content').textContent = 'Error reading binary file: ' + e.message;
                }
                
            } catch (error) {
                console.log('Error updating file viewers:', error);
                
                document.getElementById('text-content').textContent = 'File not found or empty';
                document.getElementById('csv-content').textContent = 'File not found or empty';
                document.getElementById('binary-content').textContent = 'File not found or empty';
            }
        }

        
        function selectFile(filename) {
            try {
                if (pyodide && pyodide.FS) {
                    const content = pyodide.FS.readFile(filename, { encoding: 'utf8' });
                    setEditorValue(content);
                    document.getElementById('filename-input').value = filename;
                    
                    
                    document.getElementById('current-file').textContent = filename;
                    
                    updateStatus(`Loaded: ${filename} (${content.length} characters)`);
                    

                    
                    
                    updateFileViewers();
                    
                    
                    document.querySelectorAll('.file-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    event.target.classList.add('selected');
                }
            } catch (e) {
                updateStatus(`Error loading ${filename}: ${e.message}`);
            }
        }

        
        function refreshFiles() {
            loadScriptList();
            updateStatus('File list refreshed');
        }


        function setupCodeEditor() {
            const codeTextarea = document.getElementById('code_content');
            

            codeTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const cursorPos = this.selectionStart;
                    const textBeforeCursor = this.value.substring(0, cursorPos);
                    const currentLine = textBeforeCursor.split('\n').pop();
                    
                    
                    if (currentLine.trim().endsWith(':')) {
                        e.preventDefault();
                        
                        
                        const indentMatch = currentLine.match(/^(\s*)/);
                        const currentIndent = indentMatch ? indentMatch[1] : '';
                        
                        
                        const newIndent = currentIndent + '    ';
                        const newText = this.value.substring(0, cursorPos) + '\n' + newIndent + this.value.substring(cursorPos);
                        
                        this.value = newText;
                        this.selectionStart = this.selectionEnd = cursorPos + 1 + newIndent.length;
                    }
                }
                

                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    
                    this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 4;
                }
            });
        }


        // ==============================================
        // CODE EXECUTION
        // ==============================================
        
        async function executeCode() {
            if (!isInitialized) {
                await initPyodide();
                if (!isInitialized) return;
            }

            const code = getEditorValue();
            if (!code || !code.trim()) {
                updateTerminal("No code to execute\n");
                return;
            }
            
            const runBtn = document.getElementById('run-btn');
            runBtn.disabled = true;
            
            updateTerminal("\n>>> Executing code...\n");
            
            try {
                // Setup output capture
                await pyodide.runPythonAsync(`
import sys
from io import StringIO
sys.stdout = StringIO()
sys.stderr = StringIO()
`);
                
                // Show input() notification
                if (code.includes('input(')) {
                    updateTerminal("Code contains input() - dialogs will appear\n");
                }
                
                // Execute the code
                try {
                    await pyodide.runPythonAsync(code);
                } catch (execError) {
                    if (execError.name === 'PythonError') {
                        updateTerminal("Error: " + execError.message + "\n", true);
                    } else {
                        updateTerminal("Error: " + execError.toString() + "\n", true);
                    }
                }
                
                // Get output
                const stdout = await pyodide.runPythonAsync("sys.stdout.getvalue()");
                const stderr = await pyodide.runPythonAsync("sys.stderr.getvalue()");
                
                // Restore streams
                await pyodide.runPythonAsync(`
sys.stdout = sys.__stdout__
sys.stderr = sys.__stderr__
`);
                
                // Display results
                if (stdout) {
                    updateTerminal(stdout);
                }
                if (stderr) {
                    updateTerminal(stderr, true);
                }
                
                if (!stdout && !stderr) {
                    updateTerminal("Code executed successfully (no output)\n");
                }
                
                // Update file viewers
                updateFileViewers();
                loadScriptList();
                
            } catch (error) {
                updateTerminal("Execution error: " + error.toString() + "\n", true);
                console.error("Execution error:", error);
            }
            
            runBtn.disabled = false;
        }

        function clearTerminal() {
            document.getElementById('terminal-output').textContent = '';
            updateStatus('Terminal cleared', 'success');
        }

        // Async version of input dialog for better Python integration
        function showInputDialogAsync(prompt, resolve) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.3s ease-out;
            `;

            // Create modal dialog with pixel aesthetic
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #000000;
                border: 4px solid #ffffff;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                font-family: 'Press Start 2P', monospace;
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
                animation: slideIn 0.3s ease-out;
                position: relative;
            `;

            // Add pixel-perfect styling and content
            modal.innerHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: translateY(-50px) scale(0.9); opacity: 0; }
                        to { transform: translateY(0) scale(1); opacity: 1; }
                    }
                    @keyframes pixelPulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.7; }
                    }
                    .input-modal-title {
                        color: #ffffff;
                        margin-bottom: 20px;
                        font-size: 0.7rem;
                        line-height: 1.5;
                        text-shadow: 2px 2px 0 #000000;
                        text-align: center;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        border-bottom: 3px solid #ffffff;
                        padding-bottom: 15px;
                        animation: pixelPulse 2s infinite;
                    }
                    .input-modal-prompt {
                        color: #cccccc;
                        margin-bottom: 20px;
                        font-size: 0.6rem;
                        line-height: 1.8;
                        word-wrap: break-word;
                        background: #111111;
                        padding: 15px;
                        border: 2px solid #333333;
                    }
                    .input-modal-field {
                        width: calc(100% - 24px);
                        padding: 12px;
                        background: #000000;
                        border: 3px solid #ffffff;
                        color: #ffffff;
                        font-family: 'Press Start 2P', monospace;
                        font-size: 0.6rem;
                        margin-bottom: 25px;
                        outline: none;
                        box-shadow: 3px 3px 0 #ffffff;
                        transition: all 0.2s;
                    }
                    .input-modal-field:focus {
                        transform: translate(-2px, -2px);
                        box-shadow: 5px 5px 0 #ffffff;
                        border-color: #ffffff;
                    }
                    .input-modal-buttons {
                        display: flex;
                        gap: 15px;
                        justify-content: center;
                    }
                    .input-modal-btn {
                        padding: 12px 24px;
                        background: #000000;
                        border: 3px solid #ffffff;
                        color: #ffffff;
                        cursor: pointer;
                        font-family: 'Press Start 2P', monospace;
                        font-size: 0.5rem;
                        transition: all 0.2s;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        box-shadow: 3px 3px 0 #ffffff;
                        position: relative;
                    }
                    .input-modal-btn:hover {
                        background: #ffffff;
                        color: #000000;
                        transform: translate(2px, 2px);
                        box-shadow: 1px 1px 0 #ffffff;
                    }
                    .input-modal-btn:active {
                        transform: translate(3px, 3px);
                        box-shadow: none;
                    }
                    .input-modal-btn::before {
                        content: '';
                        position: absolute;
                        top: -3px;
                        left: -3px;
                        right: -3px;
                        bottom: -3px;
                        background: linear-gradient(45deg, transparent 48%, #ffffff 48%, #ffffff 52%, transparent 52%);
                        background-size: 6px 6px;
                        z-index: -1;
                        opacity: 0.2;
                    }
                </style>
                <div class="input-modal-title">🔍 Python Input Required</div>
                <div class="input-modal-prompt">${prompt || 'Enter your input:'}</div>
                <input type="text" class="input-modal-field" id="python-input-field" placeholder="Type here..." autocomplete="off">
                <div class="input-modal-buttons">
                    <button class="input-modal-btn" id="input-ok-btn">✓ Submit</button>
                    <button class="input-modal-btn" id="input-cancel-btn">✗ Cancel</button>
                </div>
            `;

            const inputField = modal.querySelector('#python-input-field');
            const okButton = modal.querySelector('#input-ok-btn');
            const cancelButton = modal.querySelector('#input-cancel-btn');

            // Handle submission
            function submitInput() {
                const value = inputField.value;
                document.body.removeChild(overlay);
                resolve(value);
            }

            // Handle cancellation
            function cancelInput() {
                document.body.removeChild(overlay);
                resolve('');
            }

            // Event listeners
            okButton.addEventListener('click', submitInput);
            cancelButton.addEventListener('click', cancelInput);

            // Keyboard handling
            inputField.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitInput();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelInput();
                }
            });

            // Add to page and focus
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Focus with slight delay for better UX
            setTimeout(() => {
                inputField.focus();
                inputField.select();
            }, 150);
        }

        // Synchronous version using prompt as fallback
        function showInputDialog(prompt) {
            // Try to use a custom styled prompt-like dialog
            try {
                return window.prompt(prompt || 'Enter input:') || '';
            } catch (e) {
                return '';
            }
        }

        // Make both functions available globally for Pyodide
        window.showInputDialog = showInputDialog;
        window.showInputDialogAsync = showInputDialogAsync;

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                executeCode();
            }
            
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveScript();
            }
        });


        document.getElementById('filename-input').addEventListener('input', function(e) {
            if (e.target.value.trim()) {
                currentScript = e.target.value.trim();
                document.getElementById('current-file').textContent = currentScript;
            }
        });

        window.addEventListener('load', function() {
            setupCodeEditor();
            
            loadScriptList();
            initPyodide();
        });

        let isFocusMode = false;

        function toggleFocusMode() {
            const focusBtn = document.getElementById('focus-btn');
            const body = document.body;
            
            if (!isFocusMode) {
                body.classList.add('focus-mode');
                document.querySelectorAll('.file-manager, .file-viewers, .terminal-section').forEach(el => {
                    el.classList.add('background-blur');
                });
                focusBtn.innerHTML = 'EXIT';
                focusBtn.title = 'Exit focus mode';
                focusBtn.classList.add('active');
                document.getElementById('code_content').focus();
            } else {
                body.classList.remove('focus-mode');
                document.querySelectorAll('.file-manager, .file-viewers, .terminal-section').forEach(el => {
                    el.classList.remove('background-blur');
                });
                focusBtn.innerHTML = 'FOCUS';
                focusBtn.title = 'Focus Mode';
                focusBtn.classList.remove('active');
            }
            
            isFocusMode = !isFocusMode;
        }

        let isNotebookMode = false;
        let cellCounter = 8;
        let executionCounter = 1;

        function toggleNotebookMode() {
            const notebookBtn = document.getElementById('notebook-btn');
            const body = document.body;
            
            if (!isNotebookMode) {
                body.classList.add('notebook-mode');
                notebookBtn.innerHTML = 'EDITOR';
                notebookBtn.title = 'Switch to Editor Mode';
                notebookBtn.classList.add('active');
                updateCellCount();
                
                const firstCell = document.querySelector('.cell-textarea');
                if (firstCell) firstCell.focus();
            } else {
                body.classList.remove('notebook-mode');
                notebookBtn.innerHTML = 'NOTEBOOK';
                notebookBtn.title = 'Jupyter-style Notebook Mode';
                notebookBtn.classList.remove('active');
            }
            
            isNotebookMode = !isNotebookMode;
        }

        function addNotebookCell(type = 'code') {
            cellCounter++;
            const cellsContainer = document.getElementById('notebook-cells');
            const cellHtml = createCellHtml(cellCounter, type);
            
            const cellDiv = document.createElement('div');
            cellDiv.innerHTML = cellHtml;
            const cell = cellDiv.firstElementChild;
            
            cellsContainer.appendChild(cell);
            updateCellCount();
            
            const textarea = cell.querySelector('.cell-textarea');
            if (textarea) {
                textarea.focus();
                setupCellKeyboardShortcuts(textarea);
            }
        }

        function createCellHtml(cellId, type) {
            const isMarkdown = type === 'markdown';
            const cellType = isMarkdown ? 'markdown-cell' : 'code-cell';
            const cellLabel = isMarkdown ? 'Markdown Cell' : 'Code Cell';
            const executionLabel = isMarkdown ? '' : `In [${cellId}]:`;
            const placeholder = isMarkdown ? 
                '# Markdown Cell\n\nWrite markdown here...\n\n- **Bold text**\n- *Italic text*\n- `code`\n- [Links](https://example.com)' :
                '# Write your Python code here\n# Press Shift+Enter to run this cell\n\nprint("Hello from cell ' + cellId + '!")';

            return `
            <div class="notebook-cell ${cellType}" data-cell-id="${cellId}" data-cell-type="${type}">
                <div class="cell-header">
                    <div class="cell-type">
                        <span class="cell-execution-count">${executionLabel}</span>
                        ${cellLabel}
                    </div>
                    <div class="cell-controls">
                        <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                        <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                        <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                        <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">${isMarkdown ? 'C' : 'M'}</button>
                        <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                    </div>
                </div>
                <div class="cell-input">
                    <textarea class="cell-textarea" placeholder="${placeholder}"></textarea>
                </div>
                <div class="cell-output" id="output-${cellId}"></div>
            </div>`;
        }

        function runCell(button) {
            const cell = button.closest('.notebook-cell');
            const textarea = cell.querySelector('.cell-textarea');
            const output = cell.querySelector('.cell-output');
            const cellType = cell.dataset.cellType;
            
            if (cellType === 'markdown') {
                renderMarkdown(textarea.value, output);
            } else {
                runPythonCode(textarea.value, output, cell.dataset.cellId);
            }
        }

        function renderMarkdown(markdown, outputElement) {
            let html = markdown
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/\n/g, '<br>');

            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            
            outputElement.innerHTML = html;
            outputElement.classList.add('has-output');
            outputElement.style.color = '#ccc';
        }

        async function runPythonCode(code, outputElement, cellId) {
            return runPythonCodeEnhanced(code, outputElement, cellId);
        }

        function moveCell(button, direction) {
            const cell = button.closest('.notebook-cell');
            const sibling = direction === -1 ? cell.previousElementSibling : cell.nextElementSibling;
            
            if (sibling && sibling.classList.contains('notebook-cell')) {
                if (direction === -1) {
                    sibling.parentNode.insertBefore(cell, sibling);
                } else {
                    sibling.parentNode.insertBefore(sibling, cell);
                }
            }
        }

        function deleteCell(button) {
            const cell = button.closest('.notebook-cell');
            const cellsContainer = document.getElementById('notebook-cells');
            
            if (cellsContainer.children.length > 1) {
                cell.remove();
                updateCellCount();
            } else {
                alert('Cannot delete the last cell');
            }
        }

        function convertCell(button) {
            const cell = button.closest('.notebook-cell');
            const currentType = cell.dataset.cellType;
            const newType = currentType === 'code' ? 'markdown' : 'code';
            
            const output = cell.querySelector('.cell-output');
            output.innerHTML = '';
            output.classList.remove('has-output');
            
            cell.dataset.cellType = newType;
            cell.className = `notebook-cell ${newType}-cell`;
            
            button.textContent = newType === 'code' ? 'M' : 'C';
            button.title = newType === 'code' ? 'Convert to Markdown' : 'Convert to Code';
            
            const cellTypeSpan = cell.querySelector('.cell-type');
            const executionSpan = cellTypeSpan.querySelector('.cell-execution-count');
            const isMarkdown = newType === 'markdown';
            
            executionSpan.textContent = isMarkdown ? '' : `In [${cell.dataset.cellId}]:`;
            cellTypeSpan.childNodes[cellTypeSpan.childNodes.length - 1].textContent = 
                isMarkdown ? 'Markdown Cell' : 'Code Cell';
        }

        function runAllCells() {
            const cells = document.querySelectorAll('.notebook-cell');
            cells.forEach(cell => {
                const runButton = cell.querySelector('.cell-btn[onclick*="runCell"]');
                if (runButton) runCell(runButton);
            });
        }

        function clearAllOutputs() {
            const outputs = document.querySelectorAll('.cell-output');
            outputs.forEach(output => {
                output.innerHTML = '';
                output.classList.remove('has-output');
            });
        }

        function updateCellCount() {
            const cellCount = document.querySelectorAll('.notebook-cell').length;
            const counter = document.getElementById('cell-count');
            if (counter) counter.textContent = cellCount;
        }

        function exportNotebook() {
            const cells = [];
            document.querySelectorAll('.notebook-cell').forEach(cell => {
                const cellType = cell.dataset.cellType;
                const content = cell.querySelector('.cell-textarea').value;
                const output = cell.querySelector('.cell-output').innerHTML;
                
                cells.push({
                    cell_type: cellType,
                    source: content,
                    outputs: output ? [{ text: output }] : []
                });
            });
            
            const notebook = {
                cells: cells,
                metadata: {
                    kernelspec: {
                        display_name: "Python 3 (Pyodide)",
                        language: "python",
                        name: "python3"
                    }
                },
                nbformat: 4,
                nbformat_minor: 4
            };
            
            const dataStr = JSON.stringify(notebook, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportName = 'notebook.ipynb';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
        }

        function setupCellKeyboardShortcuts(textarea) {
            textarea.addEventListener('keydown', function(e) {
                const cell = textarea.closest('.notebook-cell');
                
                if (e.shiftKey && e.key === 'Enter') {
                    e.preventDefault();
                    const runButton = cell.querySelector('.cell-btn[onclick*="runCell"]');
                    if (runButton) {
                        runCell(runButton);
                        const nextCell = cell.nextElementSibling;
                        if (nextCell && nextCell.classList.contains('notebook-cell')) {
                            nextCell.querySelector('.cell-textarea').focus();
                        } else {
                            addNotebookCell('code');
                        }
                    }
                }
                
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    const runButton = cell.querySelector('.cell-btn[onclick*="runCell"]');
                    if (runButton) runCell(runButton);
                }
                
                if (e.altKey && e.key === 'Enter') {
                    e.preventDefault();
                    const runButton = cell.querySelector('.cell-btn[onclick*="runCell"]');
                    if (runButton) runCell(runButton);
                    addNotebookCell('code');
                }
                
                if (e.key === 'Escape') {
                    textarea.blur();
                }
                
                if (e.key === 'Tab' && !e.shiftKey) {
                    const cursorPos = textarea.selectionStart;
                    const textBefore = textarea.value.substring(0, cursorPos);
                    const lastWord = textBefore.split(/\s/).pop();
                    
                    const completions = {
                        'np': 'import numpy as np',
                        'pd': 'import pandas as pd',
                        'plt': 'import matplotlib.pyplot as plt',
                        'fig': 'plt.figure(figsize=(10, 6))',
                        'show': 'plt.show()',
                        'pr': 'print()',
                        'def': 'def function_name():\n    pass',
                        'for': 'for i in range():\n    ',
                        'if': 'if condition:\n    '
                    };
                    
                    if (completions[lastWord]) {
                        e.preventDefault();
                        const beforeLastWord = textBefore.substring(0, textBefore.lastIndexOf(lastWord));
                        const afterCursor = textarea.value.substring(cursorPos);
                        textarea.value = beforeLastWord + completions[lastWord] + afterCursor;
                        
                        const newPos = beforeLastWord.length + completions[lastWord].length;
                        textarea.setSelectionRange(newPos, newPos);
                    }
                }
            });
        }

        function showKeyboardShortcuts() {
            const helpContent = `
<div style="background: #111; color: #fff; padding: 20px; border-radius: 8px; max-width: 500px;">
    <h3 style="color: var(--text-bright); margin-top: 0;">⌨️ Keyboard Shortcuts</h3>
    
    <h4 style="color: #ccc; margin-bottom: 10px;">Cell Execution:</h4>
    <div style="font-family: monospace; margin-bottom: 15px;">
        <code>Shift + Enter</code> - Run cell and select next<br>
        <code>Ctrl + Enter</code> - Run cell (stay in cell)<br>
        <code>Alt + Enter</code> - Run cell and add new cell below<br>
    </div>
    
    <h4 style="color: #ccc; margin-bottom: 10px;">Cell Management:</h4>
    <div style="font-family: monospace; margin-bottom: 15px;">
        <code>Escape</code> - Exit cell edit mode<br>
        <code>Tab</code> - Auto-complete common patterns<br>
    </div>
    
    <h4 style="color: #ccc; margin-bottom: 10px;">Auto-completions:</h4>
    <div style="font-family: monospace; margin-bottom: 15px;">
        <code>np + Tab</code> → <code>import numpy as np</code><br>
        <code>pd + Tab</code> → <code>import pandas as pd</code><br>
        <code>plt + Tab</code> → <code>import matplotlib.pyplot as plt</code><br>
        <code>fig + Tab</code> → <code>plt.figure(figsize=(10, 6))</code><br>
        <code>show + Tab</code> → <code>plt.show()</code><br>
    </div>
    
    <div style="color: #888; font-size: 11px; margin-top: 15px;">
        💡 Tip: Your notebook auto-saves every 30 seconds!
    </div>
</div>
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: 'Courier New', monospace;
            `;
            
            modal.innerHTML = helpContent;
            modal.addEventListener('click', () => modal.remove());
            document.body.appendChild(modal);
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.cell-textarea').forEach(setupCellKeyboardShortcuts);
            loadNotebookFromStorage();
            setupAutoSave();
        });

        function setupAutoSave() {
            setInterval(saveNotebookToStorage, 30000); 
            
            
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('cell-textarea')) {
                    clearTimeout(window.autoSaveTimeout);
                    window.autoSaveTimeout = setTimeout(saveNotebookToStorage, 3000);
                }
            });
        }

        function saveNotebookToStorage() {
            if (!isNotebookMode) return;
            
            const cells = [];
            document.querySelectorAll('.notebook-cell').forEach(cell => {
                cells.push({
                    id: cell.dataset.cellId,
                    type: cell.dataset.cellType,
                    content: cell.querySelector('.cell-textarea').value,
                    output: cell.querySelector('.cell-output').innerHTML
                });
            });
            
            localStorage.setItem('pythonNotebook', JSON.stringify({
                cells: cells,
                timestamp: Date.now()
            }));
            
            
            showSaveIndicator();
        }

        function loadNotebookFromStorage() {
            const saved = localStorage.getItem('pythonNotebook');
            if (!saved) return;
            
            try {
                const notebook = JSON.parse(saved);
                
                
            } catch (e) {
                console.log('Could not load saved notebook');
            }
        }

        function showSaveIndicator() {
            const indicator = document.createElement('div');
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 136, 0, 0.9);
                color: white;
                padding: 8px 16px;
                border-radius: 4px;
                font-size: 12px;
                z-index: 10000;
                transition: opacity 0.3s;
            `;
            indicator.textContent = '💾 Saved';
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.style.opacity = '0';
                setTimeout(() => indicator.remove(), 300);
            }, 1500);
        }

        
        function runPythonCodeEnhanced(code, outputElement, cellId) {
            if (!pyodide) {
                outputElement.innerHTML = 'Error: Python environment not ready';
                outputElement.classList.add('has-output');
                return;
            }

            const startTime = performance.now();
            
            try {
                outputElement.innerHTML = '⏳ Executing...';
                outputElement.classList.add('has-output');
                
                
                let stdout = '';
                let stderr = '';
                
                pyodide.runPython(`
import sys
from io import StringIO
import traceback

_stdout_capture = StringIO()
_stderr_capture = StringIO()
_old_stdout = sys.stdout
_old_stderr = sys.stderr
sys.stdout = _stdout_capture
sys.stderr = _stderr_capture
                `);

                
                let result;
                try {
                    result = pyodide.runPython(code);
                } catch (pythonError) {
                    
                    stderr = pyodide.runPython(`
import traceback
traceback.print_exc()
_stderr_capture.getvalue()
                    `);
                }
                
                
                stdout = pyodide.runPython('_stdout_capture.getvalue()');
                if (!stderr) {
                    stderr = pyodide.runPython('_stderr_capture.getvalue()');
                }
                
                
                pyodide.runPython(`
sys.stdout = _old_stdout
sys.stderr = _old_stderr
                `);
                
                
                const executionTime = (performance.now() - startTime).toFixed(2);
                
                
                const executionSpan = outputElement.closest('.notebook-cell').querySelector('.cell-execution-count');
                if (executionSpan && !executionSpan.textContent.includes('Markdown')) {
                    executionSpan.textContent = `In [${executionCounter}]:`;
                    executionCounter++;
                }
                
                
                let output = '';
                if (stderr) {
                    output += `<span style="color: #ff4444;">Error:\n${stderr}</span>`;
                } else {
                    if (stdout) output += stdout;
                    if (result !== undefined && result !== null && result !== '') {
                        output += (output ? '\n' : '') + String(result);
                    }
                    if (!output) output = '(no output)';
                }
                
                output += `\n<span style="color: #666; font-size: 11px;">⏱️ Executed in ${executionTime}ms</span>`;
                
                outputElement.innerHTML = output;
                outputElement.style.color = stderr ? '#ff4444' : '#fff';
                
            } catch (error) {
                const executionTime = (performance.now() - startTime).toFixed(2);
                outputElement.innerHTML = `<span style="color: #ff4444;">JavaScript Error: ${error.message}</span>\n<span style="color: #666; font-size: 11px;">⏱️ Failed after ${executionTime}ms</span>`;
                outputElement.style.color = '#ff4444';
                outputElement.classList.add('has-output');
            }
        }

    </script>

    
    <div class="settings-widget">
        <button class="settings-cog" id="settings-toggle" title="Settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
        </button>
        <div class="settings-dropdown" id="settings-dropdown">
            <div class="settings-header">Settings</div>
            <div class="settings-section">
                <label class="settings-label">Theme</label>
                <div class="theme-selector">
                    <div class="theme-option" data-theme="default">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #000 0%, #008800 100%);"></div>
                        <div class="theme-info">
                            <div class="theme-name">Default</div>
                            <div class="theme-desc">Green Matrix</div>
                        </div>
                        <div class="theme-check">✓</div>
                    </div>
                    <div class="theme-option" data-theme="greydom">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #1a1d2e 0%, #ff4444 100%);"></div>
                        <div class="theme-info">
                            <div class="theme-name">Greydom</div>
                            <div class="theme-desc">Dark Grey-Blue</div>
                        </div>
                        <div class="theme-check">✓</div>
                    </div>
                    <div class="theme-option" data-theme="cloud">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #ffffff 0%, #2c3e50 100%);"></div>
                        <div class="theme-info">
                            <div class="theme-name">Cloud</div>
                            <div class="theme-desc">White & Grey</div>
                        </div>
                        <div class="theme-check">✓</div>
                    </div>
                    <div class="theme-option" data-theme="chaos">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #000000 0%, #808080 100%);"></div>
                        <div class="theme-info">
                            <div class="theme-name">Chaos</div>
                            <div class="theme-desc">Black & Grey</div>
                        </div>
                        <div class="theme-check">✓</div>
                    </div>
                    {% if user.profile.paidUser %}
                    <div class="theme-option" data-theme="lebron">
                        <div class="theme-preview theme-preview-lebron theme-preview-sun-only"></div>
                        <div class="theme-info">
                            <div class="theme-name">LeBron</div>
                            <div class="theme-desc">Premium 👑</div>
                        </div>
                        <div class="theme-check">✓</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Settings Widget Styles */
        .settings-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .settings-cog {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow-color);
            padding: 0;
        }

        .settings-cog:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--glow-color);
            border-color: var(--text-bright);
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        }

        .settings-cog svg {
            transition: transform 0.6s ease;
        }

        .settings-cog:hover svg {
            transform: rotate(90deg);
        }

        body.theme-lebron .settings-cog {
            background: transparent url("{% static 'auth_app/images/basketball.png' %}") center/70% no-repeat;
            border: 2px solid rgba(0,0,0,0.4);
            width: 56px;
            height: 56px;
        }

        body.theme-lebron .settings-cog svg {
            display: none;
        }

        body.theme-lebron .settings-cog:hover {
            transform: scale(1.1) rotate(45deg);
        }

        /* LeBron preview & sunshine icon */
        .theme-preview-lebron {
            position: relative;
            background: url("{% static 'auth_app/images/lebron.jpg' %}") center/cover;
        }
        .theme-icon-sun {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 22px;
            height: 22px;
            background: url("{% static 'auth_app/images/sunshine.png' %}") center/contain no-repeat;
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.5));
            pointer-events: none;
        }

        /* Sun-only preview for LeBron (premium) */
        .theme-preview-sun-only {
            background: radial-gradient(circle at center, #ffd54f 0%, #ffb300 60%, #ff8f00 100%);
            position: relative;
        }
        .theme-preview-sun-only::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: url("{% static 'auth_app/images/sunshine.png' %}") center/85% no-repeat;
            filter: drop-shadow(0 0 6px rgba(0,0,0,0.4));
        }

        /* Ace editor typography enhancements for LeBron */
        body.theme-lebron .ace_editor, 
        body.theme-lebron .ace_content, 
        body.theme-lebron .ace_line {
            font-weight: 600 !important;
            color: #111 !important;
            text-shadow: 0 0 0 transparent !important;
        }
        body.theme-lebron .ace_gutter-cell { font-weight: 600 !important; color: #222 !important; }
        body.theme-lebron .ace_keyword { font-weight: 700 !important; }
        body.theme-lebron .ace_string { font-weight: 600 !important; }
        body.theme-lebron .ace_comment { font-style: normal !important; font-weight: 500 !important; color: #444 !important; }
        body.theme-lebron .ace_variable, 
        body.theme-lebron .ace_identifier { font-weight: 600 !important; }

        /* Transparent code cells with black outlines for LeBron */
        body.theme-lebron .ace_editor,
        body.theme-lebron .ace_scroller,
        body.theme-lebron .ace_content {
            background: transparent !important;
            border: 2px solid rgba(0,0,0,0.6) !important;
        }
        body.theme-lebron .ace_gutter {
            background: transparent !important;
            border-right: 1px solid rgba(0,0,0,0.4) !important;
        }
        body.theme-lebron .ace_active-line {
            background: rgba(0,0,0,0.1) !important;
        }
        body.theme-lebron .ace_cursor {
            color: #000 !important;
            border-left: 2px solid #000 !important;
        }

        /* Notebook mode transparency for LeBron */
        body.theme-lebron.notebook-mode .container,
        body.theme-lebron.notebook-mode .main-area,
        body.theme-lebron.notebook-mode .editor-section,
        body.theme-lebron.notebook-mode .terminal-section,
        body.theme-lebron.notebook-mode .notebook-container,
        body.theme-lebron.notebook-mode .notebook-cell,
        body.theme-lebron.notebook-mode .cell-container,
        body.theme-lebron.notebook-mode .cell-input,
        body.theme-lebron.notebook-mode .cell-output,
        body.theme-lebron.notebook-mode .notebook-toolbar {
            background: transparent !important;
            border-color: rgba(0,0,0,0.4) !important;
        }
        
        body.theme-lebron.notebook-mode .notebook-cell {
            border: 2px solid rgba(0,0,0,0.6) !important;
            border-radius: 8px !important;
        }
        
        body.theme-lebron.notebook-mode .cell-type-indicator,
        body.theme-lebron.notebook-mode .cell-execution-count {
            color: #000 !important;
            font-weight: 600 !important;
        }

        .settings-dropdown {
            position: absolute;
            bottom: 60px;
            right: 0;
            width: 320px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow-color);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-height: 500px;
            overflow-y: auto;
        }

        .settings-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .settings-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            color: var(--text-bright);
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .settings-section {
            padding: 15px 20px;
        }

        .settings-label {
            display: block;
            color: var(--text-color);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .theme-selector {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-option:hover {
            border-color: var(--border-color);
            transform: translateX(5px);
            box-shadow: 0 2px 8px var(--glow-color);
        }

        .theme-option.active {
            border-color: var(--text-bright);
            background: var(--bg-tertiary);
            box-shadow: 0 4px 12px var(--glow-color);
        }

        .theme-preview {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            flex-shrink: 0;
        }

        .theme-info {
            flex: 1;
        }

        .theme-name {
            font-weight: bold;
            color: var(--text-bright);
            font-size: 12px;
            margin-bottom: 1px;
        }

        .theme-desc {
            font-size: 10px;
            color: #888;
        }

        .theme-check {
            color: var(--text-bright);
            font-size: 16px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .theme-option.active .theme-check {
            opacity: 1;
        }

        /* Scrollbar for dropdown */
        .settings-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .settings-dropdown::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .settings-dropdown::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
    </style>

    <script>
        // Settings Widget Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const settingsToggle = document.getElementById('settings-toggle');
            const settingsDropdown = document.getElementById('settings-dropdown');
            const themeOptions = document.querySelectorAll('.theme-option');

            // Get current theme from body class or default
            let currentTheme = document.body.classList.contains('theme-greydom') ? 'greydom' : 'default';

            // Set active theme on load
            updateActiveTheme(currentTheme);

            // Toggle dropdown
            settingsToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                settingsDropdown.classList.toggle('show');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!settingsDropdown.contains(e.target) && e.target !== settingsToggle) {
                    settingsDropdown.classList.remove('show');
                }
            });

            // Theme selection
            themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    changeTheme(theme);
                });
            });

            function updateActiveTheme(theme) {
                themeOptions.forEach(opt => {
                    if (opt.getAttribute('data-theme') === theme) {
                        opt.classList.add('active');
                    } else {
                        opt.classList.remove('active');
                    }
                });
            }

            function changeTheme(theme) {
                // Update body class
                document.body.classList.remove('theme-default', 'theme-greydom', 'theme-cloud', 'theme-chaos', 'theme-lebron');
                if (theme !== 'default') {
                    document.body.classList.add(`theme-${theme}`);
                }

                // Update loading screen class for LeBron theme
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.classList.remove('theme-lebron');
                    if (theme === 'lebron') {
                        loadingScreen.classList.add('theme-lebron');
                    }
                }

                // Update Ace Editor theme if it exists (both main editor and aceEditor variable)
                let aceTheme = 'ace/theme/terminal'; // default
                if (theme === 'greydom') {
                    aceTheme = 'ace/theme/monokai';
                } else if (theme === 'cloud') {
                    aceTheme = 'ace/theme/katzenmilch';
                } else if (theme === 'chaos') {
                    aceTheme = 'ace/theme/chaos';
                } else if (theme === 'lebron') {
                    aceTheme = 'ace/theme/terminal';
                }
                
                if (typeof editor !== 'undefined' && editor) {
                    editor.setTheme(aceTheme);
                }
                
                if (typeof aceEditor !== 'undefined' && aceEditor) {
                    aceEditor.setTheme(aceTheme);
                }

                // Update active state
                updateActiveTheme(theme);
                currentTheme = theme;

                // Save theme preference to server
                fetch('/auth/account/update-theme/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `theme=${theme}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Theme saved successfully');
                    }
                })
                .catch(error => console.error('Error saving theme:', error));
            }

            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });

        // Optimized LeBron bouncing basketball physics
        (function(){
            const screen = document.getElementById('loading-screen');
            if(!screen || !screen.classList.contains('theme-lebron')) return;
            const ball = screen.querySelector('.retro-computer');
            if(!ball) return;
            
            // Physics state
            let state = {
                x: ball.offsetLeft || 100,
                y: ball.offsetTop || 100,
                vx: 120, vy: 60,
                dragging: false,
                lastTime: 0
            };
            
            // Cached constants for performance
            const physics = {
                gravity: 400,
                elasticity: 0.8,
                friction: 0.998,
                minVelocity: 0.5,
                ballSize: 180
            };
            
            let bounds = screen.getBoundingClientRect();
            let boundsCache = Date.now();
            
            // Optimized frame loop with 60fps throttling
            function frame(ts) {
                // Throttle to ~60fps max
                if (ts - state.lastTime < 16) {
                    requestAnimationFrame(frame);
                    return;
                }
                
                const dt = Math.min((ts - state.lastTime) / 1000, 0.033); // Cap dt
                state.lastTime = ts;
                
                if (!state.dragging) {
                    // Update physics
                    state.vy += physics.gravity * dt;
                    state.x += state.vx * dt;
                    state.y += state.vy * dt;
                    
                    // Refresh bounds cache every 500ms
                    if (ts - boundsCache > 500) {
                        bounds = screen.getBoundingClientRect();
                        boundsCache = ts;
                    }
                    
                    // Collision detection with bounds
                    const maxX = bounds.width - physics.ballSize;
                    const maxY = bounds.height - physics.ballSize;
                    
                    if (state.x <= 0) {
                        state.x = 0;
                        state.vx = Math.abs(state.vx) * physics.elasticity;
                    } else if (state.x >= maxX) {
                        state.x = maxX;
                        state.vx = -Math.abs(state.vx) * physics.elasticity;
                    }
                    
                    if (state.y <= 0) {
                        state.y = 0;
                        state.vy = Math.abs(state.vy) * physics.elasticity;
                    } else if (state.y >= maxY) {
                        state.y = maxY;
                        state.vy = -Math.abs(state.vy) * physics.elasticity;
                    }
                    
                    // Apply friction and minimum velocity
                    state.vx *= physics.friction;
                    state.vy *= physics.friction;
                    
                    if (Math.abs(state.vx) < physics.minVelocity) state.vx = 0;
                    if (Math.abs(state.vy) < physics.minVelocity && state.y >= maxY - 1) state.vy = 0;
                    
                    // Batch DOM updates
                    ball.style.transform = `translate(${state.x}px, ${state.y}px)`;
                }
                
                requestAnimationFrame(frame);
            }
            
            // Initialize position and start loop
            ball.style.position = 'absolute';
            ball.style.left = '0px';
            ball.style.top = '0px';
            requestAnimationFrame(frame);
            
            // Click teleportation handler
            screen.addEventListener('click', e => {
                const screenRect = screen.getBoundingClientRect();
                const targetX = e.clientX - screenRect.left - physics.ballSize / 2;
                const targetY = e.clientY - screenRect.top - physics.ballSize / 2;
                
                // Constrain to bounds
                state.x = Math.max(0, Math.min(targetX, screenRect.width - physics.ballSize));
                state.y = Math.max(0, Math.min(targetY, screenRect.height - physics.ballSize));
                
                // Add some random velocity after teleport for fun physics
                state.vx = (Math.random() - 0.5) * 300;
                state.vy = (Math.random() - 0.5) * 200;
                
                e.preventDefault();
            });
        })();

        // Add keyboard shortcuts for better UX
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter or F5 to run code
                if ((e.ctrlKey && e.key === 'Enter') || e.key === 'F5') {
                    e.preventDefault();
                    executeCode();
                }
                
                // Ctrl+S to save (if logged in)
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (isLoggedIn) {
                        saveUserData();
                        updateTerminal("💾 Code auto-saved!\n");
                    }
                }
                
                // Escape to close modal (if any)
                if (e.key === 'Escape') {
                    const modal = document.getElementById('inputModal');
                    if (modal && modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                }
            });
        }

        // Helper function to test input functionality
        function testInputFunction() {
            const testCode = `
name = input("What's your name? ")
age = input("How old are you? ")
print(f"Hello {name}! You are {age} years old.")
            `;
            if (aceEditor) {
                aceEditor.setValue(testCode);
                updateTerminal("🧪 Test code loaded! Click 'Run Python Code' to test the input() function.\n");
            }
        }

        // Initialize keyboard shortcuts when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setupKeyboardShortcuts();
            
            // Show helpful tips on load
            setTimeout(() => {
                updateTerminal("🚀 PYTHON ASSEMBLY - Online Python IDE Ready!\n");
                updateTerminal("💡 Keyboard Shortcuts:\n");
                updateTerminal("   • Ctrl+Enter or F5: Run code\n");
                updateTerminal("   • Ctrl+S: Save your work\n");
                updateTerminal("   • ESC: Close dialogs\n");
                updateTerminal("   • input() function works with popup dialogs\n\n");
            }, 1000);
        });
    </script>

    <!-- Package Installer Widget -->
    <div class="package-installer collapsed" id="packageInstaller">
        <div class="package-installer-header" onclick="togglePackageInstaller()">
            <span>📦 Package Manager</span>
            <span class="package-installer-toggle">▲</span>
        </div>
        <div class="package-installer-body">
            <div class="quick-packages">
                <div class="quick-package-btn" onclick="installQuickPackage('requests')">requests</div>
                <div class="quick-package-btn" onclick="installQuickPackage('beautifulsoup4')">bs4</div>
                <div class="quick-package-btn" onclick="installQuickPackage('scipy')">scipy</div>
                <div class="quick-package-btn" onclick="installQuickPackage('pillow')">pillow</div>
                <div class="quick-package-btn" onclick="installQuickPackage('sympy')">sympy</div>
            </div>
            <div class="package-input-group">
                <input type="text" class="package-input" id="packageInput" placeholder="Package name (e.g., requests, numpy)" onkeypress="handlePackageInputKeypress(event)">
                <button class="package-install-btn" onclick="installPackage()" id="installBtn">Install</button>
            </div>
            <div class="package-status" id="packageStatus">
                <div class="status-info">🚀 Ready to install packages...</div>
                <div class="status-info">💡 Try: requests, beautifulsoup4, scipy, pillow, sympy</div>
            </div>
        </div>
    </div>

    <script>
        let packageInstallerExpanded = false;

        function togglePackageInstaller() {
            const installer = document.getElementById('packageInstaller');
            packageInstallerExpanded = !packageInstallerExpanded;
            
            if (packageInstallerExpanded) {
                installer.classList.remove('collapsed');
                installer.classList.add('expanded');
            } else {
                installer.classList.remove('expanded');
                installer.classList.add('collapsed');
            }
        }

        function updatePackageStatus(message, type = 'info') {
            const statusDiv = document.getElementById('packageStatus');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : '💬';
            
            const statusMessage = document.createElement('div');
            statusMessage.className = `status-${type}`;
            statusMessage.innerHTML = `<span style="opacity: 0.6">[${timestamp}]</span> ${icon} ${message}`;
            
            statusDiv.appendChild(statusMessage);
            statusDiv.scrollTop = statusDiv.scrollHeight;
            
            // Keep only last 10 messages
            while (statusDiv.children.length > 10) {
                statusDiv.removeChild(statusDiv.firstChild);
            }
        }

        async function installPackage() {
            const packageInput = document.getElementById('packageInput');
            const installBtn = document.getElementById('installBtn');
            const packageName = packageInput.value.trim();
            
            if (!packageName) {
                updatePackageStatus('Please enter a package name', 'error');
                return;
            }
            
            if (!window.pyodide) {
                updatePackageStatus('Pyodide not ready yet. Please wait...', 'error');
                return;
            }
            
            installBtn.disabled = true;
            installBtn.textContent = 'Installing...';
            
            try {
                updatePackageStatus(`Installing ${packageName}...`, 'info');
                
                // Try micropip first
                try {
                    await window.pyodide.runPython(`
                        import micropip
                        await micropip.install('${packageName}')
                    `);
                    updatePackageStatus(`✨ Successfully installed ${packageName} via micropip`, 'success');
                } catch (micropipError) {
                    // Fallback to pyodide.loadPackage for built-in packages
                    try {
                        await window.pyodide.loadPackage(packageName);
                        updatePackageStatus(`✨ Successfully loaded ${packageName} via pyodide`, 'success');
                    } catch (loadError) {
                        throw new Error(`Both micropip and pyodide.loadPackage failed: ${micropipError.message}`);
                    }
                }
                
                packageInput.value = '';
                
            } catch (error) {
                console.error('Package installation error:', error);
                updatePackageStatus(`Failed to install ${packageName}: ${error.message}`, 'error');
            } finally {
                installBtn.disabled = false;
                installBtn.textContent = 'Install';
            }
        }

        function installQuickPackage(packageName) {
            document.getElementById('packageInput').value = packageName;
            installPackage();
        }

        function handlePackageInputKeypress(event) {
            if (event.key === 'Enter') {
                installPackage();
            }
        }

        // Auto-expand on first visit
        setTimeout(() => {
            if (!packageInstallerExpanded) {
                togglePackageInstaller();
                updatePackageStatus('🎉 Package installer ready! Click quick buttons or type package names.', 'success');
            }
        }, 2000);
    </script>

</body>
</html>
