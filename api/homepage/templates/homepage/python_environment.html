{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLASS 12 PYTHON ASSEMBLY</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'auth_app/favicon.ico' %}">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'auth_app/favicon.ico' %}">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4GQ8NQ38P5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4GQ8NQ38P5');
    </script>
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/theme-monokai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/theme-katzenmilch.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/theme-chaos.min.js"></script>
    
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        :root {
            --primary-color: #00aa00;
            --secondary-color: #008800;
            --tertiary-color: #006600;
            --bg-primary: #000000;
            --bg-secondary: #020202;
            --bg-tertiary: #050505;
            --border-color: #008800;
            --text-color: #00cc00;
            --text-bright: #00ff00;
            --shadow-color: rgba(0, 136, 0, 0.4);
            --glow-color: rgba(0, 136, 0, 0.15);
            --grid-color: rgba(0, 136, 0, 0.03);
        }

        body.theme-greydom {
            --primary-color: #ff4444;
            --secondary-color: #cc3333;
            --tertiary-color: #aa2222;
            --bg-primary: #1a1d2e;
            --bg-secondary: #16192a;
            --bg-tertiary: #212435;
            --border-color: #ff4444;
            --text-color: #ff6666;
            --text-bright: #ff4444;
            --shadow-color: rgba(255, 68, 68, 0.4);
            --glow-color: rgba(255, 68, 68, 0.15);
            --grid-color: rgba(100, 120, 150, 0.05);
        }

        body.theme-cloud {
            --primary-color: #000000;
            --secondary-color: #1a1a1a;
            --tertiary-color: #2d2d2d;
            --bg-primary: #ffffff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5f5f5;
            --border-color: #cccccc;
            --text-color: #000000;
            --text-bright: #000000;
            --shadow-color: rgba(0, 0, 0, 0.15);
            --glow-color: rgba(0, 0, 0, 0.05);
            --grid-color: rgba(0, 0, 0, 0.03);
        }

        body.theme-chaos {
            --primary-color: #808080;
            --secondary-color: #666666;
            --tertiary-color: #4d4d4d;
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #141414;
            --border-color: #808080;
            --text-color: #b0b0b0;
            --text-bright: #d0d0d0;
            --shadow-color: rgba(128, 128, 128, 0.3);
            --glow-color: rgba(128, 128, 128, 0.1);
            --grid-color: rgba(128, 128, 128, 0.05);
        }

        body.theme-lebron {
            --primary-color: #000000;
            --secondary-color: #000000;
            --tertiary-color: #000000;
            --bg-primary: transparent;
            --bg-secondary: transparent;
            --bg-tertiary: transparent;
            --border-color: #000000;
            --text-color: #000000;
            --text-bright: #000000;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --glow-color: rgba(0, 0, 0, 0.1);
            --grid-color: rgba(0, 0, 0, 0.05);
            background: transparent !important;
        }

        body.theme-lebron::before {
            background-image: url("{% static 'auth_app/images/lebron.jpg' %}") !important;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            opacity: 1;
            z-index: -1;
            /* Remove the grid overlay */
            background-blend-mode: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 15%, var(--bg-primary) 30%, var(--bg-tertiary) 45%, var(--bg-primary) 60%, var(--bg-secondary) 75%, var(--bg-primary) 90%, var(--bg-tertiary) 100%);
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    var(--grid-color) 2px,
                    var(--grid-color) 4px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    var(--grid-color) 2px,
                    var(--grid-color) 4px
                );
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            height: 100vh;
            gap: 0;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.8s ease-in-out, visibility 0.8s;
        }

        .container.ready {
            opacity: 1;
            visibility: visible;
        }

        .container.ready .file-manager {
            animation: slideInLeft 0.8s ease-out 0.2s both;
        }

        .container.ready .main-area {
            animation: slideInUp 0.8s ease-out 0.4s both;
        }

        .container.ready .file-viewers {
            animation: slideInRight 0.8s ease-out 0.6s both;
        }


        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: var(--text-color);
            overflow: hidden;
        }

        .loading-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                var(--grid-color) 2px,
                var(--grid-color) 4px
            );
            animation: scanlines 2s linear infinite;
            pointer-events: none;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 1s ease-out, visibility 1s;
        }

        .loading-title {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 
                0 0 10px var(--secondary-color),
                0 0 20px var(--secondary-color),
                0 0 40px var(--secondary-color);
            animation: bootSequence 3s ease-in-out infinite;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        /* Loader Animation Styles */
        .loader {
            width: 64px;
            height: 64px;
            position: relative;
            background: var(--bg-secondary);
            border: 3px solid var(--secondary-color);
            box-shadow: 
                0 0 20px var(--secondary-color),
                inset 0 0 20px rgba(0, 255, 255, 0.1);
            animation: pixelSpin 1s linear infinite;
        }

        .loader::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 2px solid var(--primary-color);
            animation: pixelSpin 2s linear infinite reverse;
        }

        .loader::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: var(--secondary-color);
            box-shadow: 0 0 15px var(--secondary-color);
            animation: pixelPulse 1s ease-in-out infinite;
        }

        @keyframes pixelSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pixelPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0.5;
            }
        }

        .pixel-loader-text {
            font-size: 1.2em;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--secondary-color);
            text-shadow: 0 0 10px var(--secondary-color);
            animation: loadingTextPulse 1.5s ease-in-out infinite;
        }

        @keyframes loadingTextPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }



        @keyframes pixelGlow {
            0% { 
                text-shadow: 
                    2px 2px 0px var(--tertiary-color),
                    4px 4px 0px var(--bg-tertiary),
                    0 0 20px var(--secondary-color),
                    0 0 40px var(--secondary-color);
                transform: scale(1);
            }
            100% { 
                text-shadow: 
                    2px 2px 0px var(--tertiary-color),
                    4px 4px 0px var(--tertiary-color),
                    0 0 30px var(--primary-color),
                    0 0 60px var(--primary-color);
                transform: scale(1.02);
            }
        }

        .retro-computer {
            width: 80px;
            height: 60px;
            border: 3px solid var(--secondary-color);
            border-radius: 4px;
            position: relative;
            margin-bottom: 20px;
            background: var(--bg-primary);
            animation: computerBoot 2s ease-in-out infinite;
        }

        .retro-computer::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 15px;
            background: var(--secondary-color);
            opacity: 0.1;
            animation: screenFlicker 1.5s ease-in-out infinite;
        }

        .retro-computer::after {
            content: '█';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--secondary-color);
            font-size: 16px;
            animation: pixelBlink 1s infinite;
        }

        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: var(--secondary-color);
            margin: 0 3px;
            animation: dotPulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 10px var(--secondary-color);
        }

        .loading-dot:nth-child(1) { animation-delay: 0s; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        .loading-dot:nth-child(4) { animation-delay: 0.6s; }
        .loading-dot:nth-child(5) { animation-delay: 0.8s; }

        .loading-text {
            font-size: 1.2em;
            opacity: 0.8;
            animation: typeWriter 2s steps(20) infinite;
            border-right: 2px solid var(--secondary-color);
            white-space: nowrap;
            overflow: hidden;
            max-width: fit-content;
        }

        .loading-progress {
            margin-top: 20px;
            font-size: 0.9em;
            opacity: 0.6;
            animation: progressFade 1.5s ease-in-out infinite alternate;
        }

        .boot-sequence {
            position: absolute;
            top: 10%;
            left: 10%;
            right: 10%;
            color: var(--secondary-color);
            font-size: 12px;
            animation: bootText 3s ease-in-out;
            opacity: 0.7;
        }

        .progress-bar {
            width: 300px;
            height: 4px;
            background: var(--glow-color);
            border: 1px solid var(--border-color);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--secondary-color) 50%, 
                transparent 100%);
            width: 0%;
            animation: progressLoad 3s ease-in-out infinite;
            box-shadow: 0 0 10px var(--secondary-color);
        }

        @keyframes scanlines {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }

        @keyframes bootSequence {
            0%, 100% { 
                opacity: 1; 
                text-shadow: 
                    0 0 10px var(--secondary-color),
                    0 0 20px var(--secondary-color),
                    0 0 40px var(--secondary-color);
            }
            50% { 
                opacity: 0.7; 
                text-shadow: 
                    0 0 5px var(--secondary-color),
                    0 0 10px var(--secondary-color),
                    0 0 20px var(--secondary-color);
            }
        }

        @keyframes computerBoot {
            0%, 100% { 
                border-color: var(--secondary-color); 
                box-shadow: 0 0 20px var(--glow-color);
            }
            50% { 
                border-color: var(--tertiary-color); 
                box-shadow: 0 0 40px var(--shadow-color);
            }
        }

        @keyframes screenFlicker {
            0%, 100% { opacity: 0.1; }
            50% { opacity: 0.3; }
        }

        @keyframes pixelBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes dotPulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 0.5;
                box-shadow: 0 0 10px var(--secondary-color);
            }
            50% { 
                transform: scale(1.5); 
                opacity: 1;
                box-shadow: 0 0 20px var(--secondary-color);
            }
        }

        @keyframes typeWriter {
            0% { width: 0; }
            50% { width: 100%; }
            100% { width: 0; }
        }

        @keyframes progressFade {
            0% { opacity: 0.4; }
            100% { opacity: 0.8; }
        }

        @keyframes basketballSpin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .loading-screen.theme-lebron {
            background: #ffb3d9 !important;
        }

        .loading-screen.theme-lebron::before {
            display: none;
        }

        .loading-screen.theme-lebron .loading-title {
            color: #000000 !important;
            text-shadow: none !important;
        }

        .loading-screen.theme-lebron .retro-computer {
            width: 180px; /* enlarged for prominence */
            height: 180px;
            border: none;
            background: transparent url("{% static 'auth_app/images/basketball.png' %}") center/70% no-repeat;
            animation: basketballSpin 3s linear infinite;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
        }

        .loading-screen.theme-lebron .retro-computer::before,
        .loading-screen.theme-lebron .retro-computer::after {
            display: none;
        }

        .loading-screen.theme-lebron .loading-dot {
            background: #000000;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .loading-screen.theme-lebron .loading-progress {
            color: #000000 !important;
        }

        @keyframes bootText {
            0% { opacity: 0; transform: translateY(20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        @keyframes progressLoad {
            0% { width: 0%; transform: translateX(-100%); }
            50% { width: 100%; transform: translateX(0%); }
            100% { width: 0%; transform: translateX(100%); }
        }


        @keyframes slideInLeft {
            0% { 
                opacity: 0; 
                transform: translateX(-100px);
            }
            100% { 
                opacity: 1; 
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            0% { 
                opacity: 0; 
                transform: translateX(100px);
            }
            100% { 
                opacity: 1; 
                transform: translateX(0);
            }
        }

        @keyframes slideInUp {
            0% { 
                opacity: 0; 
                transform: translateY(50px);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0);
            }
        }


        @keyframes crtScanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(100%); }
        }

        @keyframes crtGlow {
            0% { 
                opacity: 0.8;
                filter: blur(0.5px);
            }
            100% { 
                opacity: 1;
                filter: blur(0.3px);
            }
        }

        @keyframes terminalBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--secondary-color); }
        }


        @keyframes selectedPulse {
            0%, 100% { 
                box-shadow: 0 0 15px var(--glow-color);
                border-color: var(--secondary-color);
            }
            50% { 
                box-shadow: 0 0 25px var(--shadow-color);
                border-color: var(--tertiary-color);
            }
        }

        .file-manager {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 20%, var(--bg-primary) 40%, var(--bg-tertiary) 60%, var(--bg-primary) 80%, var(--bg-secondary) 100%);
            border-right: 1px solid var(--border-color);
            padding: 10px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) var(--bg-primary);
            position: relative;
            z-index: 2;
            box-shadow: inset 0 0 20px var(--glow-color);
        }

        .file-manager::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 20px,
                var(--grid-color) 20px,
                var(--grid-color) 21px
            );
            pointer-events: none;
            z-index: -1;
        }

        .file-manager h3 {
            color: var(--text-bright);
            margin-bottom: 15px;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            text-shadow: 0 0 10px var(--text-bright);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-manager::-webkit-scrollbar {
            width: 8px;
        }

        .file-manager::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .file-manager::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--secondary-color), var(--tertiary-color));
            border-radius: 4px;
            box-shadow: 0 0 5px var(--glow-color);
        }

        .file-manager::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--tertiary-color), var(--secondary-color));
        }

        .file-list {
            list-style: none;
        }

        .file-item {
            padding: 8px 10px;
            margin: 2px 0;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            color: var(--text-color);
            transition: all 0.3s ease;
            word-break: break-all;
            position: relative;
            border: 1px solid transparent;
        }

        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, 
                var(--glow-color) 0%, 
                var(--shadow-color) 50%, 
                var(--glow-color) 100%);
            transition: width 0.3s ease;
            z-index: -1;
        }

        .file-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
            color: var(--text-bright);
            text-shadow: 0 0 5px var(--text-bright);
            transform: translateX(5px);
        }

        .file-item:hover::before {
            width: 100%;
        }

        .file-item.selected {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
            color: var(--text-bright);
            text-shadow: 0 0 10px var(--text-bright);
            box-shadow: 0 0 15px var(--shadow-color);
            animation: selectedPulse 2s ease-in-out infinite;
        }

        body.theme-lebron .file-item::after {
            /* Remove small per-file icon for cleaner premium aesthetic */
            content: none;
        }

        /* LeBron Theme - Make ALL backgrounds transparent */
        body.theme-lebron .file-manager,
        body.theme-lebron .editor-section,
        body.theme-lebron .terminal-section,
        body.theme-lebron .file-manager::before,
        body.theme-lebron .editor-section::before,
        body.theme-lebron .terminal-section::before,
        body.theme-lebron .container,
        body.theme-lebron section,
        body.theme-lebron .editor-container,
        body.theme-lebron .editor-container::before,
        body.theme-lebron .terminal-container,
        body.theme-lebron .output-container,
        body.theme-lebron .terminal-output,
        body.theme-lebron .file-controls,
        body.theme-lebron .header,
        body.theme-lebron .header-title,
        body.theme-lebron .toolbar {
            background: transparent !important;
            box-shadow: none !important;
        }

        body.theme-lebron .file-manager,
        body.theme-lebron .editor-section,
        body.theme-lebron .terminal-section {
            border-color: rgba(0, 0, 0, 0.3) !important;
        }

        body.theme-lebron .file-button,
        body.theme-lebron .btn,
        body.theme-lebron button {
            background: rgba(255, 255, 255, 0.2) !important;
            color: #000000 !important;
            border-color: #000000 !important;
        }

        body.theme-lebron .file-button:hover,
        body.theme-lebron .btn:hover,
        body.theme-lebron button:hover {
            background: rgba(255, 255, 255, 0.4) !important;
        }

        body.theme-lebron .settings-dropdown {
            background: rgba(255, 255, 255, 0.95) !important;
            border-color: #000000 !important;
        }

        body.theme-lebron .theme-option {
            background: rgba(255, 255, 255, 0.5) !important;
        }

        body.theme-lebron .theme-option:hover,
        body.theme-lebron .theme-option.active {
            background: rgba(255, 255, 255, 0.8) !important;
        }

        .file-controls {
            margin-bottom: 15px;
        }

        .file-input {
            width: 100%;
            padding: 8px;
            background: #222;
            border: 1px solid #333;
            color: #fff;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .file-button {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .file-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--glow-color) 50%,
                transparent 100%);
            transition: left 0.5s ease;
        }

        .file-button:hover {
            background: var(--bg-secondary);
            border-color: var(--text-bright);
            color: var(--text-bright);
            text-shadow: 0 0 10px var(--text-bright);
            box-shadow: 0 0 15px var(--shadow-color);
            transform: translateY(-2px);
        }

        .file-button:hover::before {
            left: 100%;
        }

        .file-button:active {
            transform: translateY(0);
            box-shadow: 0 0 5px var(--shadow-color);
        }

        .main-area {
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 30%, var(--bg-primary) 70%, var(--bg-tertiary) 100%);
        }

        .editor-section {
            flex: 1;
            padding: 0;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            z-index: 1;
            min-height: 0;
        }

        .editor-container {
            position: relative;
            height: 100%;
            max-height: 100%;
            overflow: hidden;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            box-shadow: inset 0 0 20px var(--glow-color);
        }

        .editor-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 100px,
                rgba(0, 136, 0, 0.02) 100px,
                rgba(0, 136, 0, 0.02) 101px
            );
            pointer-events: none;
            z-index: 1;
        }

        .syntax-highlight-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            padding: 15px;
            margin: 0;
            border: 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: normal;
            font-style: normal;
            line-height: 1.5;
            letter-spacing: 0;
            word-spacing: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: normal;
            overflow-wrap: break-word;
            text-rendering: auto;
            -webkit-font-smoothing: auto;
            -moz-osx-font-smoothing: auto;
            font-variant: normal;
            font-stretch: normal;

            pointer-events: none;
            z-index: 2;
            overflow: auto;
            background: #000;
            color: #fff;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            scrollbar-width: none;
            -ms-overflow-style: none;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
        }

        .syntax-highlight-overlay::-webkit-scrollbar {
            display: none;
        }

        .editor-textarea {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            color: transparent;
            caret-color: var(--secondary-color);
            border: 0;
            margin: 0;
            padding: 15px;

            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: normal;
            font-style: normal;
            line-height: 1.5;
            letter-spacing: 0;
            word-spacing: 0;

            resize: none;
            outline: none;
            tab-size: 4;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: normal;
            overflow-wrap: break-word;
            text-rendering: auto;
            -webkit-font-smoothing: auto;
            -moz-osx-font-smoothing: auto;
            font-variant: normal;
            font-stretch: normal;

            z-index: 3;
            box-sizing: border-box;
            overflow: auto;

            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) #111;
            transition: all 0.3s ease;
        }

        .editor-textarea:focus {
            caret-color: var(--secondary-color);
            filter: drop-shadow(0 0 5px rgba(0, 136, 0, 0.5));
        }

        .editor-textarea::selection {
            background: rgba(0, 136, 0, 0.3);
        }

        .editor-textarea::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .editor-textarea::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
            border: 1px solid #333;
        }

        .editor-textarea::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--secondary-color), var(--tertiary-color));
            border-radius: 6px;
            border: 2px solid #111;
            box-shadow: 0 0 10px var(--shadow-color);
        }

        .editor-textarea::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--tertiary-color), var(--secondary-color));
            box-shadow: 0 0 15px var(--shadow-color);
        }

        .editor-textarea::-webkit-scrollbar-corner {
            background: #111;
        }


        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9998;
            display: none;
            flex-direction: column;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 20px;
            border: 1px solid #333;
            border-radius: 5px;
            overflow: hidden;
        }

        .fullscreen-editor .editor-header {
            background: #111;
            border-bottom: 1px solid #333;
        }

        .fullscreen-editor .editor-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        .fullscreen-editor .editor-textarea,
        .fullscreen-editor .syntax-highlight-overlay {
            height: 100%;
        }

        .editor-header {
            background: #111;
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .editor-header h2 {
            font-size: 14px;
            margin: 0;
        }

        .editor-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Enhanced Focus and Notebook Mode Buttons */
        .focus-button {
            background: linear-gradient(45deg, var(--bg-primary) 0%, var(--secondary-color) 50%, var(--bg-primary) 100%);
            border: 2px solid var(--border-color);
            color: #ffffff;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 10px var(--glow-color);
        }

        .focus-button:hover {
            background: linear-gradient(45deg, var(--secondary-color) 0%, var(--primary-color) 50%, var(--secondary-color) 100%);
            box-shadow: 0 0 15px var(--glow-color);
            transform: translateY(-2px);
        }

        .focus-button:active {
            transform: translateY(0);
            box-shadow: 0 0 10px var(--shadow-color);
        }

        .focus-button.active {
            background: linear-gradient(45deg, var(--primary-color) 0%, var(--text-bright) 50%, var(--primary-color) 100%);
            border-color: var(--primary-color);
            box-shadow: 0 0 15px var(--shadow-color);
        }

        /* 8-Bit Pixel Button Style - Theme Responsive */
        .pixel-button {
            background: var(--bg-secondary);
            border: 3px solid var(--border-color);
            color: var(--text-bright);
            padding: 8px 14px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            box-shadow: 
                3px 3px 0px var(--tertiary-color),
                6px 6px 0px var(--bg-tertiary);
            transition: all 0.1s ease;
        }

        .pixel-button:hover {
            background: var(--secondary-color);
            box-shadow: 
                3px 3px 0px var(--primary-color),
                6px 6px 0px var(--secondary-color),
                0 0 20px var(--glow-color);
            transform: translate(-1px, -1px);
        }

        .pixel-button:active {
            transform: translate(3px, 3px);
            box-shadow: none;
        }

        .pixel-button.active {
            background: var(--primary-color);
            border-color: var(--text-bright);
            box-shadow: 
                inset 2px 2px 0px var(--tertiary-color),
                0 0 15px var(--glow-color);
        }


        .expand-button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 5px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .expand-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--glow-color) 50%,
                transparent 100%);
            transition: left 0.3s ease;
        }

        .expand-button:hover {
            background: #555;
            border-color: var(--text-bright);
            color: var(--text-bright);
            text-shadow: 0 0 5px var(--text-bright);
            transform: scale(1.1);
        }

        .expand-button:hover::before {
            left: 100%;
        }

        .expand-button:active {
            background: #222;
            transform: scale(0.95);
        }


        .python-keyword { 
            color: #ff6b6b; 
            font-weight: bold; 
            text-shadow: 0 0 5px #ff6b6b;
            transition: all 0.3s ease;
        }
        .python-string { 
            color: #4ecdc4; 
            text-shadow: 0 0 3px #4ecdc4;
        }
        .python-comment { 
            color: #95e1d3; 
            font-style: italic; 
            opacity: 0.8;
            text-shadow: 0 0 2px #95e1d3;
        }
        .python-number { 
            color: #fce38a; 
            text-shadow: 0 0 3px #fce38a;
        }
        .python-function { 
            color: #c7ceea; 
            text-shadow: 0 0 3px #c7ceea;
            transition: all 0.3s ease;
        }
        .python-operator { 
            color: #ff8a80; 
            font-weight: bold;
            text-shadow: 0 0 2px #ff8a80;
        }
        .python-builtin { 
            color: #81c784; 
            cursor: help; 
            pointer-events: auto;
            text-shadow: 0 0 5px #81c784;
            transition: all 0.3s ease;
        }
        .python-builtin:hover {
            color: var(--text-bright);
            text-shadow: 0 0 10px var(--text-bright);
            transform: scale(1.05);
        }
        .python-default { 
            color: #fff; 
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
        }


        .python-tooltip {
            position: absolute;
            background: #2a2a2a;
            border: 1px solid var(--border-color);
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 2px 8px var(--shadow-color);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .python-tooltip.show {
            opacity: 1;
        }

        .python-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 10px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid var(--border-color);
        }

        .terminal-section {
            height: 300px;
            background: #000;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            z-index: 2;
            flex-shrink: 0;
        }

        .terminal-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                var(--grid-color) 2px,
                var(--grid-color) 4px
            );
            pointer-events: none;
            z-index: 1;
            animation: crtScanlines 2s linear infinite;
        }

        .terminal-section::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, 
                var(--glow-color) 0%, 
                var(--glow-color) 50%, 
                rgba(0, 0, 0, 0.3) 100%);
            pointer-events: none;
            z-index: 1;
            animation: crtGlow 3s ease-in-out infinite alternate;
        }

        .terminal-header {
            background: #111;
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .terminal-header h2 {
            font-size: 14px;
            margin: 0;
        }

        .execute-button {
            background: linear-gradient(45deg, var(--tertiary-color) 0%, var(--secondary-color) 50%, var(--tertiary-color) 100%);
            border: 1px solid var(--border-color);
            color: #ffffff;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 8px var(--glow-color);
        }

        .execute-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--shadow-color) 50%,
                transparent 100%);
            transition: left 0.4s ease;
        }

        .execute-button:hover {
            background: var(--text-bright);
            color: var(--bg-primary);
            border-color: var(--text-bright);
            text-shadow: none;
            box-shadow: 0 0 20px var(--shadow-color);
            transform: translateY(-2px) scale(1.02);
        }

        .execute-button:hover::before {
            left: 100%;
        }

        .execute-button:active {
            transform: translateY(0) scale(0.98);
        }

        .execute-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .terminal-output {
            flex: 1;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 30%, var(--bg-primary) 70%, var(--bg-tertiary) 100%);
            color: var(--text-color);
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            overflow-y: auto;
            white-space: pre-wrap;
            border: none;
            resize: none;
            outline: none;
            position: relative;
            z-index: 2;
            text-shadow: 0 0 1px var(--text-color);
            scrollbar-width: thin;
            scrollbar-color: var(--text-bright) var(--bg-secondary);
        }


        .terminal-output img {
            display: block;
            margin: 10px 0;
            max-width: 100%;
            height: auto;
            border: 2px solid var(--text-bright);
            border-radius: 8px;
            box-shadow: 0 0 15px var(--shadow-color);
            background: #fff;
            padding: 5px;
        }

        /* Custom scrollbars for all elements */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--secondary-color) 0%, var(--tertiary-color) 50%, var(--secondary-color) 100%);
            border-radius: 5px;
            box-shadow: 0 0 3px var(--secondary-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 50%, var(--primary-color) 100%);
            box-shadow: 0 0 5px var(--secondary-color);
        }

        .terminal-output::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-output::-webkit-scrollbar-track {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
        }

        .terminal-output::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--secondary-color) 0%, var(--tertiary-color) 50%, var(--secondary-color) 100%);
            border-radius: 4px;
            box-shadow: 0 0 3px var(--secondary-color);
        }

        .terminal-output.error {
            color: #ff4444;
            text-shadow: 0 0 5px #ff4444;
        }

        .terminal-cursor::after {
            content: '█';
            animation: terminalBlink 1s infinite;
            color: var(--text-bright);
            text-shadow: 0 0 10px var(--text-bright);
        }

        .terminal-typing {
            overflow: hidden;
            border-right: 2px solid var(--text-bright);
            white-space: nowrap;
            margin: 0 auto;
            animation: 
                typing 2s steps(40, end),
                blink-caret 0.75s step-end infinite;
        }

        .terminal-input-line {
            display: none;
            color: var(--text-bright);
            background: transparent;
            border: none;
            outline: none;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            width: 100%;
            margin: 0;
            padding: 0;
            padding: 0;
        }

        .terminal-prompt {
            color: var(--text-bright);
        }

        .file-viewers {
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 20%, var(--bg-primary) 40%, var(--bg-tertiary) 60%, var(--bg-primary) 80%, var(--bg-secondary) 100%);
            border-left: 1px solid var(--border-color);
            padding: 10px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) var(--bg-primary);
            position: relative;
            z-index: 2;
            box-shadow: inset 0 0 20px var(--glow-color);
        }

        .file-viewers::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                -45deg,
                transparent,
                transparent 20px,
                var(--grid-color) 20px,
                var(--grid-color) 21px
            );
            pointer-events: none;
            z-index: -1;
        }

        .file-viewers::-webkit-scrollbar {
            width: 8px;
        }

        .file-viewers::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .file-viewers::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--text-bright), var(--text-color));
            border-radius: 4px;
            box-shadow: 0 0 5px var(--glow-color);
        }

        .file-viewers::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--text-color), var(--text-bright));
        }

        .file-viewer {
            margin-bottom: 20px;
        }

        .file-viewer h3 {
            color: var(--text-bright);
            margin-bottom: 10px;
            font-size: 12px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            text-shadow: 0 0 5px var(--text-bright);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-content {
            background: 
                linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-color);
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.3;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            scrollbar-width: thin;
            scrollbar-color: var(--text-bright) var(--bg-secondary);
            border-radius: 3px;
            box-shadow: inset 0 0 10px var(--glow-color);
            transition: all 0.3s ease;
        }

        .file-content:hover {
            border-color: var(--text-bright);
            box-shadow: 
                inset 0 0 10px var(--glow-color),
                0 0 15px var(--shadow-color);
        }

        .file-content::-webkit-scrollbar {
            width: 6px;
        }

        .file-content::-webkit-scrollbar-track {
            background: #000000;
            border-radius: 3px;
        }

        .file-content::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--text-bright), var(--primary-color));
            border-radius: 3px;
            box-shadow: 0 0 3px var(--shadow-color);
        }

        .binary-hex {
            color: #888;
            font-size: 10px;
        }

        .status-bar {
            background: 
                linear-gradient(90deg, #111 0%, var(--bg-secondary) 50%, #111 100%);
            padding: 5px 15px;
            border-top: 1px solid #333;
            font-size: 11px;
            color: var(--text-bright);
            text-shadow: 0 0 5px var(--text-bright);
            position: relative;
            z-index: 2;
        }

        .status-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--text-bright) 50%, 
                transparent 100%);
            animation: statusGlow 3s ease-in-out infinite;
        }

        @keyframes statusGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animated {
            animation: fadeIn 0.3s ease-out;
        }

        .success {
            color: var(--text-bright);
        }

        .error {
            color: #f44;
        }

        .focus-mode .background-blur {
            filter: blur(5px) brightness(0.3);
            transition: all 0.3s ease;
        }

        .focus-mode .editor-section {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 95%;
            height: 85%;
            box-shadow: 0 0 30px var(--shadow-color);
            filter: none !important;
            opacity: 1 !important;
        }

        .focus-mode .editor-section .editor-container {
            opacity: 1 !important;
            filter: brightness(1.2) !important;
        }

        .focus-mode .editor-section #editor {
            opacity: 1 !important;
        }

        .focus-mode .editor-section textarea {
            height: calc(100% - 100px);
            opacity: 1 !important;
        }

        .focus-mode::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 999;
        }


        .notebook-mode .main-area {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .notebook-container {
            display: none !important;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background: #000000;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -999;
            visibility: hidden;
        }

        .notebook-mode .notebook-container {
            display: flex !important;
            position: relative;
            z-index: 1;
            visibility: visible;
        }

        .notebook-mode .editor-section {
            display: none !important;
        }

        .notebook-mode .terminal-section {
            display: none !important;
        }

        .notebook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 136, 0, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        .notebook-title {
            color: var(--text-bright);
            font-size: 1.4em;
            font-weight: bold;
        }

        .notebook-controls {
            display: flex;
            gap: 10px;
        }

        .nb-btn {
            background: var(--glow-color);
            border: 1px solid var(--border-color);
            color: var(--text-bright);
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            transition: all 0.2s;
        }

        .nb-btn:hover {
            background: var(--shadow-color);
            box-shadow: 0 0 10px var(--shadow-color);
        }

        .notebook-cell {
            margin-bottom: 15px;
            border: 1px solid #333;
            border-radius: 5px;
            background: var(--bg-secondary);
            overflow: hidden;
            transition: all 0.3s;
        }

        .notebook-cell.selected {
            border-color: var(--secondary-color);
            box-shadow: 0 0 10px var(--shadow-color);
        }

        /* Custom Ace Editor Green-on-Black Theme Override */
        .ace_editor {
            background-color: #000000 !important;
            color: var(--text-color) !important;
        }

        body.theme-cloud .ace_editor {
            background-color: #ffffff !important;
            color: #000000 !important;
        }

        .ace_gutter {
            background-color: #050505 !important;
            color: var(--secondary-color) !important;
            border-right: 1px solid var(--tertiary-color) !important;
        }

        body.theme-cloud .ace_gutter {
            background-color: #f5f5f5 !important;
            color: #2c3e50 !important;
            border-right: 1px solid #cccccc !important;
        }

        .ace_gutter-active-line {
            background-color: var(--bg-secondary) !important;
        }

        body.theme-cloud .ace_gutter-active-line {
            background-color: #e8e8e8 !important;
        }

        .ace_marker-layer .ace_active-line {
            background-color: #080808 !important;
        }

        body.theme-cloud .ace_marker-layer .ace_active-line {
            background-color: #f0f0f0 !important;
        }

        body.theme-lebron .ace_editor {
            background-color: transparent !important;
            color: #000000 !important;
        }

        body.theme-lebron .ace_gutter {
            background-color: rgba(255, 255, 255, 0.3) !important;
            color: #000000 !important;
            border-right: 1px solid #000000 !important;
        }

        body.theme-lebron .ace_gutter-active-line {
            background-color: rgba(255, 255, 255, 0.5) !important;
        }

        body.theme-lebron .ace_marker-layer .ace_active-line {
            background-color: rgba(255, 255, 255, 0.2) !important;
        }

        body.theme-lebron .ace_cursor {
            color: #000000 !important;
            border-left: 2px solid #000000 !important;
        }

        body.theme-lebron .ace_selection {
            background-color: rgba(0, 0, 0, 0.2) !important;
        }

        body.theme-lebron .ace_keyword,
        body.theme-lebron .ace_string,
        body.theme-lebron .ace_comment,
        body.theme-lebron .ace_function,
        body.theme-lebron .ace_variable,
        body.theme-lebron .ace_constant,
        body.theme-lebron .ace_support {
            color: #000000 !important;
        }

        .ace_cursor {
            color: var(--text-bright) !important;
            border-left: 2px solid var(--text-bright) !important;
        }

        .ace_selection {
            background-color: var(--glow-color) !important;
        }

        .ace_keyword {
            color: var(--text-bright) !important;
            font-weight: bold !important;
        }

        .ace_string {
            color: var(--text-color) !important;
        }

        .ace_comment {
            color: var(--tertiary-color) !important;
            font-style: italic !important;
        }

        .ace_function {
            color: var(--text-bright) !important;
        }

        .ace_variable {
            color: var(--secondary-color) !important;
        }

        .ace_constant.ace_numeric {
            color: var(--primary-color) !important;
        }

        .ace_scrollbar {
            background-color: #000000 !important;
        }

        .ace_scrollbar-h {
            background-color: #000000 !important;
        }

        .ace_scrollbar-v {
            background-color: #000000 !important;
        }

        .cell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .cell-type {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
        }

        .cell-controls {
            display: flex;
            gap: 5px;
        }

        .cell-btn {
            background: linear-gradient(45deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px var(--glow-color);
            min-width: 30px;
            text-align: center;
        }

        .cell-btn:hover {
            background: linear-gradient(45deg, var(--bg-secondary) 0%, var(--secondary-color) 50%, var(--bg-secondary) 100%);
            color: var(--text-bright);
            box-shadow: 0 0 10px var(--shadow-color);
            transform: translateY(-1px);
        }

        .cell-btn:active {
            transform: translateY(0);
            box-shadow: 0 0 5px var(--shadow-color);
        }

        .cell-input {
            position: relative;
        }

        .cell-textarea {
            width: 100%;
            min-height: 80px;
            background: var(--bg-primary);
            border: none;
            color: var(--text-bright);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 12px;
            resize: vertical;
            outline: none;
            line-height: 1.4;
        }

        .cell-textarea::placeholder {
            color: #444;
        }

        .markdown-cell .cell-textarea {
            color: #ccc;
        }

        .cell-output {
            border-top: 1px solid #333;
            background: var(--bg-secondary);
            padding: 12px;
            color: var(--text-color);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            min-height: 30px;
            white-space: pre-wrap;
            display: none;
        }

        .cell-output.has-output {
            display: block;
        }

        .cell-execution-count {
            color: #666;
            font-size: 11px;
            margin-right: 8px;
        }

        .add-cell-btn {
            width: 100%;
            padding: 15px;
            background: rgba(0, 136, 0, 0.1);
            border: 2px dashed #333;
            color: #666;
            cursor: pointer;
            border-radius: 5px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .add-cell-btn:hover {
            border-color: var(--secondary-color);
            color: var(--text-bright);
            background: rgba(0, 136, 0, 0.2);
        }

        .notebook-stats {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            color: #888;
            font-size: 11px;
        }

        /* Package Manager 8-bit Pixel Style */
        .package-manager {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 320px;
            background: var(--bg-primary);
            border: 3px solid var(--border-color);
            box-shadow: 
                0 0 20px var(--shadow-color),
                inset 0 0 10px var(--glow-color),
                4px 4px 0 rgba(0, 0, 0, 0.5);
            z-index: 1000;
            font-family: 'Courier New', monospace;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .package-manager.collapsed {
            width: 200px;
            height: auto;
        }

        .package-manager.collapsed .pm-body {
            display: none;
        }

        .pm-header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-bottom: 2px solid var(--border-color);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .pm-title {
            font-size: 11px;
            font-weight: bold;
            color: var(--text-bright);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 8px var(--text-bright);
        }

        .pm-controls {
            display: flex;
            gap: 4px;
        }

        .pm-control-btn {
            width: 20px;
            height: 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-color);
            transition: all 0.2s;
            padding: 0;
            font-family: 'Courier New', monospace;
        }

        .pm-control-btn:hover {
            background: var(--border-color);
            color: var(--bg-primary);
            box-shadow: 0 0 10px var(--shadow-color);
            transform: scale(1.1);
        }

        .pm-control-btn:active {
            transform: scale(0.95);
        }

        .pm-body {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
            background: var(--bg-secondary);
        }

        .pm-body::-webkit-scrollbar {
            width: 8px;
        }

        .pm-body::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
        }

        .pm-body::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border: 1px solid var(--border-color);
        }

        .pm-body::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        .pm-section {
            margin-bottom: 12px;
        }

        .pm-section-title {
            font-size: 10px;
            color: var(--text-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            padding-bottom: 3px;
            border-bottom: 1px solid var(--border-color);
        }

        .pm-input-group {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .pm-input {
            flex: 1;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 8px;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            outline: none;
            transition: all 0.2s;
        }

        .pm-input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 8px var(--shadow-color);
        }

        .pm-input::placeholder {
            color: var(--text-muted);
            opacity: 0.5;
        }

        .pm-btn {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 12px;
            font-size: 10px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .pm-btn:hover {
            background: var(--border-color);
            color: var(--bg-primary);
            box-shadow: 
                0 0 10px var(--shadow-color),
                inset 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .pm-btn:active {
            transform: translateY(1px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .pm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pm-package-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .pm-package-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 6px 8px;
            margin-bottom: 4px;
            font-size: 10px;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .pm-package-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--secondary-color);
            box-shadow: 0 0 8px var(--shadow-color);
        }

        .pm-package-name {
            font-weight: bold;
            color: var(--text-bright);
        }

        .pm-package-status {
            font-size: 9px;
            color: var(--secondary-color);
            text-transform: uppercase;
        }

        .pm-package-status.installed {
            color: var(--secondary-color);
        }

        .pm-package-status.installing {
            color: var(--text-color);
            animation: pixelBlink 1s infinite;
        }

        .pm-package-status.error {
            color: var(--error-color, #ff4444);
        }

        .pm-status {
            font-size: 9px;
            color: var(--text-muted);
            padding: 6px 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            margin-top: 8px;
            font-family: 'Courier New', monospace;
            min-height: 40px;
            max-height: 80px;
            overflow-y: auto;
        }

        .pm-status::-webkit-scrollbar {
            width: 4px;
        }

        .pm-status::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .pm-status::-webkit-scrollbar-thumb {
            background: var(--border-color);
        }

        /* Pixel animation for installing */
        @keyframes pixelPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Theme-specific colors */
        body.theme-greydom .pm-package-status.installed {
            color: #ff6666;
        }

        body.theme-cloud .pm-package-status.installed {
            color: #000000;
        }

        body.theme-chaos .pm-package-status.installed {
            color: #b0b0b0;
        }

        body.theme-lebron .pm-package-status.installed {
            color: #000000;
        }

        body.theme-lebron .package-manager {
            background: rgba(255, 179, 217, 0.95);
            border-color: #000000;
        }

        body.theme-lebron .pm-header,
        body.theme-lebron .pm-body {
            background: rgba(255, 179, 217, 0.95);
        }

        body.theme-lebron .pm-input,
        body.theme-lebron .pm-btn,
        body.theme-lebron .pm-package-item,
        body.theme-lebron .pm-status {
            background: rgba(255, 255, 255, 0.5);
            border-color: #000000;
            color: #000000;
        }

        body.theme-lebron .pm-title,
        body.theme-lebron .pm-package-name {
            color: #000000;
            text-shadow: none;
        }

        /* Cell expand modal styles */
        .cell-expand-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
        }

        .cell-expand-modal.active {
            display: flex;
            flex-direction: column;
        }

        .cell-expand-header {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        .cell-expand-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-bright);
        }

        .cell-expand-close {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-size: 20px;
            font-weight: bold;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.2s;
        }

        .cell-expand-close:hover {
            background: var(--secondary-color);
            color: var(--bg-primary);
            border-color: var(--text-bright);
            transform: scale(1.1);
        }

        .cell-expand-editor-container {
            flex: 1;
            border: 2px solid var(--border-color);
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }

        #expanded-ace-editor {
            width: 100%;
            height: 100%;
            font-size: 16px;
        }

        /* Theme-specific modal overrides */
        body.theme-greydom .cell-expand-modal {
            background: rgba(139, 0, 0, 0.95);
        }

        body.theme-cloud .cell-expand-modal {
            background: rgba(240, 240, 240, 0.98);
        }

        body.theme-chaos .cell-expand-modal {
            background: rgba(30, 30, 30, 0.98);
        }

        body.theme-lebron .cell-expand-modal {
            background: rgba(255, 192, 203, 0.98);
        }

        /* Mobile Toolbar */
        .mobile-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 2px solid var(--border-color);
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            z-index: 1000;
            box-shadow: 0 -2px 10px var(--shadow-color);
        }

        .mobile-toolbar button {
            flex: 1;
            min-width: 60px;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .mobile-toolbar button:hover {
            background: var(--secondary-color);
            color: var(--text-bright);
            transform: translateY(-2px);
        }

        /* General Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px var(--shadow-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-bright);
        }

        .close-btn {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            font-size: 24px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--secondary-color);
            color: var(--text-bright);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 20px;
        }

        /* History List Styles */
        .history-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .history-item:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 0 10px var(--shadow-color);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-time {
            color: #888;
            font-size: 0.9em;
        }

        .history-code {
            background: #000;
            border: 1px solid #333;
            border-radius: 3px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .history-output {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 3px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 100px;
            overflow-y: auto;
            color: var(--text-color);
        }

        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .history-actions button {
            padding: 5px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .history-actions button:hover {
            background: var(--secondary-color);
            color: var(--text-bright);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .mobile-toolbar {
                display: flex !important;
            }

            .editor-controls {
                flex-wrap: wrap;
            }

            .focus-button {
                font-size: 10px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body class="{% if user_theme == 'greydom' %}theme-greydom{% elif user_theme == 'cloud' %}theme-cloud{% elif user_theme == 'chaos' %}theme-chaos{% elif user_theme == 'lebron' %}theme-lebron{% endif %}">
    
    <div class="loading-screen {% if user_theme == 'lebron' %}theme-lebron{% endif %}" id="loading-screen">
        <!-- Matrix Background -->
        <div class="pixel-background"></div>
        <div class="pixel-rain" id="pixel-rain"></div>
        <div class="ambient-glow"></div>
        
        <!-- Homepage-style Loader -->
        <div class="pixel-loader-container">
            <!-- Main Loader Animation (Homepage Style) -->
            <div class="loader"></div>
            <div class="pixel-loader-text" id="loading-title" style="margin-top: 20px;">INITIALIZING PYTHON ASSEMBLY</div>
            
            <!-- Progress Bar -->
            <div class="pixel-loader-bar" style="margin-top: 30px;">
                <div class="pixel-loader-bar-fill" id="loading-bar-fill" style="width: 0%"></div>
            </div>
            
            <!-- Status Text -->
            <div class="pixel-loader-progress" id="loading-text" style="margin-top: 15px;">Loading Pyodide WebAssembly...</div>
            
            <!-- Package Loading List -->
            <div class="pixel-loader-progress" id="package-status" style="margin-top: 5px; font-family: 'Courier New', monospace; font-size: 10px; color: #888;"></div>
        </div>
        
        <!-- Boot Sequence Terminal -->
        <div class="boot-sequence" style="font-family: 'Courier New', monospace; font-size: 10px; color: rgba(255,255,255,0.4); position: absolute; top: 20px; left: 20px; right: 20px;">
            <span style="color: #00ff00;">&gt;</span> PYTHON TERMINAL v3.11.4<br>
            <span style="color: #00ff00;">&gt;</span> Loading WebAssembly Runtime...<br>
            <span style="color: #00ff00;">&gt;</span> Initializing Virtual File System...<br>
            <span style="color: #00ff00;">&gt;</span> Configuring Security Sandbox...<br>
            <span style="color: #00ff00;">&gt;</span> <span style="animation: blink 1s infinite;">█</span>
        </div>
    </div>

    <div class="container" id="main-container">
        
        <div class="file-manager">
            <h3>Script Manager</h3>
            
            <div class="file-controls">
                <input type="text" id="filename-input" class="file-input" placeholder="script_name" maxlength="50">
                <button onclick="saveScript()" class="file-button">Save Script</button>
                <button onclick="deleteScript()" class="file-button">Delete Script</button>
                <button onclick="newScript()" class="file-button">New Script</button>
            </div>

            <ul class="file-list" id="file-list">
                
            </ul>
            
            <div style="margin-top: 20px; padding: 10px; background: #222; border-radius: 3px; font-size: 11px;">
                <strong>File Access Rules:</strong><br>
                • Only text.txt, tester.csv, binary.dat can be accessed<br>
                • All scripts run in browse<br>
                • Maximum of 50 scripts can be made by free users.
            </div>
        </div>

        
        <div class="main-area">
            
            <div class="editor-section">
                <div class="editor-header">
                    <h2>Python Code Editor (Client-Side)</h2>
                    <div class="editor-controls">
                        <span id="current-file">untitled_script</span>
                        <button id="history-btn" class="pixel-button" onclick="toggleHistory()" title="Execution History">HISTORY</button>
                        <button id="share-btn" class="pixel-button" onclick="toggleShareModal()" title="Share Code">SHARE</button>
                        <button id="members-btn" class="pixel-button" onclick="toggleMembersModal()" title="Session Members" style="display: none;">MEMBERS</button>
                        <button id="notebook-btn" class="pixel-button" onclick="toggleNotebookMode()" title="Jupyter-style Notebook Mode">NOTEBOOK</button>
                        <!-- <button id="focus-btn" class="pixel-button" onclick="toggleFocusMode()" title="Focus Mode">FOCUS</button> -->
                    </div>
                </div>
                <div class="editor-container">
                    <div id="ace-editor" style="width: 100%; height: 100%; font-size: 14px;"></div>
                    <textarea id="code_content" style="display: none;">{{ code_content }}</textarea>
                </div>
            </div>

            
            <div class="terminal-section">
                <div class="terminal-header">
                    <h2>Python Terminal (Client-Side)</h2>
                    <button onclick="executeCode()" class="pixel-button" id="run-btn">RUN CODE</button>
                    <button onclick="clearTerminal()" class="pixel-button">CLEAR</button>
                </div>
                <div class="terminal-output" id="terminal-output">
                    Initializing Python environment...<br>
                    Python terminal ready! Your code will run in the browser.
                    <div id="input-container" style="display: none;">
                        <span class="terminal-prompt" id="input-prompt"></span>
                        <input type="text" id="terminal-input" class="terminal-input-line">
                    </div>
                </div>
            </div>

            
            <div class="notebook-container" id="notebook-container">
                <div class="notebook-header">
                    <div class="notebook-title">Python Notebook (Jupyter-style)</div>
                    <div class="notebook-controls">
                        <button class="nb-btn" onclick="toggleNotebookMode()">← Back to Editor</button>
                        <button class="nb-btn" onclick="addNotebookCell('code')">+ Code</button>
                        <button class="nb-btn" onclick="addNotebookCell('markdown')">+ Markdown</button>
                        <button class="nb-btn" onclick="runAllCells()">Run All</button>
                        <button class="nb-btn" onclick="clearAllOutputs()">Clear Outputs</button>
                        <button class="nb-btn" onclick="showKeyboardShortcuts()">Shortcuts</button>
                        <button class="nb-btn" onclick="exportNotebook()">Export</button>
                    </div>
                </div>
                
                <div class="notebook-toolbar" style="padding: 10px; background: var(--bg-tertiary); border-radius: 5px; margin-bottom: 15px; font-size: 12px; color: #888;">
                    <strong>Quick Tips:</strong> 
                    <code>Shift+Enter</code> = Run & Next | 
                    <code>Ctrl+Enter</code> = Run | 
                    <code>Alt+Enter</code> = Run & Add Cell | 
                    <code>Tab</code> = Auto-complete | 
                    Auto-save enabled
                </div>
                
                <div id="notebook-cells">
                    
                    <div class="notebook-cell code-cell" data-cell-id="1" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [1]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="expandCell(this)" title="Expand">⛶</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea" placeholder="# Welcome to Notebook Mode!
# Write your Python code here
# Press Shift+Enter to run

import numpy as np
import matplotlib.pyplot as plt

print('Hello from Python Notebook!')">import numpy as np
print('Welcome to Python Notebook Mode!')
print('Available packages: NumPy, Matplotlib, Pandas, SciPy, Scikit-learn')
</textarea>
                        </div>
                        <div class="cell-output" id="output-1"></div>
                    </div>
                </div>
                
                <button class="add-cell-btn" onclick="addNotebookCell('code')">
                    + Add Cell
                </button>
                
                <div class="notebook-stats">
                    <div>Cells: <span id="cell-count">1</span></div>
                    <div>Mode: Notebook</div>
                </div>
            </div>
        </div>

        
        <div class="file-viewers">
            <div class="file-viewer">
                <h3>text.txt</h3>
                <div class="file-content" id="text-content">Loading from Pyodide...</div>
            </div>

            <div class="file-viewer">
                <h3>tester.csv</h3>
                <div class="file-content" id="csv-content">Loading from Pyodide...</div>
            </div>

            <div class="file-viewer">
                <h3>binary.dat</h3>
                <div class="file-content" id="binary-content">Loading from Pyodide...</div>
                <div class="file-content binary-hex" id="binary-hex" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [2]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="expandCell(this)" title="Expand">⛶</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

np.random.seed(42)
dates = pd.date_range('2024-01-01', periods=100)
data = {
    'date': dates,
    'temperature': 20 + 10 * np.sin(np.arange(100) * 2 * np.pi / 365) + np.random.normal(0, 2, 100),
    'humidity': 50 + 20 * np.cos(np.arange(100) * 2 * np.pi / 365) + np.random.normal(0, 5, 100),
    'sales': np.random.poisson(50, 100) + np.arange(100) * 0.5
}

df = pd.DataFrame(data)
print("Sample Dataset:")
print(df.head())
print(f"\nDataset info: {len(df)} rows, {len(df.columns)} columns")
print(f"Statistics:\n{df.describe().round(2)}")

fig, axes = plt.subplots(2, 2, figsize=(12, 8))
fig.suptitle('Multi-Variable Analysis Dashboard', fontsize=16)

axes[0,0].plot(df.index, df['temperature'], 'tab:orange', alpha=0.7)
axes[0,0].set_title('Temperature Trend')
axes[0,0].set_ylabel('°C')
axes[0,0].grid(True, alpha=0.3)

scatter = axes[0,1].scatter(df['temperature'], df['humidity'], 
                           c=df['sales'], cmap='viridis', alpha=0.6)
axes[0,1].set_title('Humidity vs Temperature')
axes[0,1].set_xlabel('Temperature (°C)')
axes[0,1].set_ylabel('Humidity (%)')
plt.colorbar(scatter, ax=axes[0,1], label='Sales')

axes[1,0].hist(df['sales'], bins=20, color='skyblue', alpha=0.7, edgecolor='black')
axes[1,0].set_title('Sales Distribution')
axes[1,0].set_xlabel('Sales Count')
axes[1,0].set_ylabel('Frequency')

corr_data = df[['temperature', 'humidity', 'sales']].corr()
im = axes[1,1].imshow(corr_data, cmap='coolwarm', aspect='auto')
axes[1,1].set_title('Correlation Matrix')
axes[1,1].set_xticks(range(len(corr_data.columns)))
axes[1,1].set_yticks(range(len(corr_data.columns)))
axes[1,1].set_xticklabels(corr_data.columns, rotation=45)
axes[1,1].set_yticklabels(corr_data.columns)

plt.tight_layout()
plt.show()</textarea>
                        </div>
                        <div class="cell-output" id="output-2"></div>
                    </div>

                    
                    <div class="notebook-cell code-cell" data-cell-id="3" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [3]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="expandCell(this)" title="Expand">⛶</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">from sklearn.datasets import make_classification
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report, confusion_matrix
import numpy as np
import matplotlib.pyplot as plt

print("Creating ML Classification Example...")

X, y = make_classification(n_samples=1000, n_features=4, n_informative=3, 
                          n_redundant=1, n_clusters_per_class=1, random_state=42)

feature_names = ['Feature_A', 'Feature_B', 'Feature_C', 'Feature_D']

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42)

print(f"Dataset: {X.shape[0]} samples, {X.shape[1]} features")
print(f"Training set: {X_train.shape[0]} samples")
print(f"Test set: {X_test.shape[0]} samples")

rf_model = RandomForestClassifier(n_estimators=100, random_state=42)
rf_model.fit(X_train, y_train)

y_pred = rf_model.predict(X_test)

accuracy = (y_pred == y_test).mean()
print(f"\nModel Accuracy: {accuracy:.3f}")

plt.figure(figsize=(10, 6))

plt.subplot(1, 2, 1)
importance = rf_model.feature_importances_
indices = np.argsort(importance)[::-1]
plt.title('Feature Importance')
plt.bar(range(len(importance)), importance[indices], color='lightcoral', alpha=0.8)
plt.xticks(range(len(importance)), [feature_names[i] for i in indices], rotation=45)
plt.ylabel('Importance Score')

plt.subplot(1, 2, 2)
cm = confusion_matrix(y_test, y_pred)
plt.imshow(cm, interpolation='nearest', cmap='Blues')
plt.title('Confusion Matrix')
plt.colorbar()
plt.xlabel('Predicted Label')
plt.ylabel('True Label')

thresh = cm.max() / 2.
for i, j in np.ndindex(cm.shape):
    plt.text(j, i, format(cm[i, j], 'd'),
             ha="center", va="center",
             color="white" if cm[i, j] > thresh else "black")

plt.tight_layout()
plt.show()

print(f"\nClassification Report:")
print(classification_report(y_test, y_pred))</textarea>
                        </div>
                        <div class="cell-output" id="output-3"></div>
                    </div>

                    
                    <div class="notebook-cell markdown-cell" data-cell-id="4" data-cell-type="markdown">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count"></span>
                                Markdown Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">C</button>
                                <button class="cell-btn" onclick="expandCell(this)" title="Expand">⛶</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea"># 📚 Python Notebook Features

This notebook demonstrates the **full power** of Python in the browser using Pyodide! 

##Key Features

- **Jupyter-style Interface**: Familiar cell-based editing
- **Full Python 3.11**: Complete Python environment in your browser
- **Rich Libraries**: NumPy, Pandas, Matplotlib, SciPy, Scikit-learn
- **Interactive Plotting**: Visualizations with Matplotlib
- **Data Science Ready**: Perfect for analysis and machine learning
- **No Installation**: Everything runs client-side in WebAssembly

##Getting Started

1. **Code Cells**: Write and execute Python code
2. **Markdown Cells**: Add formatted documentation (like this!)
3. **Keyboard Shortcuts**: `Shift+Enter` to run cells
4. **Cell Management**: Add, delete, move, and convert cells
5. **Export**: Save your work as a `.ipynb` file

##Tips

- Use `plt.show()` to display plots
- All computations happen in your browser
- Your work is automatically saved in browser storage

```python
# Quick example - try this in a code cell:
import this  # The Zen of Python
```

Happy coding!</textarea>
                        </div>
                        <div class="cell-output" id="output-4"></div>
                    </div>

                    <div class="notebook-cell code-cell" data-cell-id="5" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [5]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="expandCell(this)" title="Expand">⛶</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">import sympy as sp
import numpy as np
import matplotlib.pyplot as plt

print("Symbolic Mathematics with SymPy")

x, y, z = sp.symbols('x y z')
t = sp.Symbol('t', real=True)

f1 = x**3 - 3*x**2 + 2*x - 1
f2 = sp.sin(x) * sp.exp(-x/2)
f3 = sp.sqrt(x**2 + y**2)

print(f"Function 1: {f1}")
print(f"Derivative: {sp.diff(f1, x)}")
print(f"Integral: {sp.integrate(f1, x)}")

print(f"\nFunction 2: {f2}")
print(f"Derivative: {sp.diff(f2, x)}")
print(f"Limit as x->0: {sp.limit(f2, x, 0)}")

eq1 = sp.Eq(x**2 + y**2, 25)
eq2 = sp.Eq(x - y, 1)
solutions = sp.solve([eq1, eq2], [x, y])
print(f"\nSolving system: {eq1}, {eq2}")
print(f"Solutions: {solutions}")

expr = sp.expand((x + y)**4)
print(f"\nExpanded (x+y)^4: {expr}")

factored = sp.factor(x**4 - 1)
print(f"Factored x^4-1: {factored}")

x_vals = np.linspace(-2, 4, 1000)
f1_func = sp.lambdify(x, f1, 'numpy')
f1_derivative = sp.lambdify(x, sp.diff(f1, x), 'numpy')

plt.figure(figsize=(12, 4))

plt.subplot(1, 3, 1)
plt.plot(x_vals, f1_func(x_vals), 'b-', linewidth=2, label=f'f(x) = {f1}')
plt.plot(x_vals, f1_derivative(x_vals), 'r--', linewidth=2, label="f'(x)")
plt.axhline(y=0, color='k', linestyle='-', alpha=0.3)
plt.axvline(x=0, color='k', linestyle='-', alpha=0.3)
plt.grid(True, alpha=0.3)
plt.legend()
plt.title('Function and Derivative')

plt.subplot(1, 3, 2)
x_vals2 = np.linspace(0, 10, 1000)
f2_func = sp.lambdify(x, f2, 'numpy')
plt.plot(x_vals2, f2_func(x_vals2), 'g-', linewidth=2)
plt.title('sin(x) * exp(-x/2)')
plt.grid(True, alpha=0.3)

plt.subplot(1, 3, 3)
x_mesh = np.linspace(-5, 5, 50)
y_mesh = np.linspace(-5, 5, 50)
X, Y = np.meshgrid(x_mesh, y_mesh)
Z = np.sqrt(X**2 + Y**2)
contour = plt.contour(X, Y, Z, levels=20)
plt.colorbar(contour)
plt.title('sqrt(x² + y²)')

plt.tight_layout()
plt.show()</textarea>
                        </div>
                        <div class="cell-output" id="output-5"></div>
                    </div>

                    <div class="notebook-cell code-cell" data-cell-id="6" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [6]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="expandCell(this)" title="Expand">⛶</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">import networkx as nx
import matplotlib.pyplot as plt
import numpy as np
from faker import Faker

print("Network Analysis with NetworkX")

fake = Faker()
Faker.seed(42)

G = nx.Graph()

nodes = [fake.name() for _ in range(15)]
G.add_nodes_from(nodes)

edges = []
for i in range(len(nodes)):
    for j in range(i+1, len(nodes)):
        if np.random.random() < 0.3:
            weight = np.random.randint(1, 10)
            edges.append((nodes[i], nodes[j], {'weight': weight}))

G.add_edges_from(edges)

print(f"Network created with {G.number_of_nodes()} nodes and {G.number_of_edges()} edges")

centrality_measures = {
    'degree': nx.degree_centrality(G),
    'betweenness': nx.betweenness_centrality(G),
    'closeness': nx.closeness_centrality(G),
    'eigenvector': nx.eigenvector_centrality(G)
}

top_nodes = {}
for measure, values in centrality_measures.items():
    top_node = max(values, key=values.get)
    top_nodes[measure] = (top_node, values[top_node])
    print(f"Highest {measure} centrality: {top_node[:15]}... ({values[top_node]:.3f})")

plt.figure(figsize=(15, 10))

layouts = {
    'spring': nx.spring_layout(G, seed=42),
    'circular': nx.circular_layout(G),
    'kamada_kawai': nx.kamada_kawai_layout(G),
    'random': nx.random_layout(G, seed=42)
}

for i, (layout_name, pos) in enumerate(layouts.items(), 1):
    plt.subplot(2, 2, i)
    
    if layout_name == 'spring':
        node_colors = [centrality_measures['betweenness'][node] for node in G.nodes()]
        nodes = nx.draw_networkx_nodes(G, pos, node_color=node_colors, 
                                     cmap=plt.cm.viridis, node_size=300, alpha=0.8)
        plt.colorbar(nodes, shrink=0.8, label='Betweenness Centrality')
    else:
        nx.draw_networkx_nodes(G, pos, node_color='lightblue', 
                             node_size=300, alpha=0.8)
    
    nx.draw_networkx_edges(G, pos, alpha=0.5, edge_color='gray')
    
    if layout_name in ['spring', 'kamada_kawai']:
        labels = {node: node.split()[0] for node in G.nodes()}
        nx.draw_networkx_labels(G, pos, labels, font_size=8)
    
    plt.title(f'{layout_name.replace("_", " ").title()} Layout')
    plt.axis('off')

plt.tight_layout()
plt.show()

if nx.is_connected(G):
    diameter = nx.diameter(G)
    avg_path_length = nx.average_shortest_path_length(G)
    print(f"\nNetwork diameter: {diameter}")
    print(f"Average path length: {avg_path_length:.3f}")
else:
    components = list(nx.connected_components(G))
    print(f"\nNetwork has {len(components)} connected components")

clustering_coeff = nx.average_clustering(G)
print(f"Average clustering coefficient: {clustering_coeff:.3f}")

print(f"Network density: {nx.density(G):.3f}")</textarea>
                        </div>
                        <div class="cell-output" id="output-6"></div>
                    </div>

                    <div class="notebook-cell code-cell" data-cell-id="7" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [7]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="expandCell(this)" title="Expand">⛶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">import seaborn as sns
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats

print("Advanced Statistical Analysis with Seaborn")

np.random.seed(42)

data = {
    'category': np.random.choice(['A', 'B', 'C', 'D'], 500),
    'value1': np.random.normal(100, 15, 500),
    'value2': np.random.exponential(2, 500),
    'group': np.random.choice(['Group1', 'Group2', 'Group3'], 500),
    'binary': np.random.choice([0, 1], 500)
}

for i, cat in enumerate(['A', 'B', 'C', 'D']):
    mask = np.array(data['category']) == cat
    data['value1'] = np.where(mask, data['value1'] + i*10, data['value1'])

df = pd.DataFrame(data)

print("Dataset Overview:")
print(df.describe())
print(f"\nData shape: {df.shape}")
print(f"Categories: {df['category'].value_counts().to_dict()}")

plt.figure(figsize=(16, 12))

plt.subplot(2, 3, 1)
sns.histplot(data=df, x='value1', hue='category', alpha=0.7, bins=30)
plt.title('Distribution by Category')

plt.subplot(2, 3, 2)
sns.boxplot(data=df, x='category', y='value1')
plt.title('Value1 by Category')

plt.subplot(2, 3, 3)
sns.violinplot(data=df, x='group', y='value2', inner='box')
plt.title('Value2 Distribution by Group')

plt.subplot(2, 3, 4)
correlation_matrix = df.select_dtypes(include=[np.number]).corr()
sns.heatmap(correlation_matrix, annot=True, cmap='coolwarm', center=0)
plt.title('Correlation Matrix')

plt.subplot(2, 3, 5)
sns.scatterplot(data=df, x='value1', y='value2', hue='category', size='binary', alpha=0.7)
plt.title('Value1 vs Value2')

plt.subplot(2, 3, 6)
pivot_table = df.pivot_table(values='value1', index='category', columns='group', aggfunc='mean')
sns.heatmap(pivot_table, annot=True, fmt='.1f', cmap='viridis')
plt.title('Mean Value1 by Category & Group')

plt.tight_layout()
plt.show()

print("\nStatistical Tests:")

for cat in df['category'].unique():
    cat_data = df[df['category'] == cat]['value1']
    stat, p_value = stats.normaltest(cat_data)
    print(f"Category {cat} normality test: p-value = {p_value:.4f}")

f_stat, p_value = stats.f_oneway(*[df[df['category'] == cat]['value1'] for cat in df['category'].unique()])
print(f"\nANOVA test (value1 by category): F = {f_stat:.3f}, p = {p_value:.4f}")

correlation, p_value = stats.pearsonr(df['value1'], df['value2'])
print(f"Correlation (value1 vs value2): r = {correlation:.3f}, p = {p_value:.4f}")

from scipy.stats import chi2_contingency
contingency = pd.crosstab(df['category'], df['group'])
chi2, p_value, dof, expected = chi2_contingency(contingency)
print(f"Chi-square test (category vs group): χ² = {chi2:.3f}, p = {p_value:.4f}")

print(f"\nContingency Table:")
print(contingency)</textarea>
                        </div>
                        <div class="cell-output" id="output-7"></div>
                    </div>

                    <div class="notebook-cell code-cell" data-cell-id="8" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [8]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="expandCell(this)" title="Expand">⛶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea">from wordcloud import WordCloud
import matplotlib.pyplot as plt
import numpy as np
from PIL import Image
import re

print("Text Analysis and Word Cloud Generation")

sample_text = """
Python is a high-level, general-purpose programming language. Its design philosophy emphasizes 
code readability with the use of significant indentation. Python is dynamically-typed and 
garbage-collected. It supports multiple programming paradigms, including structured, 
object-oriented and functional programming. Python is often described as a batteries included 
language due to its comprehensive standard library. Data science machine learning artificial 
intelligence web development automation scripting scientific computing numpy pandas matplotlib 
sklearn tensorflow pytorch django flask jupyter notebook anaconda scipy seaborn plotly 
algorithms data structures statistics mathematics linear algebra calculus probability 
computer science software engineering programming python developer coding development 
analysis visualization dashboard interactive plotting scientific research academic industry 
business analytics big data processing visualization dashboard creation reporting tools 
automated testing continuous integration deployment cloud computing databases SQL NoSQL 
web scraping API development REST microservices containerization docker kubernetes 
version control git github gitlab collaboration open source community documentation 
debugging optimization performance profiling memory management concurrency parallel processing 
"""

print("Processing text...")
text = re.sub(r'[^a-zA-Z\s]', '', sample_text.lower())
words = text.split()
word_freq = {}
for word in words:
    if len(word) > 3:
        word_freq[word] = word_freq.get(word, 0) + 1

top_words = dict(sorted(word_freq.items(), key=lambda x: x[1], reverse=True)[:20])
print("Top 20 words by frequency:")
for word, freq in top_words.items():
    print(f"{word}: {freq}")

plt.figure(figsize=(15, 10))

plt.subplot(2, 2, 1)
wordcloud_basic = WordCloud(width=400, height=300, background_color='white', 
                           colormap='viridis', max_words=100).generate(sample_text)
plt.imshow(wordcloud_basic, interpolation='bilinear')
plt.title('Basic Word Cloud')
plt.axis('off')

plt.subplot(2, 2, 2)
wordcloud_freq = WordCloud(width=400, height=300, background_color='black', 
                          colormap='plasma', max_words=80, 
                          relative_scaling=0.5, min_font_size=8).generate_from_frequencies(word_freq)
plt.imshow(wordcloud_freq, interpolation='bilinear')
plt.title('Frequency-based Word Cloud')
plt.axis('off')

plt.subplot(2, 2, 3)
words_list = list(top_words.keys())
freqs_list = list(top_words.values())
colors = plt.cm.Set3(np.linspace(0, 1, len(words_list)))
bars = plt.bar(range(len(words_list)), freqs_list, color=colors)
plt.xticks(range(len(words_list)), words_list, rotation=45, ha='right')
plt.title('Word Frequency Distribution')
plt.ylabel('Frequency')

for i, (bar, freq) in enumerate(zip(bars, freqs_list)):
    plt.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.1, 
             str(freq), ha='center', va='bottom', fontsize=8)

plt.subplot(2, 2, 4)
wordcloud_custom = WordCloud(width=400, height=300, background_color='navy', 
                            colormap='cool', max_words=60, 
                            prefer_horizontal=0.9, max_font_size=40).generate(sample_text)
plt.imshow(wordcloud_custom, interpolation='bilinear')
plt.title('Custom Styled Word Cloud')
plt.axis('off')

plt.tight_layout()
plt.show()

print(f"\nText Statistics:")
print(f"Total characters: {len(sample_text)}")
print(f"Total words: {len(words)}")
print(f"Unique words: {len(word_freq)}")
print(f"Average word length: {np.mean([len(w) for w in words]):.2f}")
print(f"Most frequent word: '{max(word_freq, key=word_freq.get)}' ({max(word_freq.values())} times)")

word_lengths = [len(w) for w in words if len(w) > 0]
print(f"Word length distribution:")
print(f"  Min: {min(word_lengths)}")
print(f"  Max: {max(word_lengths)}")  
print(f"  Median: {np.median(word_lengths)}")
print(f"  Standard deviation: {np.std(word_lengths):.2f}")</textarea>
                        </div>
                        <div class="cell-output" id="output-8"></div>
                    </div>

                    
                    <div class="notebook-cell code-cell" data-cell-id="9" data-cell-type="code">
                        <div class="cell-header">
                            <div class="cell-type">
                                <span class="cell-execution-count">In [9]:</span>
                                Code Cell
                            </div>
                            <div class="cell-controls">
                                <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                                <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                                <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                                <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">M</button>
                                <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                            </div>
                        </div>
                        <div class="cell-input">
                            <textarea class="cell-textarea"># [DEMO] Interactive Input Demo
# This demonstrates the new input() pausing functionality!

print("[DEMO] Interactive Input Demo")
print("=" * 40)

# Basic input example
name = input("What's your name? ")
print(f"Hello, {name}! Nice to meet you!")

# Numeric input with validation
while True:
    try:
        age_input = input("How old are you? ")
        age = int(age_input)
        if age > 0:
            break
        else:
            print("Please enter a positive number!")
    except ValueError:
        print("Please enter a valid number!")

print(f"Wow, you're {age} years old!")

# Interactive calculation
print("\n[CALC] Let's do some math!")
try:
    num1 = float(input("Enter first number: "))
    operator = input("Enter operator (+, -, *, /): ").strip()
    num2 = float(input("Enter second number: "))
    
    if operator == '+':
        result = num1 + num2
    elif operator == '-':
        result = num1 - num2
    elif operator == '*':
        result = num1 * num2
    elif operator == '/':
        if num2 != 0:
            result = num1 / num2
        else:
            result = "Error: Division by zero!"
    else:
        result = "Error: Invalid operator!"
    
    print(f"\n[RESULT] {num1} {operator} {num2} = {result}")
    
except ValueError:
    print("Error: Invalid number input!")

# Fun personality test
print(f"\n[TEST] Quick personality test, {name}!")
color = input("What's your favorite color? ").lower().strip()

color_meanings = {
    'blue': 'calm and trustworthy',
    'red': 'passionate and energetic', 
    'green': 'natural and harmonious',
    'yellow': 'optimistic and creative',
    'purple': 'mysterious and imaginative',
    'orange': 'enthusiastic and friendly',
    'black': 'sophisticated and strong',
    'white': 'pure and peaceful'
}

meaning = color_meanings.get(color, 'unique and special')
print(f"[COLOR] {color.title()} lovers are typically {meaning}!")

print(f"\n[THANKS] Thanks for trying the interactive demo, {name}!")
print("[INFO] The input() function now properly pauses execution!")
print("⏰ Timeout: 20 seconds (returns empty string if no input)")</textarea>
                        </div>
                        <div class="cell-output" id="output-9"></div>
                    </div>
                </div>
                
                <button class="add-cell-btn" onclick="addNotebookCell('code')">
                    + Add Cell
                </button>
                
                <div class="notebook-stats">
                    <div>Cells: <span id="cell-count">8</span></div>
                    <div>Mode: Notebook</div>
                </div>
            </div>
        </div>

        
        <div class="file-viewers">
            <div class="file-viewer">
                <h3>text.txt</h3>
                <div class="file-content" id="text-content">Loading from Pyodide...</div>
            </div>

            <div class="file-viewer">
                <h3>tester.csv</h3>
                <div class="file-content" id="csv-content">Loading from Pyodide...</div>
            </div>

            <div class="file-viewer">
                <h3>binary.dat</h3>
                <div class="file-content" id="binary-content">Loading from Pyodide...</div>
                <div class="file-content binary-hex" id="binary-hex" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="history-modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>EXECUTION HISTORY</h2>
                <button class="close-btn" onclick="closeHistoryModal()">×</button>
            </div>
            <div class="modal-body" id="history-list">
                <div style="text-align: center; padding: 40px; color: #888;">
                    Loading history...
                </div>
            </div>
        </div>
    </div>
    <!-- Settings Modal -->
    <div class="modal" id="settings-modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>EDITOR SETTINGS</h2>
                <button class="close-btn" onclick="closeSettingsModal()">×</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px; color: var(--text-bright);">Editor Font Size</h3>
                    <input type="range" id="settings-font-size" min="10" max="24" value="14" style="width: 100%;">
                    <div style="text-align: center; margin-top: 5px; color: var(--text-color);"><span id="font-size-display">14</span>px</div>
                </div>
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px; color: var(--text-bright);">Auto-Save</h3>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; background: var(--bg-tertiary); border-radius: 5px;">
                        <input type="checkbox" id="settings-auto-save" checked style="margin-right: 10px;">
                        <span>Enable Auto-Save (every 5 seconds)</span>
                    </label>
                </div>
                <p style="font-size: 0.9em; color: #888; margin-bottom: 15px;">Note: Matplotlib plot theme can be changed via the settings cog button at the bottom right.</p>
                <button onclick="saveSettings()" class="focus-button" style="width: 100%;">Save Settings</button>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <span id="status">Python Terminal Environment Ready</span>
    </div>

    <script>
        let selectedScript = '';
        let currentScript = 'untitled_script';
        let pyodide = null;
        let isInitialized = false;
        let isWaitingForInput = false;
        let inputResolver = null;
        let loadingProgress = 0;
        const loadingSteps = [
            { percent: 10, text: 'Loading Pyodide WebAssembly...', title: 'LOADING RUNTIME' },
            { percent: 30, text: 'Installing numpy...', title: 'INSTALLING PACKAGES', package: 'numpy' },
            { percent: 40, text: 'Installing matplotlib...', title: 'INSTALLING PACKAGES', package: 'matplotlib' },
            { percent: 50, text: 'Installing micropip...', title: 'INSTALLING PACKAGES', package: 'micropip' },
            { percent: 60, text: 'Installing pandas...', title: 'CONFIGURING ENVIRONMENT', package: 'pandas' },
            { percent: 70, text: 'Installing scipy...', title: 'CONFIGURING ENVIRONMENT', package: 'scipy' },
            { percent: 80, text: 'Installing sympy...', title: 'CONFIGURING ENVIRONMENT', package: 'sympy' },
            { percent: 90, text: 'Setting up matplotlib backend...', title: 'FINALIZING SETUP' },
            { percent: 95, text: 'Setting up virtual file system...', title: 'FINALIZING SETUP' },
            { percent: 100, text: 'Environment ready!', title: 'COMPLETE' }
        ];
        let currentStepIndex = 0;


        function updateLoadingProgress(message) {
            const progressElement = document.getElementById('loading-text');
            const titleElement = document.getElementById('loading-title');
            const barFill = document.getElementById('loading-bar-fill');
            const packageStatus = document.getElementById('package-status');
            
            if (progressElement) {
                progressElement.textContent = message;
            }
            
            // Find matching step or advance to next
            let step = loadingSteps.find(s => s.text === message);
            if (!step && currentStepIndex < loadingSteps.length) {
                currentStepIndex++;
                step = loadingSteps[currentStepIndex];
            }
            
            if (step) {
                // Update progress bar
                if (barFill) {
                    barFill.style.width = step.percent + '%';
                }
                
                // Update title
                if (titleElement && step.title) {
                    titleElement.textContent = step.title;
                }
                
                // Update package status
                if (packageStatus && step.package) {
                    packageStatus.innerHTML = `<span style="color: #00ff00;">✓</span> ${step.package} installed`;
                    setTimeout(() => {
                        packageStatus.style.opacity = '0.5';
                    }, 1000);
                }
            }
        }


        // Initialize pixel rain effect
        document.addEventListener('DOMContentLoaded', () => {
            const pixelRain = document.getElementById('pixel-rain');
            if (pixelRain) {
                // Create 30 pixel drops
                for (let i = 0; i < 30; i++) {
                    const drop = document.createElement('div');
                    drop.className = 'pixel-drop';
                    drop.style.left = Math.random() * 100 + '%';
                    drop.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    drop.style.animationDelay = Math.random() * 5 + 's';
                    pixelRain.appendChild(drop);
                }
            }
        });


        function showMainInterface() {
            const loadingScreen = document.getElementById('loading-screen');
            const mainContainer = document.getElementById('main-container');
            
            if (loadingScreen && mainContainer) {
                loadingScreen.classList.add('hidden');
                mainContainer.classList.add('ready');
            }
            

            initializeAceEditor();
            

            loadUserData();
        }

        let aceEditor = null;

        function initializeAceEditor() {
            aceEditor = ace.edit("ace-editor");
            
            // Set theme based on user preference
            {% if user_theme == 'greydom' %}
                aceEditor.setTheme("ace/theme/monokai");
            {% elif user_theme == 'cloud' %}
                aceEditor.setTheme("ace/theme/katzenmilch");
            {% elif user_theme == 'chaos' %}
                aceEditor.setTheme("ace/theme/chaos");
            {% else %}
                aceEditor.setTheme("ace/theme/terminal");
            {% endif %}
            
            aceEditor.session.setMode("ace/mode/python");
            

            aceEditor.setOptions({
                fontSize: "14px",
                showPrintMargin: false,
                wrap: true
            });

            
            ace.require("ace/ext/language_tools");
            aceEditor.setOptions({
                enableBasicAutocompletion: true,
                enableLiveAutocompletion: true,
                enableSnippets: true
            });
            const defaultContent = `import numpy as np
import matplotlib.pyplot as plt
import pandas as pd

print('Python Environment Ready!')
print('Try the NOTEBOOK mode for Jupyter-style cells')

x = np.linspace(0, 10, 100)
y = np.sin(x) * np.exp(-x/5)

plt.figure(figsize=(10, 6))
plt.plot(x, y, 'b-', linewidth=2, label='Damped Sine Wave')
plt.fill_between(x, y, alpha=0.3)
plt.title('Scientific Computing in Browser')
plt.xlabel('X values')
plt.ylabel('Y values')
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()

data = pd.DataFrame({
    'x': np.random.randn(100),
    'y': np.random.randn(100),
    'category': np.random.choice(['A', 'B', 'C'], 100)
})
print(data.groupby('category').describe())`;

            aceEditor.setValue(defaultContent, -1);
            

            aceEditor.session.on('change', function() {
                document.getElementById('code_content').value = aceEditor.getValue();
            });
        }


        function getEditorValue() {
            return aceEditor ? aceEditor.getValue() : document.getElementById('code_content').value;
        }

        function setEditorValue(value) {
            if (aceEditor) {
                aceEditor.setValue(value, -1);
            }
            document.getElementById('code_content').value = value;
        }


        async function saveUserData() {
            const userData = {
                currentCode: getEditorValue(),
                scripts: {},
                notebooks: {},
                settings: {
                    theme: 'monokai',
                    fontSize: 14,
                    lastSaved: new Date().toISOString()
                }
            };


            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('python_script_') || key.startsWith('data_file_')) {
                    userData.scripts[key] = localStorage.getItem(key);
                }
            }

            
            const notebookData = localStorage.getItem('notebook_data');
            if (notebookData) {
                userData.notebooks = JSON.parse(notebookData);
            }

            try {
                const response = await fetch('/save_user_data/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('✅ User data saved to account:', result);
                    updateStatus('Data saved to account', 'success');
                    return true;
                } else {
                    console.error('❌ Failed to save to account:', result);
                    updateStatus(`Save failed: ${result.message || 'Unknown error'}`, 'error');
                    localStorage.setItem('user_data_backup', JSON.stringify(userData));
                    return false;
                }
            } catch (error) {
                console.error('❌ Network error saving data:', error);
                updateStatus('Network error, data saved locally', 'warning');
                localStorage.setItem('user_data_backup', JSON.stringify(userData));
                return false;
            }
        }

        async function deleteFromDatabase(filename) {
            try {
                const response = await fetch('/python/delete-file/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ filename: filename })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('✅ File deleted from database:', filename);
                } else {
                    console.warn('⚠️ Failed to delete from database:', result);
                }
            } catch (error) {
                console.error('❌ Error deleting from database:', error);
            }
        }

        async function loadUserData() {
            try {
                const response = await fetch('/load_user_data');
                if (response.ok) {
                    const userData = await response.json();
                    restoreUserData(userData);
                    console.log('User data loaded from account');
                    return;
                }
            } catch (error) {
                console.log('Failed to load from account, checking local backup');
            }

            
            const backupData = localStorage.getItem('user_data_backup');
            if (backupData) {
                try {
                    const userData = JSON.parse(backupData);
                    restoreUserData(userData);
                    console.log('User data loaded from local backup');
                } catch (error) {
                    console.log('Failed to parse backup data');
                }
            }
        }

        function restoreUserData(userData) {
            
            if (userData.currentCode) {
                setEditorValue(userData.currentCode);
            }

            
            if (userData.scripts) {
                for (const [key, value] of Object.entries(userData.scripts)) {
                    localStorage.setItem(key, value);
                }
            }

            
            if (userData.notebooks) {
                localStorage.setItem('notebook_data', JSON.stringify(userData.notebooks));
            }

            
            if (userData.settings) {
                if (aceEditor && userData.settings.fontSize) {
                    aceEditor.setFontSize(userData.settings.fontSize + 'px');
                }
            }

            
            loadScriptList();
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        
        let autoSaveTimer = null;
        function scheduleAutoSave() {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(saveUserData, 5000); 
        }

        
        window.addEventListener('beforeunload', function(event) {
            saveUserData();
        });

        
        document.addEventListener('DOMContentLoaded', function() {
            if (aceEditor) {
                aceEditor.session.on('change', scheduleAutoSave);
            }
        });


        async function initPyodide() {
            if (isInitialized) return;
            
            try {
                updateLoadingProgress("Loading Pyodide WebAssembly...");
                pyodide = await loadPyodide();
                
                updateLoadingProgress("Installing core packages...");
                // Only load essential packages - numpy and matplotlib are most commonly used
                await pyodide.loadPackage(["numpy", "matplotlib", "micropip"]);
                
                updateLoadingProgress("Installing essential packages via micropip...");
                // Reduced package list - only install what's commonly needed
                // Users can install additional packages on-demand using micropip
                await pyodide.runPythonAsync(`
import micropip
await micropip.install([
    'pandas',  # Data analysis
    'scipy',   # Scientific computing
    'sympy'    # Symbolic mathematics
])
                `);
                
                updateLoadingProgress("Setting up matplotlib backend...");
                
                await pyodide.runPython(`
import matplotlib
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import io
import base64
import warnings

# Suppress font warnings
warnings.filterwarnings('ignore', category=UserWarning, module='matplotlib')

# Set up matplotlib for web display with fallback font configuration
matplotlib.use('Agg')  # Use Anti-Grain Geometry backend for web

# Configure font fallbacks to avoid font file access issues
try:
    # Set font properties to use built-in fonts
    plt.rcParams['font.family'] = ['sans-serif']
    plt.rcParams['font.sans-serif'] = ['Arial', 'Helvetica', 'DejaVu Sans', 'Liberation Sans', 'Bitstream Vera Sans', 'sans-serif']
    plt.rcParams['axes.unicode_minus'] = False  # Use ASCII minus
    
    # Configure colors for dark mode display
    plt.rcParams['figure.facecolor'] = '#D3D3D3'  # Light grey background
    plt.rcParams['axes.facecolor'] = '#D3D3D3'
    plt.rcParams['text.color'] = 'black'
    plt.rcParams['axes.labelcolor'] = 'black'
    plt.rcParams['xtick.color'] = 'black'
    plt.rcParams['ytick.color'] = 'black'
    plt.rcParams['axes.edgecolor'] = 'black'
    plt.rcParams['grid.color'] = 'black'
    plt.rcParams['legend.facecolor'] = '#D3D3D3'
    plt.rcParams['legend.edgecolor'] = 'black'
    
    # Clear font cache to avoid cached font path issues
    fm.fontManager.__init__()
    
except Exception as e:
    print(f"Font configuration warning: {e}")
    # Continue with default matplotlib settings

# Function to display plots in the terminal
def show_plot():
    try:
        # Configure plot colors for dark mode
        fig = plt.gcf()
        fig.patch.set_facecolor('#D3D3D3')  # Light grey background
        
        # Set all text to black
        for ax in fig.get_axes():
            ax.set_facecolor('#D3D3D3')  # Light grey for axes background
            ax.title.set_color('black')
            ax.xaxis.label.set_color('black')
            ax.yaxis.label.set_color('black')
            ax.tick_params(colors='black', which='both')
            
            # Set spine colors to black
            for spine in ax.spines.values():
                spine.set_edgecolor('black')
            
            # Set legend text to black if legend exists
            legend = ax.get_legend()
            if legend:
                for text in legend.get_texts():
                    text.set_color('black')
                legend.get_frame().set_facecolor('#D3D3D3')
                legend.get_frame().set_edgecolor('black')
        
        buf = io.BytesIO()
        plt.savefig(buf, format='png', bbox_inches='tight', dpi=100, facecolor='#D3D3D3', edgecolor='black')
        buf.seek(0)
        img_base64 = base64.b64encode(buf.read()).decode('utf-8')
        buf.close()
        
        # Display image in terminal
        print(f'<img src="data:image/png;base64,{img_base64}" style="max-width: 100%; height: auto; background: #D3D3D3; border-radius: 5px;" />')
        plt.close()  # Close the figure to free memory
        
    except Exception as e:
        print(f"Plot display error: {e}")
        plt.close()  # Still close the figure

# Override plt.show() to use our custom display function
plt.show = show_plot

# Test plotting functionality
print("[PLOT] Matplotlib configured successfully!")
                `);
                
                updateLoadingProgress("Setting up virtual file system...");
                await setupVirtualFiles();
                
                updateLoadingProgress("Configuring file restrictions...");
                
                await pyodide.runPython(`
import builtins
import os
import asyncio
original_open = builtins.open
original_input = builtins.input

# Custom async input function that works with the web interface
async def web_input_async(prompt=""):
    # Import js module for JavaScript integration
    import js
    from pyodide.ffi import create_proxy
    
    # Create a promise that resolves when user provides input
    def create_input_promise():
        return js.Promise.new(create_proxy(lambda resolve, reject: js.showInputDialogAsync(prompt, resolve)))
    
    # Wait for the promise to resolve
    result = await create_input_promise()
    return result if result is not None else ""

# Synchronous wrapper for backward compatibility
def web_input(prompt=""):
    try:
        # Try to get the current event loop
        loop = asyncio.get_event_loop()
        if loop.is_running():
            # If we're in an async context, we need to handle this differently
            import js
            return js.showInputDialog(prompt) or ""
        else:
            # Run the async function in the event loop
            return loop.run_until_complete(web_input_async(prompt))
    except Exception as e:
        # Fallback to JavaScript sync version
        import js
        return js.showInputDialog(prompt) or ""

# Replace the built-in input function
builtins.input = web_input

def restricted_open(filename, mode='r', *args, **kwargs):
    # Allow user files
    allowed_files = ['text.txt', 'tester.csv', 'binary.dat']
    
    # Allow matplotlib, numpy, pandas, sklearn, and other library internal files
    allowed_paths = [
        '/lib/python3.11/site-packages/',
        '/lib/python311.zip/',
        '/lib/python3.11/',
        '/usr/lib/',
        '/usr/share/',
        '<frozen',  # Built-in modules
        '<string>',  # String execution
        '<stdin>',   # Interactive input
    ]
    
    # Check if it's an allowed user file
    if os.path.basename(filename) in allowed_files:
        return original_open(filename, mode, *args, **kwargs)
    
    # Check if it's a library internal file
    for allowed_path in allowed_paths:
        if filename.startswith(allowed_path) or allowed_path in filename:
            return original_open(filename, mode, *args, **kwargs)
    
    # Block everything else
    raise PermissionError(f"Access denied: Cannot open '{filename}'. Only {allowed_files} are allowed for user access.")

builtins.open = restricted_open
                `);
                
                updateLoadingProgress("Environment ready!");
                updateTerminal("Python Environment Loaded Successfully!\n");
                updateTerminal("Available: numpy, pandas, matplotlib, scipy, sklearn, seaborn, sympy, networkx, bokeh, plotly, wordcloud\n");
                updateTerminal("Use plt.show() to display plots, try the notebook mode for advanced features\n\n");
                
                isInitialized = true;
                
                
                setTimeout(() => {
                    showMainInterface();
                }, 500);
                
            } catch (error) {
                updateLoadingProgress("Error loading environment");
                updateTerminal("Error loading Python environment: " + error.message + "\n");
                
                setTimeout(() => {
                    showMainInterface();
                }, 1000);
            }
        }

        
        async function setupVirtualFiles() {
            
            try {
                const response = await fetch('/python/get-files/');
                const filesData = await response.json();
                
                
                pyodide.FS.writeFile('text.txt', filesData.text_content || 'Hello from text.txt!\nThis is a sample text file.');
                pyodide.FS.writeFile('tester.csv', filesData.csv_content || 'name,age,city\nJohn,25,NYC\nJane,30,LA');
                pyodide.FS.writeFile('binary.dat', filesData.binary_content || 'Binary data example');
                
                
                globalThis.binaryContent = filesData.binary_content || 'Binary data example';
                globalThis.binaryHexData = filesData.binary_hex || 'No hex data available';
                
                
                updateFileViewers();
                
            } catch (error) {
                
                pyodide.FS.writeFile('text.txt', 'Hello from text.txt!\nThis is a sample text file.');
                pyodide.FS.writeFile('tester.csv', 'name,age,city\nJohn,25,NYC\nJane,30,LA');
                pyodide.FS.writeFile('binary.dat', 'Binary data example');
                globalThis.binaryContent = 'Binary data example';
                globalThis.binaryHexData = 'No hex data available (server error)';
                updateFileViewers();
            }
            
            
            globalThis.inputState = {
                waiting: false,
                result: null,
                ready: false
            };
            
            globalThis.startInput = function(prompt) {
                globalThis.inputState.waiting = true;
                globalThis.inputState.result = null;
                globalThis.inputState.ready = false;
                
                showTerminalInput(prompt, function(result) {
                    globalThis.inputState.result = result;
                    globalThis.inputState.ready = true;
                    globalThis.inputState.waiting = false;
                });
            };
            
            globalThis.checkInput = function() {
                return globalThis.inputState.ready;
            };
            
            globalThis.getInputResult = function() {
                const result = globalThis.inputState.result;
                
                globalThis.inputState.waiting = false;
                globalThis.inputState.result = null;
                globalThis.inputState.ready = false;
                return result || "";
            };
            
            
            pyodide.globals.set("startInput", globalThis.startInput);
            pyodide.globals.set("checkInput", globalThis.checkInput);
            pyodide.globals.set("getInputResult", globalThis.getInputResult);
            
            
            globalThis.refreshFileList = function() {
                loadScriptList();
            };
            pyodide.globals.set("refreshFileList", globalThis.refreshFileList);
            
            await pyodide.runPython(`
import builtins
import js

# Store original open function
_original_open = builtins.open

# Create a wrapper that automatically refreshes file list after writes
class AutoRefreshFileWrapper:
    def __init__(self, file_obj, mode, filename):
        self.file_obj = file_obj
        self.mode = mode
        self.filename = filename
        self.is_write_mode = 'w' in mode or 'a' in mode
        
    def __enter__(self):
        return self
        
    def __exit__(self, exc_type, exc_val, exc_tb):
        result = self.file_obj.__exit__(exc_type, exc_val, exc_tb)
        # Auto-refresh if this was a write operation
        if self.is_write_mode:
            try:
                js.refreshFileList()
                print(f"File list auto-refreshed after modifying {self.filename}")
            except:
                pass
        return result
        
    def write(self, data):
        result = self.file_obj.write(data)
        return result
        
    def close(self):
        result = self.file_obj.close()
        # Auto-refresh on close if it was a write mode
        if self.is_write_mode:
            try:
                js.refreshFileList()
                print(f"File list auto-refreshed after closing {self.filename}")
            except:
                pass
        return result
        
    # Delegate all other attributes to the wrapped file object
    def __getattr__(self, name):
        return getattr(self.file_obj, name)

def enhanced_open(filename, mode='r', *args, **kwargs):
    file_obj = _original_open(filename, mode, *args, **kwargs)
    # Only wrap write operations for auto-refresh
    if 'w' in mode or 'a' in mode:
        return AutoRefreshFileWrapper(file_obj, mode, filename)
    else:
        return file_obj

# Replace built-in open with auto-refresh version
builtins.open = enhanced_open

def refresh_files():
    """Manually refresh the file list"""
    js.refreshFileList()
    print("File list refreshed!")

def write_file(filename, content, mode='w'):
    """Helper function to write files and auto-refresh"""
    with _original_open(filename, mode) as f:
        f.write(content)
    refresh_files()
    return f"Wrote to {filename} and refreshed file list"

def simple_input(prompt=''):
    """Blocking input function that waits for user input"""
    import time
    try:
        # Print the prompt
        print(prompt, end='', flush=True)
        
        # Start the input process
        js.startInput(str(prompt))
        
        # Wait for input with timeout (20 seconds)
        timeout_seconds = 20
        start_time = time.time()
        
        while not js.checkInput():
            # Check timeout
            if time.time() - start_time > timeout_seconds:
                print(f"\\n[Input timeout after {timeout_seconds} seconds - using empty string]")
                js.getInputResult()  # Clear the state
                return ""
            
            # Small delay to prevent busy waiting
            time.sleep(0.1)
        
        # Get the result
        result = js.getInputResult()
        print(f"\\n[Input received: '{result}']")
        return result
        
    except Exception as e:
        print(f"Input error: {e}")
        return ""

def check_input():
    """Check if input is ready"""
    return js.checkInput()

def get_input():
    """Get the input result"""
    if js.checkInput():
        return js.getInputResult()
    else:
        return None

def refresh_files():
    """Manually refresh the file list"""
    js.refreshFileList()
    print("File list refreshed!")

# Replace built-in input
builtins.input = simple_input
builtins.check_input = check_input
builtins.get_input = get_input
builtins.refresh_files = refresh_files
builtins.write_file = write_file

print("Enhanced input and file system ready!")
print("Usage:")
print("1. Call input('prompt') - execution pauses until you provide input")
print("2. Type your answer in the input field that appears and press Enter")
print("3. Code execution resumes automatically with your input")
print("4. Use write_file(filename, content) for auto-refresh")
print("5. Use refresh_files() to manually refresh the file list")
print("Example:")
print("  name = input('What is your name? ')  # Pauses here for input")
print("  print(f'Hello, {name}!')  # Continues after you type and press Enter")
print("  write_file('text.txt', 'Hello World!')  # Auto-refreshes")

# Verify files exist
try:
    with open('text.txt', 'r') as f:
        content = f.read()
        print(f"text.txt loaded ({len(content)} characters)")
    with open('tester.csv', 'r') as f:
        content = f.read()
        print(f"tester.csv loaded ({len(content)} characters)")
    with open('binary.dat', 'r') as f:
        content = f.read()
        print(f"binary.dat loaded ({len(content)} characters)")
except Exception as e:
    print(f"Error setting up files: {e}")
            `);
        }

        
        function showTerminalInput(prompt, resolver) {
            console.log('showTerminalInput called with prompt:', prompt);
            
            const terminal = document.getElementById('terminal-output');
            const inputContainer = document.getElementById('input-container');
            const inputPrompt = document.getElementById('input-prompt');
            const terminalInput = document.getElementById('terminal-input');
            
            console.log('Elements found:', {
                terminal: !!terminal,
                inputContainer: !!inputContainer,
                inputPrompt: !!inputPrompt,
                terminalInput: !!terminalInput
            });
            
            if (!terminal || !inputContainer || !inputPrompt || !terminalInput) {
                console.error('Missing required elements!');
                resolver(''); 
                return;
            }
            
            
            updateTerminal(prompt);
            
            
            terminal.scrollTop = terminal.scrollHeight;
            
            
            inputPrompt.textContent = '';
            terminalInput.value = '';
            inputContainer.style.display = 'block';
            terminalInput.style.display = 'inline';
            
            
            setTimeout(() => {
                terminalInput.focus();
                terminal.scrollTop = terminal.scrollHeight;
            }, 50);
            
            isWaitingForInput = true;
            inputResolver = resolver;
            
            console.log('Input setup complete, waiting for user input');
            
            
            terminalInput.onkeydown = function(e) {
                if (e.key === 'Enter') {
                    console.log('Enter pressed, value:', terminalInput.value);
                    const value = terminalInput.value;
                    
                    
                    updateTerminal(value + '\n');
                    
                    
                    inputContainer.style.display = 'none';
                    isWaitingForInput = false;
                    
                    
                    if (inputResolver) {
                        console.log('Resolving with value:', value);
                        inputResolver(value);
                        inputResolver = null;
                    }
                }
            };
        }

        
        function saveScript() {
            const scriptName = document.getElementById('filename-input').value.trim();
            if (!scriptName) {
                updateStatus('Please enter a script name', 'error');
                return;
            }

            
            const allowedExtensions = ['.py', '.txt', '.csv', '.dat'];
            const hasValidExtension = allowedExtensions.some(ext => scriptName.toLowerCase().endsWith(ext));
            
            if (!hasValidExtension) {
                updateStatus('File name must end with .py, .txt, .csv, or .dat', 'error');
                return;
            }

            const code = getEditorValue();
            
            
            const isPythonScript = scriptName.toLowerCase().endsWith('.py');
            const storageKey = isPythonScript ? 'python_script_' + scriptName : 'data_file_' + scriptName;
            
            localStorage.setItem(storageKey, code);
            updateStatus(`${isPythonScript ? 'Script' : 'Data file'} '${scriptName}' saved to browser storage`, 'success');
            
            // Immediately save to database
            saveUserData().then(() => {
                console.log(`File ${scriptName} saved to account`);
            }).catch((error) => {
                console.error('Error saving to account:', error);
            });
            
            loadScriptList();
            currentScript = scriptName;
            document.getElementById('current-file').textContent = currentScript;
        }

        function loadScript() {
            if (!selectedScript) {
                updateStatus('Please select a file first', 'error');
                return;
            }

            
            let code = localStorage.getItem('python_script_' + selectedScript);
            if (code === null) {
                code = localStorage.getItem('data_file_' + selectedScript);
            }
            
            if (code !== null) {
                setEditorValue(code);
                currentScript = selectedScript;
                document.getElementById('current-file').textContent = currentScript;
                updateStatus(`File '${selectedScript}' loaded`, 'success');
            } else {
                updateStatus('File not found', 'error');
            }
        }

        function deleteScript() {
            if (!selectedScript) {
                updateStatus('Please select a file first', 'error');
                return;
            }

            if (confirm(`Delete file '${selectedScript}'?`)) {
                
                let deleted = false;
                if (localStorage.getItem('python_script_' + selectedScript)) {
                    localStorage.removeItem('python_script_' + selectedScript);
                    deleted = true;
                } else if (localStorage.getItem('data_file_' + selectedScript)) {
                    localStorage.removeItem('data_file_' + selectedScript);
                    deleted = true;
                }
                
                if (deleted) {
                    updateStatus(`File '${selectedScript}' deleted`, 'success');
                    
                    // Delete from database
                    deleteFromDatabase(selectedScript);
                    
                    loadScriptList();
                    selectedScript = '';
                    
                    
                    if (currentScript === selectedScript) {
                        setEditorValue('');
                        currentScript = '';
                        document.getElementById('current-file').textContent = 'No file selected';
                    }
                } else {
                    updateStatus('File not found', 'error');
                }
            }
        }

        function newScript() {
            setEditorValue(`# New Python Script
# Available files: text.txt, tester.csv, binary.dat

print("Hello from new script!")

# Example: Read allowed file
try:
    with open('text.txt', 'r') as f:
        content = f.read()
        print("File content:", content[:100] + "..." if len(content) > 100 else content)
except Exception as e:
    print("Error:", e)

# Example: Interactive input
try:
    user_input = input("Enter something: ")
    print(f"You entered: {user_input}")
except Exception as e:
    print("Input error:", e)
`);
            document.getElementById('filename-input').value = '';
            currentScript = 'untitled_script';
            document.getElementById('current-file').textContent = currentScript;
            
            updateStatus('New script created');
        }

        function selectScript(scriptName) {
            
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            
            event.target.classList.add('selected');
            selectedScript = scriptName;
            
            
            document.getElementById('filename-input').value = scriptName;
            
            
            const code = localStorage.getItem('python_script_' + scriptName);
            if (code !== null) {
                setEditorValue(code);
                currentScript = scriptName;
                document.getElementById('current-file').textContent = currentScript;
                updateStatus(`Loaded: ${scriptName} (${code.length} characters)`);
            } else {
                updateStatus(`Error: Script '${scriptName}' not found in browser storage`);
            }
        }

        function selectDataFile(filename) {
            
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            
            event.target.classList.add('selected');
            selectedScript = filename; 
            
            
            document.getElementById('filename-input').value = filename;
            
            
            const content = localStorage.getItem('data_file_' + filename);
            if (content !== null) {
                setEditorValue(content);
                currentScript = filename;
                document.getElementById('current-file').textContent = currentScript;
                updateStatus(`Loaded: ${filename} (${content.length} characters)`);
            } else {
                updateStatus(`Error: Data file '${filename}' not found in browser storage`);
            }
        }

        function loadScriptList() {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            const computedStyle = getComputedStyle(document.body);
            const textColor = computedStyle.getPropertyValue('--text-bright').trim() || '#00ff00';
            
            // Count data files
            let dataFileCount = 3; // Default files (text.txt, tester.csv, binary.dat)
            let customDataFileCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('data_file_')) {
                    customDataFileCount++;
                }
            }
            
            const dataSection = document.createElement('li');
            dataSection.innerHTML = `<strong>Data Files (${dataFileCount + customDataFileCount}):</strong>`;
            dataSection.style.color = textColor;
            dataSection.style.marginBottom = '10px';
            fileList.appendChild(dataSection);
            
            
            const allowedFiles = ['text.txt', 'tester.csv', 'binary.dat'];
            allowedFiles.forEach(filename => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.style.cursor = 'pointer';
                li.style.padding = '5px';
                li.style.marginLeft = '15px';
                
                
                let icon = '';
                if (filename.endsWith('.txt')) icon = '';
                else if (filename.endsWith('.csv')) icon = 'CSV';
                else if (filename.endsWith('.dat')) icon = 'DAT';
                
                
                try {
                    if (pyodide && pyodide.FS) {
                        try {
                            const content = pyodide.FS.readFile(filename, { encoding: 'utf8' });
                            li.innerHTML = `${icon} ${filename} <span style="color: #888">(${content.length} chars)</span>`;
                        } catch (e) {
                            li.innerHTML = `${icon} ${filename} <span style="color: #666">(empty)</span>`;
                        }
                    } else {
                        li.innerHTML = `${icon} ${filename} <span style="color: #666">(loading...)</span>`;
                    }
                } catch (e) {
                    li.innerHTML = `${icon} ${filename} <span style="color: #666">(error)</span>`;
                }
                
                li.onclick = () => selectFile(filename);
                fileList.appendChild(li);
            });
            
            
            let hasDataFiles = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('data_file_')) {
                    hasDataFiles = true;
                    const filename = key.replace('data_file_', '');
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.style.cursor = 'pointer';
                    li.style.padding = '5px';
                    li.style.marginLeft = '15px';
                    
                    
                    let icon = '';
                    if (filename.endsWith('.txt')) icon = '';
                    else if (filename.endsWith('.csv')) icon = 'CSV';
                    else if (filename.endsWith('.dat')) icon = 'DAT';
                    
                    const content = localStorage.getItem(key);
                    li.innerHTML = `${icon} ${filename} <span style="color: #888">(${content.length} chars)</span>`;
                    li.onclick = () => selectDataFile(filename);
                    fileList.appendChild(li);
                }
            }
            
            
            const separator = document.createElement('li');
            separator.innerHTML = '<hr style="border-color: #333; margin: 10px 0;">';
            fileList.appendChild(separator);
            
            // Count saved scripts
            let scriptCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('python_script_')) {
                    scriptCount++;
                }
            }
            
            const scriptSection = document.createElement('li');
            scriptSection.innerHTML = `<strong>Saved Scripts (${scriptCount}):</strong>`;
            scriptSection.style.color = textColor;
            scriptSection.style.marginBottom = '10px';
            fileList.appendChild(scriptSection);
            
            
            let hasScripts = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('python_script_')) {
                    hasScripts = true;
                    const scriptName = key.replace('python_script_', '');
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.style.cursor = 'pointer';
                    li.style.padding = '5px';
                    li.style.marginLeft = '15px';
                    
                    const content = localStorage.getItem(key);
                    li.innerHTML = `� ${scriptName} <span style="color: #888">(${content.split('\n').length} lines)</span>`;
                    li.onclick = () => selectScript(scriptName);
                    fileList.appendChild(li);
                }
            }
            
            if (!hasScripts) {
                const noScripts = document.createElement('li');
                noScripts.style.color = '#666';
                noScripts.style.marginLeft = '15px';
                noScripts.textContent = 'No saved scripts';
                fileList.appendChild(noScripts);
            }
        }

        
        function updateFileViewers() {
            if (!pyodide || !pyodide.FS) return;
            
            try {
                
                const textContent = pyodide.FS.readFile('text.txt', { encoding: 'utf8' });
                document.getElementById('text-content').textContent = textContent;
                
                
                const csvContent = pyodide.FS.readFile('tester.csv', { encoding: 'utf8' });
                document.getElementById('csv-content').textContent = csvContent;
                
                
                try {
                    
                    if (globalThis.binaryContent && globalThis.binaryContent !== 'Binary data example') {
                        document.getElementById('binary-content').textContent = globalThis.binaryContent;
                    } else {
                        
                        const binaryData = pyodide.FS.readFile('binary.dat');
                        let binaryDisplay = '';
                        
                        
                        try {
                            const pickleResult = pyodide.runPython(`
import pickle
import io
try:
    data = open('binary.dat', 'rb').read()
    items = []
    bio = io.BytesIO(data)
    try:
        while True:
            item = pickle.load(bio)
            items.append(str(item))
    except EOFError:
        pass
    if items:
        result = f"Pickle data ({len(items)} items):\\n" + "\\n".join(f"{i}: {item}" for i, item in enumerate(items))
    else:
        result = f"Binary file ({len(data)} bytes) - not pickle data"
    result
except Exception as e:
    f"Error parsing binary data: {str(e)}"
                            `);
                            binaryDisplay = pickleResult;
                            
                            globalThis.binaryContent = binaryDisplay;
                        } catch (e) {
                            binaryDisplay = `Binary file (${binaryData.length} bytes) - parsing error: ${e.message}`;
                        }
                        
                        document.getElementById('binary-content').textContent = binaryDisplay;
                    }
                    
                    
                    if (globalThis.binaryHexData && globalThis.binaryHexData !== 'No hex data available') {
                        document.getElementById('binary-hex').textContent = globalThis.binaryHexData;
                        document.getElementById('binary-hex').style.display = 'block';
                    }
                    
                } catch (e) {
                    document.getElementById('binary-content').textContent = 'Error reading binary file: ' + e.message;
                }
                
            } catch (error) {
                console.log('Error updating file viewers:', error);
                
                document.getElementById('text-content').textContent = 'File not found or empty';
                document.getElementById('csv-content').textContent = 'File not found or empty';
                document.getElementById('binary-content').textContent = 'File not found or empty';
            }
        }

        
        function selectFile(filename) {
            try {
                if (pyodide && pyodide.FS) {
                    const content = pyodide.FS.readFile(filename, { encoding: 'utf8' });
                    setEditorValue(content);
                    document.getElementById('filename-input').value = filename;
                    
                    
                    document.getElementById('current-file').textContent = filename;
                    
                    updateStatus(`Loaded: ${filename} (${content.length} characters)`);
                    

                    
                    
                    updateFileViewers();
                    
                    
                    document.querySelectorAll('.file-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    event.target.classList.add('selected');
                }
            } catch (e) {
                updateStatus(`Error loading ${filename}: ${e.message}`);
            }
        }

        
        function refreshFiles() {
            loadScriptList();
            updateStatus('File list refreshed');
        }


        function setupCodeEditor() {
            const codeTextarea = document.getElementById('code_content');
            

            codeTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const cursorPos = this.selectionStart;
                    const textBeforeCursor = this.value.substring(0, cursorPos);
                    const currentLine = textBeforeCursor.split('\n').pop();
                    
                    
                    if (currentLine.trim().endsWith(':')) {
                        e.preventDefault();
                        
                        
                        const indentMatch = currentLine.match(/^(\s*)/);
                        const currentIndent = indentMatch ? indentMatch[1] : '';
                        
                        
                        const newIndent = currentIndent + '    ';
                        const newText = this.value.substring(0, cursorPos) + '\n' + newIndent + this.value.substring(cursorPos);
                        
                        this.value = newText;
                        this.selectionStart = this.selectionEnd = cursorPos + 1 + newIndent.length;
                    }
                }
                

                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    
                    this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 4;
                }
            });
        }


        async function executeCode() {
            if (!isInitialized) {
                await initPyodide();
            }

            const code = getEditorValue();
            if (!code.trim()) {
                updateTerminal("No code to execute.\n");
                return;
            }

            updateTerminal(`\n>>> Executing code...\n`);
            document.getElementById('run-btn').disabled = true;
            
            try {
                // Set up output capture
                await pyodide.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
sys.stderr = StringIO()
                `);

                try {
                    // Execute the code asynchronously to handle input() properly
                    const result = await pyodide.runPythonAsync(code);
                } catch (error) {
                    if (error.name === 'PythonError') {
                        updateTerminal("Error: " + error.message + "\n", true);
                    } else {
                        throw error;
                    }
                }

                // Get the output
                const stdout = await pyodide.runPython("sys.stdout.getvalue()");
                const stderr = await pyodide.runPython("sys.stderr.getvalue()");

                // Restore output streams
                await pyodide.runPython(`
sys.stdout = sys.__stdout__
sys.stderr = sys.__stderr__
                `);

                // Display results
                if (stdout) {
                    updateTerminal(stdout);
                }
                if (stderr) {
                    updateTerminal("Error: " + stderr + "\n", true);
                }
                if (!stdout && !stderr) {
                    updateTerminal("[OK] Code executed successfully (no output)\n");
                }

            } catch (error) {
                updateTerminal("[ERROR] Execution Error: " + error.message + "\n", true);
                console.error("Execution error details:", error);
            }
            
            document.getElementById('run-btn').disabled = false;
            
            // Auto-save user data
            if (isLoggedIn) {
                saveUserData();
            }
            
            loadScriptList();
            updateFileViewers();
        }

        function clearTerminal() {
            document.getElementById('terminal-output').textContent = '';
            updateStatus('Terminal cleared', 'success');
        }

        function updateTerminal(message, isError = false) {
            const terminal = document.getElementById('terminal-output');
            const span = document.createElement('span');
            
            if (message.includes('<img')) {
                span.innerHTML = message; 
            } else {
                span.textContent = message; 
            }
            
            if (isError) {
                span.style.color = '#f44';
            }
            terminal.appendChild(span);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            
            if (type !== 'info') {
                setTimeout(() => {
                    status.textContent = 'Python Terminal Environment Ready';
                    status.className = '';
                }, 3000);
            }
        }

        // Async version of input dialog for better Python integration
        function showInputDialogAsync(prompt, resolve) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.3s ease-out;
            `;

            // Create modal dialog with pixel aesthetic
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #000000;
                border: 4px solid #ffffff;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                font-family: 'Press Start 2P', monospace;
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
                animation: slideIn 0.3s ease-out;
                position: relative;
            `;

            // Add pixel-perfect styling and content
            modal.innerHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: translateY(-50px) scale(0.9); opacity: 0; }
                        to { transform: translateY(0) scale(1); opacity: 1; }
                    }
                    @keyframes pixelPulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.7; }
                    }
                    .input-modal-title {
                        color: #ffffff;
                        margin-bottom: 20px;
                        font-size: 0.7rem;
                        line-height: 1.5;
                        text-shadow: 2px 2px 0 #000000;
                        text-align: center;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        border-bottom: 3px solid #ffffff;
                        padding-bottom: 15px;
                        animation: pixelPulse 2s infinite;
                    }
                    .input-modal-prompt {
                        color: #cccccc;
                        margin-bottom: 20px;
                        font-size: 0.6rem;
                        line-height: 1.8;
                        word-wrap: break-word;
                        background: #111111;
                        padding: 15px;
                        border: 2px solid #333333;
                    }
                    .input-modal-field {
                        width: calc(100% - 24px);
                        padding: 12px;
                        background: #000000;
                        border: 3px solid #ffffff;
                        color: #ffffff;
                        font-family: 'Press Start 2P', monospace;
                        font-size: 0.6rem;
                        margin-bottom: 25px;
                        outline: none;
                        box-shadow: 3px 3px 0 #ffffff;
                        transition: all 0.2s;
                    }
                    .input-modal-field:focus {
                        transform: translate(-2px, -2px);
                        box-shadow: 5px 5px 0 #ffffff;
                        border-color: #ffffff;
                    }
                    .input-modal-buttons {
                        display: flex;
                        gap: 15px;
                        justify-content: center;
                    }
                    .input-modal-btn {
                        padding: 12px 24px;
                        background: #000000;
                        border: 3px solid #ffffff;
                        color: #ffffff;
                        cursor: pointer;
                        font-family: 'Press Start 2P', monospace;
                        font-size: 0.5rem;
                        transition: all 0.2s;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        box-shadow: 3px 3px 0 #ffffff;
                        position: relative;
                    }
                    .input-modal-btn:hover {
                        background: #ffffff;
                        color: #000000;
                        transform: translate(2px, 2px);
                        box-shadow: 1px 1px 0 #ffffff;
                    }
                    .input-modal-btn:active {
                        transform: translate(3px, 3px);
                        box-shadow: none;
                    }
                    .input-modal-btn::before {
                        content: '';
                        position: absolute;
                        top: -3px;
                        left: -3px;
                        right: -3px;
                        bottom: -3px;
                        background: linear-gradient(45deg, transparent 48%, #ffffff 48%, #ffffff 52%, transparent 52%);
                        background-size: 6px 6px;
                        z-index: -1;
                        opacity: 0.2;
                    }
                </style>
                <div class="input-modal-title">PYTHON INPUT REQUIRED</div>
                <div class="input-modal-prompt">${prompt || 'Enter your input:'}</div>
                <input type="text" class="input-modal-field" id="python-input-field" placeholder="Type here..." autocomplete="off">
                <div class="input-modal-buttons">
                    <button class="input-modal-btn" id="input-ok-btn">SUBMIT</button>
                    <button class="input-modal-btn" id="input-cancel-btn">CANCEL</button>
                </div>
            `;

            const inputField = modal.querySelector('#python-input-field');
            const okButton = modal.querySelector('#input-ok-btn');
            const cancelButton = modal.querySelector('#input-cancel-btn');

            // Handle submission
            function submitInput() {
                const value = inputField.value;
                document.body.removeChild(overlay);
                resolve(value);
            }

            // Handle cancellation
            function cancelInput() {
                document.body.removeChild(overlay);
                resolve('');
            }

            // Event listeners
            okButton.addEventListener('click', submitInput);
            cancelButton.addEventListener('click', cancelInput);

            // Keyboard handling
            inputField.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitInput();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelInput();
                }
            });

            // Add to page and focus
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Focus with slight delay for better UX
            setTimeout(() => {
                inputField.focus();
                inputField.select();
            }, 150);
        }

        // Synchronous version using prompt as fallback
        function showInputDialog(prompt) {
            // Try to use a custom styled prompt-like dialog
            try {
                return window.prompt(prompt || 'Enter input:') || '';
            } catch (e) {
                return '';
            }
        }

        // Make both functions available globally for Pyodide
        window.showInputDialog = showInputDialog;
        window.showInputDialogAsync = showInputDialogAsync;

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                executeCode();
            }
            
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveScript();
            }
        });


        document.getElementById('filename-input').addEventListener('input', function(e) {
            if (e.target.value.trim()) {
                currentScript = e.target.value.trim();
                document.getElementById('current-file').textContent = currentScript;
            }
        });

        window.addEventListener('load', function() {
            setupCodeEditor();
            
            loadScriptList();
            initPyodide();
        });

        let isFocusMode = false;

        function toggleFocusMode() {
            const focusBtn = document.getElementById('focus-btn');
            const body = document.body;
            
            if (!isFocusMode) {
                body.classList.add('focus-mode');
                document.querySelectorAll('.file-manager, .file-viewers, .terminal-section').forEach(el => {
                    el.classList.add('background-blur');
                });
                focusBtn.innerHTML = 'EXIT';
                focusBtn.title = 'Exit focus mode';
                focusBtn.classList.add('active');
                document.getElementById('code_content').focus();
            } else {
                body.classList.remove('focus-mode');
                document.querySelectorAll('.file-manager, .file-viewers, .terminal-section').forEach(el => {
                    el.classList.remove('background-blur');
                });
                focusBtn.innerHTML = 'FOCUS';
                focusBtn.title = 'Focus Mode';
                focusBtn.classList.remove('active');
            }
            
            isFocusMode = !isFocusMode;
        }

        let isNotebookMode = false;
        let cellCounter = 8;
        let executionCounter = 1;

        function toggleNotebookMode() {
            const notebookBtn = document.getElementById('notebook-btn');
            const body = document.body;
            
            if (!isNotebookMode) {
                body.classList.add('notebook-mode');
                notebookBtn.innerHTML = 'EDITOR';
                notebookBtn.title = 'Switch to Editor Mode';
                notebookBtn.classList.add('active');
                updateCellCount();
                
                const firstCell = document.querySelector('.cell-textarea');
                if (firstCell) firstCell.focus();
            } else {
                body.classList.remove('notebook-mode');
                notebookBtn.innerHTML = 'NOTEBOOK';
                notebookBtn.title = 'Jupyter-style Notebook Mode';
                notebookBtn.classList.remove('active');
            }
            
            isNotebookMode = !isNotebookMode;
        }

        // History Modal Functions
        let historyModal = null;

        function toggleHistory() {
            if (!historyModal) {
                createHistoryModal();
            }
            
            if (historyModal.style.display === 'flex') {
                historyModal.style.display = 'none';
            } else {
                historyModal.style.display = 'flex';
                loadExecutionHistory();
            }
        }

        function createHistoryModal() {
            const modalHtml = `
                <div id="history-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; justify-content: center; align-items: center;">
                    <div style="background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
                        <div style="padding: 20px; border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary);">
                            <h2 style="margin: 0; color: var(--text-bright); font-size: 24px;">EXECUTION HISTORY</h2>
                            <button onclick="toggleHistory()" class="pixel-button" style="padding: 8px 16px;">CLOSE</button>
                        </div>
                        <div id="history-content" style="padding: 20px; overflow-y: auto; flex: 1; color: var(--text-primary);">
                            <div style="text-align: center; color: var(--text-secondary);">Loading...</div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            historyModal = document.getElementById('history-modal');
            
            // Close on outside click
            historyModal.addEventListener('click', (e) => {
                if (e.target === historyModal) {
                    toggleHistory();
                }
            });
        }

        async function loadExecutionHistory() {
            const content = document.getElementById('history-content');
            content.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">Loading...</div>';
            
            try {
                const response = await fetch('/python/get-history/', {
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                const data = await response.json();
                
                if (data.history && data.history.length > 0) {
                    const historyHtml = data.history.map((entry, index) => {
                        const date = new Date(entry.executed_at);
                        const timeStr = date.toLocaleString();
                        const codePreview = entry.code_snippet.substring(0, 100) + (entry.code_snippet.length > 100 ? '...' : '');
                        
                        return `
                            <div style="border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; margin-bottom: 15px; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s;" 
                                 onmouseover="this.style.borderColor='var(--primary-color)'" 
                                 onmouseout="this.style.borderColor='var(--border-color)'"
                                 onclick="restoreFromHistory(${index})">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <strong style="color: var(--text-bright);">${timeStr}</strong>
                                    <span style="color: var(--secondary-color);">Execution time: ${entry.execution_time.toFixed(3)}s</span>
                                </div>
                                <pre style="margin: 10px 0; padding: 10px; background: var(--bg-tertiary); border-radius: 4px; overflow-x: auto; color: var(--text-primary); font-size: 12px; white-space: pre-wrap;">${codePreview}</pre>
                                ${entry.output ? `<div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">Output available</div>` : ''}
                                ${entry.error ? `<div style="margin-top: 10px; font-size: 12px; color: #ff4444;">Error occurred</div>` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    content.innerHTML = historyHtml;
                    
                    // Store history data for restoration
                    window.historyData = data.history;
                } else {
                    content.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">No execution history yet. Run some code to see it here!</div>';
                }
            } catch (error) {
                content.innerHTML = '<div style="text-align: center; color: #ff4444;">Failed to load history</div>';
                console.error('Error loading history:', error);
            }
        }

        function restoreFromHistory(index) {
            if (window.historyData && window.historyData[index]) {
                const code = window.historyData[index].code_snippet;
                if (isNotebookMode) {
                    const firstCell = document.querySelector('.cell-textarea');
                    if (firstCell) {
                        firstCell.value = code;
                    }
                } else {
                    if (window.editor) {
                        window.editor.setValue(code, -1);
                    }
                }
                toggleHistory();
            }
        }

        // Share Modal Functions
        let shareModal = null;

        function toggleShareModal() {
            console.log('toggleShareModal called');
            if (!shareModal) {
                console.log('Creating share modal...');
                createShareModal();
                // After creating, show it
                if (shareModal) {
                    console.log('Modal created, showing now');
                    shareModal.style.display = 'flex';
                } else {
                    console.error('Failed to create modal!');
                }
                return;
            }
            
            if (shareModal.style.display === 'flex') {
                console.log('Hiding modal');
                shareModal.style.display = 'none';
            } else {
                console.log('Showing modal');
                shareModal.style.display = 'flex';
            }
        }

        function createShareModal() {
            const modalHtml = `
                <div id="share-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; justify-content: center; align-items: center;">
                    <div style="background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 8px; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
                        <div style="padding: 20px; border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary);">
                            <h2 style="margin: 0; color: var(--text-bright); font-size: 24px;">SHARE CODE</h2>
                            <button onclick="toggleShareModal()" class="pixel-button" style="padding: 8px 16px;">CLOSE</button>
                        </div>
                        <div id="share-content" style="padding: 20px; color: var(--text-primary);">
                            <!-- Session Type Selection -->
                            <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                                <label style="display: block; margin-bottom: 12px; color: var(--text-bright); font-weight: bold; font-size: 16px;">Share Type:</label>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <label style="display: flex; align-items: start; gap: 10px; padding: 12px; background: var(--bg-tertiary); border-radius: 4px; cursor: pointer; border: 2px solid transparent;" id="simple-share-option">
                                        <input type="radio" name="share-type" value="simple" checked style="margin-top: 2px;" onchange="updateShareType()">
                                        <div>
                                            <div style="color: var(--text-bright); font-weight: bold; margin-bottom: 4px;">SIMPLE SHARE (Read-Only)</div>
                                            <div style="font-size: 13px; color: var(--text-secondary);">Generate a link to view your code. Others can view and fork, but cannot edit.</div>
                                        </div>
                                    </label>
                                    <label style="display: flex; align-items: start; gap: 10px; padding: 12px; background: var(--bg-tertiary); border-radius: 4px; cursor: pointer; border: 2px solid transparent;" id="collab-share-option">
                                        <input type="radio" name="share-type" value="collaborative" style="margin-top: 2px;" onchange="updateShareType()">
                                        <div>
                                            <div style="color: var(--text-bright); font-weight: bold; margin-bottom: 4px;">COLLABORATIVE SESSION</div>
                                            <div style="font-size: 13px; color: var(--text-secondary);">Create a real-time coding session. You control who can edit. Import your .py files.</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-bright); font-weight: bold;">Title:</label>
                                <input type="text" id="share-title" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: inherit;" placeholder="My Awesome Code">
                            </div>
                            
                            <!-- File Selection Dropdown -->
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-bright); font-weight: bold;">Select File to Share:</label>
                                <select id="share-file-select" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: inherit;">
                                    <option value="current">Current Editor Content</option>
                                </select>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Choose which file to share</div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-bright); font-weight: bold;">Description (Optional):</label>
                                <textarea id="share-description" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: inherit; resize: vertical; min-height: 80px;" placeholder="Describe what your code does..."></textarea>
                            </div>
                            
                            <!-- File Import Section (Collaborative Only) -->
                            <div id="file-import-section" style="display: none; margin-bottom: 15px; padding: 15px; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                                <label style="display: block; margin-bottom: 8px; color: var(--text-bright); font-weight: bold;">Import Your .py Files (Optional):</label>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">Select saved .py files to import into the session</div>
                                <div id="file-import-list" style="max-height: 200px; overflow-y: auto; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
                                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">Loading your files...</div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px; display: flex; gap: 20px;">
                                <label style="display: flex; align-items: center; gap: 8px; color: var(--text-primary); cursor: pointer;">
                                    <input type="checkbox" id="share-public" checked style="width: 18px; height: 18px;">
                                    <span>Public (anyone can join)</span>
                                </label>
                            </div>
                            <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 4px; border: 1px solid var(--border-color);">
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    ⏱️ Session will expire in <strong style="color: var(--text-bright);">7 days</strong>
                                </div>
                            </div>
                            <button onclick="shareCode()" id="share-submit-btn" class="pixel-button" style="width: 100%; padding: 12px; font-size: 16px;">GENERATE SHARE LINK</button>
                            <div id="share-result" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            shareModal = document.getElementById('share-modal');
            
            // Close on outside click
            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    toggleShareModal();
                }
            });
            
            // Load user's .py files
            loadUserPyFiles();
        }
        
        function updateShareType() {
            const shareType = document.querySelector('input[name="share-type"]:checked').value;
            const fileImportSection = document.getElementById('file-import-section');
            const submitBtn = document.getElementById('share-submit-btn');
            const simpleOption = document.getElementById('simple-share-option');
            const collabOption = document.getElementById('collab-share-option');
            
            if (shareType === 'collaborative') {
                fileImportSection.style.display = 'block';
                submitBtn.textContent = 'CREATE COLLABORATIVE SESSION';
                simpleOption.style.borderColor = 'transparent';
                collabOption.style.borderColor = 'var(--primary-color)';
            } else {
                fileImportSection.style.display = 'none';
                submitBtn.textContent = 'GENERATE SHARE LINK';
                simpleOption.style.borderColor = 'var(--primary-color)';
                collabOption.style.borderColor = 'transparent';
            }
        }
        
        async function loadUserPyFiles() {
            try {
                const response = await fetch('/python/get-files/', {
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                const data = await response.json();
                
                const fileList = document.getElementById('file-import-list');
                const fileSelect = document.getElementById('share-file-select');
                
                // Handle the actual response structure from backend
                // Backend returns: { saved_files: ['file1.py', 'file2.py', ...] }
                let pyFiles = [];
                if (data.saved_files && Array.isArray(data.saved_files)) {
                    pyFiles = data.saved_files.filter(filename => filename && filename.endsWith('.py'));
                } else if (data.files && Array.isArray(data.files)) {
                    // Fallback for object structure { files: [{filename: 'x.py'}, ...] }
                    pyFiles = data.files.filter(f => f.filename && f.filename.endsWith('.py')).map(f => f.filename);
                }
                
                // Populate the file selection dropdown
                if (fileSelect) {
                    // Keep "Current Editor Content" option and add saved files
                    const fileOptions = pyFiles.map(filename => 
                        `<option value="${filename}">${filename}</option>`
                    ).join('');
                    fileSelect.innerHTML = `
                        <option value="current">Current Editor Content</option>
                        ${pyFiles.length > 0 ? '<option disabled>──────────</option>' : ''}
                        ${fileOptions}
                    `;
                }
                
                // Populate the collaborative import checkboxes
                if (fileList) {
                    if (pyFiles.length === 0) {
                        fileList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No .py files found</div>';
                    } else {
                        fileList.innerHTML = pyFiles.map(filename => `
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 4px;" onmouseover="this.style.background='var(--bg-primary)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" class="import-file-checkbox" value="${filename}" style="width: 16px; height: 16px;">
                                <span style="color: var(--text-primary); font-family: monospace; font-size: 13px;">${filename}</span>
                            </label>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading files:', error);
                const fileList = document.getElementById('file-import-list');
                if (fileList) {
                    fileList.innerHTML = '<div style="text-align: center; color: #ff4444; padding: 20px;">Failed to load files. Please try again.</div>';
                }
            }
        }

        async function shareCode() {
            console.log('shareCode function called');
            const resultDiv = document.getElementById('share-result');
            const title = document.getElementById('share-title').value.trim();
            const description = document.getElementById('share-description').value.trim();
            const isPublic = document.getElementById('share-public').checked;
            const expiryDays = 7; // Fixed to 7 days
            const shareType = document.querySelector('input[name="share-type"]:checked').value;
            const selectedFile = document.getElementById('share-file-select').value;
            
            console.log('Share data:', { title, description, isPublic, shareType, selectedFile });
            
            if (!title) {
                resultDiv.innerHTML = '<div style="padding: 10px; background: #ff4444; color: white; border-radius: 4px;">Please enter a title</div>';
                return;
            }
            
            // Get code based on selected file
            let code = '';
            
            if (selectedFile === 'current') {
                // Use current editor content
                if (isNotebookMode) {
                    const cells = document.querySelectorAll('.cell-textarea');
                    code = Array.from(cells).map(cell => cell.value).join('\n\n# --- Cell Break ---\n\n');
                } else {
                    code = window.editor ? window.editor.getValue() : '';
                }
            } else {
                // Fetch selected file content from backend
                resultDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">Loading file...</div>';
                try {
                    const filesResponse = await fetch('/python/get-files/', {
                        headers: {'X-CSRFToken': '{{ csrf_token }}'}
                    });
                    const filesData = await filesResponse.json();
                    
                    if (filesData.python_files && filesData.python_files[selectedFile]) {
                        code = filesData.python_files[selectedFile];
                    } else {
                        resultDiv.innerHTML = '<div style="padding: 10px; background: #ff4444; color: white; border-radius: 4px;">Could not load selected file</div>';
                        return;
                    }
                } catch (error) {
                    resultDiv.innerHTML = '<div style="padding: 10px; background: #ff4444; color: white; border-radius: 4px;">Error loading file</div>';
                    return;
                }
            }
            
            if (!code.trim()) {
                resultDiv.innerHTML = '<div style="padding: 10px; background: #ff4444; color: white; border-radius: 4px;">No code to share. Please select a file or write code in the editor.</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">' + 
                (shareType === 'collaborative' ? 'Creating session...' : 'Generating share link...') + '</div>';
            
            try {
                let response, data;
                
                if (shareType === 'collaborative') {
                    // Get selected files to import
                    const selectedFiles = Array.from(document.querySelectorAll('.import-file-checkbox:checked')).map(cb => cb.value);
                    const importedFiles = {};
                    
                    // Fetch file contents if any selected
                    if (selectedFiles.length > 0) {
                        const filesResponse = await fetch('/python/get-files/', {
                            headers: {'X-CSRFToken': '{{ csrf_token }}'}
                        });
                        const filesData = await filesResponse.json();
                        // Backend returns { python_files: {filename: content}, saved_files: [filenames] }
                        selectedFiles.forEach(filename => {
                            if (filesData.python_files && filesData.python_files[filename]) {
                                importedFiles[filename] = filesData.python_files[filename];
                            }
                        });
                    }
                    
                    // Create collaborative session
                    response = await fetch('/python/session/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            title: title,
                            description: description,
                            is_public: isPublic,
                            code: code,
                            imported_files: importedFiles,
                            expires_days: expiryDays
                        })
                    });
                    
                    data = await response.json();
                    
                    if (data.session_url) {
                        const fullUrl = window.location.origin + data.session_url;
                        const expiresDate = new Date(data.expires_at).toLocaleDateString();
                        const selectedFilesCount = selectedFiles.length;
                        resultDiv.innerHTML = `
                            <div style="padding: 15px; background: var(--bg-secondary); border: 2px solid var(--primary-color); border-radius: 4px;">
                                <div style="margin-bottom: 10px; color: var(--text-bright); font-weight: bold;">✓ Collaborative Session Created!</div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">
                                    Expires: ${expiresDate} | Imported: ${selectedFilesCount} file(s)
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                    <input type="text" value="${fullUrl}" readonly id="share-url-input" style="flex: 1; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: monospace; font-size: 12px;">
                                    <button onclick="copyShareUrl()" class="pixel-button" style="padding: 8px 16px;">COPY</button>
                                </div>
                                <button onclick="window.location.href = '${data.session_url}'" class="pixel-button" style="width: 100%; padding: 10px;">JOIN SESSION</button>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = '<div style="padding: 10px; background: #ff4444; color: white; border-radius: 4px;">Failed to create session: ' + (data.message || 'Unknown error') + '</div>';
                    }
                } else {
                    // Simple share
                    response = await fetch('/python/share/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            code: code,
                            title: title,
                            description: description,
                            is_public: isPublic,
                            expires_in_days: expiryDays
                        })
                    });
                    
                    data = await response.json();
                    
                    if (data.share_url) {
                        // Backend already returns full URL, no need to prepend origin
                        const fullUrl = data.share_url;
                        resultDiv.innerHTML = `
                            <div style="padding: 15px; background: var(--bg-secondary); border: 2px solid var(--primary-color); border-radius: 4px;">
                                <div style="margin-bottom: 10px; color: var(--text-bright); font-weight: bold;">✓ Share Link Generated!</div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">
                                    Anyone with this link can view your code (expires in 7 days)
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                    <input type="text" value="${fullUrl}" readonly id="share-url-input" style="flex: 1; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: monospace; font-size: 12px;">
                                    <button onclick="copyShareUrl()" class="pixel-button" style="padding: 8px 16px;">COPY</button>
                                </div>
                                <button onclick="window.open('${fullUrl}', '_blank')" class="pixel-button" style="width: 100%; padding: 10px;">VIEW SHARED CODE</button>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = '<div style="padding: 10px; background: #ff4444; color: white; border-radius: 4px;">Failed to generate share link</div>';
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = '<div style="padding: 10px; background: #ff4444; color: white; border-radius: 4px;">Error: ' + error.message + '</div>';
                console.error('Error sharing code:', error);
            }
        }

        function copyShareUrl() {
            const input = document.getElementById('share-url-input');
            input.select();
            document.execCommand('copy');
            
            const resultDiv = document.getElementById('share-result');
            const originalHtml = resultDiv.innerHTML;
            resultDiv.innerHTML = '<div style="padding: 10px; background: var(--primary-color); color: var(--bg-primary); border-radius: 4px; text-align: center; font-weight: bold;">COPIED TO CLIPBOARD!</div>';
            
            setTimeout(() => {
                resultDiv.innerHTML = originalHtml;
            }, 2000);
        }

        // Members Modal Functions (for collaborative sessions)
        let membersModal = null;
        let currentSessionId = null;
        let isSessionOwner = false;
        let membersRefreshInterval = null;

        function toggleMembersModal() {
            if (!membersModal) {
                createMembersModal();
            }
            
            if (membersModal.style.display === 'flex') {
                membersModal.style.display = 'none';
                if (membersRefreshInterval) {
                    clearInterval(membersRefreshInterval);
                    membersRefreshInterval = null;
                }
            } else {
                membersModal.style.display = 'flex';
                loadSessionMembers();
                // Auto-refresh members list every 5 seconds
                membersRefreshInterval = setInterval(loadSessionMembers, 5000);
            }
        }

        function createMembersModal() {
            const modalHtml = `
                <div id="members-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; justify-content: center; align-items: center;">
                    <div style="background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
                        <div style="padding: 20px; border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary);">
                            <h2 style="margin: 0; color: var(--text-bright); font-size: 24px;">SESSION MEMBERS</h2>
                            <button onclick="toggleMembersModal()" class="pixel-button" style="padding: 8px 16px;">CLOSE</button>
                        </div>
                        <div id="members-content" style="padding: 20px; overflow-y: auto; flex: 1; color: var(--text-primary);">
                            <div style="text-align: center; color: var(--text-secondary);">Loading members...</div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            membersModal = document.getElementById('members-modal');
            
            // Close on outside click
            membersModal.addEventListener('click', (e) => {
                if (e.target === membersModal) {
                    toggleMembersModal();
                }
            });
        }

        async function loadSessionMembers() {
            if (!currentSessionId) return;
            
            const content = document.getElementById('members-content');
            
            try {
                const response = await fetch(`/python/session/${currentSessionId}/members/`, {
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                const data = await response.json();
                
                if (data.members && data.members.length > 0) {
                    const membersHtml = data.members.map(member => {
                        const onlineIndicator = member.is_online ? 
                            '<span style="display: inline-block; width: 10px; height: 10px; background: #00ff00; border-radius: 50%; margin-right: 8px;"></span>' :
                            '<span style="display: inline-block; width: 10px; height: 10px; background: #666; border-radius: 50%; margin-right: 8px;"></span>';
                        
                        const ownerBadge = member.is_owner ? 
                            '<span style="background: var(--primary-color); color: var(--bg-primary); padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; margin-left: 8px;">OWNER</span>' : '';
                        
                        const permissionControls = isSessionOwner && !member.is_owner ? `
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select onchange="changeMemberPermission('${member.user_id}', this.value)" style="padding: 4px 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-size: 12px;">
                                    <option value="view" ${member.permission === 'view' ? 'selected' : ''}>View Only</option>
                                    <option value="edit" ${member.permission === 'edit' ? 'selected' : ''}>Can Edit</option>
                                </select>
                                <button onclick="removeMember('${member.user_id}', '${member.username}')" class="pixel-button" style="padding: 4px 12px; font-size: 12px; background: #cc0000;">KICK</button>
                            </div>
                        ` : `<span style="color: var(--text-secondary); font-size: 13px;">${member.permission === 'edit' ? 'Can Edit' : 'View Only'}</span>`;
                        
                        return `
                            <div style="border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; margin-bottom: 12px; background: var(--bg-secondary);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${isSessionOwner && !member.is_owner ? '10px' : '0'};">
                                    <div style="display: flex; align-items: center;">
                                        ${onlineIndicator}
                                        <strong style="color: var(--text-bright); font-size: 16px;">${member.username}</strong>
                                        ${ownerBadge}
                                    </div>
                                    ${member.is_owner ? '<span style="color: var(--text-secondary); font-size: 13px;">Full Access</span>' : ''}
                                </div>
                                ${!member.is_owner ? permissionControls : ''}
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                                    Last active: ${new Date(member.last_active).toLocaleString()}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    const onlineCount = data.members.filter(m => m.is_online).length;
                    const totalCount = data.members.length;
                    
                    content.innerHTML = `
                        <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 4px; border: 1px solid var(--border-color);">
                            <div style="color: var(--text-bright); font-weight: bold;">
                                ${onlineCount} / ${totalCount} members online
                            </div>
                        </div>
                        ${membersHtml}
                    `;
                } else {
                    content.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">No members in this session yet.</div>';
                }
            } catch (error) {
                content.innerHTML = '<div style="text-align: center; color: #ff4444;">Failed to load members</div>';
                console.error('Error loading members:', error);
            }
        }

        async function changeMemberPermission(userId, permission) {
            if (!currentSessionId) return;
            
            try {
                const response = await fetch(`/python/session/${currentSessionId}/permission/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        permission: permission
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Refresh the members list
                    loadSessionMembers();
                } else {
                    alert('Failed to update permission: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error changing permission:', error);
                alert('Error changing permission');
            }
        }

        async function removeMember(userId, username) {
            if (!currentSessionId) return;
            
            if (!confirm(`Remove ${username} from the session?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/python/session/${currentSessionId}/remove-member/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        user_id: userId
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Refresh the members list
                    loadSessionMembers();
                } else {
                    alert('Failed to remove member: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error removing member:', error);
                alert('Error removing member');
            }
        }

        function addNotebookCell(type = 'code') {
            cellCounter++;
            const cellsContainer = document.getElementById('notebook-cells');
            const cellHtml = createCellHtml(cellCounter, type);
            
            const cellDiv = document.createElement('div');
            cellDiv.innerHTML = cellHtml;
            const cell = cellDiv.firstElementChild;
            
            cellsContainer.appendChild(cell);
            updateCellCount();
            
            const textarea = cell.querySelector('.cell-textarea');
            if (textarea) {
                textarea.focus();
                setupCellKeyboardShortcuts(textarea);
            }
        }

        function createCellHtml(cellId, type) {
            const isMarkdown = type === 'markdown';
            const cellType = isMarkdown ? 'markdown-cell' : 'code-cell';
            const cellLabel = isMarkdown ? 'Markdown Cell' : 'Code Cell';
            const executionLabel = isMarkdown ? '' : `In [${cellId}]:`;
            const placeholder = isMarkdown ? 
                '# Markdown Cell\n\nWrite markdown here...\n\n- **Bold text**\n- *Italic text*\n- `code`\n- [Links](https://example.com)' :
                '# Write your Python code here\n# Press Shift+Enter to run this cell\n\nprint("Hello from cell ' + cellId + '!")';

            return `
            <div class="notebook-cell ${cellType}" data-cell-id="${cellId}" data-cell-type="${type}">
                <div class="cell-header">
                    <div class="cell-type">
                        <span class="cell-execution-count">${executionLabel}</span>
                        ${cellLabel}
                    </div>
                    <div class="cell-controls">
                        <button class="cell-btn" onclick="runCell(this)" title="Run Cell">▶</button>
                        <button class="cell-btn" onclick="moveCell(this, -1)" title="Move Up">↑</button>
                        <button class="cell-btn" onclick="moveCell(this, 1)" title="Move Down">↓</button>
                        <button class="cell-btn" onclick="convertCell(this)" title="Convert Type">${isMarkdown ? 'C' : 'M'}</button>
                        <button class="cell-btn" onclick="expandCell(this)" title="Expand">⛶</button>
                        <button class="cell-btn" onclick="deleteCell(this)" title="Delete">×</button>
                    </div>
                </div>
                <div class="cell-input">
                    <textarea class="cell-textarea" placeholder="${placeholder}"></textarea>
                </div>
                <div class="cell-output" id="output-${cellId}"></div>
            </div>`;
        }

        function runCell(button) {
            const cell = button.closest('.notebook-cell');
            const textarea = cell.querySelector('.cell-textarea');
            const output = cell.querySelector('.cell-output');
            const cellType = cell.dataset.cellType;
            
            if (cellType === 'markdown') {
                renderMarkdown(textarea.value, output);
            } else {
                runPythonCode(textarea.value, output, cell.dataset.cellId);
            }
        }

        function renderMarkdown(markdown, outputElement) {
            let html = markdown
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/\n/g, '<br>');

            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            
            outputElement.innerHTML = html;
            outputElement.classList.add('has-output');
            outputElement.style.color = '#ccc';
        }

        async function runPythonCode(code, outputElement, cellId) {
            return runPythonCodeEnhanced(code, outputElement, cellId);
        }

        function moveCell(button, direction) {
            const cell = button.closest('.notebook-cell');
            const sibling = direction === -1 ? cell.previousElementSibling : cell.nextElementSibling;
            
            if (sibling && sibling.classList.contains('notebook-cell')) {
                if (direction === -1) {
                    sibling.parentNode.insertBefore(cell, sibling);
                } else {
                    sibling.parentNode.insertBefore(sibling, cell);
                }
            }
        }

        function deleteCell(button) {
            const cell = button.closest('.notebook-cell');
            const cellsContainer = document.getElementById('notebook-cells');
            
            if (cellsContainer.children.length > 1) {
                cell.remove();
                updateCellCount();
            } else {
                alert('Cannot delete the last cell');
            }
        }

        function convertCell(button) {
            const cell = button.closest('.notebook-cell');
            const currentType = cell.dataset.cellType;
            const newType = currentType === 'code' ? 'markdown' : 'code';
            
            const output = cell.querySelector('.cell-output');
            output.innerHTML = '';
            output.classList.remove('has-output');
            
            cell.dataset.cellType = newType;
            cell.className = `notebook-cell ${newType}-cell`;
            
            button.textContent = newType === 'code' ? 'M' : 'C';
            button.title = newType === 'code' ? 'Convert to Markdown' : 'Convert to Code';
            
            const cellTypeSpan = cell.querySelector('.cell-type');
            const executionSpan = cellTypeSpan.querySelector('.cell-execution-count');
            const isMarkdown = newType === 'markdown';
            
            executionSpan.textContent = isMarkdown ? '' : `In [${cell.dataset.cellId}]:`;
            cellTypeSpan.childNodes[cellTypeSpan.childNodes.length - 1].textContent = 
                isMarkdown ? 'Markdown Cell' : 'Code Cell';
        }

        // Global variable to track expanded cell editor
        let expandedCellEditor = null;
        let expandedCellTextarea = null;

        function expandCell(button) {
            const cell = button.closest('.notebook-cell');
            const textarea = cell.querySelector('.cell-textarea');
            const cellId = cell.dataset.cellId;
            const cellType = cell.dataset.cellType;
            
            // Store reference to the original textarea
            expandedCellTextarea = textarea;
            
            // Show the modal
            const modal = document.getElementById('cell-expand-modal');
            const titleEl = document.getElementById('expand-modal-title');
            titleEl.textContent = `Cell ${cellId} - ${cellType === 'code' ? 'Code' : 'Markdown'} Editor`;
            modal.classList.add('active');
            
            // Initialize Ace editor if not already done
            if (!expandedCellEditor) {
                expandedCellEditor = ace.edit('expanded-ace-editor');
                expandedCellEditor.setOptions({
                    enableBasicAutocompletion: true,
                    enableLiveAutocompletion: true,
                    enableSnippets: true,
                    fontSize: '16px',
                    showPrintMargin: false
                });
            }
            
            // Set the theme based on current theme
            const body = document.body;
            let aceTheme = 'ace/theme/monokai';
            if (body.classList.contains('theme-greydom') || body.classList.contains('theme-default')) {
                aceTheme = 'ace/theme/monokai';
            } else if (body.classList.contains('theme-cloud')) {
                aceTheme = 'ace/theme/katzenmilch';
            } else if (body.classList.contains('theme-chaos')) {
                aceTheme = 'ace/theme/chaos';
            } else if (body.classList.contains('theme-lebron')) {
                aceTheme = 'ace/theme/katzenmilch';
            }
            expandedCellEditor.setTheme(aceTheme);
            
            // Set mode for syntax highlighting
            if (cellType === 'code') {
                expandedCellEditor.session.setMode('ace/mode/python');
            } else {
                expandedCellEditor.session.setMode('ace/mode/markdown');
            }
            
            // Load content from textarea
            expandedCellEditor.setValue(textarea.value, -1);
            
            // Focus the editor
            expandedCellEditor.focus();
            
            // Set up sync from editor back to textarea on every change
            expandedCellEditor.session.on('change', function() {
                if (expandedCellTextarea) {
                    expandedCellTextarea.value = expandedCellEditor.getValue();
                }
            });
        }

        function closeExpandedCell() {
            const modal = document.getElementById('cell-expand-modal');
            modal.classList.remove('active');
            
            // Sync final content one more time
            if (expandedCellEditor && expandedCellTextarea) {
                expandedCellTextarea.value = expandedCellEditor.getValue();
            }
            
            // Clear reference
            expandedCellTextarea = null;
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('cell-expand-modal');
                if (modal.classList.contains('active')) {
                    closeExpandedCell();
                }
            }
        });

        function runAllCells() {
            const cells = document.querySelectorAll('.notebook-cell');
            cells.forEach(cell => {
                const runButton = cell.querySelector('.cell-btn[onclick*="runCell"]');
                if (runButton) runCell(runButton);
            });
        }

        function clearAllOutputs() {
            const outputs = document.querySelectorAll('.cell-output');
            outputs.forEach(output => {
                output.innerHTML = '';
                output.classList.remove('has-output');
            });
        }

        function updateCellCount() {
            const cellCount = document.querySelectorAll('.notebook-cell').length;
            const counter = document.getElementById('cell-count');
            if (counter) counter.textContent = cellCount;
        }

        function exportNotebook() {
            const cells = [];
            document.querySelectorAll('.notebook-cell').forEach(cell => {
                const cellType = cell.dataset.cellType;
                const content = cell.querySelector('.cell-textarea').value;
                const output = cell.querySelector('.cell-output').innerHTML;
                
                cells.push({
                    cell_type: cellType,
                    source: content,
                    outputs: output ? [{ text: output }] : []
                });
            });
            
            const notebook = {
                cells: cells,
                metadata: {
                    kernelspec: {
                        display_name: "Python 3 (Pyodide)",
                        language: "python",
                        name: "python3"
                    }
                },
                nbformat: 4,
                nbformat_minor: 4
            };
            
            const dataStr = JSON.stringify(notebook, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportName = 'notebook.ipynb';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
        }

        function setupCellKeyboardShortcuts(textarea) {
            textarea.addEventListener('keydown', function(e) {
                const cell = textarea.closest('.notebook-cell');
                
                if (e.shiftKey && e.key === 'Enter') {
                    e.preventDefault();
                    const runButton = cell.querySelector('.cell-btn[onclick*="runCell"]');
                    if (runButton) {
                        runCell(runButton);
                        const nextCell = cell.nextElementSibling;
                        if (nextCell && nextCell.classList.contains('notebook-cell')) {
                            nextCell.querySelector('.cell-textarea').focus();
                        } else {
                            addNotebookCell('code');
                        }
                    }
                }
                
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    const runButton = cell.querySelector('.cell-btn[onclick*="runCell"]');
                    if (runButton) runCell(runButton);
                }
                
                if (e.altKey && e.key === 'Enter') {
                    e.preventDefault();
                    const runButton = cell.querySelector('.cell-btn[onclick*="runCell"]');
                    if (runButton) runCell(runButton);
                    addNotebookCell('code');
                }
                
                if (e.key === 'Escape') {
                    textarea.blur();
                }
                
                if (e.key === 'Tab' && !e.shiftKey) {
                    const cursorPos = textarea.selectionStart;
                    const textBefore = textarea.value.substring(0, cursorPos);
                    const lastWord = textBefore.split(/\s/).pop();
                    
                    const completions = {
                        'np': 'import numpy as np',
                        'pd': 'import pandas as pd',
                        'plt': 'import matplotlib.pyplot as plt',
                        'fig': 'plt.figure(figsize=(10, 6))',
                        'show': 'plt.show()',
                        'pr': 'print()',
                        'def': 'def function_name():\n    pass',
                        'for': 'for i in range():\n    ',
                        'if': 'if condition:\n    '
                    };
                    
                    if (completions[lastWord]) {
                        e.preventDefault();
                        const beforeLastWord = textBefore.substring(0, textBefore.lastIndexOf(lastWord));
                        const afterCursor = textarea.value.substring(cursorPos);
                        textarea.value = beforeLastWord + completions[lastWord] + afterCursor;
                        
                        const newPos = beforeLastWord.length + completions[lastWord].length;
                        textarea.setSelectionRange(newPos, newPos);
                    }
                }
            });
        }

        function showKeyboardShortcuts() {
            const helpContent = `
<div style="background: #111; color: #fff; padding: 20px; border-radius: 8px; max-width: 500px;">
    <h3 style="color: var(--text-bright); margin-top: 0;">KEYBOARD SHORTCUTS</h3>
    
    <h4 style="color: #ccc; margin-bottom: 10px;">Cell Execution:</h4>
    <div style="font-family: monospace; margin-bottom: 15px;">
        <code>Shift + Enter</code> - Run cell and select next<br>
        <code>Ctrl + Enter</code> - Run cell (stay in cell)<br>
        <code>Alt + Enter</code> - Run cell and add new cell below<br>
    </div>
    
    <h4 style="color: #ccc; margin-bottom: 10px;">Cell Management:</h4>
    <div style="font-family: monospace; margin-bottom: 15px;">
        <code>Escape</code> - Exit cell edit mode<br>
        <code>Tab</code> - Auto-complete common patterns<br>
    </div>
    
    <h4 style="color: #ccc; margin-bottom: 10px;">Auto-completions:</h4>
    <div style="font-family: monospace; margin-bottom: 15px;">
        <code>np + Tab</code> → <code>import numpy as np</code><br>
        <code>pd + Tab</code> → <code>import pandas as pd</code><br>
        <code>plt + Tab</code> → <code>import matplotlib.pyplot as plt</code><br>
        <code>fig + Tab</code> → <code>plt.figure(figsize=(10, 6))</code><br>
        <code>show + Tab</code> → <code>plt.show()</code><br>
    </div>
    
    <div style="color: #888; font-size: 11px; margin-top: 15px;">
        [TIP] Your notebook auto-saves every 30 seconds!
    </div>
</div>
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: 'Courier New', monospace;
            `;
            
            modal.innerHTML = helpContent;
            modal.addEventListener('click', () => modal.remove());
            document.body.appendChild(modal);
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.cell-textarea').forEach(setupCellKeyboardShortcuts);
            loadNotebookFromStorage();
            setupAutoSave();
        });

        function setupAutoSave() {
            setInterval(saveNotebookToStorage, 30000); 
            
            
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('cell-textarea')) {
                    clearTimeout(window.autoSaveTimeout);
                    window.autoSaveTimeout = setTimeout(saveNotebookToStorage, 3000);
                }
            });
        }

        function saveNotebookToStorage() {
            if (!isNotebookMode) return;
            
            const cells = [];
            document.querySelectorAll('.notebook-cell').forEach(cell => {
                cells.push({
                    id: cell.dataset.cellId,
                    type: cell.dataset.cellType,
                    content: cell.querySelector('.cell-textarea').value,
                    output: cell.querySelector('.cell-output').innerHTML
                });
            });
            
            localStorage.setItem('pythonNotebook', JSON.stringify({
                cells: cells,
                timestamp: Date.now()
            }));
            
            
            showSaveIndicator();
        }

        function loadNotebookFromStorage() {
            const saved = localStorage.getItem('pythonNotebook');
            if (!saved) return;
            
            try {
                const notebook = JSON.parse(saved);
                
                
            } catch (e) {
                console.log('Could not load saved notebook');
            }
        }

        function showSaveIndicator() {
            const indicator = document.createElement('div');
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 136, 0, 0.9);
                color: white;
                padding: 8px 16px;
                border-radius: 4px;
                font-size: 12px;
                z-index: 10000;
                transition: opacity 0.3s;
            `;
            indicator.textContent = '[SAVED]';
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.style.opacity = '0';
                setTimeout(() => indicator.remove(), 300);
            }, 1500);
        }

        
        function runPythonCodeEnhanced(code, outputElement, cellId) {
            if (!pyodide) {
                outputElement.innerHTML = 'Error: Python environment not ready';
                outputElement.classList.add('has-output');
                return;
            }

            const startTime = performance.now();
            
            try {
                outputElement.innerHTML = '⏳ Executing...';
                outputElement.classList.add('has-output');
                
                
                let stdout = '';
                let stderr = '';
                
                pyodide.runPython(`
import sys
from io import StringIO
import traceback

_stdout_capture = StringIO()
_stderr_capture = StringIO()
_old_stdout = sys.stdout
_old_stderr = sys.stderr
sys.stdout = _stdout_capture
sys.stderr = _stderr_capture
                `);

                
                let result;
                try {
                    result = pyodide.runPython(code);
                } catch (pythonError) {
                    
                    stderr = pyodide.runPython(`
import traceback
traceback.print_exc()
_stderr_capture.getvalue()
                    `);
                }
                
                
                stdout = pyodide.runPython('_stdout_capture.getvalue()');
                if (!stderr) {
                    stderr = pyodide.runPython('_stderr_capture.getvalue()');
                }
                
                
                pyodide.runPython(`
sys.stdout = _old_stdout
sys.stderr = _old_stderr
                `);
                
                
                const executionTime = (performance.now() - startTime).toFixed(2);
                
                
                const executionSpan = outputElement.closest('.notebook-cell').querySelector('.cell-execution-count');
                if (executionSpan && !executionSpan.textContent.includes('Markdown')) {
                    executionSpan.textContent = `In [${executionCounter}]:`;
                    executionCounter++;
                }
                
                
                let output = '';
                if (stderr) {
                    output += `<span style="color: #ff4444;">Error:\n${stderr}</span>`;
                } else {
                    if (stdout) output += stdout;
                    if (result !== undefined && result !== null && result !== '') {
                        output += (output ? '\n' : '') + String(result);
                    }
                    if (!output) output = '(no output)';
                }
                
                output += `\n<span style="color: #666; font-size: 11px;">[TIME] Executed in ${executionTime}ms</span>`;
                
                outputElement.innerHTML = output;
                outputElement.style.color = stderr ? '#ff4444' : '#fff';
                
                // Save execution to history
                saveExecutionToHistory(code, stdout || output, stderr, executionTime, !stderr);
                
            } catch (error) {
                const executionTime = (performance.now() - startTime).toFixed(2);
                outputElement.innerHTML = `<span style="color: #ff4444;">JavaScript Error: ${error.message}</span>\n<span style="color: #666; font-size: 11px;">[TIME] Failed after ${executionTime}ms</span>`;
                outputElement.style.color = '#ff4444';
                outputElement.classList.add('has-output');
                
                // Save failed execution to history
                saveExecutionToHistory(code, '', error.message, executionTime, false);
            }
        }

    </script>

    
    <div class="settings-widget">
        <button class="settings-cog" id="settings-toggle" title="Settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
        </button>
        <div class="settings-dropdown" id="settings-dropdown">
            <div class="settings-header">Settings</div>
            <div class="settings-section">
                <label class="settings-label">Theme</label>
                <div class="theme-selector">
                    <div class="theme-option" data-theme="default">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #000 0%, var(--secondary-color) 100%);"></div>
                        <div class="theme-info">
                            <div class="theme-name">Default</div>
                            <div class="theme-desc">Green Matrix</div>
                        </div>
                        <div class="theme-check">✓</div>
                    </div>
                    <div class="theme-option" data-theme="greydom">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #1a1d2e 0%, #ff4444 100%);"></div>
                        <div class="theme-info">
                            <div class="theme-name">Greydom</div>
                            <div class="theme-desc">Dark Grey & Red</div>
                        </div>
                        <div class="theme-check">✓</div>
                    </div>
                    <div class="theme-option" data-theme="cloud">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #ffffff 0%, #2c3e50 100%);"></div>
                        <div class="theme-info">
                            <div class="theme-name">Cloud</div>
                            <div class="theme-desc">White & Grey</div>
                        </div>
                        <div class="theme-check">✓</div>
                    </div>
                    <div class="theme-option" data-theme="chaos">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #000000 0%, #808080 100%);"></div>
                        <div class="theme-info">
                            <div class="theme-name">Chaos</div>
                            <div class="theme-desc">Black & Grey</div>
                        </div>
                        <div class="theme-check">✓</div>
                    </div>
                    {% if user.profile.paidUser %}
                    <div class="theme-option" data-theme="lebron">
                        <div class="theme-preview theme-preview-lebron theme-preview-sun-only"></div>
                        <div class="theme-info">
                            <div class="theme-name">LeBron</div>
                            <div class="theme-desc">Premium</div>
                        </div>
                        <div class="theme-check">✓</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Plot Theme Section -->
            <div class="settings-section">
                <label class="settings-label">
                    <span>Plot Background</span>
                    <span class="settings-hint">Matplotlib charts theme</span>
                </label>
                <div class="toggle-group">
                    <div class="toggle-option active" data-plot-theme="dark">
                        <div class="toggle-icon">DARK</div>
                        <div class="toggle-text">Dark Mode</div>
                    </div>
                    <div class="toggle-option" data-plot-theme="light">
                        <div class="toggle-icon">LIGHT</div>
                        <div class="toggle-text">Light Mode</div>
                    </div>
                </div>
            </div>
            
            <!-- Panel Edit Mode Section -->
            <div class="settings-section">
                <label class="settings-label">
                    <span>Panel Edit Mode</span>
                    <span class="settings-hint">Resize panels by dragging borders</span>
                </label>
                <button class="panel-edit-btn" id="toggle-panel-edit">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>Enter Edit Mode</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Panel Edit Mode Exit Button -->
    <div class="panel-edit-exit" id="panel-edit-exit" style="display: none;">
        <button class="exit-edit-btn" title="Exit Edit Mode & Save Layout">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            <span>Save Layout</span>
        </button>
    </div>

    <style>
        /* Settings Widget Styles */
        .settings-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .settings-cog {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: none;
            padding: 0;
            outline: none;
        }

        .settings-cog:hover {
            transform: scale(1.05);
            box-shadow: none;
            border-color: var(--border-color);
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        }
        
        .settings-cog:focus {
            outline: none;
            box-shadow: none;
        }

        /* Hide settings during loading */
        .loading-screen:not(.hidden) ~ * .settings-widget,
        body:has(.loading-screen:not(.hidden)) .settings-widget {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }

        .settings-cog svg {
            transition: transform 0.6s ease;
        }

        .settings-cog:hover svg {
            transform: rotate(90deg);
        }

        body.theme-lebron .settings-cog {
            background: transparent url("{% static 'auth_app/images/basketball.png' %}") center/70% no-repeat;
            border: 2px solid rgba(0,0,0,0.4);
            width: 56px;
            height: 56px;
        }

        body.theme-lebron .settings-cog svg {
            display: none;
        }

        body.theme-lebron .settings-cog:hover {
            transform: scale(1.1) rotate(45deg);
        }

        /* LeBron preview & sunshine icon */
        .theme-preview-lebron {
            position: relative;
            background: url("{% static 'auth_app/images/lebron.jpg' %}") center/cover;
        }
        .theme-icon-sun {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 22px;
            height: 22px;
            background: url("{% static 'auth_app/images/sunshine.png' %}") center/contain no-repeat;
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.5));
            pointer-events: none;
        }

        /* Sun-only preview for LeBron (premium) */
        .theme-preview-sun-only {
            background: radial-gradient(circle at center, #ffd54f 0%, #ffb300 60%, #ff8f00 100%);
            position: relative;
        }
        .theme-preview-sun-only::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: url("{% static 'auth_app/images/sunshine.png' %}") center/85% no-repeat;
            filter: drop-shadow(0 0 6px rgba(0,0,0,0.4));
        }

        /* Ace editor typography enhancements for LeBron */
        body.theme-lebron .ace_editor, 
        body.theme-lebron .ace_content, 
        body.theme-lebron .ace_line {
            font-weight: 600 !important;
            color: #111 !important;
            text-shadow: 0 0 0 transparent !important;
        }
        body.theme-lebron .ace_gutter-cell { font-weight: 600 !important; color: #222 !important; }
        body.theme-lebron .ace_keyword { font-weight: 700 !important; }
        body.theme-lebron .ace_string { font-weight: 600 !important; }
        body.theme-lebron .ace_comment { font-style: normal !important; font-weight: 500 !important; color: #444 !important; }
        body.theme-lebron .ace_variable, 
        body.theme-lebron .ace_identifier { font-weight: 600 !important; }

        /* Transparent code cells with black outlines for LeBron */
        body.theme-lebron .ace_editor,
        body.theme-lebron .ace_scroller,
        body.theme-lebron .ace_content {
            background: transparent !important;
            border: 2px solid rgba(0,0,0,0.6) !important;
        }
        body.theme-lebron .ace_gutter {
            background: transparent !important;
            border-right: 1px solid rgba(0,0,0,0.4) !important;
        }
        body.theme-lebron .ace_active-line {
            background: rgba(0,0,0,0.1) !important;
        }
        body.theme-lebron .ace_cursor {
            color: #000 !important;
            border-left: 2px solid #000 !important;
        }

        /* Notebook mode transparency for LeBron */
        body.theme-lebron.notebook-mode .container,
        body.theme-lebron.notebook-mode .main-area,
        body.theme-lebron.notebook-mode .editor-section,
        body.theme-lebron.notebook-mode .terminal-section,
        body.theme-lebron.notebook-mode .notebook-container,
        body.theme-lebron.notebook-mode .notebook-cell,
        body.theme-lebron.notebook-mode .cell-container,
        body.theme-lebron.notebook-mode .cell-input,
        body.theme-lebron.notebook-mode .cell-output,
        body.theme-lebron.notebook-mode .notebook-toolbar {
            background: transparent !important;
            border-color: rgba(0,0,0,0.4) !important;
        }
        
        body.theme-lebron.notebook-mode .notebook-cell {
            border: 2px solid rgba(0,0,0,0.6) !important;
            border-radius: 8px !important;
        }
        
        body.theme-lebron.notebook-mode .cell-type-indicator,
        body.theme-lebron.notebook-mode .cell-execution-count {
            color: #000 !important;
            font-weight: 600 !important;
        }

        .settings-dropdown {
            position: absolute;
            bottom: 60px;
            right: 0;
            width: 320px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow-color);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-height: 500px;
            overflow-y: auto;
        }

        .settings-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .settings-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            color: var(--text-bright);
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .settings-section {
            padding: 15px 20px;
        }

        .settings-label {
            display: block;
            color: var(--text-color);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .theme-selector {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-option:hover {
            border-color: var(--border-color);
            transform: translateX(5px);
            box-shadow: 0 2px 8px var(--glow-color);
        }

        .theme-option.active {
            border-color: var(--text-bright);
            background: var(--bg-tertiary);
            box-shadow: 0 4px 12px var(--glow-color);
        }

        .theme-preview {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            flex-shrink: 0;
        }

        .theme-info {
            flex: 1;
        }

        .theme-name {
            font-weight: bold;
            color: var(--text-bright);
            font-size: 12px;
            margin-bottom: 1px;
        }

        .theme-desc {
            font-size: 10px;
            color: #888;
        }

        .theme-check {
            color: var(--text-bright);
            font-size: 16px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .theme-option.active .theme-check {
            opacity: 1;
        }

        /* Plot Theme Toggle Group */
        .settings-hint {
            display: block;
            font-size: 10px;
            color: #888;
            font-weight: normal;
            margin-top: 2px;
        }

        .toggle-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .toggle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 12px 8px;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-option:hover {
            border-color: var(--border-color);
            box-shadow: 0 2px 8px var(--glow-color);
        }

        .toggle-option.active {
            border-color: var(--text-bright);
            background: var(--bg-tertiary);
            box-shadow: 0 4px 12px var(--glow-color);
        }

        .toggle-icon {
            font-size: 11px;
            font-weight: bold;
            color: var(--text-color);
            letter-spacing: 1px;
        }

        .toggle-text {
            font-size: 10px;
            color: var(--text-color);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toggle-option.active .toggle-text {
            color: var(--text-bright);
        }

        /* Scrollbar for dropdown */
        .settings-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .settings-dropdown::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .settings-dropdown::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        /* Panel Edit Button */
        .panel-edit-btn {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .panel-edit-btn:hover {
            border-color: var(--text-bright);
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            box-shadow: 0 4px 12px var(--glow-color);
            transform: translateY(-2px);
        }
        
        .panel-edit-btn.active {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            border-color: var(--text-bright);
            color: var(--text-bright);
        }
        
        /* Panel Edit Exit Button */
        .panel-edit-exit {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
        }
        
        .exit-edit-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            border: 2px solid #ff6666;
            border-radius: 8px;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(255, 68, 68, 0.4);
        }
        
        .exit-edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(255, 68, 68, 0.6);
            background: linear-gradient(135deg, #ff6666 0%, #ff2222 100%);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Panel Edit Mode Styles */
        body.panel-edit-mode {
            cursor: default;
        }
        
        body.panel-edit-mode * {
            user-select: none;
            pointer-events: none;
        }
        
        body.panel-edit-mode .resize-handle {
            pointer-events: all;
        }
        
        body.panel-edit-mode .exit-edit-btn {
            pointer-events: all;
        }
        
        /* Resize Handles */
        .resize-handle {
            position: fixed;
            background: var(--text-bright);
            opacity: 0;
            transition: opacity 0.3s ease, background 0.3s ease;
            z-index: 9999;
            pointer-events: all;
        }
        
        body.panel-edit-mode .resize-handle {
            opacity: 0.5;
        }
        
        .resize-handle:hover,
        .resize-handle.dragging {
            opacity: 1;
            background: var(--secondary-color);
        }
        
        .resize-handle-vertical {
            width: 4px;
            cursor: ew-resize;
        }
        
        .resize-handle-horizontal {
            height: 4px;
            cursor: ns-resize;
        }
        
        /* Highlight panels in edit mode */
        body.panel-edit-mode .file-manager,
        body.panel-edit-mode .main-area,
        body.panel-edit-mode .file-viewers {
            outline: 2px dashed var(--border-color);
            outline-offset: -2px;
        }
        
        body.panel-edit-mode .editor-section,
        body.panel-edit-mode .terminal-section {
            outline: 2px dashed var(--border-color);
            outline-offset: -2px;
        }
    </style>

    <script>
        // Settings Widget Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const settingsToggle = document.getElementById('settings-toggle');
            const settingsDropdown = document.getElementById('settings-dropdown');
            const themeOptions = document.querySelectorAll('.theme-option');

            // Get current theme from body class or default
            let currentTheme = document.body.classList.contains('theme-greydom') ? 'greydom' : 'default';

            // Set active theme on load
            updateActiveTheme(currentTheme);

            // Toggle dropdown
            settingsToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                settingsDropdown.classList.toggle('show');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!settingsDropdown.contains(e.target) && e.target !== settingsToggle) {
                    settingsDropdown.classList.remove('show');
                }
            });

            // Theme selection
            themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    changeTheme(theme);
                });
            });

            function updateActiveTheme(theme) {
                themeOptions.forEach(opt => {
                    if (opt.getAttribute('data-theme') === theme) {
                        opt.classList.add('active');
                    } else {
                        opt.classList.remove('active');
                    }
                });
            }

            function changeTheme(theme) {
                // Update body class
                document.body.classList.remove('theme-default', 'theme-greydom', 'theme-cloud', 'theme-chaos', 'theme-lebron');
                if (theme !== 'default') {
                    document.body.classList.add(`theme-${theme}`);
                }

                // Update loading screen class for LeBron theme
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.classList.remove('theme-lebron');
                    if (theme === 'lebron') {
                        loadingScreen.classList.add('theme-lebron');
                    }
                }

                // Update Ace Editor theme if it exists (both main editor and aceEditor variable)
                let aceTheme = 'ace/theme/terminal'; // default
                if (theme === 'greydom') {
                    aceTheme = 'ace/theme/monokai';
                } else if (theme === 'cloud') {
                    aceTheme = 'ace/theme/katzenmilch';
                } else if (theme === 'chaos') {
                    aceTheme = 'ace/theme/chaos';
                } else if (theme === 'lebron') {
                    aceTheme = 'ace/theme/terminal';
                }
                
                if (typeof editor !== 'undefined' && editor) {
                    editor.setTheme(aceTheme);
                }
                
                if (typeof aceEditor !== 'undefined' && aceEditor) {
                    aceEditor.setTheme(aceTheme);
                }

                // Update active state
                updateActiveTheme(theme);
                currentTheme = theme;

                // Save theme preference to server
                fetch('/auth/account/update-theme/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `theme=${theme}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Theme saved successfully');
                    }
                })
                .catch(error => console.error('Error saving theme:', error));
            }

            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Plot Theme Toggle
            const plotToggleOptions = document.querySelectorAll('.toggle-option');
            let currentPlotTheme = '{{ user.profile.dark_mode_plots|default:True }}' === 'True' ? 'dark' : 'light';
            
            // Set initial active state
            plotToggleOptions.forEach(opt => {
                if (opt.getAttribute('data-plot-theme') === currentPlotTheme) {
                    opt.classList.add('active');
                } else {
                    opt.classList.remove('active');
                }
            });

            plotToggleOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const plotTheme = this.getAttribute('data-plot-theme');
                    changePlotTheme(plotTheme);
                });
            });

            function changePlotTheme(plotTheme) {
                const darkMode = plotTheme === 'dark';
                
                // Update active state
                plotToggleOptions.forEach(opt => {
                    if (opt.getAttribute('data-plot-theme') === plotTheme) {
                        opt.classList.add('active');
                    } else {
                        opt.classList.remove('active');
                    }
                });

                currentPlotTheme = plotTheme;

                // Save to server
                fetch('/python/update-plot-theme/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ dark_mode_plots: darkMode })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Plot theme saved successfully');
                        updateMatplotlibTheme(darkMode);
                    }
                })
                .catch(error => console.error('Error saving plot theme:', error));
            }

            async function updateMatplotlibTheme(darkMode) {
                if (!pyodide) return;
                
                try {
                    await pyodide.runPythonAsync(`
import matplotlib.pyplot as plt

# Set plot theme
if ${darkMode ? 'True' : 'False'}:
    plt.style.use('dark_background')
    plt.rcParams['figure.facecolor'] = '#000000'
    plt.rcParams['axes.facecolor'] = '#111111'
    plt.rcParams['axes.edgecolor'] = '#00aa00'
    plt.rcParams['text.color'] = '#00ff00'
    plt.rcParams['xtick.color'] = '#00cc00'
    plt.rcParams['ytick.color'] = '#00cc00'
    plt.rcParams['grid.color'] = '#004400'
    plt.rcParams['legend.facecolor'] = '#111111'
    plt.rcParams['legend.edgecolor'] = '#00aa00'
else:
    plt.style.use('default')
    plt.rcParams['figure.facecolor'] = 'white'
    plt.rcParams['axes.facecolor'] = 'white'

print(f"Matplotlib theme updated to {'dark' if ${darkMode ? 'True' : 'False'} else 'light'} mode")
                    `);
                } catch (error) {
                    console.error('Error updating matplotlib theme:', error);
                }
            }
        });

        // History and Share Functions
        function toggleHistory() {
            const modal = document.getElementById('history-modal');
            if (modal) {
                modal.classList.toggle('active');
                if (modal.classList.contains('active')) {
                    loadExecutionHistory();
                }
            }
        }

        async function loadExecutionHistory() {
            const historyList = document.getElementById('history-list');
            if (!historyList) return;
            
            historyList.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
            
            try {
                const response = await fetch('/python/get-history/');
                const data = await response.json();
                
                if (data.status === 'success' && data.history.length > 0) {
                    historyList.innerHTML = data.history.map(h => `
                        <div class="history-item ${h.was_successful ? 'success' : 'error'}">
                            <div class="history-header">
                                <strong>${h.filename}</strong>
                                <span>${new Date(h.executed_at).toLocaleString()}</span>
                            </div>
                            <div class="history-code">${escapeHtml(h.code_snippet)}</div>
                            <div class="history-meta">
                                <span>${h.execution_time.toFixed(2)}ms</span>
                                <button onclick="loadHistoryCode('${h.id}')" class="btn-small">Load Code</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyList.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No execution history yet.</div>';
                }
            } catch (error) {
                historyList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f44;">Error loading history</div>';
                console.error('Error loading history:', error);
            }
        }

        async function loadHistoryCode(historyId) {
            try {
                const response = await fetch(`/python/get-history/`);
                const data = await response.json();
                const history = data.history.find(h => h.id.toString() === historyId.toString());
                
                if (history) {
                    setEditorValue(history.full_code);
                    document.getElementById('history-modal').classList.remove('active');
                    updateStatus('Code loaded from history', 'success');
                }
            } catch (error) {
                console.error('Error loading history code:', error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ==============================
        // PANEL EDIT MODE - Resizable Layout
        // ==============================
        (function() {
            let isEditMode = false;
            let resizeHandles = [];
            let currentHandle = null;
            let startX = 0, startY = 0;
            let startSizes = {};

            const panelEditBtn = document.querySelector('.panel-edit-btn');
            const exitEditBtn = document.querySelector('.exit-edit-btn');
            const exitEditContainer = document.getElementById('panel-edit-exit');
            const mainContainer = document.querySelector('.container');
            const leftPanel = document.querySelector('.file-manager');
            const middleColumn = document.querySelector('.main-area');
            const rightPanel = document.querySelector('.file-viewers');
            const editorContainer = document.querySelector('.editor-section');
            const executorContainer = document.querySelector('.terminal-section');

            // Default layout values
            const defaults = {
                leftWidth: '300px',
                middleWidth: '1fr',
                rightWidth: '250px',
                editorHeight: '60%',
                executorHeight: '40%'
            };

            // Load saved layout from localStorage
            function loadLayout() {
                try {
                    const saved = localStorage.getItem('panelLayout');
                    if (saved) {
                        const layout = JSON.parse(saved);
                        applyLayout(layout);
                    }
                } catch (error) {
                    console.error('Error loading layout:', error);
                }
            }

            // Apply layout values to DOM
            function applyLayout(layout) {
                if (mainContainer && layout.gridColumns) {
                    mainContainer.style.gridTemplateColumns = layout.gridColumns;
                }
                if (editorContainer && layout.editorHeight) {
                    editorContainer.style.height = layout.editorHeight;
                }
                if (executorContainer && layout.executorHeight) {
                    executorContainer.style.height = layout.executorHeight;
                }
            }

            // Save layout to localStorage
            function saveLayout() {
                try {
                    const layout = {
                        gridColumns: mainContainer ? mainContainer.style.gridTemplateColumns || 
                                    `${defaults.leftWidth} ${defaults.middleWidth} ${defaults.rightWidth}` : null,
                        editorHeight: editorContainer ? editorContainer.style.height || defaults.editorHeight : null,
                        executorHeight: executorContainer ? executorContainer.style.height || defaults.executorHeight : null
                    };
                    localStorage.setItem('panelLayout', JSON.stringify(layout));
                    updateStatus('Layout saved successfully!', 'success');
                } catch (error) {
                    console.error('Error saving layout:', error);
                    updateStatus('Failed to save layout', 'error');
                }
            }

            // Create resize handles dynamically
            function createResizeHandles() {
                // Clear existing handles
                resizeHandles.forEach(h => h.element.remove());
                resizeHandles = [];

                // Vertical handle between left panel and middle column
                if (leftPanel && mainContainer) {
                    const handle1 = document.createElement('div');
                    handle1.className = 'resize-handle resize-handle-vertical';
                    handle1.dataset.position = 'left-middle';
                    handle1.style.position = 'fixed';
                    handle1.style.zIndex = '9999';
                    document.body.appendChild(handle1);
                    resizeHandles.push({ element: handle1, type: 'vertical', position: 'left-middle' });
                    updateHandlePosition(handle1, leftPanel, 'right');
                }

                // Vertical handle between middle column and right panel
                if (rightPanel && mainContainer) {
                    const handle2 = document.createElement('div');
                    handle2.className = 'resize-handle resize-handle-vertical';
                    handle2.dataset.position = 'middle-right';
                    handle2.style.position = 'fixed';
                    handle2.style.zIndex = '9999';
                    document.body.appendChild(handle2);
                    resizeHandles.push({ element: handle2, type: 'vertical', position: 'middle-right' });
                    updateHandlePosition(handle2, rightPanel, 'left');
                }

                // Horizontal handle between editor and executor
                if (editorContainer && executorContainer) {
                    const handle3 = document.createElement('div');
                    handle3.className = 'resize-handle resize-handle-horizontal';
                    handle3.dataset.position = 'editor-executor';
                    handle3.style.position = 'fixed';
                    handle3.style.zIndex = '9999';
                    document.body.appendChild(handle3);
                    resizeHandles.push({ element: handle3, type: 'horizontal', position: 'editor-executor' });
                    updateHandlePosition(handle3, editorContainer, 'bottom');
                }

                // Attach event listeners
                resizeHandles.forEach(({ element, type, position }) => {
                    element.addEventListener('mousedown', (e) => startResize(e, type, position));
                });
            }

            // Update handle position based on panel bounds
            function updateHandlePosition(handle, panel, edge) {
                const rect = panel.getBoundingClientRect();
                if (edge === 'right') {
                    handle.style.left = (rect.right - 2) + 'px';
                    handle.style.top = rect.top + 'px';
                    handle.style.height = rect.height + 'px';
                    handle.style.width = '4px';
                } else if (edge === 'left') {
                    handle.style.left = (rect.left - 2) + 'px';
                    handle.style.top = rect.top + 'px';
                    handle.style.height = rect.height + 'px';
                    handle.style.width = '4px';
                } else if (edge === 'bottom') {
                    handle.style.left = rect.left + 'px';
                    handle.style.top = (rect.bottom - 2) + 'px';
                    handle.style.width = rect.width + 'px';
                    handle.style.height = '4px';
                }
            }

            // Update handle positions on scroll/resize
            function updateAllHandlePositions() {
                resizeHandles.forEach(({ element, position }) => {
                    if (position === 'left-middle' && leftPanel) {
                        updateHandlePosition(element, leftPanel, 'right');
                    } else if (position === 'middle-right' && rightPanel) {
                        updateHandlePosition(element, rightPanel, 'left');
                    } else if (position === 'editor-executor' && editorContainer) {
                        updateHandlePosition(element, editorContainer, 'bottom');
                    }
                });
            }

            // Start resize operation
            function startResize(e, type, position) {
                e.preventDefault();
                currentHandle = { type, position };
                startX = e.clientX;
                startY = e.clientY;

                // Store starting sizes
                if (mainContainer) {
                    const cols = window.getComputedStyle(mainContainer).gridTemplateColumns.split(' ');
                    startSizes.leftWidth = parseFloat(cols[0]) || 300;
                    startSizes.middleWidth = parseFloat(cols[1]) || 600;
                    startSizes.rightWidth = parseFloat(cols[2]) || 250;
                }
                if (editorContainer) {
                    startSizes.editorHeight = editorContainer.offsetHeight;
                }
                if (executorContainer) {
                    startSizes.executorHeight = executorContainer.offsetHeight;
                }

                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                document.body.style.cursor = type === 'vertical' ? 'col-resize' : 'row-resize';
                document.body.style.userSelect = 'none';
            }

            // Handle resize drag
            function handleResize(e) {
                if (!currentHandle) return;

                const { type, position } = currentHandle;

                if (type === 'vertical') {
                    const deltaX = e.clientX - startX;

                    if (position === 'left-middle') {
                        // Resize left panel
                        const newLeftWidth = Math.max(200, Math.min(600, startSizes.leftWidth + deltaX));
                        
                        if (newLeftWidth > 200 && mainContainer) {
                            mainContainer.style.gridTemplateColumns = 
                                `${newLeftWidth}px 1fr ${startSizes.rightWidth}px`;
                            updateAllHandlePositions();
                        }
                    } else if (position === 'middle-right') {
                        // Resize right panel
                        const newRightWidth = Math.max(200, Math.min(600, startSizes.rightWidth - deltaX));
                        
                        if (newRightWidth > 200 && mainContainer) {
                            mainContainer.style.gridTemplateColumns = 
                                `${startSizes.leftWidth}px 1fr ${newRightWidth}px`;
                            updateAllHandlePositions();
                        }
                    }
                } else if (type === 'horizontal') {
                    const deltaY = e.clientY - startY;
                    
                    // For vertical sections, we need to adjust heights
                    const newEditorHeight = Math.max(150, startSizes.editorHeight + deltaY);

                    if (editorContainer) {
                        editorContainer.style.flex = `0 0 ${newEditorHeight}px`;
                        updateAllHandlePositions();
                    }

                    // Trigger Ace Editor resize
                    if (typeof aceEditor !== 'undefined' && aceEditor) {
                        aceEditor.resize();
                    }
                }
            }

            // Stop resize operation
            function stopResize() {
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                currentHandle = null;
            }

            // Toggle panel edit mode
            function togglePanelEditMode() {
                isEditMode = !isEditMode;

                if (isEditMode) {
                    // Enter edit mode
                    document.body.classList.add('panel-edit-mode');
                    createResizeHandles();
                    if (exitEditContainer) exitEditContainer.style.display = 'block';
                    if (panelEditBtn) {
                        panelEditBtn.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <line x1="9" y1="3" x2="9" y2="21"/>
                                <line x1="15" y1="3" x2="15" y2="21"/>
                                <line x1="3" y1="12" x2="21" y2="12"/>
                            </svg>
                            Exit Edit Mode
                        `;
                    }
                    updateStatus('Panel edit mode enabled. Drag borders to resize.', 'info');
                    
                    // Add window resize listener to update handle positions
                    window.addEventListener('resize', updateAllHandlePositions);
                    window.addEventListener('scroll', updateAllHandlePositions);
                } else {
                    // Exit edit mode
                    document.body.classList.remove('panel-edit-mode');
                    resizeHandles.forEach(h => h.element.remove());
                    resizeHandles = [];
                    if (exitEditContainer) exitEditContainer.style.display = 'none';
                    if (panelEditBtn) {
                        panelEditBtn.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                            </svg>
                            Panel Edit Mode
                        `;
                    }
                    
                    // Remove event listeners
                    window.removeEventListener('resize', updateAllHandlePositions);
                    window.removeEventListener('scroll', updateAllHandlePositions);
                    
                    updateStatus('Panel edit mode disabled', 'info');
                }
            }

            // Initialize
            if (panelEditBtn) {
                panelEditBtn.addEventListener('click', togglePanelEditMode);
            }

            if (exitEditBtn) {
                exitEditBtn.addEventListener('click', () => {
                    saveLayout();
                    togglePanelEditMode();
                });
            }

            // Load saved layout on page load
            loadLayout();

            // Handle window resize
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    if (typeof aceEditor !== 'undefined' && aceEditor) {
                        aceEditor.resize();
                    }
                }, 100);
            });
        })();

        // Optimized LeBron bouncing basketball physics
        (function(){
            const screen = document.getElementById('loading-screen');
            if(!screen || !screen.classList.contains('theme-lebron')) return;
            const ball = screen.querySelector('.retro-computer');
            if(!ball) return;
            
            // Physics state
            let state = {
                x: ball.offsetLeft || 100,
                y: ball.offsetTop || 100,
                vx: 120, vy: 60,
                dragging: false,
                lastTime: 0
            };
            
            // Cached constants for performance
            const physics = {
                gravity: 400,
                elasticity: 0.8,
                friction: 0.998,
                minVelocity: 0.5,
                ballSize: 180
            };
            
            let bounds = screen.getBoundingClientRect();
            let boundsCache = Date.now();
            
            // Optimized frame loop with 60fps throttling
            function frame(ts) {
                // Throttle to ~60fps max
                if (ts - state.lastTime < 16) {
                    requestAnimationFrame(frame);
                    return;
                }
                
                const dt = Math.min((ts - state.lastTime) / 1000, 0.033); // Cap dt
                state.lastTime = ts;
                
                if (!state.dragging) {
                    // Update physics
                    state.vy += physics.gravity * dt;
                    state.x += state.vx * dt;
                    state.y += state.vy * dt;
                    
                    // Refresh bounds cache every 500ms
                    if (ts - boundsCache > 500) {
                        bounds = screen.getBoundingClientRect();
                        boundsCache = ts;
                    }
                    
                    // Collision detection with bounds
                    const maxX = bounds.width - physics.ballSize;
                    const maxY = bounds.height - physics.ballSize;
                    
                    if (state.x <= 0) {
                        state.x = 0;
                        state.vx = Math.abs(state.vx) * physics.elasticity;
                    } else if (state.x >= maxX) {
                        state.x = maxX;
                        state.vx = -Math.abs(state.vx) * physics.elasticity;
                    }
                    
                    if (state.y <= 0) {
                        state.y = 0;
                        state.vy = Math.abs(state.vy) * physics.elasticity;
                    } else if (state.y >= maxY) {
                        state.y = maxY;
                        state.vy = -Math.abs(state.vy) * physics.elasticity;
                    }
                    
                    // Apply friction and minimum velocity
                    state.vx *= physics.friction;
                    state.vy *= physics.friction;
                    
                    if (Math.abs(state.vx) < physics.minVelocity) state.vx = 0;
                    if (Math.abs(state.vy) < physics.minVelocity && state.y >= maxY - 1) state.vy = 0;
                    
                    // Batch DOM updates
                    ball.style.transform = `translate(${state.x}px, ${state.y}px)`;
                }
                
                requestAnimationFrame(frame);
            }
            
            // Initialize position and start loop
            ball.style.position = 'absolute';
            ball.style.left = '0px';
            ball.style.top = '0px';
            requestAnimationFrame(frame);
            
            // Click teleportation handler
            screen.addEventListener('click', e => {
                const screenRect = screen.getBoundingClientRect();
                const targetX = e.clientX - screenRect.left - physics.ballSize / 2;
                const targetY = e.clientY - screenRect.top - physics.ballSize / 2;
                
                // Constrain to bounds
                state.x = Math.max(0, Math.min(targetX, screenRect.width - physics.ballSize));
                state.y = Math.max(0, Math.min(targetY, screenRect.height - physics.ballSize));
                
                // Add some random velocity after teleport for fun physics
                state.vx = (Math.random() - 0.5) * 300;
                state.vy = (Math.random() - 0.5) * 200;
                
                e.preventDefault();
            });
        })();

        // Add keyboard shortcuts for better UX
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter or F5 to run code
                if ((e.ctrlKey && e.key === 'Enter') || e.key === 'F5') {
                    e.preventDefault();
                    executeCode();
                }
                
                // Ctrl+S to save (if logged in)
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (isLoggedIn) {
                        saveUserData();
                        updateTerminal("[SAVE] Code auto-saved!\n");
                    }
                }
                
                // Escape to close modal (if any)
                if (e.key === 'Escape') {
                    const modal = document.getElementById('inputModal');
                    if (modal && modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                }
            });
        }

        // Helper function to test input functionality
        function testInputFunction() {
            const testCode = `
name = input("What's your name? ")
age = input("How old are you? ")
print(f"Hello {name}! You are {age} years old.")
            `;
            if (aceEditor) {
                aceEditor.setValue(testCode);
                updateTerminal("[TEST] Test code loaded! Click 'Run Python Code' to test the input() function.\n");
            }
        }

        // Initialize keyboard shortcuts when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setupKeyboardShortcuts();
            
            // Show helpful tips on load
            setTimeout(() => {
                updateTerminal("[READY] PYTHON ASSEMBLY - Online Python IDE Ready!\n");
                updateTerminal("[INFO] Keyboard Shortcuts:\n");
                updateTerminal("   • Ctrl+Enter or F5: Run code\n");
                updateTerminal("   • Ctrl+S: Save your work\n");
                updateTerminal("   • ESC: Close dialogs\n");
                updateTerminal("   • input() function works with popup dialogs\n\n");
            }, 1000);
        });
    </script>

    <!-- Package Manager UI -->
    <div class="package-manager collapsed" id="package-manager">
        <div class="pm-header" id="pm-header">
            <div class="pm-title">PACKAGE MANAGER</div>
            <div class="pm-controls">
                <button class="pm-control-btn" onclick="togglePackageManager()" title="Toggle">▼</button>
            </div>
        </div>
        <div class="pm-body" id="pm-body">
            <div class="pm-section">
                <div class="pm-section-title">INSTALL PACKAGE</div>
                <div class="pm-input-group">
                    <input type="text" class="pm-input" id="package-name-input" placeholder="package-name" />
                    <button class="pm-btn" onclick="installPackageUI()">INSTALL</button>
                </div>
            </div>
            
            <div class="pm-section">
                <div class="pm-section-title">QUICK INSTALL</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                    <button class="pm-btn" onclick="installQuickPackage('mysql-connector-python')">mysql</button>
                    <button class="pm-btn" onclick="installQuickPackage('pillow')">pillow</button>
                    <button class="pm-btn" onclick="installQuickPackage('requests')">requests</button>
                    <button class="pm-btn" onclick="installQuickPackage('openpyxl')">openpyxl</button>
                </div>
            </div>
            
            <div class="pm-section">
                <div class="pm-section-title">INSTALLED PACKAGES</div>
                <ul class="pm-package-list" id="installed-packages">
                    <li class="pm-package-item">
                        <span class="pm-package-name">numpy</span>
                        <span class="pm-package-status installed">INSTALLED</span>
                    </li>
                    <li class="pm-package-item">
                        <span class="pm-package-name">pandas</span>
                        <span class="pm-package-status installed">INSTALLED</span>
                    </li>
                    <li class="pm-package-item">
                        <span class="pm-package-name">matplotlib</span>
                        <span class="pm-package-status installed">INSTALLED</span>
                    </li>
                    <li class="pm-package-item">
                        <span class="pm-package-name">scipy</span>
                        <span class="pm-package-status installed">INSTALLED</span>
                    </li>
                    <li class="pm-package-item">
                        <span class="pm-package-name">scikit-learn</span>
                        <span class="pm-package-status installed">INSTALLED</span>
                    </li>
                </ul>
            </div>
            
            <div class="pm-status" id="pm-status">
                > Package manager ready
            </div>
        </div>
    </div>

    <script>
        // Package Manager Functionality
        let installedPackages = new Set(['numpy', 'pandas', 'matplotlib', 'scipy', 'scikit-learn', 'seaborn', 'sympy', 'networkx', 'plotly', 'bokeh', 'altair', 'wordcloud', 'beautifulsoup4', 'requests', 'pillow', 'openpyxl', 'rich', 'pydantic']);
        
        function updatePMStatus(message) {
            const statusEl = document.getElementById('pm-status');
            if (statusEl) {
                const timestamp = new Date().toLocaleTimeString();
                statusEl.innerHTML = `[${timestamp}] ${message}`;
                statusEl.scrollTop = statusEl.scrollHeight;
            }
        }
        
        async function installPackageUI() {
            const input = document.getElementById('package-name-input');
            const packageName = input.value.trim();
            
            if (!packageName) {
                updatePMStatus('> Error: Package name required');
                return;
            }
            
            await installPackage(packageName);
            input.value = '';
        }
        
        async function installQuickPackage(packageName) {
            await installPackage(packageName);
        }
        
        async function installPackage(packageName) {
            if (!isInitialized || !pyodide) {
                updatePMStatus('> Error: Python environment not ready');
                updateTerminal('[PKG] Python environment not initialized yet\n', true);
                return;
            }
            
            if (installedPackages.has(packageName)) {
                updatePMStatus(`> ${packageName} already installed`);
                updateTerminal(`[PKG] ${packageName} is already installed\n`);
                return;
            }
            
            updatePMStatus(`> Installing ${packageName}...`);
            updateTerminal(`[PKG] Installing ${packageName}...\n`);
            
            // Add to UI as installing
            addPackageToList(packageName, 'installing');
            
            try {
                await pyodide.runPythonAsync(`
import micropip
await micropip.install('${packageName}')
print('Package ${packageName} installed successfully!')
                `);
                
                installedPackages.add(packageName);
                updatePackageStatus(packageName, 'installed');
                updatePMStatus(`> ${packageName} installed successfully`);
                updateTerminal(`[PKG] ${packageName} installed successfully!\n`);
                
            } catch (error) {
                updatePackageStatus(packageName, 'error');
                updatePMStatus(`> Failed to install ${packageName}`);
                updateTerminal(`[PKG] Failed to install ${packageName}: ${error.message}\n`, true);
                
                // Remove from list after error
                setTimeout(() => {
                    const item = document.querySelector(`[data-package="${packageName}"]`);
                    if (item) item.remove();
                }, 2000);
            }
        }
        
        function addPackageToList(packageName, status) {
            const list = document.getElementById('installed-packages');
            
            // Check if already exists
            if (document.querySelector(`[data-package="${packageName}"]`)) {
                return;
            }
            
            const item = document.createElement('li');
            item.className = 'pm-package-item';
            item.setAttribute('data-package', packageName);
            item.innerHTML = `
                <span class="pm-package-name">${packageName}</span>
                <span class="pm-package-status ${status}">${status.toUpperCase()}</span>
            `;
            list.appendChild(item);
        }
        
        function updatePackageStatus(packageName, status) {
            const item = document.querySelector(`[data-package="${packageName}"]`);
            if (item) {
                const statusEl = item.querySelector('.pm-package-status');
                statusEl.className = `pm-package-status ${status}`;
                statusEl.textContent = status.toUpperCase();
            }
        }
        
        function togglePackageManager() {
            const pm = document.getElementById('package-manager');
            const btn = event.target;
            pm.classList.toggle('collapsed');
            
            // Change button icon
            if (pm.classList.contains('collapsed')) {
                btn.textContent = '▼';
                btn.title = 'Expand';
            } else {
                btn.textContent = '▲';
                btn.title = 'Collapse';
            }
        }
        
        // Make package manager draggable
        (function() {
            const pm = document.getElementById('package-manager');
        })();
        
        // Initialize package manager status
        document.addEventListener('DOMContentLoaded', function() {
            updatePMStatus('> Package manager initialized');
        });
    </script>

    <!-- Cell Expand Modal -->
    <div class="cell-expand-modal" id="cell-expand-modal">
        <div class="cell-expand-header">
            <span class="cell-expand-title" id="expand-modal-title">Expanded Cell Editor</span>
            <button class="cell-expand-close" onclick="closeExpandedCell()">×</button>
        </div>
        <div class="cell-expand-editor-container">
            <div id="expanded-ace-editor"></div>
        </div>
    </div>

    <!-- Enhanced Features Script (Inline) -->
    <script>
        // Enhanced features JavaScript - migrated from external file
        
        // Mobile toolbar setup
        if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
            document.addEventListener('DOMContentLoaded', function() {
                const mobileToolbar = document.getElementById('mobile-toolbar');
                if (mobileToolbar) {
                    mobileToolbar.style.display = 'flex';
                }
            });
        }

        function insertText(text) {
            if (aceEditor) {
                aceEditor.session.insert(aceEditor.getCursorPosition(), text);
                aceEditor.focus();
            }
        }

        // History Modal Functions
        function toggleHistory() {
            const modal = document.getElementById('history-modal');
            if (modal.style.display === 'none' || !modal.style.display) {
                loadExecutionHistory();
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').style.display = 'none';
        }

        async function loadExecutionHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">Loading...</div>';
            
            try {
                const response = await fetch('/python/get-history/?limit=20');
                const data = await response.json();
                
                if (data.status === 'success' && data.history.length > 0) {
                    historyList.innerHTML = data.history.map(h => `
                        <div class="history-item">
                            <div class="history-header">
                                <strong>${h.filename}</strong>
                                <span class="history-time">${new Date(h.executed_at).toLocaleString()}</span>
                            </div>
                            <div class="history-code">${escapeHtml(h.code_snippet)}</div>
                            ${h.output ? `<div class="history-output">${escapeHtml(h.output)}</div>` : ''}
                            ${h.error ? `<div class="history-output" style="color: #ff6b6b;">${escapeHtml(h.error)}</div>` : ''}
                            <div style="font-size: 0.85em; color: #888; margin-top: 5px;">
                                ⏱️ ${h.execution_time.toFixed(2)}ms
                                ${h.was_successful ? '✓ Success' : '✗ Error'}
                            </div>
                            <div class="history-actions">
                                <button onclick='loadCodeFromHistory(${JSON.stringify(h.full_code)})'>Load Code</button>
                                <button onclick='copyCode(${JSON.stringify(h.full_code)})'>Copy</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">No execution history yet. Run some code to see it here!</div>';
                }
            } catch (error) {
                historyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #ff6b6b;">Error loading history</div>';
                console.error('Error loading history:', error);
            }
        }

        function loadCodeFromHistory(code) {
            if (aceEditor) {
                aceEditor.setValue(code, -1);
                closeHistoryModal();
                updateStatus('Code loaded from history', 'success');
            }
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                updateStatus('Code copied to clipboard!', 'success');
            });
        }

        // Settings Modal Functions
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            if (modal.style.display === 'none' || !modal.style.display) {
                loadUserSettings();
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        async function loadUserSettings() {
            try {
                const response = await fetch('/python/get-settings/');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const darkPlotsCheckbox = document.getElementById('settings-dark-plots');
                    if (darkPlotsCheckbox) {
                        darkPlotsCheckbox.checked = data.settings.dark_mode_plots;
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        async function saveSettings() {
            const darkPlotsCheckbox = document.getElementById('settings-dark-plots');
            const fontSizeSlider = document.getElementById('settings-font-size');
            const darkPlots = darkPlotsCheckbox ? darkPlotsCheckbox.checked : false;
            const fontSize = fontSizeSlider ? fontSizeSlider.value : 14;
            
            // Save plot theme
            try {
                await fetch('/python/update-plot-theme/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        dark_mode_plots: darkPlots
                    })
                });
                
                // Update editor font size
                if (aceEditor) {
                    aceEditor.setOptions({
                        fontSize: fontSize + 'px'
                    });
                }
                
                // Update plot theme in Pyodide
                if (pyodide && isInitialized) {
                    await pyodide.runPythonAsync(`
import builtins
builtins.set_plot_theme('${darkPlots ? 'dark' : 'light'}')
                    `);
                }
                
                updateStatus('Settings saved!', 'success');
                closeSettingsModal();
            } catch (error) {
                alert('Error saving settings: ' + error.message);
            }
        }

        // Font size slider
        document.addEventListener('DOMContentLoaded', function() {
            const fontSizeSlider = document.getElementById('settings-font-size');
            const fontSizeDisplay = document.getElementById('font-size-display');
            
            if (fontSizeSlider && fontSizeDisplay) {
                fontSizeSlider.addEventListener('input', function() {
                    fontSizeDisplay.textContent = this.value;
                });
            }
        });

        // Enhanced autocomplete for Ace editor
        function setupEnhancedAutocomplete() {
            if (!aceEditor) return;
            
            const pythonCompletions = {
                'numpy': ['array', 'zeros', 'ones', 'arange', 'linspace', 'random', 'mean', 'std', 'sum', 'max', 'min'],
                'np': ['array', 'zeros', 'ones', 'arange', 'linspace', 'random', 'mean', 'std', 'sum', 'max', 'min'],
                'pandas': ['DataFrame', 'Series', 'read_csv', 'read_excel', 'read_json', 'concat', 'merge'],
                'pd': ['DataFrame', 'Series', 'read_csv', 'read_excel', 'read_json', 'concat', 'merge'],
                'matplotlib.pyplot': ['plot', 'scatter', 'bar', 'hist', 'show', 'xlabel', 'ylabel', 'title', 'legend', 'grid', 'figure', 'subplot'],
                'plt': ['plot', 'scatter', 'bar', 'hist', 'show', 'xlabel', 'ylabel', 'title', 'legend', 'grid', 'figure', 'subplot'],
                'builtins': ['print', 'input', 'len', 'range', 'sum', 'min', 'max', 'sorted', 'enumerate', 'zip', 'map', 'filter', 'list', 'dict', 'set', 'tuple']
            };
            
            const pythonKeywords = ['def', 'class', 'if', 'elif', 'else', 'for', 'while', 'try', 'except', 'finally', 
                                   'import', 'from', 'as', 'return', 'break', 'continue', 'pass', 'yield', 'with', 
                                   'lambda', 'and', 'or', 'not', 'in', 'is', 'True', 'False', 'None'];
            
            aceEditor.completers = [{
                getCompletions: function(editor, session, pos, prefix, callback) {
                    const completions = [];
                    const line = session.getLine(pos.row).substring(0, pos.column);
                    
                    // Check for method completion (after dot)
                    const match = line.match(/(\w+)\.(\w*)$/);
                    if (match) {
                        const module = match[1];
                        if (pythonCompletions[module]) {
                            pythonCompletions[module].forEach(method => {
                                completions.push({
                                    caption: method,
                                    value: method,
                                    meta: module,
                                    score: 1000
                                });
                            });
                        }
                    } else {
                        // Keyword completion
                        pythonKeywords.forEach(keyword => {
                            if (keyword.toLowerCase().startsWith(prefix.toLowerCase())) {
                                completions.push({
                                    caption: keyword,
                                    value: keyword,
                                    meta: 'keyword',
                                    score: 900
                                });
                            }
                        });
                        
                        // Built-in functions
                        pythonCompletions.builtins.forEach(func => {
                            if (func.toLowerCase().startsWith(prefix.toLowerCase())) {
                                completions.push({
                                    caption: func,
                                    value: func + '()',
                                    meta: 'builtin',
                                    score: 800
                                });
                            }
                        });
                    }
                    
                    callback(null, completions);
                }
            }];
            
            // Enable autocomplete features
            aceEditor.setOptions({
                enableBasicAutocompletion: true,
                enableLiveAutocompletion: true,
                enableSnippets: true
            });
        }

        // Save execution to history
        async function saveExecutionToHistory(code, output, error, executionTime, wasSuccessful) {
            try {
                await fetch('/python/save-execution/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        code: code,
                        output: output,
                        error: error,
                        execution_time: executionTime,
                        filename: currentScript || 'untitled.py',
                        was_successful: wasSuccessful
                    })
                });
            } catch (error) {
                console.error('Error saving execution history:', error);
            }
        }

        // Helper functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        console.log('✓ Enhanced features loaded: History, Sharing, Settings, Autocomplete, Mobile Toolbar');
    </script>

</body>
</html>
