{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - PYTHON ASSEMBLY</title>
    
    <link rel="icon" type="image/x-icon" href="{% static 'auth_app/favicon.ico' %}">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-bg: #000000;
            --secondary-bg: #1a1a1a;
            --tertiary-bg: #2a2a2a;
            --accent-color: #00ff00;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --border-color: #444444;
            --online-color: #00ff00;
            --offline-color: #666666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            background: var(--primary-bg);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 12px;
            line-height: 1.6;
        }

        /* Background Animation */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: #000000;
            background-image: 
                radial-gradient(circle at 25px 25px, #ffffff 1px, transparent 0),
                radial-gradient(circle at 75px 75px, #333333 1px, transparent 0);
            background-size: 100px 100px;
            animation: matrixScroll 20s linear infinite;
        }

        @keyframes matrixScroll {
            0% { background-position: 0 0, 50px 50px; }
            100% { background-position: 0 100px, 50px 150px; }
        }

        /* Top Navigation */
        .top-nav {
            height: 60px;
            background: var(--secondary-bg);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
        }

        .nav-logo {
            font-size: 16px;
            color: var(--accent-color);
            text-shadow: 2px 2px 0 rgba(0, 255, 0, 0.3);
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }

        .nav-link {
            padding: 10px 15px;
            background: var(--tertiary-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background: var(--accent-color);
            color: #000000;
            border-color: var(--accent-color);
        }

        /* Main Container */
        .community-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--secondary-bg);
            border-right: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
        }

        .sidebar-tab {
            flex: 1;
            padding: 15px;
            background: var(--tertiary-bg);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            transition: all 0.3s;
        }

        .sidebar-tab.active {
            background: var(--secondary-bg);
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Friends Tab */
        .add-friend-section {
            padding: 15px;
            background: var(--tertiary-bg);
            border: 2px solid var(--border-color);
            margin-bottom: 20px;
        }

        .add-friend-title {
            font-size: 10px;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .add-friend-form {
            display: flex;
            gap: 10px;
        }

        .add-friend-input {
            flex: 1;
            padding: 8px;
            background: var(--primary-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }

        .add-friend-btn {
            padding: 8px 15px;
            background: var(--accent-color);
            color: #000000;
            border: none;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
        }

        .add-friend-btn:hover {
            opacity: 0.8;
        }

        .section-title {
            font-size: 10px;
            margin: 20px 0 10px 0;
            color: var(--text-muted);
        }

        .friend-requests {
            margin-bottom: 20px;
        }

        .friend-request {
            padding: 10px;
            background: var(--tertiary-bg);
            border: 2px solid var(--border-color);
            margin-bottom: 10px;
        }

        .request-username {
            font-size: 10px;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .request-actions {
            display: flex;
            gap: 5px;
        }

        .request-btn {
            padding: 5px 10px;
            border: none;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
        }

        .accept-btn {
            background: var(--accent-color);
            color: #000000;
        }

        .reject-btn {
            background: var(--error-color, #ff0000);
            color: #000000;
        }

        .friend-item {
            padding: 10px;
            background: var(--tertiary-bg);
            border: 2px solid var(--border-color);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s;
        }

        .friend-item:hover {
            background: var(--border-color);
        }

        .friend-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.online {
            background: var(--online-color);
            box-shadow: 0 0 5px var(--online-color);
        }

        .status-dot.offline {
            background: var(--offline-color);
        }

        .friend-username {
            font-size: 10px;
        }

        .friend-status-msg {
            font-size: 8px;
            color: var(--text-muted);
            margin-top: 3px;
        }

        .remove-friend-btn {
            padding: 5px 10px;
            background: var(--error-color, #ff0000);
            color: #000000;
            border: none;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 7px;
        }

        /* DMs Tab */
        .dm-list-item {
            padding: 10px;
            background: var(--tertiary-bg);
            border: 2px solid var(--border-color);
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dm-list-item:hover,
        .dm-list-item.active {
            background: var(--border-color);
        }

        .dm-username {
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .unread-badge {
            background: var(--accent-color);
            color: #000000;
            padding: 2px 6px;
            font-size: 8px;
            border-radius: 10px;
        }

        .dm-preview {
            font-size: 8px;
            color: var(--text-muted);
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--primary-bg);
        }

        .content-header {
            height: 60px;
            background: var(--secondary-bg);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
        }

        .content-title {
            font-size: 14px;
            color: var(--accent-color);
        }

        .status-message-form {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .status-message-input {
            padding: 8px;
            background: var(--primary-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 10px;
            width: 300px;
        }

        .update-status-btn {
            padding: 8px 15px;
            background: var(--accent-color);
            color: #000000;
            border: none;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
        }

        /* Messages View */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .message-item {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--tertiary-bg);
            border: 2px solid var(--border-color);
            max-width: 70%;
        }

        .message-item.mine {
            align-self: flex-end;
            background: var(--secondary-bg);
            border-color: var(--accent-color);
        }

        .message-sender {
            font-size: 9px;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .message-text {
            font-size: 10px;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
        }

        .message-time {
            font-size: 7px;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .message-input-container {
            padding: 20px;
            background: var(--secondary-bg);
            border-top: 2px solid var(--border-color);
        }

        .message-input-form {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 10px;
            background: var(--primary-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }

        .send-message-btn {
            padding: 10px 20px;
            background: var(--accent-color);
            color: #000000;
            border: none;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
        }

        .send-message-btn:hover {
            opacity: 0.8;
        }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
        }

        .empty-state-text {
            font-size: 12px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        /* Loading/Error Messages */
        .message-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            background: var(--tertiary-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-size: 10px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .message-toast.success {
            border-color: var(--accent-color);
        }

        .message-toast.error {
            border-color: var(--error-color, #ff0000);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="background-animation"></div>

    <!-- Top Navigation -->
    <div class="top-nav">
        <div class="nav-logo">>>> COMMUNITY</div>
        <div class="nav-links">
            <a href="/" class="nav-link">HOME</a>
            <a href="/python/" class="nav-link">PYTHON</a>
            <a href="/logout/" class="nav-link">LOGOUT</a>
        </div>
    </div>

    <!-- Main Container -->
    <div class="community-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" onclick="switchTab('friends')">FRIENDS</button>
                <button class="sidebar-tab" onclick="switchTab('dms')">DMs</button>
            </div>
            <div class="sidebar-content">
                <!-- Friends Tab Content -->
                <div id="friends-tab" class="tab-content">
                    <div class="add-friend-section">
                        <div class="add-friend-title">ADD FRIEND</div>
                        <div class="add-friend-form">
                            <input type="text" id="friendUsername" class="add-friend-input" placeholder="Enter username...">
                            <button class="add-friend-btn" onclick="sendFriendRequest()">ADD</button>
                        </div>
                    </div>

                    <!-- Pending Requests -->
                    <div id="pendingRequests" class="friend-requests">
                        <div class="section-title">PENDING REQUESTS</div>
                        {% for request in pending_requests %}
                        <div class="friend-request" data-request-id="{{ request.id }}">
                            <div class="request-username">{{ request.from_user.username }}</div>
                            <div class="request-actions">
                                <button class="request-btn accept-btn" onclick="respondToRequest({{ request.id }}, 'accept')">ACCEPT</button>
                                <button class="request-btn reject-btn" onclick="respondToRequest({{ request.id }}, 'reject')">REJECT</button>
                            </div>
                        </div>
                        {% empty %}
                        <div style="font-size: 8px; color: var(--text-muted); padding: 10px;">No pending requests</div>
                        {% endfor %}
                    </div>

                    <!-- Online Friends -->
                    <div class="section-title">ONLINE</div>
                    <div id="onlineFriends"></div>

                    <!-- Offline Friends -->
                    <div class="section-title">OFFLINE</div>
                    <div id="offlineFriends"></div>
                </div>

                <!-- DMs Tab Content -->
                <div id="dms-tab" class="tab-content" style="display: none;">
                    <div id="dmsList"></div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <div class="content-header">
                <div class="content-title" id="contentTitle">>>> WELCOME {{ user.username }}</div>
                <div class="status-message-form">
                    <input type="text" id="statusMessage" class="status-message-input" placeholder="Set status message...">
                    <button class="update-status-btn" onclick="updateStatus()">UPDATE</button>
                </div>
            </div>

            <!-- Empty State (shown by default) -->
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ’¬</div>
                    <div class="empty-state-text">Select a friend to start chatting</div>
                </div>
            </div>

            <!-- Message Input (hidden by default) -->
            <div class="message-input-container" id="messageInputContainer" style="display: none;">
                <div class="message-input-form">
                    <input type="text" id="messageInput" class="message-input" placeholder="Type a message...">
                    <button class="send-message-btn" onclick="sendMessage()">SEND</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const csrfToken = '{{ csrf_token }}';
        let currentTab = 'friends';
        let currentChatUser = null;
        let friendsData = {{ friends_json|safe }};

        // Switch between tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.sidebar-tab:nth-child(${tab === 'friends' ? 1 : 2})`).classList.add('active');
            
            document.getElementById('friends-tab').style.display = tab === 'friends' ? 'block' : 'none';
            document.getElementById('dms-tab').style.display = tab === 'dms' ? 'block' : 'none';

            if (tab === 'dms') {
                loadDMsList();
            }
        }

        // Load and display friends
        function loadFriends() {
            fetch('/community/friends/', {
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    friendsData = data.friends;
                    displayFriends(data.friends);
                }
            });
        }

        function displayFriends(friends) {
            const onlineContainer = document.getElementById('onlineFriends');
            const offlineContainer = document.getElementById('offlineFriends');
            
            onlineContainer.innerHTML = '';
            offlineContainer.innerHTML = '';

            const online = friends.filter(f => f.is_online);
            const offline = friends.filter(f => !f.is_online);

            online.forEach(friend => {
                onlineContainer.innerHTML += createFriendElement(friend, true);
            });

            offline.forEach(friend => {
                offlineContainer.innerHTML += createFriendElement(friend, false);
            });

            if (online.length === 0) {
                onlineContainer.innerHTML = '<div style="font-size: 8px; color: var(--text-muted); padding: 10px;">No online friends</div>';
            }
            if (offline.length === 0) {
                offlineContainer.innerHTML = '<div style="font-size: 8px; color: var(--text-muted); padding: 10px;">No offline friends</div>';
            }
        }

        function createFriendElement(friend, isOnline) {
            return `
                <div class="friend-item" onclick="openChat(${friend.id}, '${friend.username}')">
                    <div class="friend-info">
                        <div class="status-dot ${isOnline ? 'online' : 'offline'}"></div>
                        <div>
                            <div class="friend-username">${friend.username}</div>
                            ${friend.status_message ? `<div class="friend-status-msg">${friend.status_message}</div>` : ''}
                        </div>
                    </div>
                    <button class="remove-friend-btn" onclick="event.stopPropagation(); removeFriend(${friend.id}, '${friend.username}')">REMOVE</button>
                </div>
            `;
        }

        // Send friend request
        function sendFriendRequest() {
            const username = document.getElementById('friendUsername').value.trim();
            if (!username) {
                showToast('Please enter a username', 'error');
                return;
            }

            fetch('/community/send-friend-request/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ username })
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message, data.status);
                if (data.status === 'success') {
                    document.getElementById('friendUsername').value = '';
                }
            });
        }

        // Respond to friend request
        function respondToRequest(requestId, action) {
            fetch('/community/respond-friend-request/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ request_id: requestId, action })
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message, data.status);
                if (data.status === 'success') {
                    document.querySelector(`[data-request-id="${requestId}"]`).remove();
                    loadFriends();
                }
            });
        }

        // Remove friend
        function removeFriend(friendId, username) {
            if (!confirm(`Remove ${username} from friends?`)) return;

            fetch('/community/remove-friend/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ friend_id: friendId })
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message, data.status);
                if (data.status === 'success') {
                    loadFriends();
                }
            });
        }

        // Update status message
        function updateStatus() {
            const statusMessage = document.getElementById('statusMessage').value;

            fetch('/community/update-status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ status_message: statusMessage })
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message, data.status);
            });
        }

        // Open chat with a friend
        function openChat(userId, username) {
            currentChatUser = userId;
            document.getElementById('contentTitle').textContent = `>>> DM: ${username}`;
            document.getElementById('messageInputContainer').style.display = 'block';
            loadMessages(userId);
        }

        // Load messages
        function loadMessages(userId) {
            fetch(`/community/messages/${userId}/`, {
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayMessages(data.messages);
                }
            });
        }

        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ’¬</div><div class="empty-state-text">No messages yet. Start the conversation!</div></div>';
                return;
            }

            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-item ${msg.is_mine ? 'mine' : ''}`;
                messageDiv.innerHTML = `
                    <div class="message-sender">${msg.sender_username}</div>
                    <div class="message-text">${escapeHtml(msg.message)}</div>
                    <div class="message-time">${formatTime(msg.created_at)}</div>
                `;
                container.appendChild(messageDiv);
            });

            container.scrollTop = container.scrollHeight;
        }

        // Send message
        function sendMessage() {
            if (!currentChatUser) return;

            const message = document.getElementById('messageInput').value.trim();
            if (!message) return;

            fetch('/community/send-message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    recipient_id: currentChatUser,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('messageInput').value = '';
                    loadMessages(currentChatUser);
                } else {
                    showToast(data.message, 'error');
                }
            });
        }

        // Load DMs list
        function loadDMsList() {
            // Get unique chat partners from friends
            const dmsList = document.getElementById('dmsList');
            dmsList.innerHTML = '';

            friendsData.forEach(friend => {
                dmsList.innerHTML += `
                    <div class="dm-list-item" onclick="openChat(${friend.id}, '${friend.username}'); switchTab('dms');">
                        <div class="dm-username">
                            <div class="status-dot ${friend.is_online ? 'online' : 'offline'}"></div>
                            ${friend.username}
                        </div>
                    </div>
                `;
            });

            if (friendsData.length === 0) {
                dmsList.innerHTML = '<div style="font-size: 8px; color: var(--text-muted); padding: 10px;">No friends to message</div>';
            }
        }

        // Utility functions
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `message-toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        // Enter key to send message
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            document.getElementById('friendUsername').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendFriendRequest();
                }
            });

            document.getElementById('statusMessage').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    updateStatus();
                }
            });

            // Load friends on page load
            loadFriends();

            // Refresh friends list every 30 seconds
            setInterval(loadFriends, 30000);
        });
    </script>
</body>
</html>
