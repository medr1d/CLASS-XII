{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud IDE - Python Assembly</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'auth_app/favicon.ico' %}">
    
    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4GQ8NQ38P5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4GQ8NQ38P5');
    </script>
    
    <style>
        :root {
            --primary-color: #00aa00;
            --secondary-color: #008800;
            --tertiary-color: #006600;
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #1a1a1a;
            --border-color: #008800;
            --text-color: #00cc00;
            --text-bright: #00ff00;
            --shadow-color: rgba(0, 136, 0, 0.4);
            --glow-color: rgba(0, 136, 0, 0.15);
            --grid-color: rgba(0, 136, 0, 0.03);
        }

        body.theme-greydom {
            --primary-color: #ff4444;
            --secondary-color: #cc3333;
            --tertiary-color: #aa2222;
            --bg-primary: #1a1d2e;
            --bg-secondary: #16192a;
            --bg-tertiary: #212435;
            --border-color: #ff4444;
            --text-color: #ff6666;
            --text-bright: #ff4444;
            --shadow-color: rgba(255, 68, 68, 0.4);
            --glow-color: rgba(255, 68, 68, 0.15);
            --grid-color: rgba(100, 120, 150, 0.05);
        }

        body.theme-cloud {
            --primary-color: #000000;
            --secondary-color: #1a1a1a;
            --tertiary-color: #2d2d2d;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --border-color: #cccccc;
            --text-color: #000000;
            --text-bright: #000000;
            --shadow-color: rgba(0, 0, 0, 0.15);
            --glow-color: rgba(0, 0, 0, 0.05);
            --grid-color: rgba(0, 0, 0, 0.03);
        }

        body.theme-chaos {
            --primary-color: #808080;
            --secondary-color: #666666;
            --tertiary-color: #4d4d4d;
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #141414;
            --border-color: #808080;
            --text-color: #b0b0b0;
            --text-bright: #d0d0d0;
            --shadow-color: rgba(128, 128, 128, 0.3);
            --glow-color: rgba(128, 128, 128, 0.1);
            --grid-color: rgba(128, 128, 128, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: var(--bg-primary);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                var(--grid-color) 2px,
                var(--grid-color) 4px
            ),
            repeating-linear-gradient(
                90deg,
                transparent,
                transparent 2px,
                var(--grid-color) 2px,
                var(--grid-color) 4px
            );
            pointer-events: none;
            z-index: 0;
        }

        /* Main Layout */
        .ide-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 50px 1fr 250px 30px;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Top Bar */
        .top-bar {
            grid-column: 1 / 3;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .logo {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-bright);
            text-shadow: 0 0 10px var(--text-bright);
            letter-spacing: 2px;
        }

        .project-selector {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .project-name {
            color: var(--text-color);
            font-size: 14px;
            padding: 8px 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .top-bar-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: var(--secondary-color);
            color: var(--text-bright);
            box-shadow: 0 0 15px var(--shadow-color);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--secondary-color);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-color);
        }

        /* Sidebar / File Explorer */
        .sidebar {
            grid-row: 2 / 4;
            background: var(--bg-secondary);
            border-right: 2px solid var(--border-color);
            overflow-y: auto;
            box-shadow: inset 0 0 20px var(--glow-color);
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 13px;
            color: var(--text-bright);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-tree {
            padding: 10px;
        }

        .tree-node {
            padding: 8px 10px;
            margin: 2px 0;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-color);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tree-node:hover {
            background: var(--bg-tertiary);
            color: var(--text-bright);
            transform: translateX(5px);
        }

        .tree-node.selected {
            background: var(--secondary-color);
            color: var(--text-bright);
            box-shadow: 0 0 10px var(--shadow-color);
        }

        .tree-node-icon {
            font-size: 14px;
        }

        /* Editor Area */
        .editor-area {
            grid-row: 2 / 3;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
        }

        .editor-tabs {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 5px;
            min-height: 40px;
        }

        .editor-tab {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-color);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 4px 4px 0 0;
        }

        .editor-tab.active {
            background: var(--bg-primary);
            color: var(--text-bright);
            border-color: var(--secondary-color);
        }

        .editor-tab:hover {
            background: var(--secondary-color);
            color: var(--text-bright);
        }

        .tab-close {
            font-size: 16px;
            padding: 0 4px;
        }

        #monaco-editor {
            flex: 1;
            position: relative;
        }

        /* Terminal Area */
        .terminal-area {
            grid-row: 3 / 4;
            grid-column: 2 / 3;
            background: var(--bg-primary);
            border-top: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            background: var(--bg-secondary);
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-tabs {
            display: flex;
            gap: 5px;
            flex: 1;
            overflow-x: auto;
        }

        .terminal-tab {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            padding: 6px 12px;
            font-size: 11px;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .terminal-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-bright);
        }

        .terminal-tab.active {
            background: var(--bg-primary);
            color: var(--secondary-color);
            border-color: var(--secondary-color);
            font-weight: bold;
        }

        .terminal-tab-close {
            color: var(--text-muted);
            cursor: pointer;
            padding: 0 4px;
            font-size: 14px;
            line-height: 1;
        }

        .terminal-tab-close:hover {
            color: #ff4444;
        }

        .terminal-title {
            font-size: 12px;
            color: var(--text-bright);
            text-transform: uppercase;
        }

        .terminal-actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 4px 10px !important;
            font-size: 10px !important;
        }

        .terminal-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .terminal-output {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            color: var(--text-color);
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-y: auto;
            white-space: pre-wrap;
            text-shadow: 0 0 1px var(--text-color);
            display: none;
            cursor: text;
            user-select: text;
        }

        .terminal-output.active {
            display: flex;
            flex-direction: column;
        }

        .terminal-output-content {
            flex: 1;
            overflow-y: auto;
            user-select: text;
        }

        .terminal-input-line {
            display: flex;
            align-items: center;
            margin-top: 10px;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
        }

        .terminal-input-prompt {
            color: var(--secondary-color);
            margin-right: 10px;
            font-weight: bold;
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-family: inherit;
            font-size: inherit;
            outline: none;
        }

        .terminal-output::-webkit-scrollbar {
            width: 10px;
        }

        .terminal-output::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .terminal-output::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 5px;
        }

        .terminal-output.error {
            color: #ff4444;
            text-shadow: 0 0 5px #ff4444;
        }

        .terminal-prompt {
            color: var(--text-bright);
            font-weight: bold;
        }

        /* Status Bar */
        .status-bar {
            grid-row: 4 / 5;
            grid-column: 1 / 3;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-color);
        }

        .status-left, .status-right {
            display: flex;
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-online {
            color: #00ff88;
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* Loading Spinner */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: var(--bg-secondary);
            padding: 30px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 0 30px var(--shadow-color);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 0;
            box-shadow: 0 4px 20px var(--shadow-color);
            z-index: 10000;
            min-width: 150px;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-color);
            transition: all 0.2s;
        }

        .context-menu-item:hover {
            background: var(--secondary-color);
            color: var(--text-bright);
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 0;
            min-width: 180px;
            box-shadow: 0 4px 12px var(--shadow-color);
            z-index: 10001;
            display: none;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .context-menu-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-bright);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 5px 0;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 30px var(--shadow-color);
        }

        .modal-title {
            font-size: 18px;
            color: var(--text-bright);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--text-color);
            text-transform: uppercase;
        }

        .input-field {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-family: inherit;
            font-size: 13px;
            border-radius: 4px;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 10px var(--glow-color);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 20px var(--shadow-color);
            z-index: 10001;
            animation: slideIn 0.3s ease-out;
            min-width: 300px;
        }

        .notification.success {
            border-color: var(--primary-color);
        }

        .notification.error {
            border-color: #ff4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .ide-container {
                grid-template-columns: 220px 1fr;
            }
        }

        @media (max-width: 768px) {
            .ide-container {
                grid-template-columns: 1fr;
                grid-template-rows: 50px 1fr 200px 30px;
            }
            
            .sidebar {
                display: none;
            }
            
            .sidebar.mobile-active {
                display: block;
                position: fixed;
                top: 50px;
                left: 0;
                bottom: 230px;
                width: 280px;
                z-index: 100;
            }
        }

        /* Enhanced Context Menu Styles */
        .file-context-menu {
            position: fixed;
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            border: 1px solid var(--secondary-color);
            border-radius: 6px;
            padding: 6px 0;
            min-width: 200px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 0 1px var(--border-color);
            z-index: 10002;
            display: none;
            backdrop-filter: blur(10px);
            animation: contextMenuFadeIn 0.15s ease-out;
        }

        .file-context-menu.active {
            display: block;
        }

        @keyframes contextMenuFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-5px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .context-menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--secondary-color);
            transform: scaleY(0);
            transition: transform 0.2s;
        }

        .context-menu-item:hover::before {
            transform: scaleY(1);
        }

        .context-menu-item:hover {
            background: linear-gradient(90deg, var(--secondary-color)15, transparent);
            color: var(--text-bright);
            padding-left: 20px;
        }

        .context-menu-item .icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0.8;
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* Improved File Tree Animations */
        .tree-node {
            animation: fadeInSlide 0.3s ease-out;
            transform-origin: left;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .tree-node:hover {
            background: linear-gradient(90deg, var(--secondary-color)10, transparent);
            transform: translateX(2px);
        }

        /* Button Hover Effects */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        /* Tab Animations */
        .editor-tab, .terminal-tab {
            animation: tabSlideIn 0.3s ease-out;
        }

        @keyframes tabSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Pulse Animation for Active Elements */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .status-item.online {
            animation: pulse 2s infinite;
        }

        /* Smooth Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 5px;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-bright);
        }

        /* Loading Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--border-color);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body class="theme-{{ user_theme }}">
    <div class="ide-container">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="logo">CLOUD IDE</div>
            <div class="project-selector">
                <span class="project-name">{{ current_project.name }}</span>
            </div>
            <div class="top-bar-actions">
                <button class="btn btn-primary" onclick="runCode()">RUN CODE</button>
                <button class="btn" onclick="saveCurrentFile()">SAVE FILE</button>
                <button class="btn" onclick="formatCode()">FORMAT</button>
                <button class="btn" onclick="showSearchModal()">SEARCH</button>
                <!-- <button class="btn" onclick="showTemplateModal()">TEMPLATES</button> -->
                <button class="btn" onclick="showPackageModal()">PACKAGES</button>
                <button class="btn" onclick="showProjectModal()">PROJECTS</button>
                <button class="btn" onclick="showShortcutsModal()">HELP</button>
                <a href="/python/" class="btn">BACK</a>
            </div>
        </div>

        <!-- File Explorer Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">FILES</span>
                <div style="display: flex; gap: 5px;">
                    <button class="btn btn-sm" onclick="triggerFileUpload()" title="Upload Files" style="padding: 4px 8px; font-size: 11px;">UPLOAD</button>
                    <button class="btn btn-sm" onclick="downloadProject()" title="Download Project as ZIP" style="padding: 4px 8px; font-size: 11px;">ZIP</button>
                    <button class="btn btn-sm" onclick="refreshFileTree()" title="Refresh File Tree" style="padding: 4px 8px; font-size: 11px;">REFRESH</button>
                </div>
            </div>
            <input type="file" id="fileUploadInput" multiple style="display: none;" onchange="handleFileUpload(event)">
            <div class="file-tree" id="fileTree">
                <!-- Files will be populated by JavaScript -->
            </div>
        </div>

        <!-- Editor Area -->
        <div class="editor-area">
            <div class="editor-tabs" id="editorTabs">
                <!-- Tabs will be populated by JavaScript -->
            </div>
            <div id="monaco-editor"></div>
        </div>

        <!-- Terminal Area -->
        <div class="terminal-area">
            <div class="terminal-header">
                <div class="terminal-tabs" id="terminalTabs">
                    <!-- Terminal tabs will be populated by JavaScript -->
                </div>
                <div class="terminal-actions">
                    <button class="btn btn-sm" onclick="createNewTerminal()" title="New Terminal">
                        <span style="font-size: 14px;">+</span> NEW
                    </button>
                    <button class="btn btn-sm" onclick="clearActiveTerminal()" title="Clear Terminal">CLEAR</button>
                </div>
            </div>
            <div class="terminal-container">
                <!-- Terminal outputs will be populated by JavaScript -->
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <div class="status-item">
                    <span>User:</span>
                    <span>{{ user.username }}</span>
                </div>
                <div class="status-item" id="statusFile">
                    <span>File:</span>
                    <span>main.py</span>
                </div>
                <div class="status-item" id="statusEncoding">
                    <span>UTF-8</span>
                </div>
            </div>
            <div class="status-right">
                <div class="status-item" id="statusLines">
                    <span>Lines: 0</span>
                </div>
                <div class="status-item" id="statusLanguage">
                    <span>Python</span>
                </div>
                <div class="status-item">
                    <span class="status-online">● ONLINE</span>
                </div>
            </div>
        </div>
    </div>

    <!-- New File Modal -->
    <div class="modal" id="newFileModal">
        <div class="modal-content">
            <h2 class="modal-title">Create New File</h2>
            <div class="input-group">
                <label class="input-label">File Name</label>
                <input type="text" class="input-field" id="newFileName" placeholder="example.py">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('newFileModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createNewFile()">Create</button>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 class="modal-title">Project Management</h2>
            <div class="input-group">
                <label class="input-label">Current Project</label>
                <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 4px;">
                    {{ current_project.name }}
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 20px;">
                <!-- <button class="btn btn-primary" onclick="closeModal('projectModal'); showTemplateModal();">New Project from Template</button> -->
                <button class="btn" onclick="closeModal('projectModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Template Selection Modal -->
    <div class="modal" id="templateModal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 class="modal-title">Create Project from Template</h2>
            <p style="opacity: 0.7; margin-bottom: 20px;">Choose a template to quickly start your project</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                <!-- Flask Web App Template -->
                <div class="template-card" onclick="createFromTemplate('flask')" style="cursor: pointer; padding: 15px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.2s;">
                    <h3 style="color: var(--primary-color); margin-bottom: 10px;">Flask Web App</h3>
                    <p style="font-size: 13px; opacity: 0.8; margin-bottom: 10px;">Modern Flask application with routes, templates, and database setup</p>
                    <div style="font-size: 11px; opacity: 0.6;">Includes: app.py, routes, templates, static files</div>
                </div>

                <!-- Django Project Template -->
                <div class="template-card" onclick="createFromTemplate('django')" style="cursor: pointer; padding: 15px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.2s;">
                    <h3 style="color: var(--primary-color); margin-bottom: 10px;">Django Project</h3>
                    <p style="font-size: 13px; opacity: 0.8; margin-bottom: 10px;">Complete Django project structure with views, models, and templates</p>
                    <div style="font-size: 11px; opacity: 0.6;">Includes: manage.py, settings, views, models</div>
                </div>

                <!-- Data Science Template -->
                <div class="template-card" onclick="createFromTemplate('datascience')" style="cursor: pointer; padding: 15px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.2s;">
                    <h3 style="color: var(--primary-color); margin-bottom: 10px;">Data Science</h3>
                    <p style="font-size: 13px; opacity: 0.8; margin-bottom: 10px;">Data analysis project with pandas, numpy, and visualization examples</p>
                    <div style="font-size: 11px; opacity: 0.6;">Includes: analysis.py, visualization.py, requirements.txt</div>
                </div>

                <!-- Web Scraper Template -->
                <div class="template-card" onclick="createFromTemplate('scraper')" style="cursor: pointer; padding: 15px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.2s;">
                    <h3 style="color: var(--primary-color); margin-bottom: 10px;">Web Scraper</h3>
                    <p style="font-size: 13px; opacity: 0.8; margin-bottom: 10px;">Web scraping project with requests and BeautifulSoup examples</p>
                    <div style="font-size: 11px; opacity: 0.6;">Includes: scraper.py, utils.py, config.py</div>
                </div>

                <!-- API Client Template -->
                <div class="template-card" onclick="createFromTemplate('api')" style="cursor: pointer; padding: 15px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.2s;">
                    <h3 style="color: var(--primary-color); margin-bottom: 10px;">API Client</h3>
                    <p style="font-size: 13px; opacity: 0.8; margin-bottom: 10px;">REST API client with authentication and error handling</p>
                    <div style="font-size: 11px; opacity: 0.6;">Includes: client.py, auth.py, models.py</div>
                </div>

                <!-- Blank Project -->
                <div class="template-card" onclick="createFromTemplate('blank')" style="cursor: pointer; padding: 15px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.2s;">
                    <h3 style="color: var(--primary-color); margin-bottom: 10px;">Blank Project</h3>
                    <p style="font-size: 13px; opacity: 0.8; margin-bottom: 10px;">Start from scratch with just a main.py file</p>
                    <div style="font-size: 11px; opacity: 0.6;">Includes: main.py</div>
                </div>
            </div>

            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn" onclick="closeModal('templateModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Package Manager Modal -->
    <div class="modal" id="packageModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 class="modal-title">Package Manager</h2>
            <div class="input-group">
                <label class="input-label">Install Package</label>
                <input type="text" id="packageName" class="modal-input" placeholder="e.g., requests, pandas, flask">
            </div>
            <div style="margin: 15px 0;">
                <h3 style="font-size: 14px; margin-bottom: 10px;">Popular Packages:</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <button class="btn btn-sm" onclick="installPackage('requests')">requests</button>
                    <button class="btn btn-sm" onclick="installPackage('pandas')">pandas</button>
                    <button class="btn btn-sm" onclick="installPackage('numpy')">numpy</button>
                    <button class="btn btn-sm" onclick="installPackage('flask')">flask</button>
                    <button class="btn btn-sm" onclick="installPackage('beautifulsoup4')">beautifulsoup4</button>
                    <button class="btn btn-sm" onclick="installPackage('matplotlib')">matplotlib</button>
                </div>
            </div>
            <div id="installedPackages" style="margin-top: 20px;">
                <h3 style="font-size: 14px; margin-bottom: 10px;">Note:</h3>
                <p style="font-size: 12px; opacity: 0.7;">Packages are available in the cloud environment. Install status indicates local availability for download.</p>
            </div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="installPackageFromInput()">Install</button>
                <button class="btn" onclick="closeModal('packageModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Search & Replace Modal -->
    <div class="modal" id="searchModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 class="modal-title">Search & Replace</h2>
            
            <div class="input-group">
                <label class="input-label">Find</label>
                <input type="text" id="searchInput" class="modal-input" placeholder="Search in current file..." onkeypress="if(event.key==='Enter') findNext()">
            </div>
            
            <div class="input-group">
                <label class="input-label">Replace with</label>
                <input type="text" id="replaceInput" class="modal-input" placeholder="Replace with...">
            </div>
            
            <div style="display: flex; gap: 10px; margin: 15px 0;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" id="caseSensitive" style="cursor: pointer;">
                    <span style="font-size: 13px;">Case Sensitive</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" id="useRegex" style="cursor: pointer;">
                    <span style="font-size: 13px;">Use Regex</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" id="wholeWord" style="cursor: pointer;">
                    <span style="font-size: 13px;">Whole Word</span>
                </label>
            </div>
            
            <div id="searchResults" style="margin: 15px 0; font-size: 13px; opacity: 0.7;">
                <!-- Results will be shown here -->
            </div>
            
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="findNext()">Find Next</button>
                <button class="btn btn-primary" onclick="findPrevious()">Find Previous</button>
                <button class="btn" onclick="replaceNext()">Replace</button>
                <button class="btn" onclick="replaceAll()">Replace All</button>
                <button class="btn" onclick="closeModal('searchModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal" id="shortcutsModal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 class="modal-title">Keyboard Shortcuts</h2>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;">
                <div>
                    <h3 style="color: var(--primary-color); font-size: 14px; margin-bottom: 10px;">File Operations</h3>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Ctrl + S</span>
                        <span>Save File</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Ctrl + F</span>
                        <span>Search</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Ctrl + H</span>
                        <span>Replace</span>
                    </div>
                </div>
                
                <div>
                    <h3 style="color: var(--primary-color); font-size: 14px; margin-bottom: 10px;">Code Execution</h3>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Ctrl + Enter</span>
                        <span>Run Code</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Ctrl + Shift + T</span>
                        <span>New Terminal</span>
                    </div>
                </div>
                
                <div>
                    <h3 style="color: var(--primary-color); font-size: 14px; margin-bottom: 10px;">Editor</h3>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Ctrl + /</span>
                        <span>Toggle Comment</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Ctrl + D</span>
                        <span>Duplicate Line</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Alt + ↑/↓</span>
                        <span>Move Line</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Ctrl + Space</span>
                        <span>Trigger Suggestions</span>
                    </div>
                </div>
                
                <div>
                    <h3 style="color: var(--primary-color); font-size: 14px; margin-bottom: 10px;">Navigation</h3>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Ctrl + G</span>
                        <span>Go to Line</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Ctrl + W</span>
                        <span>Close Tab</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn" onclick="closeModal('shortcutsModal')">Close</button>
            </div>
        </div>
    </div>

    <style>
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .shortcut-key {
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--primary-color);
        }
        
        .template-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary-color) !important;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.1);
        }
    </style>

    <script>
        // Configuration
        const PROJECT_ID = "{{ project_id }}";
        const CSRF_TOKEN = "{{ csrf_token }}";
        
        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue || CSRF_TOKEN;
        }
        
        let editor = null;
        let currentFile = null;
        let openTabs = [];
        let fileTree = [];
        
        // Performance optimization: Cache Monaco models and file contents
        const monacoModels = new Map(); // path -> model
        const fileContentCache = new Map(); // path -> {content, timestamp}
        const CACHE_DURATION = 60000; // 1 minute cache
        
        // Terminal Management
        let terminals = [];
        let activeTerminalId = null;
        let terminalCounter = 0;
        
        // Initialize first terminal
        document.addEventListener('DOMContentLoaded', function() {
            createNewTerminal();
        });
        
        function createNewTerminal() {
            terminalCounter++;
            const terminalId = `terminal-${terminalCounter}`;
            
            const terminal = {
                id: terminalId,
                name: `Terminal ${terminalCounter}`,
                history: [],
                commandHistory: [],
                historyIndex: -1
            };
            
            terminals.push(terminal);
            
            // Create terminal tab
            const tabsContainer = document.getElementById('terminalTabs');
            const tab = document.createElement('div');
            tab.className = 'terminal-tab';
            tab.dataset.terminalId = terminalId;
            tab.innerHTML = `
                <span class="terminal-tab-name">${terminal.name}</span>
                ${terminals.length > 1 ? `<span class="terminal-tab-close" onclick="closeTerminal(event, '${terminalId}')">×</span>` : ''}
            `;
            tab.onclick = (e) => {
                if (!e.target.classList.contains('terminal-tab-close')) {
                    switchTerminal(terminalId);
                }
            };
            tabsContainer.appendChild(tab);
            
            // Create terminal output
            const container = document.querySelector('.terminal-container');
            const output = document.createElement('div');
            output.className = 'terminal-output';
            output.id = terminalId;
            output.innerHTML = `
                <div class="terminal-output-content">
                    <div class="terminal-prompt">$ Cloud IDE Terminal ${terminalCounter}</div>
                    <div>Ready to execute code...</div>
                    <div style="opacity: 0.6; margin-top: 10px;">Press "RUN" to execute your Python code or type commands.</div>
                    <div style="opacity: 0.6;">Use Ctrl+C to copy, Ctrl+V to paste. Use Up/Down arrows for command history.</div>
                </div>
                <div class="terminal-input-line">
                    <span class="terminal-input-prompt">$</span>
                    <input type="text" class="terminal-input" placeholder="Type a command..." data-terminal-id="${terminalId}">
                </div>
            `;
            container.appendChild(output);
            
            // Add keyboard event listeners for command history
            const input = output.querySelector('.terminal-input');
            input.addEventListener('keydown', handleTerminalInput);
            input.addEventListener('paste', (e) => {
                // Allow default paste behavior
                setTimeout(() => {
                    appendToTerminal(`$ ${input.value}`);
                }, 10);
            });
            
            // Switch to new terminal
            switchTerminal(terminalId);
            
            return terminalId;
        }
        
        function handleTerminalInput(event) {
            const input = event.target;
            const terminalId = input.dataset.terminalId;
            const terminal = terminals.find(t => t.id === terminalId);
            
            if (!terminal) return;
            
            // Handle Enter key - execute command
            if (event.key === 'Enter') {
                const command = input.value.trim();
                if (command) {
                    // Add to command history
                    terminal.commandHistory.push(command);
                    terminal.historyIndex = terminal.commandHistory.length;
                    
                    // Display command
                    appendToTerminal(`$ ${command}`);
                    
                    // Process command (you can add more commands here)
                    processTerminalCommand(command, terminalId);
                    
                    input.value = '';
                }
                event.preventDefault();
            }
            // Handle Up arrow - previous command
            else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (terminal.commandHistory.length > 0 && terminal.historyIndex > 0) {
                    terminal.historyIndex--;
                    input.value = terminal.commandHistory[terminal.historyIndex];
                }
            }
            // Handle Down arrow - next command
            else if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (terminal.historyIndex < terminal.commandHistory.length - 1) {
                    terminal.historyIndex++;
                    input.value = terminal.commandHistory[terminal.historyIndex];
                } else {
                    terminal.historyIndex = terminal.commandHistory.length;
                    input.value = '';
                }
            }
        }
        
        function processTerminalCommand(command, terminalId) {
            const oldActiveTerminal = activeTerminalId;
            switchTerminal(terminalId);
            
            const lowerCommand = command.toLowerCase();
            
            // Built-in commands
            if (lowerCommand === 'clear' || lowerCommand === 'cls') {
                clearActiveTerminal();
            } else if (lowerCommand === 'help') {
                appendToTerminal('Available commands:');
                appendToTerminal('  clear/cls  - Clear the terminal');
                appendToTerminal('  help       - Show this help message');
                appendToTerminal('  history    - Show command history');
                appendToTerminal('  run        - Run the current file');
                appendToTerminal('  pwd        - Show current project');
                appendToTerminal('\nNote: This is a simulated terminal. Python code runs via the RUN button.');
            } else if (lowerCommand === 'history') {
                const terminal = terminals.find(t => t.id === terminalId);
                if (terminal && terminal.commandHistory.length > 0) {
                    appendToTerminal('Command history:');
                    terminal.commandHistory.forEach((cmd, idx) => {
                        appendToTerminal(`  ${idx + 1}  ${cmd}`);
                    });
                } else {
                    appendToTerminal('No command history');
                }
            } else if (lowerCommand === 'run') {
                runCode();
            } else if (lowerCommand === 'pwd') {
                appendToTerminal(`Current project: ${PROJECT_ID}`);
            } else {
                appendToTerminal(`Command not recognized: ${command}`);
                appendToTerminal('Type "help" for available commands.');
            }
            
            if (oldActiveTerminal !== terminalId) {
                switchTerminal(oldActiveTerminal);
            }
        }
        
        function switchTerminal(terminalId) {
            activeTerminalId = terminalId;
            
            // Update tab styles
            document.querySelectorAll('.terminal-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.terminalId === terminalId);
            });
            
            // Update output visibility
            document.querySelectorAll('.terminal-output').forEach(output => {
                output.classList.toggle('active', output.id === terminalId);
            });
        }
        
        function closeTerminal(event, terminalId) {
            event.stopPropagation();
            
            if (terminals.length === 1) {
                showNotification('Cannot close the last terminal', 'warning');
                return;
            }
            
            // Remove terminal from array
            const index = terminals.findIndex(t => t.id === terminalId);
            if (index !== -1) {
                terminals.splice(index, 1);
            }
            
            // Remove tab and output
            const tab = document.querySelector(`[data-terminal-id="${terminalId}"]`);
            const output = document.getElementById(terminalId);
            
            if (tab) tab.remove();
            if (output) output.remove();
            
            // Switch to another terminal if this was active
            if (activeTerminalId === terminalId) {
                switchTerminal(terminals[0].id);
            }
        }
        
        function clearActiveTerminal() {
            if (!activeTerminalId) return;
            
            const output = document.getElementById(activeTerminalId);
            if (output) {
                const terminal = terminals.find(t => t.id === activeTerminalId);
                const content = output.querySelector('.terminal-output-content');
                if (content) {
                    content.innerHTML = `
                        <div class="terminal-prompt">$ Terminal cleared</div>
                        <div>Ready for new output...</div>
                    `;
                }
                if (terminal) {
                    terminal.history = [];
                }
            }
        }
        
        function appendToTerminal(text, isError = false) {
            if (!activeTerminalId) return;
            
            const output = document.getElementById(activeTerminalId);
            if (output) {
                const content = output.querySelector('.terminal-output-content');
                if (content) {
                    const line = document.createElement('div');
                    line.textContent = text;
                    if (isError) {
                        line.style.color = '#ff4444';
                    }
                    content.appendChild(line);
                    content.scrollTop = content.scrollHeight;
                    
                    // Add to terminal history
                    const terminal = terminals.find(t => t.id === activeTerminalId);
                    if (terminal) {
                        terminal.history.push({ text, isError, timestamp: new Date() });
                    }
                }
            }
        }
        
        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        
        require(['vs/editor/editor.main'], function() {
            // Set theme based on user preference
            const userTheme = "{{ user_theme }}";
            let monacoTheme = 'vs-dark';
            
            if (userTheme === 'cloud') {
                monacoTheme = 'vs';
            }
            
            editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                value: '# Welcome to Cloud IDE\n\nprint("Hello, World!")\n',
                language: 'python',
                theme: monacoTheme,
                fontSize: 14,
                minimap: { enabled: true },
                automaticLayout: true,
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                lineNumbers: 'on',
                renderWhitespace: 'selection',
                tabSize: 4,
                // Code Intelligence Features
                suggest: {
                    snippetsPreventQuickSuggestions: false,
                    showWords: true,
                    showKeywords: true,
                    showSnippets: true,
                },
                quickSuggestions: {
                    other: true,
                    comments: false,
                    strings: true
                },
                acceptSuggestionOnCommitCharacter: true,
                acceptSuggestionOnEnter: 'on',
                parameterHints: {
                    enabled: true,
                    cycle: true
                },
                formatOnPaste: true,
                formatOnType: true,
                autoClosingBrackets: 'always',
                autoClosingQuotes: 'always',
                autoIndent: 'full',
                bracketPairColorization: {
                    enabled: true
                },
                // Error Detection
                renderValidationDecorations: 'on',
            });
            
            // Configure Python language features
            monaco.languages.registerCompletionItemProvider('python', {
                provideCompletionItems: (model, position) => {
                    const suggestions = getPythonSuggestions(model, position);
                    return { suggestions };
                }
            });
            
            // Load initial file tree
            loadFileTree();
            
            // Auto-save on change (debounced)
            let saveTimeout;
            editor.onDidChangeModelContent(() => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    autoSaveCurrentFile();
                }, 2000); // Auto-save after 2 seconds of no typing
                
                updateStatusBar();
            });
        });
        
        // API Functions
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                }
            };
            
            const response = await fetch(url, { ...defaultOptions, ...options });
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Request failed');
            }
            
            return data;
        }
        
        // File Tree Management
        async function loadFileTree() {
            try {
                const data = await apiRequest(`/api/ide/projects/${PROJECT_ID}/files/`);
                fileTree = data.file_tree;
                renderFileTree();
                
                // Open first Python file if available
                if (fileTree.length > 0) {
                    const firstPythonFile = findFirstPythonFile(fileTree);
                    if (firstPythonFile) {
                        openFile(firstPythonFile.path);
                    }
                }
            } catch (error) {
                showNotification('Error loading files: ' + error.message, 'error');
            }
        }
        
        function findFirstPythonFile(tree) {
            for (const node of tree) {
                if (node.type === 'file' && node.file_type === 'python') {
                    return node;
                }
                if (node.type === 'directory' && node.children) {
                    const found = findFirstPythonFile(node.children);
                    if (found) return found;
                }
            }
            return null;
        }
        
        function renderFileTree() {
            const container = document.getElementById('fileTree');
            container.innerHTML = '';
            renderTreeNodes(fileTree, container, 0);
        }
        
        function renderTreeNodes(nodes, container, level) {
            nodes.forEach(node => {
                const nodeElement = document.createElement('div');
                nodeElement.className = 'tree-node';
                nodeElement.style.paddingLeft = (level * 20 + 10) + 'px';
                nodeElement.dataset.path = node.path;
                nodeElement.dataset.type = node.type;
                
                const icon = node.type === 'directory' ? '▶' : getFileIcon(node.file_type);
                nodeElement.innerHTML = `
                    <span class="tree-node-icon">${icon}</span>
                    <span>${node.name}</span>
                `;
                
                if (currentFile === node.path) {
                    nodeElement.classList.add('selected');
                }
                
                if (node.type === 'file') {
                    nodeElement.onclick = () => openFile(node.path);
                }
                
                // Add context menu for all nodes
                nodeElement.oncontextmenu = (e) => showContextMenu(e, node.path, node.type);
                
                container.appendChild(nodeElement);
                
                if (node.type === 'directory' && node.children) {
                    renderTreeNodes(node.children, container, level + 1);
                }
            });
        }
        
        function getFileIcon(fileType) {
            const icons = {
                'python': '●',
                'text': '▫',
                'json': '{}',
                'csv': '▤',
                'markdown': 'M',
                'html': '<>',
                'css': '#',
                'javascript': 'JS'
            };
            return icons[fileType] || '▫';
        }
        
        // File Operations
        async function openFile(filePath) {
            try {
                // If file is already open, just switch to it
                if (currentFile === filePath && monacoModels.has(filePath)) {
                    editor.setModel(monacoModels.get(filePath));
                    renderTabs();
                    updateStatusBar();
                    return;
                }
                
                let fileData;
                const cached = fileContentCache.get(filePath);
                const now = Date.now();
                
                // Use cache if available and fresh
                if (cached && (now - cached.timestamp) < CACHE_DURATION) {
                    fileData = cached;
                } else {
                    // Fetch from server
                    const data = await apiRequest(`/api/ide/projects/${PROJECT_ID}/files/${encodeURIComponent(filePath)}/`);
                    fileData = {
                        content: data.file.content,
                        name: data.file.name,
                        file_type: data.file.file_type,
                        timestamp: now
                    };
                    fileContentCache.set(filePath, fileData);
                }
                
                currentFile = filePath;
                
                // Reuse or create Monaco model
                let model = monacoModels.get(filePath);
                if (!model) {
                    // Determine language
                    const languageMap = {
                        'python': 'python',
                        'javascript': 'javascript',
                        'html': 'html',
                        'css': 'css',
                        'json': 'json',
                        'markdown': 'markdown',
                        'text': 'plaintext'
                    };
                    const language = languageMap[fileData.file_type] || 'plaintext';
                    
                    // Create new model
                    const uri = monaco.Uri.parse(`file:///${filePath}`);
                    model = monaco.editor.createModel(fileData.content, language, uri);
                    monacoModels.set(filePath, model);
                } else {
                    // Update existing model content
                    model.setValue(fileData.content);
                }
                
                // Switch to the model
                editor.setModel(model);
                
                // Add to tabs if not already open
                if (!openTabs.find(tab => tab.path === filePath)) {
                    openTabs.push({
                        name: fileData.name,
                        path: filePath,
                        type: fileData.file_type
                    });
                }
                
                renderTabs();
                updateStatusBar();
                renderFileTree(); // Refresh to update selected state
                
            } catch (error) {
                showNotification('Error opening file: ' + error.message, 'error');
            }
        }
        
        function renderTabs() {
            const container = document.getElementById('editorTabs');
            container.innerHTML = '';
            
            openTabs.forEach(tab => {
                const tabElement = document.createElement('div');
                tabElement.className = 'editor-tab';
                if (tab.path === currentFile) {
                    tabElement.classList.add('active');
                }
                
                tabElement.innerHTML = `
                    <span>${getFileIcon(tab.type)}</span>
                    <span>${tab.name}</span>
                    <span class="tab-close" onclick="closeTab('${tab.path}', event)">×</span>
                `;
                
                tabElement.onclick = (e) => {
                    if (!e.target.classList.contains('tab-close')) {
                        openFile(tab.path);
                    }
                };
                
                container.appendChild(tabElement);
            });
        }
        
        function closeTab(filePath, event) {
            event.stopPropagation();
            
            openTabs = openTabs.filter(tab => tab.path !== filePath);
            
            // Dispose Monaco model to free memory
            const model = monacoModels.get(filePath);
            if (model) {
                model.dispose();
                monacoModels.delete(filePath);
            }
            
            // Clear cache
            fileContentCache.delete(filePath);
            
            renderTabs();
            
            if (currentFile === filePath) {
                if (openTabs.length > 0) {
                    openFile(openTabs[0].path);
                } else {
                    currentFile = null;
                    editor.setModel(null);
                }
            }
        }
        
        async function saveCurrentFile() {
            if (!currentFile) {
                showNotification('No file open', 'error');
                return;
            }
            
            // Check if editor has a model
            const model = editor.getModel();
            if (!model) {
                showNotification('No file content to save', 'error');
                return;
            }
            
            try {
                const content = model.getValue();
                
                await apiRequest(`/api/ide/projects/${PROJECT_ID}/files/save/`, {
                    method: 'POST',
                    body: JSON.stringify({
                        path: currentFile,
                        content: content
                    })
                });
                
                // Update cache with new content
                fileContentCache.set(currentFile, {
                    content: content,
                    timestamp: Date.now()
                });
                
                showNotification('File saved successfully', 'success');
            } catch (error) {
                showNotification('Error saving file: ' + error.message, 'error');
            }
        }
        
        async function autoSaveCurrentFile() {
            if (!currentFile) return;
            
            // Check if editor has a model
            const model = editor.getModel();
            if (!model) return;
            
            try {
                const content = model.getValue();
                
                const response = await fetch(`/api/ide/projects/${PROJECT_ID}/files/save/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        path: currentFile,
                        content: content
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || data.status !== 'success') {
                    // Silently fail - don't spam console for auto-save failures
                    return;
                }
                
                // Update cache
                fileContentCache.set(currentFile, {
                    content: content,
                    timestamp: Date.now()
                });
            } catch (error) {
                // Silently fail auto-save to avoid interrupting user
            }
        }
        
        function showNewFileModal() {
            document.getElementById('newFileModal').classList.add('active');
            document.getElementById('newFileName').focus();
        }
        
        async function createNewFile() {
            const fileName = document.getElementById('newFileName').value.trim();
            
            if (!fileName) {
                showNotification('Please enter a file name', 'error');
                return;
            }
            
            try {
                await apiRequest(`/api/ide/projects/${PROJECT_ID}/files/save/`, {
                    method: 'POST',
                    body: JSON.stringify({
                        path: fileName,
                        content: ''
                    })
                });
                
                closeModal('newFileModal');
                document.getElementById('newFileName').value = '';
                await loadFileTree();
                await openFile(fileName);
                showNotification('File created successfully', 'success');
            } catch (error) {
                showNotification('Error creating file: ' + error.message, 'error');
            }
        }
        
        // Code Execution
        async function runCode() {
            const code = editor.getValue();
            
            if (!code.trim()) {
                showNotification('No code to run', 'error');
                return;
            }
            
            // Scan for input() calls in the code
            const inputCalls = scanForInputCalls(code);
            let userInputs = [];
            
            // If input() calls found, prompt user for inputs
            if (inputCalls.length > 0) {
                appendToTerminal('$ Code requires input(). Prompting for inputs...\n');
                userInputs = await promptForInputs(inputCalls);
                
                if (userInputs === null) {
                    // User cancelled
                    showNotification('Code execution cancelled', 'info');
                    return;
                }
            }
            
            clearActiveTerminal();
            appendToTerminal('$ Running code...');
            
            try {
                const data = await apiRequest(`/api/ide/projects/${PROJECT_ID}/execute/`, {
                    method: 'POST',
                    body: JSON.stringify({
                        code: code,
                        file_path: currentFile || 'untitled.py',
                        timeout: 10,
                        inputs: userInputs
                    })
                });
                
                appendToTerminal('$ Execution completed\n');
                
                if (data.output) {
                    appendToTerminal(data.output);
                }
                
                if (data.error) {
                    appendToTerminal(data.error, true);
                }
                
                // Display plots if any
                if (data.plots && data.plots.length > 0) {
                    appendToTerminal(`\n📊 Generated ${data.plots.length} plot(s):\n`);
                    data.plots.forEach((plot, idx) => {
                        // Create image element in terminal
                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${plot.data}`;
                        img.style.maxWidth = '100%';
                        img.style.margin = '10px 0';
                        img.style.border = '2px solid var(--border-color)';
                        img.style.borderRadius = '4px';
                        const terminalOutput = document.querySelector(`#${activeTerminal} .terminal-output`);
                        terminalOutput.appendChild(img);
                    });
                }
                
                appendToTerminal(`\nExecution time: ${data.execution_time.toFixed(2)}ms`, false);
                appendToTerminal(`Return code: ${data.return_code}`, false);
                
                if (data.return_code === 0 && !data.error) {
                    showNotification('Code executed successfully', 'success');
                } else {
                    showNotification('Code execution completed with errors', 'error');
                }
                
            } catch (error) {
                appendToTerminal('Error: ' + error.message, true);
                showNotification('Execution error: ' + error.message, 'error');
            }
        }
        
        function scanForInputCalls(code) {
            // Simple regex to find input() calls with prompts
            const inputRegex = /input\s*\(\s*['"](.*?)['"]\s*\)/g;
            const inputs = [];
            let match;
            
            while ((match = inputRegex.exec(code)) !== null) {
                inputs.push(match[1] || 'Enter input:');
            }
            
            // Also check for input() without prompt
            const simpleInputRegex = /input\s*\(\s*\)/g;
            const simpleMatches = code.match(simpleInputRegex);
            if (simpleMatches) {
                for (let i = 0; i < simpleMatches.length; i++) {
                    inputs.push('Enter input:');
                }
            }
            
            return inputs;
        }
        
        async function promptForInputs(prompts) {
            return new Promise((resolve) => {
                // Create modal for input collection
                const modalHtml = `
                    <div id="input-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                        <div style="background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 8px; width: 90%; max-width: 600px; padding: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
                            <h3 style="margin: 0 0 20px 0; color: var(--text-bright);">Code Requires Input</h3>
                            <p style="margin-bottom: 20px; color: var(--text-secondary);">Your code calls input() ${prompts.length} time(s). Please provide the inputs below:</p>
                            <div id="input-fields-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                                ${prompts.map((prompt, index) => `
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; color: var(--text-bright); font-size: 14px;">${index + 1}. ${prompt}</label>
                                        <input type="text" id="user-input-${index}" class="input-field" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: inherit;" placeholder="Enter value...">
                                    </div>
                                `).join('')}
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button onclick="cancelInputModal()" style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-family: inherit;">CANCEL</button>
                                <button onclick="submitInputs()" style="padding: 10px 20px; background: var(--primary-color); border: none; border-radius: 4px; color: #000; font-weight: bold; cursor: pointer; font-family: inherit;">RUN WITH INPUTS</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Focus first input
                setTimeout(() => {
                    document.getElementById('user-input-0')?.focus();
                }, 100);
                
                // Store resolve function globally so button can call it
                window.resolveInputPrompt = resolve;
            });
        }
        
        function cancelInputModal() {
            document.getElementById('input-modal')?.remove();
            if (window.resolveInputPrompt) {
                window.resolveInputPrompt(null);
                delete window.resolveInputPrompt;
            }
        }
        
        function submitInputs() {
            const inputs = [];
            let index = 0;
            
            while (true) {
                const input = document.getElementById(`user-input-${index}`);
                if (!input) break;
                inputs.push(input.value);
                index++;
            }
            
            document.getElementById('input-modal')?.remove();
            
            if (window.resolveInputPrompt) {
                window.resolveInputPrompt(inputs);
                delete window.resolveInputPrompt;
            }
        }
        
        // UI Functions
        function showProjectModal() {
            document.getElementById('projectModal').classList.add('active');
        }
        
        function showTemplateModal() {
            document.getElementById('templateModal').classList.add('active');
        }
        
        function showPackageModal() {
            document.getElementById('packageModal').classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        async function createFromTemplate(templateType) {
            const projectName = prompt(`Enter project name for ${templateType} template:`);
            if (!projectName) return;
            
            try {
                const response = await fetch('/api/ide/projects/create-from-template/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        name: projectName,
                        template: templateType
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    showNotification(`Project "${projectName}" created successfully!`, 'success');
                    closeModal('templateModal');
                    
                    // Redirect to new project
                    setTimeout(() => {
                        window.location.href = `/ide/?project=${data.project.id}`;
                    }, 1000);
                } else {
                    showNotification(data.message || 'Failed to create project', 'error');
                }
            } catch (error) {
                showNotification('Error creating project: ' + error.message, 'error');
            }
        }
        
        function installPackageFromInput() {
            const packageName = document.getElementById('packageName').value.trim();
            if (!packageName) {
                showNotification('Please enter a package name', 'error');
                return;
            }
            installPackage(packageName);
        }
        
        async function installPackage(packageName) {
            if (!packageName || !packageName.trim()) {
                showNotification('Please enter a package name', 'error');
                return;
            }
            
            showNotification(`Checking ${packageName}...`, 'info');
            
            try {
                const response = await fetch(`/api/ide/projects/${PROJECT_ID}/packages/install/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({ package_name: packageName })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification(data.message || `${packageName} is available!`, 'success');
                    document.getElementById('packageName').value = '';
                } else {
                    showNotification(data.message || `Package ${packageName} not found`, 'error');
                }
            } catch (error) {
                showNotification(`Error checking ${packageName}: ${error.message}`, 'error');
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function refreshFileTree() {
            loadFileTree();
            showNotification('Files refreshed', 'success');
        }
        
        function updateStatusBar() {
            const model = editor.getModel();
            document.getElementById('statusLines').innerHTML = `<span>Lines: ${model.getLineCount()}</span>`;
            
            if (currentFile) {
                const fileName = currentFile.split('/').pop();
                document.getElementById('statusFile').innerHTML = `<span>File:</span><span>${fileName}</span>`;
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S = Save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveCurrentFile();
            }
            
            // Ctrl/Cmd + Enter = Run
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }
            
            // Ctrl/Cmd + F = Search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                showSearchModal();
            }
            
            // Ctrl/Cmd + H = Replace
            if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                e.preventDefault();
                showSearchModal();
                document.getElementById('replaceInput').focus();
            }
            
            // Ctrl/Cmd + Shift + T = New Terminal
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
                e.preventDefault();
                createNewTerminal();
            }
            
            // Escape = Close modal
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
        
        // Modal backdrop click to close
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Search & Replace Functions
        let currentSearchMatches = [];
        let currentMatchIndex = -1;

        function showSearchModal() {
            document.getElementById('searchModal').classList.add('active');
            document.getElementById('searchInput').focus();
        }

        function showShortcutsModal() {
            document.getElementById('shortcutsModal').classList.add('active');
        }

        function findNext() {
            const searchText = document.getElementById('searchInput').value;
            if (!searchText || !editor.getModel()) {
                showNotification('Please enter search text', 'error');
                return;
            }

            const model = editor.getModel();
            const caseSensitive = document.getElementById('caseSensitive').checked;
            const wholeWord = document.getElementById('wholeWord').checked;
            const useRegex = document.getElementById('useRegex').checked;

            // Use Monaco's built-in find functionality
            editor.trigger('search', 'actions.find', {
                searchString: searchText,
                isRegex: useRegex,
                matchCase: caseSensitive,
                matchWholeWord: wholeWord
            });

            // Trigger find next
            editor.trigger('search', 'editor.action.nextMatchFindAction');
        }

        function findPrevious() {
            const searchText = document.getElementById('searchInput').value;
            if (!searchText || !editor.getModel()) {
                showNotification('Please enter search text', 'error');
                return;
            }

            // Use Monaco's built-in find functionality
            editor.trigger('search', 'editor.action.previousMatchFindAction');
        }

        function replaceNext() {
            const replaceText = document.getElementById('replaceInput').value;
            
            if (!editor.getModel()) {
                showNotification('No file open', 'error');
                return;
            }

            // Replace current selection
            const selection = editor.getSelection();
            if (selection && !selection.isEmpty()) {
                editor.executeEdits('replace', [{
                    range: selection,
                    text: replaceText
                }]);
                
                // Find next occurrence
                findNext();
                showNotification('Replaced 1 occurrence', 'success');
            } else {
                findNext();
            }
        }

        function replaceAll() {
            const searchText = document.getElementById('searchInput').value;
            const replaceText = document.getElementById('replaceInput').value;
            
            if (!searchText || !editor.getModel()) {
                showNotification('Please enter search text', 'error');
                return;
            }

            const model = editor.getModel();
            const content = model.getValue();
            const caseSensitive = document.getElementById('caseSensitive').checked;
            const useRegex = document.getElementById('useRegex').checked;
            
            let newContent;
            let count = 0;

            if (useRegex) {
                try {
                    const flags = caseSensitive ? 'g' : 'gi';
                    const regex = new RegExp(searchText, flags);
                    newContent = content.replace(regex, (match) => {
                        count++;
                        return replaceText;
                    });
                } catch (e) {
                    showNotification('Invalid regex pattern', 'error');
                    return;
                }
            } else {
                const searchRegex = new RegExp(
                    searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'),
                    caseSensitive ? 'g' : 'gi'
                );
                newContent = content.replace(searchRegex, (match) => {
                    count++;
                    return replaceText;
                });
            }

            if (count > 0) {
                model.setValue(newContent);
                showNotification(`Replaced ${count} occurrence(s)`, 'success');
            } else {
                showNotification('No matches found', 'info');
            }
        }

        // Template and Package Modal Functions
        function showTemplateModal() {
            document.getElementById('templateModal').classList.add('active');
        }

        function showPackageModal() {
            document.getElementById('packageModal').classList.add('active');
        }

        async function createFromTemplate(templateType) {
            const projectName = prompt('Enter project name:', `${templateType.charAt(0).toUpperCase() + templateType.slice(1)} Project`);
            
            if (!projectName) return;
            
            closeModal('templateModal');
            showNotification('Creating project from template...', 'info');
            
            try {
                const response = await fetch('/api/ide/projects/create-from-template/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        name: projectName,
                        template: templateType
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification(`Project "${projectName}" created successfully!`, 'success');
                    // Reload page to switch to new project
                    setTimeout(() => {
                        window.location.href = '/ide/';
                    }, 1500);
                } else {
                    showNotification(data.message || 'Failed to create project', 'error');
                }
            } catch (error) {
                console.error('Error creating project:', error);
                showNotification('Error creating project', 'error');
            }
        }

        function installPackageFromInput() {
            const packageName = document.getElementById('packageName').value.trim();
            if (packageName) {
                installPackage(packageName);
            }
        }

        function installPackage(packageName) {
            // Simulate package installation
            showNotification(`Package "${packageName}" is available in the cloud environment`, 'success');
            document.getElementById('packageName').value = '';
        }

        // Python Code Intelligence
        function getPythonSuggestions(model, position) {
            const word = model.getWordUntilPosition(position);
            const range = {
                startLineNumber: position.lineNumber,
                endLineNumber: position.lineNumber,
                startColumn: word.startColumn,
                endColumn: word.endColumn
            };

            // Python built-in functions and keywords
            const pythonKeywords = [
                { label: 'print', kind: monaco.languages.CompletionItemKind.Function, insertText: 'print(${1:value})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Print to console' },
                { label: 'input', kind: monaco.languages.CompletionItemKind.Function, insertText: 'input(${1:prompt})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Get user input' },
                { label: 'len', kind: monaco.languages.CompletionItemKind.Function, insertText: 'len(${1:obj})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Return length of object' },
                { label: 'range', kind: monaco.languages.CompletionItemKind.Function, insertText: 'range(${1:stop})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Create range object' },
                { label: 'str', kind: monaco.languages.CompletionItemKind.Class, insertText: 'str(${1:obj})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Convert to string' },
                { label: 'int', kind: monaco.languages.CompletionItemKind.Class, insertText: 'int(${1:value})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Convert to integer' },
                { label: 'float', kind: monaco.languages.CompletionItemKind.Class, insertText: 'float(${1:value})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Convert to float' },
                { label: 'list', kind: monaco.languages.CompletionItemKind.Class, insertText: 'list(${1:iterable})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Create list' },
                { label: 'dict', kind: monaco.languages.CompletionItemKind.Class, insertText: 'dict()', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Create dictionary' },
                { label: 'set', kind: monaco.languages.CompletionItemKind.Class, insertText: 'set()', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Create set' },
                { label: 'tuple', kind: monaco.languages.CompletionItemKind.Class, insertText: 'tuple(${1:iterable})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Create tuple' },
                { label: 'open', kind: monaco.languages.CompletionItemKind.Function, insertText: 'open(${1:file}, ${2:mode})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Open file' },
                { label: 'isinstance', kind: monaco.languages.CompletionItemKind.Function, insertText: 'isinstance(${1:obj}, ${2:type})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Check instance type' },
                { label: 'enumerate', kind: monaco.languages.CompletionItemKind.Function, insertText: 'enumerate(${1:iterable})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Enumerate items' },
                { label: 'zip', kind: monaco.languages.CompletionItemKind.Function, insertText: 'zip(${1:iter1}, ${2:iter2})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Zip iterables' },
                { label: 'sum', kind: monaco.languages.CompletionItemKind.Function, insertText: 'sum(${1:iterable})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Sum of items' },
                { label: 'max', kind: monaco.languages.CompletionItemKind.Function, insertText: 'max(${1:iterable})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Maximum value' },
                { label: 'min', kind: monaco.languages.CompletionItemKind.Function, insertText: 'min(${1:iterable})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Minimum value' },
                
                // Code snippets
                { label: 'def', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'def ${1:function_name}(${2:params}):\n    ${3:pass}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Function definition' },
                { label: 'class', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'class ${1:ClassName}:\n    def __init__(self${2:, params}):\n        ${3:pass}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Class definition' },
                { label: 'if', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'if ${1:condition}:\n    ${2:pass}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'If statement' },
                { label: 'for', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'for ${1:item} in ${2:iterable}:\n    ${3:pass}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'For loop' },
                { label: 'while', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'while ${1:condition}:\n    ${2:pass}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'While loop' },
                { label: 'try', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'try:\n    ${1:pass}\nexcept ${2:Exception} as ${3:e}:\n    ${4:pass}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Try-except block' },
                { label: 'with', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'with ${1:expression} as ${2:variable}:\n    ${3:pass}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'With statement' },
                { label: 'lambda', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'lambda ${1:x}: ${2:x}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Lambda function' },
                { label: 'main', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'if __name__ == "__main__":\n    ${1:main()}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation: 'Main guard' },
            ];

            return pythonKeywords.map(item => ({
                ...item,
                range: range
            }));
        }

        function formatCode() {
            if (!editor.getModel()) {
                showNotification('No file open', 'error');
                return;
            }
            
            // Trigger Monaco's built-in formatter
            editor.getAction('editor.action.formatDocument').run();
            showNotification('Code formatted', 'success');
        }

        // File Upload/Download Functions
        function triggerFileUpload() {
            document.getElementById('fileUploadInput').click();
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            try {
                const response = await fetch(`/api/ide/projects/${PROJECT_ID}/upload/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    showNotification(`Uploaded ${files.length} file(s) successfully`, 'success');
                    loadFileTree();
                } else {
                    showNotification(data.message || 'Upload failed', 'error');
                }
            } catch (error) {
                showNotification('Upload error: ' + error.message, 'error');
            }

            // Reset input
            event.target.value = '';
        }

        async function downloadProject() {
            try {
                showNotification('Preparing download...', 'info');
                const response = await fetch(`/api/ide/projects/${PROJECT_ID}/download/`, {
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `project-${PROJECT_ID}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showNotification('Project downloaded successfully', 'success');
                } else {
                    const data = await response.json();
                    showNotification(data.message || 'Download failed', 'error');
                }
            } catch (error) {
                showNotification('Download error: ' + error.message, 'error');
            }
        }

        async function downloadFile(filePath) {
            if (!filePath) return;

            try {
                const response = await fetch(`/api/ide/projects/${PROJECT_ID}/file/download/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({ file_path: filePath })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filePath.split('/').pop();
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showNotification('File downloaded', 'success');
                } else {
                    const data = await response.json();
                    showNotification(data.message || 'Download failed', 'error');
                }
            } catch (error) {
                showNotification('Download error: ' + error.message, 'error');
            }
            closeContextMenu();
        }

        // Context Menu Functions
        let contextMenuTarget = null;
        let contextMenuType = null;

        function showContextMenu(event, filePath, type) {
            event.preventDefault();
            event.stopPropagation();
            
            contextMenuTarget = filePath;
            contextMenuType = type;
            
            const menu = document.getElementById('contextMenu');
            menu.innerHTML = ''; // Clear existing items
            
            // Build menu based on type
            if (type === 'file') {
                menu.innerHTML = `
                    <div class="context-menu-item" onclick="copyFileContents()">
                        <span>Copy Contents</span>
                    </div>
                    <div class="context-menu-item" onclick="renameItem()">
                        <span>Rename</span>
                    </div>
                    <div class="context-menu-item" onclick="downloadFile()">
                        <span>Download</span>
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" style="color: #ff4444;" onclick="deleteItem()">
                        <span>Delete</span>
                    </div>
                `;
            } else if (type === 'directory') {
                menu.innerHTML = `
                    <div class="context-menu-item" onclick="showNewFileDialog()">
                        <span>New File</span>
                    </div>
                    <div class="context-menu-item" onclick="showNewFolderDialog()">
                        <span>New Folder</span>
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" onclick="renameItem()">
                        <span>Rename</span>
                    </div>
                    <div class="context-menu-item" style="color: #ff4444;" onclick="deleteItem()">
                        <span>Delete</span>
                    </div>
                `;
            }
            
            // Position menu at mouse coordinates
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('active');
        }

        function closeContextMenu() {
            const menu = document.getElementById('contextMenu');
            menu.classList.remove('active');
            contextMenuTarget = null;
            contextMenuType = null;
        }

        // Close context menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.file-context-menu')) {
                closeContextMenu();
            }
        });

        // Add context menu to file tree empty space
        document.addEventListener('DOMContentLoaded', () => {
            const fileTree = document.getElementById('fileTree');
            
            fileTree.addEventListener('contextmenu', (e) => {
                // Show context menu on empty space (not on file/folder nodes)
                // Check if the click is on fileTree or its direct children that aren't file nodes
                const isFileNode = e.target.closest('.file-node');
                
                if (!isFileNode) {
                    e.preventDefault();
                    
                    const menu = document.getElementById('contextMenu');
                    menu.innerHTML = `
                        <div class="context-menu-item" onclick="showNewFileDialog()">
                            <span>📄 New File</span>
                        </div>
                        <div class="context-menu-item" onclick="showNewFolderDialog()">
                            <span>📁 New Folder</span>
                        </div>
                    `;
                    
                    menu.style.left = e.pageX + 'px';
                    menu.style.top = e.pageY + 'px';
                    menu.classList.add('active');
                    
                    contextMenuTarget = null;
                    contextMenuType = 'empty';
                }
            });
        });

        // Context Menu Actions
        async function copyFileContents() {
            closeContextMenu();
            if (!contextMenuTarget) return;
            
            try {
                const response = await fetch(`/api/ide/file/${PROJECT_ID}/?path=${encodeURIComponent(contextMenuTarget)}`);
                const data = await response.json();
                
                if (data.success) {
                    await navigator.clipboard.writeText(data.content);
                    showNotification('File contents copied to clipboard!', 'success');
                } else {
                    showNotification('Failed to copy file contents', 'error');
                }
            } catch (error) {
                console.error('Error copying file:', error);
                showNotification('Error copying file contents', 'error');
            }
        }

        async function renameItem() {
            closeContextMenu();
            if (!contextMenuTarget) return;
            
            const currentName = contextMenuTarget.split('/').pop();
            const newName = prompt(`Rename ${contextMenuType}:`, currentName);
            
            if (!newName || newName === currentName) return;
            
            try {
                const response = await fetch(`/api/ide/projects/${PROJECT_ID}/files/rename/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        old_path: contextMenuTarget,
                        new_name: newName,
                        type: contextMenuType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`${contextMenuType} renamed successfully!`, 'success');
                    await loadFileTree();
                    // If the renamed item was open, close it and open with new name
                    if (currentFile === contextMenuTarget) {
                        await openFile(data.new_path);
                    }
                } else {
                    showNotification(data.error || 'Failed to rename', 'error');
                }
            } catch (error) {
                console.error('Error renaming:', error);
                showNotification('Error renaming item', 'error');
            }
        }

        async function deleteItem() {
            closeContextMenu();
            if (!contextMenuTarget) return;
            
            if (!confirm(`Are you sure you want to delete this ${contextMenuType}?`)) return;
            
            try {
                const response = await fetch(`/api/ide/delete/${PROJECT_ID}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        path: contextMenuTarget,
                        type: contextMenuType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`${contextMenuType} deleted successfully!`, 'success');
                    await loadFileTree();
                    
                    // Close tab if it's the current file
                    if (contextMenuType === 'file' && currentFile === contextMenuTarget) {
                        closeTab(contextMenuTarget);
                    }
                } else {
                    showNotification(data.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                console.error('Error deleting:', error);
                showNotification('Error deleting item', 'error');
            }
        }

        function showNewFileDialog() {
            closeContextMenu();
            showInlineInput('file');
        }

        function showNewFolderDialog() {
            closeContextMenu();
            showInlineInput('folder');
        }
        
        function showInlineInput(type) {
            // Remove any existing inline input
            const existing = document.querySelector('.inline-input-container');
            if (existing) existing.remove();
            
            // Determine where to insert the input
            const basePath = contextMenuTarget || '';
            const container = document.getElementById('fileTree');
            
            // Calculate indentation level
            let level = 0;
            if (basePath) {
                level = basePath.split('/').length;
            }
            
            // Create inline input element
            const inputContainer = document.createElement('div');
            inputContainer.className = 'inline-input-container tree-node';
            inputContainer.style.paddingLeft = (level * 20 + 10) + 'px';
            inputContainer.style.background = 'var(--bg-secondary)';
            inputContainer.style.borderLeft = '2px solid var(--primary-color)';
            
            const icon = type === 'folder' ? '▶' : '●';
            inputContainer.innerHTML = `
                <span class="tree-node-icon">${icon}</span>
                <input type="text" id="inline-name-input" 
                       style="background: transparent; border: none; color: var(--text-primary); outline: none; font-family: inherit; flex: 1; padding: 2px;" 
                       placeholder="${type === 'folder' ? 'Folder name' : 'File name'}"
                       autocomplete="off">
            `;
            
            // Insert at the correct position
            if (basePath && type === 'folder') {
                // Insert after the parent folder
                const parentNode = container.querySelector(`[data-path="${basePath}"]`);
                if (parentNode && parentNode.nextSibling) {
                    parentNode.parentNode.insertBefore(inputContainer, parentNode.nextSibling);
                } else if (parentNode) {
                    parentNode.parentNode.appendChild(inputContainer);
                } else {
                    container.insertBefore(inputContainer, container.firstChild);
                }
            } else {
                // Insert at the top for root level items
                container.insertBefore(inputContainer, container.firstChild);
            }
            
            const input = document.getElementById('inline-name-input');
            input.focus();
            
            // Handle input submission
            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const name = input.value.trim();
                    
                    if (!name) {
                        inputContainer.remove();
                        return;
                    }
                    
                    // Validate name
                    if (name.includes('/') || name.includes('\\')) {
                        showNotification('Invalid name: cannot contain / or \\', 'error');
                        return;
                    }
                    
                    inputContainer.remove();
                    
                    if (type === 'file') {
                        await createNewFile(name);
                    } else {
                        await createNewFolder(name);
                    }
                } else if (e.key === 'Escape') {
                    inputContainer.remove();
                }
            });
            
            // Remove on blur
            input.addEventListener('blur', () => {
                setTimeout(() => inputContainer.remove(), 200);
            });
        }

        async function createNewFile(fileName) {
            try {
                const basePath = contextMenuTarget || '';
                const fullPath = basePath ? `${basePath}/${fileName}` : fileName;
                
                const response = await fetch(`/api/ide/file/${PROJECT_ID}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        path: fullPath,
                        content: ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('File created successfully!', 'success');
                    await loadFileTree();
                    openFile(fullPath);
                } else {
                    showNotification(data.error || 'Failed to create file', 'error');
                }
            } catch (error) {
                console.error('Error creating file:', error);
                showNotification('Error creating file', 'error');
            }
        }

        async function createNewFolder(folderName) {
            try {
                const basePath = contextMenuTarget || '';
                const fullPath = basePath ? `${basePath}/${folderName}` : folderName;
                
                const response = await fetch(`/api/ide/projects/${PROJECT_ID}/directories/create/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        path: fullPath
                    })
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Server returned non-JSON response');
                }
                
                const data = await response.json();
                
                if (data.status === 'success' || data.success) {
                    showNotification('Folder created successfully!', 'success');
                    await loadFileTree();
                } else {
                    showNotification(data.message || data.error || 'Failed to create folder', 'error');
                }
            } catch (error) {
                console.error('Error creating folder:', error);
                showNotification(`Error creating folder: ${error.message}`, 'error');
            }
        }

        async function downloadFile() {
            closeContextMenu();
            if (!contextMenuTarget) return;
            
            try {
                const response = await fetch(`/api/ide/file/${PROJECT_ID}/?path=${encodeURIComponent(contextMenuTarget)}`);
                const data = await response.json();
                
                if (data.success) {
                    const blob = new Blob([data.content], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = contextMenuTarget.split('/').pop();
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showNotification('File downloaded!', 'success');
                } else {
                    showNotification('Failed to download file', 'error');
                }
            } catch (error) {
                console.error('Error downloading file:', error);
                showNotification('Error downloading file', 'error');
            }
        }

        // Drag and Drop Support
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.querySelector('.sidebar');
            
            sidebar.addEventListener('dragover', (e) => {
                e.preventDefault();
                sidebar.style.background = 'rgba(0, 255, 136, 0.1)';
            });

            sidebar.addEventListener('dragleave', () => {
                sidebar.style.background = '';
            });

            sidebar.addEventListener('drop', async (e) => {
                e.preventDefault();
                sidebar.style.background = '';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const input = document.getElementById('fileUploadInput');
                    input.files = files;
                    await handleFileUpload({ target: input });
                }
            });
        });
    </script>

    <!-- Context Menu -->
    <div class="file-context-menu" id="contextMenu">
        <!-- Context menu items will be dynamically populated -->
    </div>

</body>
</html>
