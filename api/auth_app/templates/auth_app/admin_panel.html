<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN PANEL</title>
    {% load static %}
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #000; color: #fff; min-height: 100vh; overflow-x: hidden; }
        
        .grid-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px); background-size: 50px 50px; animation: gridMove 60s linear infinite; z-index: 0; }
        
        @keyframes gridMove { 0% { background-position: 0 0; } 100% { background-position: 50px 50px; } }
        
        .container { position: relative; z-index: 1; width: 100%; max-width: 1800px; margin: 0 auto; padding: 40px 30px; }
        
        .header { background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); color: #fff; padding: 40px 50px; border: 3px solid #333; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1) inset; position: relative; overflow: hidden; }
        
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, #fff, transparent); animation: shimmer 3s infinite; }
        
        @keyframes shimmer { 0%, 100% { opacity: 0; } 50% { opacity: 0.3; } }
        
        .header h1 { font-size: 2.8rem; font-weight: bold; letter-spacing: 10px; text-align: center; text-transform: uppercase; background: linear-gradient(135deg, #fff 0%, #999 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        .header p { text-align: center; margin-top: 12px; font-size: 0.95rem; letter-spacing: 4px; color: #666; text-transform: uppercase; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .stat { background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); border: 2px solid #222; border-radius: 10px; padding: 30px 25px; text-align: center; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); position: relative; overflow: hidden; }
        
        .stat::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%); opacity: 0; transition: opacity 0.4s; }
        
        .stat:hover { transform: translateY(-5px); border-color: #444; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4); }
        
        .stat:hover::before { opacity: 1; }
        
        .stat-label { font-size: 0.8rem; letter-spacing: 3px; text-transform: uppercase; color: #777; margin-bottom: 12px; position: relative; z-index: 1; }
        
        .stat-value { font-size: 3rem; font-weight: bold; letter-spacing: 4px; color: #fff; position: relative; z-index: 1; text-shadow: 0 0 20px rgba(255, 255, 255, 0.3); }
        
        .table-wrapper { background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); border: 2px solid #222; border-radius: 10px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); overflow: hidden; }
        
        .table-title { background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); color: #fff; padding: 25px 35px; font-size: 1.4rem; font-weight: bold; letter-spacing: 6px; text-transform: uppercase; border-bottom: 2px solid #222; }
        
        .table-scroll { max-height: 600px; overflow: auto; }
        
        .table-scroll::-webkit-scrollbar { width: 12px; height: 12px; }
        .table-scroll::-webkit-scrollbar-track { background: #0a0a0a; }
        .table-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 6px; border: 2px solid #0a0a0a; }
        .table-scroll::-webkit-scrollbar-thumb:hover { background: #444; }
        
        table { width: 100%; border-collapse: collapse; }
        
        thead { position: sticky; top: 0; z-index: 10; }
        
        th { background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); color: #aaa; padding: 18px 25px; text-align: left; font-size: 0.85rem; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; border-bottom: 2px solid #222; }
        
        tbody tr { border-bottom: 1px solid #1a1a1a; transition: all 0.3s ease; }
        
        tbody tr:hover { background: linear-gradient(90deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%); }
        
        td { padding: 20px 25px; font-size: 0.95rem; letter-spacing: 0.5px; color: #ccc; }
        
        .id { color: #666; font-size: 0.85rem; }
        .name { font-weight: bold; color: #fff; }
        .admin-badge { display: inline-block; padding: 4px 10px; background: linear-gradient(135deg, #333 0%, #1a1a1a 100%); color: #fff; font-size: 0.7rem; font-weight: bold; letter-spacing: 1.5px; margin-left: 12px; border: 1px solid #444; border-radius: 4px; }
        .email { color: #999; font-size: 0.9rem; }
        
        .badge { display: inline-block; padding: 8px 16px; border: 2px solid; font-size: 0.8rem; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; border-radius: 6px; }
        .badge-paid { color: #fff; border-color: #fff; background: rgba(255, 255, 255, 0.05); box-shadow: 0 0 20px rgba(255, 255, 255, 0.2); }
        .badge-free { color: #555; border-color: #333; background: rgba(0, 0, 0, 0.3); }
        
        .toggle-wrapper { display: flex; align-items: center; gap: 15px; }
        
        .switch { position: relative; width: 70px; height: 36px; cursor: pointer; }
        .switch input { display: none; }
        .switch-track { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #0a0a0a; border: 2px solid #333; border-radius: 18px; transition: all 0.3s; }
        .switch-track::before { content: ''; position: absolute; height: 24px; width: 24px; left: 4px; bottom: 4px; background: #333; border-radius: 50%; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5); }
        .switch input:checked + .switch-track { background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); border-color: #666; }
        .switch input:checked + .switch-track::before { transform: translateX(34px); background: #fff; box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
        
        .switch-label { font-size: 0.9rem; font-weight: bold; letter-spacing: 2px; color: #555; min-width: 60px; transition: all 0.3s; }
        .switch-label.on { color: #fff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
        
        .loading { opacity: 0.4; pointer-events: none; }
        
        .empty { text-align: center; padding: 80px 30px; color: #444; }
        .empty-icon { font-size: 5rem; margin-bottom: 20px; opacity: 0.3; }
        .empty-text { font-size: 1.5rem; letter-spacing: 3px; text-transform: uppercase; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .header { animation: fadeIn 0.5s ease; }
        .stat:nth-child(1) { animation: fadeIn 0.6s ease; }
        .stat:nth-child(2) { animation: fadeIn 0.7s ease; }
        .stat:nth-child(3) { animation: fadeIn 0.8s ease; }
        .stat:nth-child(4) { animation: fadeIn 0.9s ease; }
        .table-wrapper { animation: fadeIn 1s ease; }
        
        @media (max-width: 768px) {
            .container { padding: 20px 15px; }
            .header h1 { font-size: 2rem; letter-spacing: 6px; }
            .stat-value { font-size: 2.5rem; }
            th, td { padding: 12px 15px; font-size: 0.85rem; }
            .switch { width: 60px; height: 32px; }
            .switch input:checked + .switch-track::before { transform: translateX(28px); }
        }
    </style>
</head>
<body>
    <div class="grid-bg"></div>
    <div class="container">
        <div class="header">
            <h1>◢ ADMIN PANEL ◣</h1>
            <p>User Management System</p>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" id="total">{{ users|length }}</div>
            </div>
            <div class="stat">
                <div class="stat-label">Paid Users</div>
                <div class="stat-value" id="paid">{{ paid_users_count }}</div>
            </div>
            <div class="stat">
                <div class="stat-label">Free Users</div>
                <div class="stat-value" id="free">{{ free_users_count }}</div>
            </div>
            <div class="stat">
                <div class="stat-label">Superusers</div>
                <div class="stat-value" id="super">{{ superusers_count }}</div>
            </div>
        </div>
        
        <div class="table-wrapper">
            <div class="table-title">▸ USER DATABASE</div>
            <div class="table-scroll">
                {% if users %}
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Paid user</th>
                            <th>Control</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr id="row-{{ user.id }}">
                            <td class="id">#{{ user.id }}</td>
                            <td class="name">
                                {{ user.username }}
                                {% if user.is_superuser %}<span class="admin-badge">ADMIN</span>{% endif %}
                            </td>
                            <td class="email">{{ user.email }}</td>
                            <td>
                                <span class="badge {% if user.profile.paidUser %}badge-paid{% else %}badge-free{% endif %}" id="badge-{{ user.id }}">
                                    {% if user.profile.paidUser %}● PAID{% else %}○ FREE{% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="toggle-wrapper">
                                    <label class="switch">
                                        <input type="checkbox" {% if user.profile.paidUser %}checked{% endif %} onchange="toggle({{ user.id }}, this)">
                                        <span class="switch-track"></span>
                                    </label>
                                    <span class="switch-label {% if user.profile.paidUser %}on{% endif %}" id="label-{{ user.id }}">
                                        {% if user.profile.paidUser %}ON{% else %}OFF{% endif %}
                                    </span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty">
                    <div class="empty-icon">◢◤</div>
                    <div class="empty-text">No Users Found</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <script>
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Main toggle function with improved error handling
        async function toggle(userId, checkbox) {
            const row = document.getElementById('row-' + userId);
            const badge = document.getElementById('badge-' + userId);
            const label = document.getElementById('label-' + userId);
            
            // Store original state
            const originalState = checkbox.checked;
            
            // Add loading state
            row.classList.add('loading');
            
            try {
                const csrftoken = getCookie('csrftoken');
                
                if (!csrftoken) {
                    throw new Error('CSRF token not found. Please refresh the page.');
                }
                
                console.log('Sending request to update user', userId, 'to', originalState);
                
                const response = await fetch('/auth/api/update-paid-status/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        paid_status: originalState
                    }),
                    credentials: 'same-origin'
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    // Update UI to reflect new state
                    updateUserUI(userId, originalState);
                    updateStats();
                    
                    // Visual feedback
                    row.style.background = 'rgba(255, 255, 255, 0.1)';
                    setTimeout(() => { 
                        row.style.background = ''; 
                    }, 300);
                    
                    console.log('Successfully updated user', userId, 'paid status to', originalState);
                } else {
                    // Revert checkbox if server says it failed
                    checkbox.checked = !originalState;
                    throw new Error(data.error || 'Failed to update user status');
                }
                
            } catch (error) {
                console.error('Error updating paid status:', error);
                // Revert checkbox on error
                checkbox.checked = !originalState;
                alert(`Error: ${error.message}\n\nPlease try again or refresh the page.`);
            } finally {
                row.classList.remove('loading');
            }
        }
        
        // Update UI elements for a user
        function updateUserUI(userId, isPaid) {
            const badge = document.getElementById('badge-' + userId);
            const label = document.getElementById('label-' + userId);
            
            if (isPaid) {
                label.textContent = 'ON';
                label.classList.add('on');
                badge.className = 'badge badge-paid';
                badge.innerHTML = '● PAID';
            } else {
                label.textContent = 'OFF';
                label.classList.remove('on');
                badge.className = 'badge badge-free';
                badge.innerHTML = '○ FREE';
            }
        }
        
        // Update statistics counters
        function updateStats() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            let paidCount = 0;
            let freeCount = 0;
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    paidCount++;
                } else {
                    freeCount++;
                }
            });
            
            document.getElementById('paid').textContent = paidCount;
            document.getElementById('free').textContent = freeCount;
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin panel loaded');
            console.log('CSRF token present:', !!getCookie('csrftoken'));
        });
    </script>
</body>
</html>
