{% extends "auth_app/base.html" %}

{% block title %}Account - YTHON{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
    }
    
    body {
        font-family: 'Press Start 2P', cursive;
        background: #000;
        color: #0f0;
        overflow-x: hidden;
    }
    
    /* Pixelated Grid Background */
    .pixel-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        background-image:
            repeating-linear-gradient(0deg, transparent, transparent 19px, #0a0a0a 19px, #0a0a0a 20px),
            repeating-linear-gradient(90deg, transparent, transparent 19px, #0a0a0a 19px, #0a0a0a 20px);
        background-size: 20px 20px;
        z-index: 0;
        animation: gridScroll 20s linear infinite;
    }
    
    @keyframes gridScroll {
        0% { background-position: 0 0; }
        100% { background-position: 20px 20px; }
    }
    
    /* Scanlines Effect */
    .scanlines {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 999;
        background: repeating-linear-gradient(
            0deg,
            transparent,
            transparent 2px,
            rgba(0, 255, 0, 0.03) 2px,
            rgba(0, 255, 0, 0.03) 4px
        );
        animation: scanline 10s linear infinite;
    }
    
    @keyframes scanline {
        0% { transform: translateY(0); }
        100% { transform: translateY(10px); }
    }
    
    .container {
        position: relative;
        z-index: 1;
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 20px;
    }
    
    /* Pixel Border Box */
    .pixel-box {
        background: #000;
        border: 4px solid #0f0;
        box-shadow: 
            0 0 0 4px #000,
            0 0 0 8px #0f0,
            0 0 20px #0f0;
        padding: 30px;
        margin-bottom: 30px;
        position: relative;
    }
    
    .pixel-box::before {
        content: '';
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        background: linear-gradient(45deg, transparent 48%, #0f0 48%, #0f0 52%, transparent 52%);
        background-size: 8px 8px;
        pointer-events: none;
        opacity: 0.3;
    }
    
    /* Header */
    .pixel-header {
        text-align: center;
        margin-bottom: 40px;
    }
    
    .pixel-header h1 {
        font-size: 2rem;
        color: #0f0;
        text-shadow: 
            3px 3px 0 #000,
            4px 4px 0 #0f0;
        animation: glitch 5s infinite;
        margin-bottom: 15px;
    }
    
    @keyframes glitch {
        0%, 90%, 100% {
            text-shadow: 3px 3px 0 #000, 4px 4px 0 #0f0;
        }
        95% {
            text-shadow: -2px -2px 0 #f0f, 3px 3px 0 #0ff;
        }
    }
    
    .pixel-badge {
        display: inline-block;
        padding: 8px 16px;
        background: #000;
        border: 3px solid #0f0;
        color: #0f0;
        font-size: 0.6rem;
        margin-top: 10px;
        box-shadow: 0 0 10px #0f0;
        animation: blink 1s infinite;
    }
    
    @keyframes blink {
        0%, 50%, 100% { opacity: 1; }
        25%, 75% { opacity: 0.7; }
    }
    
    .premium-badge {
        border-color: #ff0;
        color: #ff0;
        box-shadow: 0 0 15px #ff0;
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: #000;
        border: 3px solid #0f0;
        padding: 20px;
        text-align: center;
        position: relative;
        transition: all 0.3s;
    }
    
    .stat-card:hover {
        border-color: #ff0;
        box-shadow: 0 0 20px #ff0;
        transform: scale(1.05);
    }
    
    .stat-label {
        font-size: 0.6rem;
        color: #0a0;
        margin-bottom: 10px;
    }
    
    .stat-value {
        font-size: 1.5rem;
        color: #0f0;
        text-shadow: 2px 2px 0 #000;
    }
    
    /* Settings Section */
    .settings-section {
        margin-bottom: 30px;
    }
    
    .settings-section h2 {
        font-size: 1.2rem;
        color: #0f0;
        margin-bottom: 20px;
        text-shadow: 2px 2px 0 #000;
        border-bottom: 3px solid #0f0;
        padding-bottom: 10px;
    }
    
    .setting-item {
        background: #000;
        border: 2px solid #0a0;
        padding: 20px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s;
    }
    
    .setting-item:hover {
        border-color: #0f0;
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
    }
    
    .setting-info h3 {
        font-size: 0.8rem;
        color: #0f0;
        margin-bottom: 8px;
    }
    
    .setting-info p {
        font-size: 0.6rem;
        color: #0a0;
        line-height: 1.5;
    }
    
    /* Pixel Button */
    .pixel-btn {
        font-family: 'Press Start 2P', cursive;
        font-size: 0.7rem;
        padding: 12px 24px;
        background: #000;
        color: #0f0;
        border: 3px solid #0f0;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        position: relative;
        overflow: hidden;
    }
    
    .pixel-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: #0f0;
        transition: left 0.3s;
        z-index: -1;
    }
    
    .pixel-btn:hover::before {
        left: 0;
    }
    
    .pixel-btn:hover {
        color: #000;
        box-shadow: 0 0 20px #0f0;
    }
    
    .pixel-btn.danger {
        border-color: #f00;
        color: #f00;
    }
    
    .pixel-btn.danger::before {
        background: #f00;
    }
    
    .pixel-btn.danger:hover {
        box-shadow: 0 0 20px #f00;
    }
    
    .pixel-btn:disabled {
        opacity: 0.3;
        cursor: not-started;
    }
    
    /* Toggle Switch Pixel Style */
    .pixel-toggle {
        width: 80px;
        height: 40px;
        background: #000;
        border: 3px solid #0a0;
        position: relative;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .pixel-toggle.active {
        border-color: #0f0;
        box-shadow: 0 0 15px #0f0;
    }
    
    .pixel-toggle-slider {
        position: absolute;
        width: 30px;
        height: 30px;
        background: #0a0;
        border: 2px solid #0f0;
        top: 2px;
        left: 2px;
        transition: all 0.3s;
    }
    
    .pixel-toggle.active .pixel-toggle-slider {
        left: 42px;
        background: #0f0;
        box-shadow: 0 0 10px #0f0;
    }
    
    /* Theme Selector */
    .theme-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .theme-card {
        background: #000;
        border: 2px solid #0a0;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
    }
    
    .theme-card:hover {
        border-color: #0f0;
        transform: scale(1.05);
    }
    
    .theme-card.active {
        border-color: #ff0;
        box-shadow: 0 0 20px #ff0;
    }
    
    .theme-preview {
        width: 100%;
        height: 60px;
        margin-bottom: 10px;
        border: 2px solid #0a0;
    }
    
    .theme-name {
        font-size: 0.6rem;
        color: #0f0;
    }
    
    /* 2FA Section */
    .twofa-status {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .status-indicator {
        width: 20px;
        height: 20px;
        background: #f00;
        border: 2px solid #f00;
        box-shadow: 0 0 10px #f00;
    }
    
    .status-indicator.active {
        background: #0f0;
        border-color: #0f0;
        box-shadow: 0 0 10px #0f0;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    /* QR Code Modal */
    .pixel-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .pixel-modal.show {
        display: flex;
    }
    
    .modal-content {
        background: #000;
        border: 4px solid #0f0;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 0 30px #0f0;
    }
    
    .modal-header {
        font-size: 1rem;
        color: #0f0;
        margin-bottom: 20px;
        text-align: center;
        text-shadow: 2px 2px 0 #000;
    }
    
    .qr-container {
        background: #fff;
        padding: 20px;
        text-align: center;
        margin: 20px 0;
        border: 3px solid #0f0;
    }
    
    .backup-codes {
        background: #000;
        border: 2px solid #0a0;
        padding: 15px;
        margin: 15px 0;
        font-size: 0.6rem;
        color: #0f0;
        font-family: 'Press Start 2P', cursive;
        line-height: 2;
    }
    
    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }
    
    /* Password Change Section */
    .password-form {
        background: #000;
        border: 2px solid #0a0;
        padding: 20px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        font-size: 0.6rem;
        color: #0f0;
        margin-bottom: 8px;
    }
    
    .form-group input {
        width: 100%;
        padding: 12px;
        background: #000;
        border: 2px solid #0a0;
        color: #0f0;
        font-family: 'Press Start 2P', cursive;
        font-size: 0.6rem;
        transition: all 0.3s;
    }
    
    .form-group input:focus {
        outline: none;
        border-color: #0f0;
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
    }
    
    /* Loading Animation */
    .pixel-loader {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #0a0;
        border-top-color: #0f0;
        animation: pixelSpin 1s steps(8) infinite;
    }
    
    @keyframes pixelSpin {
        to { transform: rotate(360deg); }
    }
    
    /* Notification */
    .pixel-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #000;
        border: 3px solid #0f0;
        padding: 20px;
        font-size: 0.7rem;
        color: #0f0;
        box-shadow: 0 0 20px #0f0;
        z-index: 2000;
        animation: slideIn 0.5s, slideOut 0.5s 4.5s;
    }
    
    @keyframes slideIn {
        from { transform: translateX(400px); }
        to { transform: translateX(0); }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); }
        to { transform: translateX(400px); }
    }
    
    .pixel-notification.error {
        border-color: #f00;
        box-shadow: 0 0 20px #f00;
        color: #f00;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .pixel-header h1 {
            font-size: 1.2rem;
        }
        
        .pixel-box {
            padding: 20px;
        }
        
        .setting-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .theme-grid {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
    }
</style>

<div class="pixel-bg"></div>
<div class="scanlines"></div>

<div class="container">
    <!-- Header -->
    <div class="pixel-box pixel-header">
        <h1>🎮 PLAYER PROFILE 🎮</h1>
        <div>
            <span style="color: #0f0; font-size: 0.8rem;">USERNAME: {{ user.username|upper }}</span>
            {% if user.profile.paidUser %}
                <div class="pixel-badge premium-badge">⭐ PREMIUM PLAYER ⭐</div>
            {% else %}
                <div class="pixel-badge">FREE PLAYER</div>
            {% endif %}
        </div>
    </div>
    
    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">PLAYER ID</div>
            <div class="stat-value">{{ user.id }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">JOINED</div>
            <div class="stat-value" style="font-size: 0.7rem;">{{ user.date_joined|date:"Y-m-d" }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">STATUS</div>
            <div class="stat-value">ACTIVE</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">THEME</div>
            <div class="stat-value" style="font-size: 0.7rem;">{{ user.profile.theme|upper }}</div>
        </div>
    </div>
    
    <!-- Two-Factor Authentication -->
    <div class="pixel-box settings-section">
        <h2>🔐 TWO-FACTOR AUTH</h2>
        <div class="setting-item">
            <div class="setting-info">
                <h3>2FA SECURITY</h3>
                <p>Add an extra layer of security to your account with TOTP authentication</p>
                <div class="twofa-status" style="margin-top: 10px;">
                    <div class="status-indicator {% if user.two_factor.is_enabled %}active{% endif %}"></div>
                    <span style="font-size: 0.6rem; color: #0f0;">
                        {% if user.two_factor.is_enabled %}ENABLED{% else %}DISABLED{% endif %}
                    </span>
                </div>
            </div>
            <div>
                {% if user.two_factor.is_enabled %}
                    <button class="pixel-btn danger" onclick="disable2FA()">DISABLE</button>
                {% else %}
                    <button class="pixel-btn" onclick="enable2FA()">ENABLE</button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Theme Settings -->
    <div class="pixel-box settings-section">
        <h2>🎨 THEME SELECTION</h2>
        <div class="theme-grid">
            <div class="theme-card {% if user.profile.theme == 'default' %}active{% endif %}" onclick="changeTheme('default')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #0f0 0%, #0a0 100%);"></div>
                <div class="theme-name">DEFAULT</div>
            </div>
            <div class="theme-card {% if user.profile.theme == 'greydom' %}active{% endif %}" onclick="changeTheme('greydom')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #666 0%, #333 100%);"></div>
                <div class="theme-name">GREYDOM</div>
            </div>
            <div class="theme-card {% if user.profile.theme == 'cloud' %}active{% endif %}" onclick="changeTheme('cloud')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #fff 0%, #ccc 100%);"></div>
                <div class="theme-name">CLOUD</div>
            </div>
            <div class="theme-card {% if user.profile.theme == 'chaos' %}active{% endif %}" onclick="changeTheme('chaos')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #000 0%, #444 100%);"></div>
                <div class="theme-name">CHAOS</div>
            </div>
            {% if user.profile.paidUser %}
            <div class="theme-card {% if user.profile.theme == 'lebron' %}active{% endif %}" onclick="changeTheme('lebron')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);"></div>
                <div class="theme-name">⭐ LEBRON</div>
            </div>
            {% else %}
            <div class="theme-card" style="opacity: 0.5; cursor: not-allowed;" title="Premium only">
                <div class="theme-preview" style="background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);"></div>
                <div class="theme-name">🔒 LEBRON</div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Password Change -->
    <div class="pixel-box settings-section">
        <h2>🔑 CHANGE PASSWORD</h2>
        <div class="password-form">
            <div class="form-group">
                <label>CURRENT PASSWORD</label>
                <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>
            <div class="form-group">
                <label>NEW PASSWORD</label>
                <input type="password" id="newPassword" placeholder="Enter new password">
            </div>
            <div class="form-group">
                <label>CONFIRM NEW PASSWORD</label>
                <input type="password" id="confirmPassword" placeholder="Confirm new password">
            </div>
            <button class="pixel-btn" onclick="changePassword()" style="width: 100%;">UPDATE PASSWORD</button>
        </div>
    </div>
    
    <!-- Account Actions -->
    <div class="pixel-box" style="text-align: center;">
        <a href="{% url 'homepage:python_environment' %}" class="pixel-btn" style="display: inline-block; margin: 10px; text-decoration: none;">▶ START CODING</a>
        <a href="{% url 'auth_app:logout' %}" class="pixel-btn danger" style="display: inline-block; margin: 10px; text-decoration: none;">⏻ LOGOUT</a>
    </div>
</div>

<!-- 2FA Setup Modal -->
<div class="pixel-modal" id="twoFAModal">
    <div class="modal-content">
        <div class="modal-header">SETUP 2FA</div>
        <div id="modalBody">
            <p style="font-size: 0.6rem; color: #0a0; margin-bottom: 20px; line-height: 1.8;">
                Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)
            </p>
            <div class="qr-container" id="qrContainer">
                <div class="pixel-loader"></div>
            </div>
            <div class="form-group">
                <label>ENTER VERIFICATION CODE</label>
                <input type="text" id="totpCode" placeholder="000000" maxlength="6" style="text-align: center; letter-spacing: 10px;">
            </div>
            <div id="backupCodes" style="display: none;">
                <p style="font-size: 0.6rem; color: #ff0; margin-bottom: 10px;">
                    ⚠️ SAVE THESE BACKUP CODES ⚠️
                </p>
                <div class="backup-codes" id="codesContainer"></div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="pixel-btn" onclick="verify2FA()">VERIFY</button>
            <button class="pixel-btn danger" onclick="closeModal()">CANCEL</button>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    function showNotification(message, isError = false) {
        const notification = document.createElement('div');
        notification.className = 'pixel-notification' + (isError ? ' error' : '');
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }
    
    function changeTheme(theme) {
        fetch('{% url "auth_app:update_theme" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: 'theme=' + theme
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('THEME UPDATED: ' + theme.toUpperCase());
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.error || 'THEME UPDATE FAILED', true);
            }
        })
        .catch(error => showNotification('ERROR: ' + error, true));
    }
    
    function changePassword() {
        const current = document.getElementById('currentPassword').value;
        const newPass = document.getElementById('newPassword').value;
        const confirm = document.getElementById('confirmPassword').value;
        
        if (!current || !newPass || !confirm) {
            showNotification('ALL FIELDS REQUIRED', true);
            return;
        }
        
        fetch('{% url "auth_app:request_password_change" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                current_password: current,
                new_password: newPass,
                confirm_password: confirm
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('VERIFICATION CODE SENT');
                const code = prompt('Enter verification code from your email:');
                if (code) {
                    verifyPasswordChange(code);
                }
            } else {
                showNotification(data.error || 'PASSWORD CHANGE FAILED', true);
            }
        })
        .catch(error => showNotification('ERROR: ' + error, true));
    }
    
    function verifyPasswordChange(code) {
        fetch('{% url "auth_app:verify_password_change" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ code: code })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('PASSWORD CHANGED SUCCESSFULLY');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } else {
                showNotification(data.error || 'VERIFICATION FAILED', true);
            }
        })
        .catch(error => showNotification('ERROR: ' + error, true));
    }
    
    function enable2FA() {
        document.getElementById('twoFAModal').classList.add('show');
        fetch('{% url "auth_app:enable_2fa" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('qrContainer').innerHTML = data.qr_code;
            } else {
                showNotification(data.error || '2FA SETUP FAILED', true);
                closeModal();
            }
        })
        .catch(error => {
            showNotification('ERROR: ' + error, true);
            closeModal();
        });
    }
    
    function verify2FA() {
        const code = document.getElementById('totpCode').value;
        if (!code || code.length !== 6) {
            showNotification('ENTER 6-DIGIT CODE', true);
            return;
        }
        
        fetch('{% url "auth_app:verify_2fa" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ code: code })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('backupCodes').style.display = 'block';
                document.getElementById('codesContainer').innerHTML = data.backup_codes.join('<br>');
                showNotification('2FA ENABLED SUCCESSFULLY');
                setTimeout(() => location.reload(), 3000);
            } else {
                showNotification(data.error || 'VERIFICATION FAILED', true);
            }
        })
        .catch(error => showNotification('ERROR: ' + error, true));
    }
    
    function disable2FA() {
        if (!confirm('ARE YOU SURE YOU WANT TO DISABLE 2FA?')) {
            return;
        }
        
        fetch('{% url "auth_app:disable_2fa" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('2FA DISABLED');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.error || '2FA DISABLE FAILED', true);
            }
        })
        .catch(error => showNotification('ERROR: ' + error, true));
    }
    
    function closeModal() {
        document.getElementById('twoFAModal').classList.remove('show');
    }
</script>
{% endblock %}
